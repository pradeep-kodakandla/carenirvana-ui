<mat-menu #menu="matMenu" class="my-class">
  <div class="container">
    <div class="column" *ngFor="let column of columns">
      <div class="section" *ngFor="let section of column.sections">
        <h5 style="color: #007BFF;">{{ section.header }}</h5>
        <div class="body-item" *ngFor="let item of section.bodyItems">
          <button mat-menu-item>
            {{ item }}
          </button>
        </div>
      </div>
    </div>
  </div>
</mat-menu>
<div class="navbar div-primary">
  <!-- Left Side: Home Icon -->
  <div class="left">
    <button mat-icon-button (click)="goToPage('dashboard')">
      <mat-icon style="color:white;">home</mat-icon>
    </button>

    <button mat-icon-button (click)="goToPage('dashboard')">
      <img src="assets/icons/CareNirvanaLogo.png" class="home-icon" alt="Care Nirvana Logo" />
    </button>
    <h4 style="margin-top: 8px !important; padding-right:10px">Care Nirvana</h4>

    <!-- Tabs Container -->
    <ul class="nav nav-tabs" style="border-bottom:none;">
      <ng-container *ngFor="let tab of headerService.getTabs()">
        <li class="nav-item">
          <button class="nav-link"
                  data-bs-toggle="tab"
                  type="button"
                  role="tab"
                  [class.active]="tab.route === headerService.getSelectedTab()"
                  (click)="onTabClick(tab.route)"
                  [attr.aria-controls]="'tab' + tab.label">
            <div class="tab">
              <span class="tab-title">Member ID: ({{ tab.memberId }})</span>
              <!--{{ tab.label.includes('Auth') ? 'Auth' : 'Member' }} - ID: {{ tab.memberId }}-->
              <span style="padding-top:5px;">{{ tab.label }}</span>
              <span class="close-btn" (click)="removeTab(tab)"><mat-icon style="vertical-align:bottom;">close</mat-icon></span>
            </div>
          </button>
        </li>
      </ng-container>

      <!-- âœ… "+" button appears at the end of the dynamic tabs -->
      <li *ngIf="headerService.getTabs().length > 0" class="nav-item">
        <button class="nav-link add-tab-btn" (click)="onAddNewTab()"> <mat-icon style="vertical-align:bottom;">add</mat-icon></button>
      </li>
    </ul>
  </div>


  <div class="right">
    <div class="notification-bar">

      <!--<div class="search-bar" *ngIf="isExpanded">
        <input type="text"
               class="form-control"
               placeholder="Search Care Nirvana"
               [(ngModel)]="searchQuery"
               [class.expanded]="isExpanded"
               (blur)="collapseSearch()" />

      </div>
      <button mat-icon-button (click)="toggleSearch()">
        <mat-icon style="color:white;">search</mat-icon>
      </button>-->
      <!-- Search icon opens member search popover -->
      <button mat-icon-button
              aria-label="Member search"
              #memberSearchTrigger="matMenuTrigger"
              [matMenuTriggerFor]="memberSearchMenu">
        <mat-icon style="color:white;">search</mat-icon>
      </button>

      <!-- Popover containing the reusable member search component -->
      <mat-menu #memberSearchMenu="matMenu"
                class="history-popover"
                yPosition="below"
                [overlapTrigger]="false"
                [hasBackdrop]="true"
                [backdropClass]="'cdk-overlay-dark-backdrop'"
                matMenuTriggerRestoreFocus="false">
        <div class="member-search-wrap" (click)="$event.stopPropagation()">
          <!-- Your reusable member search component -->
          <ui-member-search (memberSelected)="onHeaderMemberSelected($event)">
          </ui-member-search>
        </div>
      </mat-menu>


      <button mat-icon-button (click)="goToPage('admin-config')">
        <mat-icon style="color:white;">settings</mat-icon>
      </button>

      <button hidden mat-icon-button [matMenuTriggerFor]="menu">
        <mat-icon style="color:white;">apps</mat-icon>
      </button>

      <!-- History: hover/click to open, stays open until outside click -->
      <button mat-icon-button
              aria-label="Recently accessed (last 24 hours)"
              #historyTrigger="matMenuTrigger"
              [matMenuTriggerFor]="historyMenu"
              (onclick)="openHistoryMenu(historyTrigger)">
        <!-- no mouseleave -->
        <mat-icon style="color:white;">history</mat-icon>
      </button>

      <mat-menu #historyMenu="matMenu"
                class="history-popover"
                yPosition="below"
                [overlapTrigger]="false"
                [hasBackdrop]="true"
                [backdropClass]="'cdk-overlay-dark-backdrop'"
                matMenuTriggerRestoreFocus="false"
                (click)="$event.stopPropagation()">

        <!-- chips + table (your existing content) -->
        <div class="counts-wrap">
          <div class="counts-title">
            User accessed <span class="subtle">from last 24 hours</span>
          </div>
          <div class="chip-row">
            <span class="count-chip members">Members: {{ accessCounts?.members ?? 0 }}</span>
            <span class="count-chip auths">Auths: {{ accessCounts?.auths ?? 0 }}</span>
            <span class="count-chip complaints">Complaints: {{ accessCounts?.complaints ?? 0 }}</span>
          </div>
        </div>

        <div class="divider"></div>

        <div class="table-scroll">
          <table class="recent-table">
            <thead>
              <tr>
                <th>Member Id</th>
                <th>Member Name</th>
                <th>Feature Group Name</th>
                <th>Feature Name</th>
                <th>Auth Number</th>
                <th>Action</th>
                <th>Accessed Date Time</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let it of items">
                <td>
                  <a href="#"
                     class="link-member"
                     (click)="openMemberTab(it.memberID, it.memberName, it.memberDetailsId); $event.preventDefault()">
                    {{ it.memberID || 'N/A' }}
                  </a>
                </td>
                <td>{{ it.memberName || 'N/A' }}</td>
                <td>{{ it.featureGroupName || 'N/A' }}</td>
                <td>{{ it.featureName || 'N/A' }}</td>
                <td>
                  <a *ngIf="it.authNumber"
                     href="#"
                     class="link-auth"
                     (click)="openAuthTab(it.authNumber,it.memberID, it.memberDetailsId); $event.preventDefault()">
                    {{ it.authNumber }}
                  </a>
                  <span *ngIf="!it.authNumber">N/A</span>
                </td>
                <td>{{ it.action || 'N/A' }}</td>
                <td>{{ it.accessedDateTime | date:'MM/dd/yyyy, hh:mm a' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </mat-menu>


      <!--<button mat-icon-button>
        <mat-icon class="mat-badge" aria-hidden="false" style="color:white;" matBadge="15">message</mat-icon>
      </button>-->

      <button mat-icon-button
              aria-label="Messages"
              #messagesTrigger="matMenuTrigger"
              [matMenuTriggerFor]="messagesMenu"
              (onclick)="openMessagesMenu(messagesTrigger)">
        <mat-icon style="color:white;" matBadge="15">message</mat-icon>
      </button>

      <!-- Messages popover -->
      <mat-menu #messagesMenu="matMenu"
                class="history-popover"
                yPosition="below"
                [overlapTrigger]="false"
                [hasBackdrop]="true"
                [backdropClass]="'cdk-overlay-dark-backdrop'"
                matMenuTriggerRestoreFocus="false">
        <div class="messages-wrap" (click)="$event.stopPropagation()">
          <!-- Give the panel a nice fixed size -->
          <app-messages [memberDetailsId]="selectedMemberDetailsId"
                        [careStaffOptions]="careStaffOptions">
          </app-messages>
        </div>
      </mat-menu>

      <button mat-icon-button>
        <mat-icon class="mat-badge" aria-hidden="false" style="color:white;" matBadge="15">mail</mat-icon>
      </button>

      <button mat-icon-button
              aria-label="Messages"
              #messagesTrigger="matMenuTrigger"
              [matMenuTriggerFor]="alertsMenu"
              (onclick)="openMessagesMenu(messagesTrigger)">
        <mat-icon style="color:white;" aria-hidden="false" matBadge="20">notifications</mat-icon>
      </button>
      <!-- Alert popover -->
      <mat-menu #alertsMenu="matMenu"
                class="history-popover"
                yPosition="below"
                [overlapTrigger]="false"
                [hasBackdrop]="true"
                [backdropClass]="'cdk-overlay-dark-backdrop'"
                matMenuTriggerRestoreFocus="false">
        <div class="messages-wrap" (click)="$event.stopPropagation()">
          <!-- Give the panel a nice fixed size -->
          <app-member-alerts [showTable]="true"></app-member-alerts>
        </div>
      </mat-menu>

      <button mat-icon-button [matMenuTriggerFor]="menuperson">
        <mat-icon style="color:white;">person</mat-icon>
      </button>

      <mat-menu class="mat-mdc-menu-panel" #menuperson="matMenu">
        <div class="body-item">

          <button mat-menu-item>
            <mat-icon>manage account</mat-icon>
            <span>Profile</span>
          </button>
          <button mat-menu-item>
            <mat-icon>password</mat-icon>
            <span>Change Password</span>
          </button>
          <button mat-menu-item (click)="goToLogoutPage('')">
            <mat-icon>logout</mat-icon>
            <span>Log Out</span>
          </button>
        </div>
      </mat-menu>

    </div>
  </div>
</div>
