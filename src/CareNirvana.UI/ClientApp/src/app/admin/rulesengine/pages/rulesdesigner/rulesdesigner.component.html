<div class="topbar">
  <div class="left">
    <div class="titleRow">
      <div class="title">Rules Designer</div>
      <div class="subtitle">Drag fields ‚Üí build WHEN, then drag actions ‚Üí THEN. JSON stays in sync.</div>
    </div>
  </div>

  <div class="right">
    <button class="btn" (click)="back()">Back</button>
    <button class="btn primary" [disabled]="saving" (click)="save()">
      {{ saving ? 'Saving...' : 'Save' }}
    </button>
  </div>
  <div class="error" *ngIf="error">{{ error }}</div>
  <div class="success" *ngIf="successMsg">{{ successMsg }}</div>
</div>


<!-- IMPORTANT: cdkDropListGroup connects ALL drop lists so drops won‚Äôt snap back -->
<div class="designer"
     cdkDropListGroup
     [class.jsonCollapsed]="jsonPanelCollapsed"
     [ngStyle]="jsonPanelCollapsed ? { 'grid-template-columns': 'auto 1fr 44px' } : null">


  <!-- LEFT PALETTE -->
  <div class="panel card leftpanel">

    <!-- Fields -->
    <div class="section">
      <div class="sectionhead">
        <div class="sectiontitle">Fields</div>
        <button class="link" (click)="showAllFields = !showAllFields">
          {{ showAllFields ? 'Top 5' : 'Show all' }}
        </button>
      </div>
      <input class="search" [(ngModel)]="fieldSearch" placeholder="Search fields..." />

      <div class="palette"
           cdkDropList
           [id]="fieldsPaletteId"
           [cdkDropListSortingDisabled]="true">
        <div class="pill"
             *ngFor="let f of visibleFields"
             cdkDrag
             (cdkDragMoved)="onPaletteDragMoved($event)"
             (cdkDragEnded)="onPaletteDragEnded()"
             [cdkDragData]="dragField(f)"
             cdkDragPreviewClass="drag-preview">
          {{ f.label }}
          <!--<div class="pillsub">{{ f.key }}</div>-->
        </div>
      </div>
    </div>

    <!-- Functions -->
    <div class="section">
      <!--<div class="sectionhead">
        <div class="sectiontitle">Functions</div>
        <button class="link" (click)="showAllFunctions = !showAllFunctions">
          {{ showAllFunctions ? 'Top 5' : 'Show all' }}
        </button>
      </div>-->
      <div class="sectionhead">
        <div class="sectiontitle">Functions</div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="link" type="button" (click)="refreshFunctions()" [disabled]="functionsLoading">
            {{ functionsLoading ? 'Refreshing...' : 'Refresh' }}
          </button>

          <button class="link" type="button" (click)="showAllFunctions = !showAllFunctions">
            {{ showAllFunctions ? 'Top 5' : 'Show all' }}
          </button>
        </div>
      </div>

      <input class="search" [(ngModel)]="functionSearch" placeholder="Search functions..." />

      <div class="palette"
           cdkDropList
           [id]="functionsPaletteId"
           [cdkDropListSortingDisabled]="true">
        <div class="pill"
             *ngFor="let fn of visibleFunctions"
             cdkDrag
             (cdkDragMoved)="onPaletteDragMoved($event)"
             (cdkDragEnded)="onPaletteDragEnded()"
             [cdkDragData]="dragFunction(fn)"
             cdkDragPreviewClass="drag-preview">
          {{ fn.label }}
          <div class="pillsub">returns {{ fn.returnType }}</div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="section">
      <div class="sectionhead">
        <div class="sectiontitle">Actions</div>
        <button class="link" (click)="showAllActions = !showAllActions">
          {{ showAllActions ? 'Top 5' : 'Show all' }}
        </button>
      </div>
      <input class="search" [(ngModel)]="actionSearch" placeholder="Search actions..." />

      <div class="palette"
           cdkDropList
           [id]="actionsPaletteId"
           [cdkDropListSortingDisabled]="true">
        <div class="pill"
             *ngFor="let a of visibleActions"
             cdkDrag
             (cdkDragMoved)="onPaletteDragMoved($event)"
             (cdkDragEnded)="onPaletteDragEnded()"
             [cdkDragData]="dragAction(a)"
             cdkDragPreviewClass="drag-preview">
          {{ a.label }}
          <div class="pillsub">{{ a.key }}</div>
        </div>
      </div>
    </div>



    <!-- Decision Outputs (Decision Table rule only) -->
    <div class="section" *ngIf="designerMode === 'DECISION_TABLE' && decisionOutputFields.length">
      <div class="sectionhead">
        <div class="sectiontitle">Decision Outputs</div>
        <button class="link" (click)="showAllDecisionOutputs = !showAllDecisionOutputs">
          {{ showAllDecisionOutputs ? 'Top 5' : 'Show all' }}
        </button>
      </div>

      <input class="search" [(ngModel)]="decisionOutputSearch" placeholder="Search decision outputs..." />

      <div class="palette"
           cdkDropList
           [id]="decisionOutputsPaletteId"
           [cdkDropListSortingDisabled]="true">
        <div class="pill"
             *ngFor="let o of visibleDecisionOutputs"
             cdkDrag
             (cdkDragMoved)="onPaletteDragMoved($event)"
             (cdkDragEnded)="onPaletteDragEnded()"
             [cdkDragData]="dragField(o)"
             cdkDragPreviewClass="drag-preview">
          {{ o.label }}
          <div class="pillsub">Decision output</div>
        </div>
      </div>
    </div>

    <!-- Decision Tables -->
    <div class="section">
      <div class="sectionhead">
        <div class="sectiontitle">Decision Tables</div>
        <button class="link" (click)="showAllDecisionTables = !showAllDecisionTables">
          {{ showAllDecisionTables ? 'Top 5' : 'Show all' }}
        </button>
      </div>
      <input class="search" [(ngModel)]="decisionTableSearch" placeholder="Search decision tables..." />

      <div class="palette"
           cdkDropList
           [id]="decisionTablesPaletteId"
           [cdkDropListSortingDisabled]="true">
        <div class="pill"
             *ngFor="let t of visibleDecisionTables"
             cdkDrag
             (cdkDragMoved)="onPaletteDragMoved($event)"
             (cdkDragEnded)="onPaletteDragEnded()"
             [cdkDragData]="dragDecisionTable(t)"
             cdkDragPreviewClass="drag-preview">
          {{ t.name || t.id }}
          <div class="pillsub">{{ t.id }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- MIDDLE: WHEN/THEN CANVAS -->
  <div class="panel card midpanel"
       [style.flex]="'1 1 0'"
       [style.flexBasis]="'0'"
       [style.width]="'auto'"
       [style.minWidth]="'0'">
    <!-- RUN FIRST: Decision Table (drag here) -->
    <div class="block runfirst">
      <div class="blockhead">
        <div class="blocktitle">RUN FIRST</div>
        <div class="hint">Drag a decision table here to run it first.</div>

        <div class="spacer"></div>

        <button class="btn small"
                type="button"
                *ngIf="loadedDecisionTable?.id"
                (click)="clearRunFirstDecisionTable()">
          Remove
        </button>
      </div>

      <div class="runFirstCanvas"
           cdkDropList
           [id]="runFirstDropId"
           [cdkDropListEnterPredicate]="canDropToRunFirst"
           [cdkDropListSortingDisabled]="true"
           (cdkDropListDropped)="dropToRunFirst($event)">

        <div class="watermark" *ngIf="!loadedDecisionTable?.id">
          Drag a <b>Decision Table</b> here (optional). It will execute before WHEN/THEN.
        </div>

        <div class="dtCard" *ngIf="loadedDecisionTable?.id">
          <div class="dtCardHead">
            <div>
              <!--<div class="dtCardTitle">Decision Table Rule</div>-->
              <div class="dtCardSub">
                Decision table runs first. Use <b>Decision.*</b> outputs as response or for routing.
              </div>
            </div>

            <!--<button class="btn small"
                    type="button"
                    (click)="openDecisionTableInBuilder()"
                    [disabled]="!loadedDecisionTable?.id">
              Open in Decision Table Builder
            </button>-->
          </div>

          <div class="dtModeRow">
            <div class="dtModeLabel">Mode</div>

            <button class="chipbtn tiny"
                    type="button"
                    [class.active]="dtResponseMode === 'DIRECT'"
                    (click)="setDtResponseMode('DIRECT')">
              Return outputs
            </button>

            <button class="chipbtn tiny"
                    type="button"
                    [class.active]="dtResponseMode === 'ROUTE'"
                    (click)="setDtResponseMode('ROUTE')">
              Route on outputs
            </button>

            <div class="spacer"></div>

            <span class="dtModeHint" *ngIf="dtResponseMode === 'DIRECT'">
              Routing below is disabled.
            </span>
          </div>

          <div class="dtBannerMeta">
            <!--<span class="dtPill">ID: {{ loadedDecisionTable?.id }}</span>-->
            <span class="dtPill" *ngIf="loadedDecisionTable?.name">Name: {{ loadedDecisionTable?.name }}</span>
            <span class="dtPill" *ngIf="loadedDecisionTable?.tableVersion != null">Version: {{ loadedDecisionTable?.tableVersion }}</span>
          </div>

          <div class="dtOutputsRow">
            <div class="dtOutputsLabel">Outputs</div>
            <div class="dtOutputsChips">
              <span class="dtPill dtOutputChip" *ngFor="let o of decisionOutputsMeta">
                Decision.{{ o.key }}
                <button class="x mini" type="button" (click)="removeDecisionOutput(o.key)">‚úï</button>
              </span>

              <span class="dtPill ghost" *ngIf="!decisionOutputsMeta?.length">
                No outputs yet
              </span>
            </div>
          </div>

          <!--<div class="dtOutputEditor">
            <input class="text mini"
                   [(ngModel)]="dtNewOutputKey"
                   placeholder="Output key (e.g. result1)" />

            <select class="op"
                    [(ngModel)]="dtNewOutputType">
              <option *ngFor="let t of dataTypeOptions" [ngValue]="t">{{ t }}</option>
            </select>

            <input class="text mini"
                   [(ngModel)]="dtNewOutputLabel"
                   placeholder="Label (optional)" />

            <button class="btn small" type="button" (click)="addDecisionOutput()">
              Add
            </button>
          </div>-->
        </div>
      </div>
    </div>

    <!-- Branch Tabs -->
    <div class="branchtabs" *ngIf="!isDtDirectResponse">
      <button class="tab"
              *ngFor="let b of branches; let i = index"
              [class.active]="i === activeBranchIndex"
              (click)="setActiveBranch(i)">
        {{ b.type === 'IF' ? 'IF' : (b.type === 'ELSE_IF' ? 'ELSE IF' : 'ELSE') }}
      </button>

      <div class="spacer"></div>

      <button class="tab ghost" (click)="addElseIf()">+ ELSE IF</button>
      <button class="tab ghost" (click)="ensureElseBranch()">+ ELSE</button>
    </div>

    <!-- WHEN -->
    <div class="block" *ngIf="!isDtDirectResponse && activeBranch.type !== 'ELSE'">
      <div class="blockhead">
        <div class="blocktitle">WHEN</div>

      </div>

      <!-- IMPORTANT: ONE stable drop-list for canvas (no *ngIf on this element) -->
      <div class="canvas"
           cdkDropList
           [id]="canvasDropId"
           [cdkDropListEnterPredicate]="canDropToWhen"
           [cdkDropListSortingDisabled]="true"
           (cdkDropListDropped)="dropToActiveWhenCanvas($event)">

        <div class="watermark" *ngIf="isActiveGroupEmpty()">
          Drag a <b>field</b><span *ngIf="designerMode === 'DECISION_TABLE'"> or <b>Decision.*</b> output</span> (or function) here to start building the rule‚Ä¶
        </div>

        <!-- Render active group's children -->
        <ng-container *ngIf="activeBranch.when as root">
          <ng-container *ngTemplateOutlet="groupTpl; context:{ $implicit: root }"></ng-container>
        </ng-container>
      </div>
    </div>

    <!-- ELSE branch has no WHEN -->
    <div class="block" *ngIf="!isDtDirectResponse && activeBranch.type === 'ELSE'">
      <div class="watermark solo">
        ELSE branch: no WHEN conditions. Only THEN actions will run.
      </div>
    </div>

    <!-- THEN -->
    <div class="block" *ngIf="!isDtDirectResponse">
      <div class="blockhead">
        <div class="blocktitle">THEN</div>
        <div class="hint">Drag an action from the left into this area.</div>
      </div>

      <div class="thenCanvas"
           cdkDropList
           [id]="thenDropId"
           [cdkDropListEnterPredicate]="canDropToThen"
           [cdkDropListSortingDisabled]="true"
           (cdkDropListDropped)="dropToThenCanvas($event)">

        <div class="watermark" *ngIf="activeBranch.then.length === 0">
          Drag an <b>action</b> here (ex: Create Member Alert, Add Activity)‚Ä¶
        </div>

        <div class="actionCard" *ngFor="let ai of activeBranch.then">
          <div class="actionTop">
            <div class="actionTitle">{{ ai.label }}</div>
            <button class="iconbtn" (click)="removeAction(ai.id)">‚úï</button>
          </div>

          <ng-container *ngIf="actionDef(ai.actionKey) as def">
            <div class="paramRow"
                 *ngFor="let p of def.params"
                 [class.hiddenparam]="p.uiType === 'hidden'">

              <div class="paramLabel">
                {{ p.fieldName }}
                <span class="req" *ngIf="p.required">*</span>
              </div>

              <div class="paramValue">
                <div class="exprslot"
                     cdkDropList
                     [cdkDropListEnterPredicate]="canDropToExpr"
                     [cdkDropListSortingDisabled]="true"
                     (cdkDropListDropped)="dropActionParam(ai.id, p.fieldKey, $event)">

                  <ng-container *ngIf="ai.params[p.fieldKey] && ai.params[p.fieldKey]?.type !== 'literal'; else actionLiteral">
                    <span class="chip">
                      {{ exprLabel(ai.params[p.fieldKey]) }}
                    </span>
                    <button class="x" (click)="clearActionParam(ai.id, p.fieldKey)">‚úï</button>
                  </ng-container>

                  <ng-template #actionLiteral>
                    <div class="acWrap" (click)="$event.stopPropagation()">
                      <input class="text mini"
                             [value]="literalText(ai.params[p.fieldKey])"
                             (focus)="openActionParamAutocomplete(ai.id, p.fieldKey, p.dataType, literalText(ai.params[p.fieldKey]))"
                             (keydown)="onExprAutoKeydown($event)"
                             (input)="setActionParamLiteral(ai.id, p.fieldKey, $any($event.target).value, p.dataType); updateExprAutoQuery(actionParamKey(ai.id, p.fieldKey), $any($event.target).value)"
                             placeholder="Type value or search field/function..." />
                      <div class="acPanel" *ngIf="isExprAutoOpen(actionParamKey(ai.id, p.fieldKey))" (mousedown)="$event.stopPropagation()">
                        <div class="acHeader">Search fields / functions</div>
                        <button class="acClose" type="button" (mousedown)="$event.preventDefault(); closeExprAutocomplete()">‚úï</button>

                        <div class="acEmpty" *ngIf="exprAuto.items.length === 0">No matches</div>

                        <div class="acItem" *ngFor="let it of exprAuto.items"
                             (mousedown)="$event.preventDefault(); applyExprAuto(it)">
                          <div class="acMain">
                            <span class="acKind" [class.fn]="it.kind==='function'">{{ it.kind === 'function' ? '∆í' : '‚õÅ' }}</span>
                            {{ it.label }}
                          </div>
                          <div class="acMeta">{{ it.meta }}</div>
                        </div>
                      </div>
                    </div>
                  </ng-template>

                </div>
              </div>
            </div>
          </ng-container>
        </div>

      </div>
    </div>

    <!-- Recursive group renderer -->
    <ng-template #groupTpl let-g>
      <div class="groupBox">
        <div class="groupHead">
          <button class="chipbtn tiny" (click)="addGroup(g.id)">+ Group</button>
        </div>

        <div class="groupBody"
             cdkDropList
             [id]="g.id"
             [cdkDropListEnterPredicate]="canDropToWhen"
             [cdkDropListSortingDisabled]="true"
             (cdkDropListDropped)="dropToGroup(g.id, $event)">

          <div class="watermark" *ngIf="g.children.length === 0">
            Drop a field here‚Ä¶
          </div>

          <ng-container *ngFor="let n of g.children; let idx = index">
            <div class="joiner" *ngIf="idx > 0">
              <select class="joinerSelect"
                      [(ngModel)]="g.op"
                      (ngModelChange)="onGroupOpChanged()">
                <option [ngValue]="'AND'">AND</option>
                <option [ngValue]="'OR'">OR</option>
              </select>
            </div>

            <ng-container [ngSwitch]="n.nodeType">

              <!-- Condition -->
              <div *ngSwitchCase="'condition'" class="condRow">
                <!-- Left -->
                <div class="exprslot"
                     cdkDropList
                     [cdkDropListEnterPredicate]="canDropToExpr"
                     [cdkDropListSortingDisabled]="true"
                     (cdkDropListDropped)="dropCondLeft(n.id, $event)">

                  <ng-container *ngIf="n.left; else leftEmpty">
                    <span class="chip">{{ exprLabel(n.left) }}</span>
                    <button class="x" (click)="clearCondLeft(n.id)">‚úï</button>
                  </ng-container>

                  <ng-template #leftEmpty>
                    <span class="slotph">drop field/function</span>
                  </ng-template>
                </div>

                <!-- Operator -->
                <select class="op"
                        [(ngModel)]="n.operator"
                        (ngModelChange)="onOperatorChanged()"
                        [disabled]="!n.left">
                  <option [ngValue]="null">Operator‚Ä¶</option>
                  <option *ngFor="let op of operatorOptionsFor(n.left)"
                          [ngValue]="op.key">
                    {{ op.label }}
                  </option>
                </select>

                <!-- Right -->
                <div class="exprslot rhs"
                     *ngIf="operatorNeedsRhs(n.operator)">
                  <div class="exprslot inner"
                       cdkDropList
                       [cdkDropListEnterPredicate]="canDropToExpr"
                       [cdkDropListSortingDisabled]="true"
                       (cdkDropListDropped)="dropCondRight(n.id, $event)">

                    <ng-container *ngIf="n.right && n.right.type !== 'literal'; else rightLiteral">
                      <span class="chip">{{ exprLabel(n.right) }}</span>
                      <button class="x" (click)="clearCondRight(n.id)">‚úï</button>
                    </ng-container>

                    <ng-template #rightLiteral>
                      <div class="acWrap" (click)="$event.stopPropagation()">
                        <input class="text mini"
                               [value]="literalText(n.right)"
                               (focus)="openCondRightAutocomplete(n.id, literalText(n.right))"
                               (keydown)="onExprAutoKeydown($event)"
                               (input)="setCondLiteralRight(n.id, $any($event.target).value); updateExprAutoQuery(condRightKey(n.id), $any($event.target).value)"
                               placeholder="Type value or search field/function..." />

                        <div class="acPanel" *ngIf="isExprAutoOpen(condRightKey(n.id))" (mousedown)="$event.stopPropagation()">
                          <div class="acHeader">Search fields / functions</div>
                          <button class="acClose" type="button" (mousedown)="$event.preventDefault(); closeExprAutocomplete()">‚úï</button>

                          <div class="acEmpty" *ngIf="exprAuto.items.length === 0">No matches</div>

                          <div class="acItem" *ngFor="let it of exprAuto.items"
                               (mousedown)="$event.preventDefault(); applyExprAuto(it)">
                            <div class="acMain">
                              <span class="acKind" [class.fn]="it.kind==='function'">{{ it.kind === 'function' ? '∆í' : '‚õÅ' }}</span>
                              {{ it.label }}
                            </div>
                            <div class="acMeta">{{ it.meta }}</div>
                          </div>
                        </div>
                      </div>
                    </ng-template>
                  </div>
                </div>

                <button class="iconbtn" (click)="removeWhenNode(g.id, n.id)">üóë</button>
              </div>

              <!-- Nested Group -->
              <div *ngSwitchCase="'group'" class="nested">
                <ng-container *ngTemplateOutlet="groupTpl; context:{ $implicit: n }"></ng-container>
                <div class="rowend">
                  <button class="link danger" (click)="removeWhenNode(g.id, n.id)">Remove group</button>
                </div>
              </div>

            </ng-container>
          </ng-container>
        </div>
      </div>
    </ng-template>
  </div>

  <!-- RIGHT JSON -->
  <!-- RIGHT JSON -->
  <!-- RIGHT PANEL -->
  <div class="panel card rightpanel"
       [class.jsonCollapsed]="jsonPanelCollapsed"
       [ngStyle]="jsonPanelCollapsed ? { flex: '0 0 44px', width: '44px', minWidth: '44px', maxWidth: '44px', padding: '0' } : null">

    <div class="jsonhead"
         [ngStyle]="jsonPanelCollapsed ? { padding: '8px 6px', justifyContent: 'center' } : null">

      <!-- Tabs (only when expanded) -->
      <div class="rtabs" *ngIf="!jsonPanelCollapsed">
        <button class="rtab"
                [class.active]="rightPanelTab === 'settings'"
                type="button"
                (click)="rightPanelTab = 'settings'">
          Settings
        </button>
        <button class="rtab"
                [class.active]="rightPanelTab === 'json'"
                type="button"
                (click)="rightPanelTab = 'json'">
          JSON
        </button>


      </div>

      <div class="spacer" *ngIf="!jsonPanelCollapsed"></div>

      <!-- JSON buttons only on JSON tab -->
      <div class="jsonbtns" *ngIf="!jsonPanelCollapsed && rightPanelTab === 'json'">
        <button class="btn small" (click)="applyJsonToDesigner()">Apply</button>
        <button class="btn small" (click)="discardJsonEdits()">Discard</button>
      </div>

      <!-- Collapse/Expand stays the same -->
      <button class="btn small"
              type="button"
              (click)="toggleJsonPanel()"
              [attr.title]="jsonPanelCollapsed ? 'Expand Rule JSON' : 'Collapse Rule JSON'"
              [attr.aria-label]="jsonPanelCollapsed ? 'Expand Rule JSON' : 'Collapse Rule JSON'">
        {{ jsonPanelCollapsed ? '‚ü®' : '‚ü©' }}
      </button>
    </div>

    <ng-container *ngIf="!jsonPanelCollapsed">
      <div class="rightcontent">

        <!-- JSON TAB -->
        <ng-container *ngIf="rightPanelTab === 'json'; else settingsTab">
          <textarea class="jsonarea"
                    [(ngModel)]="jsonText"
                    (focus)="onJsonFocus()"
                    (blur)="onJsonBlur()"></textarea>

          <div class="error" *ngIf="jsonError">{{ jsonError }}</div>
        </ng-container>

        <!-- SETTINGS TAB -->
        <ng-template #settingsTab>
          <!-- Reuse headercard field styles, but force vertical layout -->
          <div class="settingsform headercard">
            <div class="formgrid">

              <div class="flfield">
                <input class="flinput" placeholder=" " [(ngModel)]="name" />
                <label class="fllabel">Rule Name</label>
              </div>

              <div class="flfield" [class.filled]="!!ruleType">
                <ui-smart-dropdown class="flcontrol"
                                   label="Rule Type"
                                   [options]="ruleTypeUiOptions"
                                   [(ngModel)]="ruleType">
                </ui-smart-dropdown>
              </div>

              <div class="flfield" [class.filled]="!!ruleGroupId">
                <ui-smart-dropdown class="flcontrol"
                                   label="Rule Group"
                                   [options]="groupUiOptions"
                                   [(ngModel)]="ruleGroupId">
                </ui-smart-dropdown>
              </div>

              <div class="flfield filled">
                <div class="activeRow">
                  <label class="activeLabel">Active</label>
                  <label class="switch">
                    <input type="checkbox" [(ngModel)]="activeFlag" />
                    <span class="slider"></span>
                  </label>
                </div>
              </div>

              <div class="flfield full">
                <textarea class="fltextarea" rows="2" placeholder=" " [(ngModel)]="description"></textarea>
                <label class="fllabel">Description</label>
              </div>
            </div>
          </div>
        </ng-template>

      </div>
    </ng-container>

    <!-- Collapsed rail stays as-is -->
    <div *ngIf="jsonPanelCollapsed"
         style="display: flex; align-items: center; justify-content: center; user-select: none; writing-mode: vertical-rl; transform: rotate(180deg); font-weight: 600; opacity: 0.8;">
      Settings
    </div>
  </div>



</div>
