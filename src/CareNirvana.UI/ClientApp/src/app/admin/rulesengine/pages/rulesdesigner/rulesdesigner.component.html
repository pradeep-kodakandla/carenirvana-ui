<div class="topbar">
  <div class="left">
    <button class="btn" (click)="back()">← Back</button>
    <div class="titleblock">
      <div class="title">Rule Designer</div>
      <div class="subtitle" *ngIf="rule">
        {{ rule.name }} • {{ groupName(rule.ruleGroupId) }} • {{ rule.ruleType }}
      </div>
    </div>
  </div>

  <div class="right">
    <button class="btn" (click)="toggleJson()">{{ showJson ? 'Hide JSON' : 'Show JSON' }}</button>
    <button class="btn primary" (click)="save()" [disabled]="saving">{{ saving ? 'Saving...' : 'Save' }}</button>
  </div>
</div>

<div class="err" *ngIf="error">{{ error }}</div>

<div class="shell" *ngIf="!loading && !error">

  <!-- Header info like decisionrules -->
  <div class="card headercard">
    <div class="grid">
      <div class="flfield">
        <input class="flinput" placeholder=" " [(ngModel)]="name" (ngModelChange)="refreshJsonPreview()" />
        <label class="fllabel">Rule Name</label>
      </div>

      <div class="flfield">
        <ui-smart-dropdown class="flcontrol"
                           label="Rule Type"
                           [options]="ruleTypeUiOptions"
                           [(ngModel)]="ruleType"
                           (ngModelChange)="refreshJsonPreview()">
        </ui-smart-dropdown>
      </div>

      <div class="flfield">
        <ui-smart-dropdown class="flcontrol"
                           label="Rule Group"
                           [options]="groupUiOptions"
                           [(ngModel)]="ruleGroupId"
                           (ngModelChange)="refreshJsonPreview()">
        </ui-smart-dropdown>
      </div>

      <div class="flfield">
        <div class="activeRow">
          <label class="activeLabel">Active</label>
          <label class="switch">
            <input type="checkbox" [(ngModel)]="activeFlag" />
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <div class="flfield full">
        <textarea class="fltextarea" rows="2" placeholder=" " [(ngModel)]="description" (ngModelChange)="refreshJsonPreview()"></textarea>
        <label class="fllabel">Description</label>
      </div>
    </div>
  </div>

  <div class="bodygrid">
    <!-- IF -->
    <div class="card panel">
      <div class="panelhead">
        <div class="pilltag iftag">IF</div>
        <div class="paneltitle">Conditions</div>
        <button class="btn" (click)="addCondition()">+ Add</button>
      </div>

      <div class="list" *ngIf="conditions.length === 0">
        <div class="emptyline">No conditions. Add one.</div>
      </div>

      <div class="cond" *ngFor="let c of conditions; let i = index">
        <div class="rowhead">
          <div class="rowtitle">{{ i + 1 }}. {{ c.name }}</div>
          <button class="icon" (click)="removeCondition(i)">✕</button>
        </div>

        <div class="rowgrid">
          <div class="flfield">
            <input class="flinput" placeholder=" " [(ngModel)]="c.name" (ngModelChange)="refreshJsonPreview()" />
            <label class="fllabel">Label</label>
          </div>

          <div class="flfield">
            <ui-smart-dropdown class="flcontrol"
                               label="Operator"
                               [options]="operators"
                               [(ngModel)]="c.operator"
                               (ngModelChange)="refreshJsonPreview()">
            </ui-smart-dropdown>
          </div>

          <div class="flfield">
            <ui-smart-dropdown class="flcontrol"
                               label="Data Type"
                               [options]="dataTypes"
                               [(ngModel)]="c.dataType"
                               (ngModelChange)="refreshJsonPreview()">
            </ui-smart-dropdown>
          </div>

          <div class="flfield full">
            <input class="flinput" placeholder=" " [(ngModel)]="c.mappedFieldLabel" (ngModelChange)="refreshJsonPreview()" />
            <label class="fllabel">Mapped Field Label</label>
          </div>

          <div class="flfield">
            <input class="flinput" placeholder=" " [(ngModel)]="c.mappedModule" (ngModelChange)="refreshJsonPreview()" />
            <label class="fllabel">Module</label>
          </div>

          <div class="flfield">
            <input class="flinput" placeholder=" " [(ngModel)]="c.mappedDatasetKey" (ngModelChange)="refreshJsonPreview()" />
            <label class="fllabel">Dataset</label>
          </div>

          <div class="flfield">
            <input class="flinput" placeholder=" " [(ngModel)]="c.mappedFieldPath" (ngModelChange)="refreshJsonPreview()" />
            <label class="fllabel">Field Path</label>
          </div>

          <div class="flfield">
            <input class="flinput" placeholder=" " [(ngModel)]="c.mappedFieldKey" (ngModelChange)="refreshJsonPreview()" />
            <label class="fllabel">Field Key</label>
          </div>
        </div>
      </div>
    </div>

    <!-- THEN -->
    <div class="card panel">
      <div class="panelhead">
        <div class="pilltag thentag">THEN</div>
        <div class="paneltitle">Outputs</div>
        <button class="btn" (click)="addResult()">+ Add</button>
      </div>

      <div class="metaRow">
        <div class="flfield">
          <ui-smart-dropdown class="flcontrol"
                             label="Hit Policy"
                             [options]="hitPolicies"
                             [(ngModel)]="hitPolicy"
                             (ngModelChange)="refreshJsonPreview()">
          </ui-smart-dropdown>
        </div>

        <div class="flfield">
          <ui-smart-dropdown class="flcontrol"
                             label="Return Mode"
                             [options]="returnModes"
                             [(ngModel)]="returnMode"
                             (ngModelChange)="refreshJsonPreview()">
          </ui-smart-dropdown>
        </div>
      </div>

      <div class="list" *ngIf="results.length === 0">
        <div class="emptyline">No outputs. Add one.</div>
      </div>

      <div class="cond" *ngFor="let r of results; let i = index">
        <div class="rowhead">
          <div class="rowtitle">{{ i + 1 }}. {{ r.name }}</div>
          <button class="icon" (click)="removeResult(i)">✕</button>
        </div>

        <div class="rowgrid">
          <div class="flfield">
            <input class="flinput" placeholder=" " [(ngModel)]="r.name" (ngModelChange)="refreshJsonPreview()" />
            <label class="fllabel">Label</label>
          </div>

          <div class="flfield">
            <ui-smart-dropdown class="flcontrol"
                               label="Data Type"
                               [options]="dataTypes"
                               [(ngModel)]="r.dataType"
                               (ngModelChange)="refreshJsonPreview()">
            </ui-smart-dropdown>
          </div>
        </div>
      </div>
    </div>

    <!-- JSON -->
    <div class="card panel jsonpanel" *ngIf="showJson">
      <div class="panelhead">
        <div class="paneltitle">JSON</div>
        <button class="btn" (click)="applyJsonToDesigner()">Apply JSON → Designer</button>
      </div>

      <div class="jsonerr" *ngIf="jsonError">{{ jsonError }}</div>

      <textarea class="jsonarea"
                rows="24"
                [(ngModel)]="jsonText"></textarea>

      <div class="hint">
        Tip: You can paste the ruleJson you receive from API here and click “Apply JSON → Designer”.
      </div>
    </div>
  </div>
</div>

<div class="loading" *ngIf="loading">Loading...</div>
