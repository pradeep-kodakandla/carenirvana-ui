<!-- decisiontablebuilder.component.html -->
<form class="page" [formGroup]="form">
  <div class="topbar">
    <div class="left">
      <div class="title">Decision Table Builder</div>
      <div class="hint">Add columns + enter rows like a real decision table.</div>
      <div class="status">{{ statusText }}</div>
    </div>

    <div class="right">
      <select class="select" [value]="selectedTableId ?? ''" (change)="loadTable(($any($event.target)).value)">
        <option value="" disabled>Select template</option>
        <option *ngFor="let t of tables; trackBy: trackByTable" [value]="t.id">{{ t.name }}</option>
      </select>

      <button class="btn" type="button" (click)="createNewTable()">New</button>
      <button class="btn primary" type="button" (click)="saveTable()">Save</button>
      <button class="btn danger" type="button" (click)="deleteCurrent()">Delete</button>
    </div>
  </div>

  <!-- Meta -->
  <div class="card meta">
    <div class="field">
      <label>Name</label>
      <input class="input" type="text" formControlName="name" />
    </div>

    <div class="field">
      <label>Hit Policy</label>
      <select class="select" formControlName="hitPolicy">
        <option *ngFor="let hp of hitPolicies" [value]="hp">{{ hp }}</option>
      </select>
    </div>

    <div class="field">
      <label>Status</label>
      <select class="select" formControlName="status">
        <option value="DRAFT">DRAFT</option>
        <option value="PUBLISHED">PUBLISHED</option>
        <option value="ARCHIVED">ARCHIVED</option>
      </select>
    </div>

    <div class="field small">
      <label>Version</label>
      <input class="input" type="number" formControlName="version" />
    </div>
  </div>

  <!-- Decision table grid -->
  <div class="card dtcard">
    <div class="dttoolbar">
      <div class="chips">
        <span class="chip cond">Conditions {{ conditionCols.length }}</span>
        <span class="chip calc">Calculations {{ calculationCols.length }}</span>
        <span class="chip res">Results {{ resultCols.length }}</span>
      </div>

      <div class="tools">
        <button class="btn" type="button" (click)="addRow()">+ Add Row</button>
        <button class="btn" type="button" (click)="toggleJson()">{{ viewMode === 'table' ? '{}' : 'Table' }}</button>
      </div>
    </div>

    <!-- JSON view -->
    <div class="jsonwrap" *ngIf="viewMode === 'json'">
      <pre class="json">{{ jsonPreview }}</pre>
    </div>

    <!-- TABLE view -->
    <div class="dtwrap" *ngIf="viewMode === 'table'">

      <!-- backdrop to close menus -->
      <div class="menubackdrop"
           *ngIf="showAddMenu || showRowMenu || showColMenu"
           (click)="closeMenus()"></div>

      <div class="dtgrid" [style.gridTemplateColumns]="gridTemplateColumns">

        <!-- Group header row -->
        <div class="cell grouphead rowhead"></div>

        <div class="cell grouphead condhead" [style.gridColumn]="condGroupSpan">Condition</div>

        <div class="cell grouphead calchead"
             *ngIf="calculationCols.length > 0"
             [style.gridColumn]="calcGroupSpan">Calculation</div>

        <div class="cell grouphead reshead" [style.gridColumn]="resGroupSpan">Result</div>

        <!-- Column header row -->
        <div class="cell colhead rowhead"></div>

        <!-- Condition columns -->
        <ng-container *ngFor="let c of conditionCols; let i = index; trackBy: trackByCol">
          <div class="cell colhead">
            <div class="coltitle">
              <input class="colinput"
                     [value]="c.label"
                     (input)="setColLabel(c, $any($event.target).value)"
                     placeholder="Condition" />
              <button class="iconbtn" type="button" (click)="openColMenu('condition', i, $event)">â–¾</button>
            </div>
            <div class="colsub">{{ c.key }}</div>
          </div>
        </ng-container>

        <!-- Add column (+) spacer column header -->
        <div class="cell colhead addcol">
          <button class="addbtn" type="button" (click)="openAddMenu($event)">ï¼‹</button>
        </div>

        <!-- Calculation columns -->
        <ng-container *ngFor="let c of calculationCols; let i = index; trackBy: trackByCol">
          <div class="cell colhead">
            <div class="coltitle">
              <input class="colinput"
                     [value]="c.label"
                     (input)="setColLabel(c, $any($event.target).value)"
                     placeholder="Calculation" />
              <button class="iconbtn" type="button" (click)="openColMenu('calculation', i, $event)">â–¾</button>
            </div>
            <div class="colsub">{{ c.key }}</div>
          </div>
        </ng-container>

        <!-- Result columns -->
        <ng-container *ngFor="let c of resultCols; let i = index; trackBy: trackByCol">
          <div class="cell colhead">
            <div class="coltitle">
              <input class="colinput"
                     [value]="c.label"
                     (input)="setColLabel(c, $any($event.target).value)"
                     placeholder="Result" />
              <button class="iconbtn" type="button" (click)="openColMenu('result', i, $event)">â–¾</button>
            </div>
            <div class="colsub">{{ c.key }}</div>
          </div>
        </ng-container>

        <!-- Data rows -->
        <ng-container *ngFor="let r of rows; let ri = index; trackBy: trackByRow">

          <!-- row head -->
          <div class="cell rowhead">
            <div class="rowheadinner">
              <div class="rindex">{{ ri + 1 }}</div>
              <button class="playbtn" type="button" title="Run row">â–¶</button>

              <label class="switch">
                <input type="checkbox" [checked]="r.enabled" (change)="setRowEnabled(ri, $any($event.target).checked)" />
                <span class="slider"></span>
              </label>

              <button class="iconbtn" type="button" (click)="openRowMenu(ri, $event)">â‹®</button>
            </div>
          </div>

          <!-- condition cells -->
          <ng-container *ngFor="let c of conditionCols; trackBy: trackByCol">
            <div class="cell">
              <input class="cellinput"
                     [value]="getCell(r, c.id)"
                     (input)="setCell(r, c.id, $any($event.target).value)"
                     placeholder="Empty..." />
            </div>
          </ng-container>

          <!-- spacer cell under + column -->
          <div class="cell spacer"></div>

          <!-- calculation cells -->
          <ng-container *ngFor="let c of calculationCols; trackBy: trackByCol">
            <div class="cell">
              <div class="fncell">
                <span class="fnpill">Fn</span>
                <input class="cellinput"
                       [value]="getCell(r, c.id)"
                       (input)="setCell(r, c.id, $any($event.target).value)"
                       placeholder="Expression..." />
              </div>
            </div>
          </ng-container>

          <!-- result cells -->
          <ng-container *ngFor="let c of resultCols; trackBy: trackByCol">
            <div class="cell">
              <input class="cellinput"
                     [value]="getCell(r, c.id)"
                     (input)="setCell(r, c.id, $any($event.target).value)"
                     placeholder="Value..." />
            </div>
          </ng-container>

        </ng-container>
      </div>

      <!-- Add column dropdown -->
      <div class="menu" *ngIf="showAddMenu" [ngStyle]="addMenuStyle">
        <button type="button" class="menuitem" (click)="addColumn('condition')">ï¼‹ Add Condition Column</button>
        <button type="button" class="menuitem" (click)="addColumn('calculation')">ï¼‹ Add Calculation Column</button>
        <button type="button" class="menuitem" (click)="addColumn('result')">ï¼‹ Add Result Column</button>
      </div>

      <!-- Column menu -->
      <div class="menu" *ngIf="showColMenu" [ngStyle]="colMenuStyle">
        <button type="button" class="menuitem dangerItem" (click)="removeColumn()">ðŸ—‘ Remove Column</button>
      </div>

      <!-- Row menu -->
      <div class="menu" *ngIf="showRowMenu" [ngStyle]="rowMenuStyle">
        <button type="button" class="menuitem" (click)="moveRow(-1)">â†• Move Up</button>
        <button type="button" class="menuitem" (click)="moveRow(1)">â†• Move Down</button>
        <button type="button" class="menuitem" (click)="insertRow(true)">ï¼‹ Insert Above</button>
        <button type="button" class="menuitem" (click)="insertRow(false)">ï¼‹ Insert Below</button>
        <button type="button" class="menuitem" (click)="copyRow()">â§‰ Copy</button>
        <button type="button" class="menuitem" (click)="clearRow()">âŒ« Clear row</button>
        <button type="button" class="menuitem dangerItem" (click)="deleteRow()">ðŸ—‘ Delete row</button>
      </div>

    </div>
  </div>
</form>
