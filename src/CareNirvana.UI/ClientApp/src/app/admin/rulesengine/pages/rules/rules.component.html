<div class="pagehead">
  <div class="h2">Business Rules</div>
  <button class="btn primary" (click)="onNewRule()">+ New Rule</button>
</div>

<div class="card formcard" *ngIf="showForm">
  <div class="formtitle">{{ isEditMode ? 'Edit Rule' : 'Create Rule' }}</div>

  <div class="formgrid">
    <div class="flfield">
      <input class="flinput" placeholder=" " [(ngModel)]="form.name" />
      <label class="fllabel">Rule Name</label>
    </div>

    <div class="flfield" [class.filled]="!!form.ruleType">
      <ui-smart-dropdown class="flcontrol"
                         label="Rule Type"
                         [options]="ruleTypeUiOptions"
                         [(ngModel)]="form.ruleType">
      </ui-smart-dropdown>
    </div>

    <div class="flfield full" [class.filled]="!!form.ruleGroupId">
      <ui-smart-dropdown class="flcontrol"
                         label="Rule Group"
                         [options]="groupUiOptions"
                         [(ngModel)]="form.ruleGroupId">
      </ui-smart-dropdown>

      <div class="hint" *ngIf="groups.length === 0">
        Create a Rule Group first to assign rules.
      </div>
    </div>

    <!-- âœ… ActiveFlag -->
    <div class="flfield full filled">
      <div class="activeRow">
        <label class="activeLabel">Active</label>
        <label class="switch">
          <input type="checkbox" [(ngModel)]="form.activeFlag" />
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <div class="flfield full">
      <textarea class="fltextarea" rows="4" placeholder=" " [(ngModel)]="form.description"></textarea>
      <label class="fllabel">Description</label>
    </div>
  </div>

  <div class="formactions">
    <button class="btn" (click)="onCancel()">Cancel</button>

    <!-- âœ… NEW: open designer for create/edit form -->
    <button class="btn" (click)="openDesignerForForm()">Designer</button>

    <button class="btn primary" (click)="onSave()" [disabled]="groups.length === 0">
      {{ isEditMode ? 'Update' : 'Save' }}
    </button>
  </div>
</div>

<div class="rulestop">
  <div class="search">
    <span class="sicon">ðŸ”Ž</span>
    <input [(ngModel)]="searchText" placeholder="Search rules." />
  </div>
</div>

<div class="empty" *ngIf="!showForm && rules.length === 0">
  <div class="emptytitle">No Rules</div>
  <div class="emptytext">Create a rule and assign it to a rule group.</div>
</div>

<div class="rulegrid" *ngIf="filteredRules.length > 0">
  <div class="card rulecard" *ngFor="let r of filteredRules">
    <div class="ruletitle">{{ r.name }}</div>

    <div class="rulemeta">ðŸ“¦ {{ groupName(r.ruleGroupId) }}</div>

    <div class="ruledesc">{{ r.description }}</div>

    <div class="rulebadges">
      <span class="pill">{{ r.ruleType }}</span>
      <span class="pill" [class.off]="!r.activeFlag">{{ r.activeFlag ? 'Active' : 'Inactive' }}</span>
      <span class="pill" *ngIf="hasRuleJson(r)">Designer</span>
      <span class="pill" *ngIf="!hasRuleJson(r)">No Designer</span>
    </div>

    <div class="ruleactions">
      <button class="btnoutline" (click)="openDesigner(r)">Designer</button>
      <button class="btnoutline" (click)="openDesigner(r)">Edit</button>
      <button class="btndanger" (click)="onDelete(r)">Delete</button>
    </div>

  </div>
</div>

<!-- ========================= -->
<!-- âœ… Rule Designer Modal -->
<!-- ========================= -->
<div class="modalbackdrop" *ngIf="designerOpen" (click)="closeDesigner()"></div>

<div class="modal" *ngIf="designerOpen" (click)="$event.stopPropagation()">
  <div class="modalhead">
    <div class="modaltitle">Rule Designer</div>
    <button class="iconbtn" (click)="closeDesigner()">âœ•</button>
  </div>

  <div class="modalmeta">
    <div class="metaitem"><b>Name:</b> {{ designerHeaderName }}</div>
    <div class="metaitem"><b>Group:</b> {{ designerHeaderGroup }}</div>
    <div class="metaitem"><b>Type:</b> {{ designerHeaderType }}</div>
  </div>

  <div class="modalbody">
    <div class="hint">
      Paste/edit the rule JSON. If empty, the rule will be saved with no <code>ruleJson</code>.
      The <code>input</code> is automatically extracted from JSON (if present) and sent along on save.
    </div>

    <textarea class="jsonarea"
              rows="16"
              [(ngModel)]="designerText"
              (ngModelChange)="designerDirty = true"
              placeholder="{ }"></textarea>

    <div class="err" *ngIf="designerError">{{ designerError }}</div>
  </div>

  <div class="modalactions">
    <button class="btn" (click)="validateDesigner()">Validate</button>
    <button class="btn" (click)="formatDesigner()" [disabled]="!(designerText || '').trim()">Format</button>

    <button class="btn primary"
            (click)="saveDesigner()"
            [disabled]="designerSaving">
      {{ designerSaving ? 'Saving...' : 'Save' }}
    </button>
  </div>
</div>
