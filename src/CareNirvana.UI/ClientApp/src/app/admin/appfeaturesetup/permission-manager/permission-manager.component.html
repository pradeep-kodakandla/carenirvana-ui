<div class="container py-4">

  <!--<h2 class="text-center mb-4">Role Permissions Manager</h2>-->

  <div style="display: flex; gap: 20px;">

    <!-- Role Dropdown -->
    <div style="flex: 1;">
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Select Role</mat-label>

        <mat-select [(ngModel)]="selectedRole">
          <mat-option *ngFor="let role of roles" [value]="role">
            {{ role }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Module Multi-Select Dropdown -->
    <div style="flex: 1;">
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Select Modules</mat-label>

        <mat-select [(ngModel)]="selectedModules" multiple (ngModelChange)="onModulesChanged()">
          <mat-option *ngFor="let mod of allModules" [value]="mod.moduleId">
            {{ mod.moduleName }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Feature Group Dropdown -->
    <mat-form-field appearance="outline" class="w-100">
      <mat-label>Select Feature Group</mat-label>
      <mat-select [(ngModel)]="selectedFeatureGroup" (selectionChange)="onFeatureGroupChanged($event)">
        <mat-option *ngFor="let feature of availableFeatureGroups" [value]="feature">
          {{ feature }}
        </mat-option>
      </mat-select>
    </mat-form-field>



  </div>



  <div *ngIf="selectedModules.length > 0" class="mb-4">
    <input type="text" class="form-control mb-3" placeholder="Search features..." [(ngModel)]="searchText">
  </div>

  <ng-container *ngIf="readyToRender">
    <div *ngFor="let module of filteredModules" class="module-section mb-4">

      <!--<div class="d-flex justify-content-between align-items-center module-header"
               (click)="toggleExpand(module.moduleId)"
               style="cursor: pointer;">

            <h5 class="fw-bold m-0">
          {{ module.moduleName }}
          <span class="expand-icon">
            <i [class]="expandState[module.moduleId] ? 'bi bi-caret-down-fill' : 'bi bi-caret-right-fill'"></i>
          </span>
        </h5>

      </div>-->

      <div *ngIf="expandState[module.moduleId]" class="module-content mt-3">

        <div *ngFor="let featureGroup of module.featureGroups" class="feature-group-section mt-3">

          <h6 class="fw-bold mt-3 mb-2">{{ featureGroup.featureGroupName }}</h6>

          <div class="table-responsive">
            <table class="table table-bordered table-striped align-middle">
              <thead class="table-light">
                <tr>
                  <th>
                    <input type="checkbox"
                           [checked]="isAllPagesSelected(featureGroup)"
                           [indeterminate]="isSomePagesSelected(featureGroup)"
                           (change)="toggleAllPagesForGroup(featureGroup, $event)" />
                    Features
                  </th>

                  <th class="text-center">
                    <input type="checkbox"
                           [checked]="isAllSelected('View', featureGroup)"
                           [indeterminate]="isSomeSelected('View', featureGroup)"
                           (change)="toggleAll('View', featureGroup, $event)" />
                    View
                  </th>

                  <th class="text-center">
                    <input type="checkbox"
                           [checked]="isAllSelected('Edit', featureGroup)"
                           [indeterminate]="isSomeSelected('Edit', featureGroup)"
                           (change)="toggleAll('Edit', featureGroup, $event)" />
                    Edit
                  </th>

                  <th class="text-center">
                    <input type="checkbox"
                           [checked]="isAllSelected('Add', featureGroup)"
                           [indeterminate]="isSomeSelected('Add', featureGroup)"
                           (change)="toggleAll('Add', featureGroup, $event)" />
                    Add
                  </th>

                  <th class="text-center">
                    <input type="checkbox"
                           [checked]="isAllSelected('Delete', featureGroup)"
                           [indeterminate]="isSomeSelected('Delete', featureGroup)"
                           (change)="toggleAll('Delete', featureGroup, $event)" />
                    Delete
                  </th>

                  <th class="text-center">
                    <input type="checkbox"
                           [checked]="isAllSelected('Download', featureGroup)"
                           [indeterminate]="isSomeSelected('Download', featureGroup)"
                           (change)="toggleAll('Download', featureGroup, $event)" />
                    Download
                  </th>

                  <th class="text-center">
                    <input type="checkbox"
                           [checked]="isAllSelected('Print', featureGroup)"
                           [indeterminate]="isSomeSelected('Print', featureGroup)"
                           (change)="toggleAll('Print', featureGroup, $event)" />
                    Print
                  </th>
                </tr>
              </thead>

              <tbody>
                <tr *ngFor="let page of featureGroup.pages" [hidden]="!filterPage(page.name)">
                  <td>
                    <input type="checkbox"
                           [checked]="isPageFullySelected(page)"
                           [indeterminate]="isPagePartiallySelected(page)"
                           (change)="togglePageSelection(page, $event)">
                    <span class="fw-bold ms-2">{{ page.name }}</span>
                  </td>

                  <!-- Action columns -->
                  <td class="text-center">
                    <ng-container *ngIf="getAction(page, 'View'); else disabledCell">
                      <input type="checkbox"
                             class="form-check-input"
                             [ngModel]="getAction(page, 'View')!.checked"
                             (ngModelChange)="onActionChange(page, 'View', $event)">
                    </ng-container>
                    <ng-template #disabledCell>
                      <input type="checkbox" class="form-check-input" disabled>
                    </ng-template>
                  </td>

                  <td class="text-center">
                    <ng-container *ngIf="getAction(page, 'Edit'); else disabledCell">
                      <input type="checkbox"
                             class="form-check-input"
                             [ngModel]="getAction(page, 'Edit')!.checked"
                             (ngModelChange)="onActionChange(page, 'Edit', $event)">
                    </ng-container>
                  </td>

                  <td class="text-center">
                    <ng-container *ngIf="getAction(page, 'Add'); else disabledCell">
                      <input type="checkbox"
                             class="form-check-input"
                             [ngModel]="getAction(page, 'Add')!.checked"
                             (ngModelChange)="onActionChange(page, 'Add', $event)">
                    </ng-container>
                  </td>

                  <td class="text-center">
                    <ng-container *ngIf="getAction(page, 'Delete'); else disabledCell">
                      <input type="checkbox"
                             class="form-check-input"
                             [ngModel]="getAction(page, 'Delete')!.checked"
                             (ngModelChange)="onActionChange(page, 'Delete', $event)">
                    </ng-container>
                  </td>

                  <td class="text-center">
                    <ng-container *ngIf="getAction(page, 'Download'); else disabledCell">
                      <input type="checkbox"
                             class="form-check-input"
                             [ngModel]="getAction(page, 'Download')!.checked"
                             (ngModelChange)="onActionChange(page, 'Download', $event)">
                    </ng-container>
                  </td>

                  <td class="text-center">
                    <ng-container *ngIf="getAction(page, 'Print'); else disabledCell">
                      <input type="checkbox"
                             class="form-check-input"
                             [ngModel]="getAction(page, 'Print')!.checked"
                             (ngModelChange)="onActionChange(page, 'Print', $event)">
                    </ng-container>
                  </td>

                </tr>
              </tbody>
            </table>
          </div>


        </div>

      </div>

    </div>

  </ng-container>

  <div class="sticky-footer bg-light p-3 shadow-sm d-flex justify-content-end">
    <button class="btn btn-success me-2" (click)="savePermissions()">Save Changes</button>
    <button class="btn btn-secondary">Cancel</button>
  </div>


