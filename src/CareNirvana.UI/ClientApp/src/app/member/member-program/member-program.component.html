<div class="activity-container">
  <!-- LEFT: Program Timeline/List -->
  <div class="activity-left">
    <div class="left-controls">
      <input type="text"
             placeholder="üîç Search..."
             [(ngModel)]="searchTerm"
             (input)="applyFilter()"
             class="search-input" />

      <div class="right-actions">
        <div class="sort-wrapper" (mouseenter)="showSort = true" (mouseleave)="showSort = false">
          <button class="sort-icon" type="button">‚áÖ</button>
          <div class="sort-menu" *ngIf="showSort">
            <div class="sort-option" (click)="applySort('startDate_desc')">Start Date (New ‚Üí Old)</div>
            <div class="sort-option" (click)="applySort('startDate_asc')">Start Date (Old ‚Üí New)</div>
            <div class="sort-option" (click)="applySort('programLabel_asc')">Program (A‚ÄìZ)</div>
            <div class="sort-option" (click)="applySort('programLabel_desc')">Program (Z‚ÄìA)</div>
            <div class="sort-option" (click)="applySort('statusLabel_asc')">Status (A‚ÄìZ)</div>
            <div class="sort-option" (click)="applySort('statusLabel_desc')">Status (Z‚ÄìA)</div>
          </div>
        </div>

        <button class="add-btn" type="button" (click)="openFormForAdd()" [disabled]="!canAdd">‚ûï Add Program</button>
      </div>
    </div>

    <div class="timeline-list">
      <div *ngFor="let p of filtered; trackBy: trackById"
           class="timeline-item"
           [class.selected]="p.memberProgramId === selectedId">

        <div class="timeline-dot" [class.completed]="isCompleted(p)"></div>

        <div class="timeline-content" (click)="editProgram(p)">
          <div class="timeline-header">
            <div class="timeline-title">
              {{ p._programLabel || ('Program #' + p.programId) }}
            </div>
            <div class="timeline-priority priority-default">
              {{ p._startEndDisplay }}
            </div>
            <span class="activity-actions" (click)="$event.stopPropagation()">
              <button type="button" class="icon-btn" title="Edit" [disabled]="!canEdit" (click)="editProgram(p)">‚úèÔ∏è</button>
              <button type="button" class="icon-btn" title="Delete" [disabled]="!canDelete" (click)="deleteProgram(p)">üóëÔ∏è</button>
            </span>
          </div>

          <div class="timeline-summary">
            <span class="timeline-title">Status:</span> {{ p._statusLabel || p.programStatusId }}
            <ng-container *ngIf="p._statusReasonLabel"> ‚Ä¢ <span class="timeline-title">Reason:</span> {{ p._statusReasonLabel }}</ng-container>
            <ng-container *ngIf="p._referralSourceLabel"> ‚Ä¢ <span class="timeline-title">Referral:</span> {{ p._referralSourceLabel }}</ng-container>
            <ng-container *ngIf="p._assignedToLabel"> ‚Ä¢ <span class="timeline-title">Assigned:</span> {{ p._assignedToLabel }}</ng-container>
            <ng-container *ngIf="p.activeFlag === false"> ‚Ä¢ <em>Inactive</em></ng-container>
          </div>
        </div>
      </div>

      <!-- Empty state -->
      <div *ngIf="!loading && filtered.length === 0" class="timeline-item">
        <div class="timeline-content">
          <div class="timeline-header">
            <div class="timeline-title">No programs found</div>
          </div>
          <div class="timeline-summary">Try a different search or click ‚ÄúAdd Program‚Äù.</div>
        </div>
      </div>
    </div>

    <!-- PAGER -->
    <!--<div class="d-flex" style="gap:.5rem; margin-top: .5rem;">
      <button class="icon-btn" type="button" (click)="prevPage()" [disabled]="page<=1">‚¨ÖÔ∏è Prev</button>
      <div style="align-self:center;">Page {{ page }} ‚Ä¢ {{ total }} total</div>
      <button class="icon-btn" type="button" (click)="nextPage()" [disabled]="page*pageSize >= total">Next ‚û°Ô∏è</button>
    </div>-->
  </div>

  <!-- RIGHT: Form / AI Summary -->
  <div class="activity-right">
    <ng-container *ngIf="isFormVisible; else summaryTpl">
      <div class="auth-form">
        <form #programForm="ngForm" (ngSubmit)="saveProgram()">
          <div class="form-grid">
            <!-- Program -->
            <div class="form-outline dropdown-container">
              <label class="floating-label">Program <span class="text-danger">*</span></label>
              <div class="input-with-icon">
                <input class="form-control"
                       name="program"
                       [(ngModel)]="form.programDisplay"
                       (input)="filterOptions('program')"
                       (focus)="openDropdown('program')"
                       (blur)="onAutoBlur('program')"
                       autocomplete="off"
                       required />
                <span class="dropdown-arrow">&#9662;</span>

                <div class="autocomplete-dropdown" *ngIf="auto.program.open && auto.program.filtered.length">
                  <div class="autocomplete-option"
                       *ngFor="let opt of auto.program.filtered"
                       (mousedown)="selectAuto('program', opt)">
                    {{ opt.label }}
                  </div>
                </div>
              </div>
              <div class="invalid-feedback" *ngIf="showValidationErrors && !form.programId">Program is required.</div>
            </div>

            <!-- Status -->
            <div class="form-outline dropdown-container">
              <label class="floating-label">Status <span class="text-danger">*</span></label>
              <div class="input-with-icon">
                <input class="form-control"
                       name="status"
                       [(ngModel)]="form.statusDisplay"
                       (input)="filterOptions('status')"
                       (focus)="openDropdown('status')"
                       (blur)="onAutoBlur('status')"
                       autocomplete="off"
                       required />
                <span class="dropdown-arrow">&#9662;</span>

                <div class="autocomplete-dropdown" *ngIf="auto.status.open && auto.status.filtered.length">
                  <div class="autocomplete-option"
                       *ngFor="let opt of auto.status.filtered"
                       (mousedown)="selectAuto('status', opt)">
                    {{ opt.label }}
                  </div>
                </div>
              </div>
              <div class="invalid-feedback" *ngIf="showValidationErrors && !form.programStatusId">Status is required.</div>
            </div>

            <!-- Reason -->
            <div class="form-outline dropdown-container">
              <label class="floating-label">Status Reason</label>
              <div class="input-with-icon">
                <input class="form-control"
                       name="reason"
                       [(ngModel)]="form.reasonDisplay"
                       (input)="filterOptions('reason')"
                       (focus)="openDropdown('reason')"
                       (blur)="onAutoBlur('reason')"
                       autocomplete="off" />
                <span class="dropdown-arrow">&#9662;</span>

                <div class="autocomplete-dropdown" *ngIf="auto.reason.open && auto.reason.filtered.length">
                  <div class="autocomplete-option"
                       *ngFor="let opt of auto.reason.filtered"
                       (mousedown)="selectAuto('reason', opt)">
                    {{ opt.label }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Referral Source -->
            <div class="form-outline dropdown-container">
              <label class="floating-label">Referral Source</label>
              <div class="input-with-icon">
                <input class="form-control"
                       name="referral"
                       [(ngModel)]="form.referralDisplay"
                       (input)="filterOptions('referral')"
                       (focus)="openDropdown('referral')"
                       (blur)="onAutoBlur('referral')"
                       autocomplete="off" />
                <span class="dropdown-arrow">&#9662;</span>

                <div class="autocomplete-dropdown" *ngIf="auto.referral.open && auto.referral.filtered.length">
                  <div class="autocomplete-option"
                       *ngFor="let opt of auto.referral.filtered"
                       (mousedown)="selectAuto('referral', opt)">
                    {{ opt.label }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Assigned To -->
            <div class="form-outline dropdown-container">
              <label class="floating-label">Assigned To</label>
              <div class="input-with-icon">
                <input class="form-control"
                       name="assignedTo"
                       [(ngModel)]="form.assignedToDisplay"
                       (input)="filterOptions('assignedTo')"
                       (focus)="openDropdown('assignedTo')"
                       (blur)="onAutoBlur('assignedTo')"
                       autocomplete="off" />
                <span class="dropdown-arrow">&#9662;</span>

                <div class="autocomplete-dropdown" *ngIf="auto.assignedTo.open && auto.assignedTo.filtered.length">
                  <div class="autocomplete-option"
                       *ngFor="let opt of auto.assignedTo.filtered"
                       (mousedown)="selectAuto('assignedTo', opt)">
                    {{ opt.label }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Start Date -->
            <div class="form-outline">
              <label class="floating-label">Start Date <span class="text-danger">*</span></label>
              <input class="form-control"
                     name="startDate"
                     [(ngModel)]="form.startDate"
                     type="date"
                     required />
              <div class="invalid-feedback" *ngIf="showValidationErrors && !form.startDate">Start Date is required.</div>
            </div>

            <!-- End Date -->
            <div class="form-outline">
              <label class="floating-label">End Date</label>
              <input class="form-control"
                     name="endDate"
                     [(ngModel)]="form.endDate"
                     type="date" />
            </div>

            <!-- Active -->
            <div class="form-outline">
              <label class="floating-label">Active</label>
              <select class="form-control" name="activeFlag" [(ngModel)]="form.activeFlag">
                <option [ngValue]="true">Yes</option>
                <option [ngValue]="false">No</option>
              </select>
            </div>
          </div>

          <div class="button-group">
            <button type="submit" [disabled]="saving || !canAdd">{{ form.memberProgramId ? 'Update' : 'Save' }}</button>
            <button type="button" (click)="cancelForm()">Cancel</button>
          </div>
        </form>
      </div>
    </ng-container>

    <ng-template #summaryTpl>
      <div class="ai-summary">
        <h3>üìä Programs Summary</h3>
        <p><strong>Total:</strong> {{ total }}</p>
        <p><strong>Active:</strong> {{ summary.active }}</p>
        <p><strong>Most Recent Start:</strong> {{ summary.recentStart || '‚Äî' }}</p>
        <p><strong>Assigned to Me:</strong> {{ summary.assignedToMe }}</p>
      </div>
    </ng-template>
  </div>
</div>
