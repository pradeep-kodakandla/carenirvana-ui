<div class="activity-container">
  <!-- Left Side - Timeline -->
  <div class="activity-left">
    <!-- Top Search + Action Bar -->
    <div class="left-controls">
      <input type="text" placeholder="üîç Search..." [(ngModel)]="searchTerm" (input)="applySearch()" class="search-input" />

      <div class="right-actions">
        <div class="sort-wrapper" (mouseenter)="showSort = true" (mouseleave)="showSort = false">
          <button class="sort-icon">‚áÖ</button>
          <div class="sort-menu" *ngIf="showSort">
            <div class="sort-option" (click)="applySort('activityType_asc')">Activity Type (A‚ÄìZ)</div>
            <div class="sort-option" (click)="applySort('activityType_desc')">Activity Type (Z‚ÄìA)</div>
            <div class="sort-option" (click)="applySort('priority_asc')">Priority (Low ‚Üí High)</div>
            <div class="sort-option" (click)="applySort('priority_desc')">Priority (High ‚Üí Low)</div>
            <div class="sort-option" (click)="applySort('status_asc')">Status (A‚ÄìZ)</div>
            <div class="sort-option" (click)="applySort('status_desc')">Status (Z‚ÄìA)</div>
          </div>
        </div>
        <button class="add-btn" (click)="onAddNewActivity()" [disabled]="!canAdd">‚ûï Add Activity</button>
      </div>

    </div>

    <div cdkDropList (cdkDropListDropped)="dropActivity($event)" class="timeline-list">
      <div *ngFor="let activity of filteredActivities; let i = index" cdkDrag class="timeline-item" [ngClass]="{'selected': selectedIndex === i}">
        <div class="timeline-dot" [ngClass]="{'completed': activity.statusId === 2}"></div>
        <div class="timeline-content" (click)="selectActivity(i)">
          <div class="timeline-header">
            <div class="timeline-title">
              Activity Type: {{ activity.activityTypeLabel || 'Unknown Activity' }}


              <span *ngIf="activity.statusId === 2">‚úÖ</span>
              <span *ngIf="activity.statusId !== 2">‚è≥</span>
            </div>
            <div class="timeline-priority" [ngClass]="getPriorityClass(activity.priorityId)">
              Priority: {{ activity.priorityLabel || 'No Priority' }}
            </div>
            <!-- Action Icons -->
            <span class="activity-actions">
              <button type="button"
                      class="icon-btn"
                      title="Accept"
                      [disabled]="activity.statusId === 2"
                      (click)="markAsCompleted(i)">
                üëç
              </button>

              <button type="button" class="icon-btn" title="Delete" [disabled]="!canEdit" (click)="deleteActivity(i)">
                üóëÔ∏è
              </button>
            </span>
          </div>
          <div class="timeline-summary">
            Assign To: {{ getProviderName(activity.referredTo) || 'No Assignee' }} | Scheduled: {{ formatDateEST(activity.followUpDateTime) }}
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Right Side - Form or Summary -->
  <div class="activity-right">
    <ng-container *ngIf="isEditing; else aiSummary">
      <div class="auth-form" [attr.data-form-key]="formKey">
        <form [formGroup]="activityForm">
          <div class="form-grid">

            <div class="form-outline dropdown-container">
              <label class="floating-label">Activity Type <span class="text-danger">*</span></label>
              <ui-dropdown formControlName="activityType"
                           [options]="activityTypeOptions"
                           [compareWith]="compareId"
                           placeholder="Select activity type">
              </ui-dropdown>
              <div *ngIf="activityForm.get('activityType')?.touched && activityForm.get('activityType')?.invalid" class="text-danger">
                Activity Type is required.
              </div>
            </div>



            <div class="form-outline dropdown-container">
              <label class="floating-label">Priority <span class="text-danger">*</span></label>
              <ui-dropdown formControlName="priority"
                           [options]="priorityOptions"
                           [compareWith]="compareId"
                           placeholder="Select priority">
              </ui-dropdown>
              <div *ngIf="activityForm.get('priority')?.touched && activityForm.get('priority')?.invalid" class="text-danger">
                Priority is required.
              </div>
            </div>


            <div class="form-outline position-relative">
              <label class="floating-label">Scheduled Date & Time <span class="text-danger">*</span></label>
              <ui-datetime-picker formControlName="followUpDateTime"
                                  placeholderDate="Select date"
                                  placeholderTime="Select time">
              </ui-datetime-picker>
              <div *ngIf="activityForm.get('followUpDateTime')?.touched && activityForm.get('followUpDateTime')?.invalid" class="text-danger">
                Scheduled date is required.
              </div>
            </div>

            <!-- Due Date & Time -->
            <div class="form-outline position-relative">
              <label class="floating-label">Due Date & Time <span class="text-danger">*</span></label>
              <ui-datetime-picker formControlName="dueDate"
                                  placeholderDate="Select date"
                                  placeholderTime="Select time">
              </ui-datetime-picker>
              <div *ngIf="activityForm.get('dueDate')?.touched && activityForm.get('dueDate')?.invalid" class="text-danger">
                Due date is required.
              </div>
            </div>

            <!-- Assign To (single, autocomplete) -->
            <div class="form-outline dropdown-container">
              <label class="floating-label">Assign To <span class="text-danger">*</span></label>
              <ui-dropdown formControlName="assignTo"
                           [options]="assignToOptions"
                           [compareWith]="compareId"
                           placeholder="Select user">
              </ui-dropdown>
              <div *ngIf="activityForm.get('assignTo')?.touched && activityForm.get('assignTo')?.invalid" class="text-danger">
                Assign To is required.
              </div>
            </div>

            <div class="form-outline dropdown-container">
              <label class="floating-label">Work Group</label>
              <ui-multi-check-dropdown formControlName="workGroups"
                                       [options]="workGroupOptions"
                                       [defaultSelect]="true"
                                       [showChips]="false"
                                       placeholder="Select work groups">
              </ui-multi-check-dropdown>
            </div>

            <div class="form-outline dropdown-container">
              <label class="floating-label">Work Basket</label>
              <ui-multi-check-dropdown formControlName="workBasket"
                                       [options]="workBasketOptions"
                                       [defaultSelect]="true"
                                       [showChips]="false"
                                       placeholder="Select work basket">
              </ui-multi-check-dropdown>
            </div>

            <!-- Work Basket (single, autocomplete) -->
            <!--<div class="form-outline dropdown-container">
              <label class="floating-label">Work Basket</label>
              <ui-dropdown formControlName="workBasket"
                           [options]="workBasketOptions"
                           [compareWith]="compareId"
                           placeholder="Select work basket">
              </ui-dropdown>
            </div>-->
            <!-- Work Basket Users (single, autocomplete; enabled based on basket) -->
            <div class="form-outline dropdown-container">
              <label class="floating-label">Work Basket Users</label>
              <ui-multi-check-dropdown formControlName="workBasketUser"
                                       [options]="workBasketUserOptions"
                                       [defaultSelect]="true"
                                       [showChips]="false"
                                       placeholder="Select work basket user">
              </ui-multi-check-dropdown>
            </div>
            <!--<div class="form-outline dropdown-container">
              <label class="floating-label">Work Basket Users</label>
              <ui-dropdown formControlName="workBasketUser"
                           [options]="workBasketUserOptions"
                           [compareWith]="compareId"
                           placeholder="Select user in basket">
              </ui-dropdown>
            </div>-->


            <div class="form-outline full-width" style="grid-column: span 2;">
              <label class="floating-label">Comments <span class="text-danger">*</span></label>
              <textarea class="form-control"
                        formControlName="comments"
                        rows="3"
                        [ngClass]="{'is-invalid': activityForm.get('comments')?.touched && activityForm.get('comments')?.invalid}">
              </textarea>
              <div *ngIf="activityForm.get('comments')?.touched && activityForm.get('comments')?.invalid" class="invalid-feedback">
                Comments are required.
              </div>
            </div>



          </div>

          <div class="button-group">
            <button type="button" (click)="onSubmit()" [disabled]="!canAdd">Save</button>
            <button type="button" (click)="onCancel()">Cancel</button>
          </div>
        </form>
      </div>
    </ng-container>

    <ng-template #aiSummary>
      <div class="ai-summary">
        <h3>üìä Activities Summary</h3>
        <p><strong>Total Activities:</strong> {{ activities.length }}</p>
        <p><strong>Completed:</strong> {{ getCompletedCount() }}</p>
        <p><strong>Pending:</strong> {{ getPendingCount() }}</p>
        <p><strong>High Priority:</strong> {{ getPriorityCount('High') }}</p>
        <p><strong>Medium Priority:</strong> {{ getPriorityCount('Medium') }}</p>
        <p><strong>Low Priority:</strong> {{ getPriorityCount('Low') }}</p>
      </div>
    </ng-template>
  </div>
</div>
