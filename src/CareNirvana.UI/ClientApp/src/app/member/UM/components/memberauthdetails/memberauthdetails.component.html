<mat-menu #menu="matMenu">
  <button mat-menu-item class="row-menu-item row-menu-item--primary">
    <span class="row-menu-icon">
      <mat-icon>add</mat-icon>
    </span>
    <span class="row-menu-label">Add Activity</span>
  </button>

  <button mat-menu-item class="row-menu-item">
    <span class="row-menu-icon">
      <mat-icon>edit_note</mat-icon>
    </span>
    <span class="row-menu-label">Add Notes</span>
  </button>

  <button mat-menu-item class="row-menu-item">
    <span class="row-menu-icon">
      <mat-icon>assignment</mat-icon>
    </span>
    <span class="row-menu-label">Run Assessment</span>
  </button>

  <button mat-menu-item class="row-menu-item">
    <span class="row-menu-icon">
      <mat-icon>description</mat-icon>
    </span>
    <span class="row-menu-label">Add Documents</span>
  </button>

  <button mat-menu-item class="row-menu-item">
    <span class="row-menu-icon">
      <mat-icon>outgoing_mail</mat-icon>
    </span>
    <span class="row-menu-label">Send Letter</span>
  </button>

  <button mat-menu-item class="row-menu-item">
    <span class="row-menu-icon">
      <mat-icon>content_copy</mat-icon>
    </span>
    <span class="row-menu-label">Clone Auth</span>
  </button>

  <button mat-menu-item class="row-menu-item">
    <span class="row-menu-icon">
      <mat-icon>person_remove</mat-icon>
    </span>
    <span class="row-menu-label">Transfer</span>
  </button>

  <button mat-menu-item class="row-menu-item">
    <span class="row-menu-icon">
      <mat-icon>summarize</mat-icon>
    </span>
    <span class="row-menu-label">Auth Summary </span>
  </button>
</mat-menu>

<!-- Search + Add + Toggles -->
<div class="d-flex justify-content-between align-items-center w-100 pb-2"
     style="padding-right:12px;padding-left:5px; padding-top:5px;">

  <div class="search-section">
    <input type="text" placeholder="ðŸ” Search..." (input)="applyFilter($event)" class="search-input" #input />
  </div>

  <div class="d-flex align-items-center ms-3">
    <button matTooltip="Click to add a new authorization"
            class="btn btn-primary ms-2"
            (click)="onAddAuthClick()" [disabled]="!hasPagePermission('add')">
      Add Auth
    </button>

    <button mat-icon-button (click)="toggleViewMode()" matTooltip="Toggle View">
      <mat-icon>{{ viewMode === 'card' ? 'table_chart' : 'view_module' }}</mat-icon>
    </button>

    <button mat-icon-button (click)="toggleCompactMode()" matTooltip="Toggle Compact Mode">
      <mat-icon>{{ compactMode ? 'zoom_out' : 'zoom_in' }}</mat-icon>
    </button>
  </div>
</div>

<!-- CARD VIEW -->
<div *ngIf="viewMode === 'card'" class="d-flex flex-column" style="margin: 0 10px;">
  <div class="row g-3">
    <div class="col-lg-4 col-md-6" *ngFor="let row of pagedCardData">
      <mat-card [ngClass]="{ 'case-card': true, 'compact': compactMode }">

        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <span *ngIf="row.requestPriority === 'Expedited'" class="priority-cell" matTooltip="Expedited">
              <svg class="expedited-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="red" class="bi bi-exclamation-circle-fill" viewBox="0 0 16 16">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4m.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2" />
              </svg>
              <!--<mat-icon class="expedited-icon" aria-hidden="true">error</mat-icon>-->
            </span>
            <a class="case-link" (click)="onAuthClick(row.authNumber)" matTooltip="Click to access auth details">

              {{ row.authNumber }}
            </a>
          </div>
          <div class="d-flex align-items-center">
            <span class="case-chip me-2 type" matTooltip="Auth Type">
              {{ row.authTemplateName || row.authTypeId || 'â€”' }}
            </span>
            <span class="case-chip me-2 status" matTooltip="Auth Status">
              {{ row.authStatusText || row.authStatus || 'â€”' }}
            </span>
            <button mat-icon-button [matMenuTriggerFor]="menu">
              <mat-icon>more_vert</mat-icon>
            </button>
          </div>
        </div>

        <div class="d-flex flex-column gap-1">
          <div class="text-sm">
            <mat-icon class="me-1" fontIcon="schedule" inline></mat-icon>
            <strong>Due Date: </strong>&nbsp;
            {{ row.authDueDate ? (row.authDueDate | date) : 'â€”' }}
          </div>

          <div class="text-sm">
            <mat-icon class="me-1" fontIcon="event" inline></mat-icon>
            <strong>Next Review: </strong>&nbsp;
            {{ row.nextReviewDate ? (row.nextReviewDate | date) : 'â€”' }}
          </div>

          <div class="text-sm">
            <mat-icon class="me-1" fontIcon="healing" inline></mat-icon>
            <strong>Treatment: </strong>&nbsp;
            {{ row.treatementType || 'â€”' }}
          </div>

          <div class="text-sm">
            <mat-icon class="me-1" fontIcon="account_circle" inline></mat-icon>
            <strong>Created: </strong>&nbsp;
            {{ row.createdByUserName || 'â€”' }}
            <span class="muted">â€¢ {{ row.createdOn ? (row.createdOn | date) : '' }}</span>
          </div>
        </div>

      </mat-card>
    </div>
  </div>
</div>

<!-- TABLE VIEW -->
<div *ngIf="viewMode === 'table'" class="d-flex flex-column"
     style="margin-left:10px; margin-right:10px; width: 100%;">
  <table class="responsive-table" mat-table [dataSource]="dataSource" multiTemplateDataRows matSort>

    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let row">
        <button mat-icon-button [matMenuTriggerFor]="menu">
          <mat-icon>list</mat-icon>
        </button>
      </td>
    </ng-container>

    <ng-container matColumnDef="authNumber">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Auth # </th>
      <td mat-cell *matCellDef="let row">
        <a mat-button (click)="onAuthClick(row.authNumber)">{{ row.authNumber }}</a>
      </td>
    </ng-container>

    <ng-container matColumnDef="authTypeText">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Type </th>
      <td mat-cell *matCellDef="let row"> {{ row.authTypeText || row.authTypeId || '' }} </td>
    </ng-container>

    <ng-container matColumnDef="authStatusText">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Status </th>
      <td mat-cell *matCellDef="let row"> {{ row.authStatusText || row.authStatus || '' }} </td>
    </ng-container>

    <ng-container matColumnDef="authDueDate">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Due Date </th>
      <td mat-cell *matCellDef="let row">
        {{ row.authDueDate ? (row.authDueDate | date:'MM/dd/yyyy') : '' }}
      </td>
    </ng-container>

    <ng-container matColumnDef="nextReviewDate">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Next Review </th>
      <td mat-cell *matCellDef="let row">
        {{ row.nextReviewDate ? (row.nextReviewDate | date:'MM/dd/yyyy') : '' }}
      </td>
    </ng-container>

    <ng-container matColumnDef="treatmentType">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Treatment </th>
      <td mat-cell *matCellDef="let row"> {{ row.treatmentType || '' }} </td>
    </ng-container>

    <ng-container matColumnDef="createdOn">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Created On </th>
      <td mat-cell *matCellDef="let row">
        {{ row.createdOn ? (row.createdOn | date:'MM/dd/yyyy HH:mm') : '' }}
      </td>
    </ng-container>

    <ng-container matColumnDef="createdByUserName">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Created By </th>
      <td mat-cell *matCellDef="let row"> {{ row.createdByUserName || '' }} </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
  </table>
</div>

<!-- No Data -->
<div *ngIf="isEmpty && !isLoading" class="text-center w-100 mt-3 no-data">
  <p class="text-muted">No data available</p>
</div>

<!-- Pagination -->
<mat-paginator #paginator
               [pageSizeOptions]="[5, 10, 15, 20]"
               showFirstLastButtons
               [length]="viewMode === 'card' ? dataSource.filteredData.length : dataSource.data.length"
               [pageSize]="pageSize"
               [pageIndex]="pageIndex"
               (page)="onPageChange($event)">
</mat-paginator>
