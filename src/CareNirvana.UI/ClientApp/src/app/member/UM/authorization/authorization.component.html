
<div class="container" style="padding: 0px !important; font-family: 'Open Sans', sans-serif !important; font-size: 14px !important; position: relative;" *ngIf="!showAuthorizationComponent">
  <!-- Close Button -->
  <div class="close-container d-flex justify-content-between align-items-center">
    <div class="card p-2 shadow-sm rounded flex-grow-1">
      <div class="info-container">
        <div *ngFor="let info of additionalInfo" class="info-item">
          <span class="info-label">{{ info.label }}:</span>
          <span class="info-value">{{ info.value }} | </span>
        </div>
      </div>
    </div>
    <div class="d-flex align-items-center">
      <span>
        <mat-icon>menu</mat-icon>
      </span>
      <span class="close-btn ms-2" (click)="onCancelClick()">
        <mat-icon>close</mat-icon>
      </span>
    </div>
  </div>


  <div class="content-section">
    <ng-template #enrollmentTooltip>
      <div class="tooltip-container">
        <div class="tooltip-row">
          <label class="tooltip-label">LOB:</label>
          <span class="tooltip-value">Medicare</span>
        </div>
        <div class="tooltip-row">
          <label class="tooltip-label">Account:</label>
          <span class="tooltip-value">Microsoft</span>
        </div>
        <div class="tooltip-row">
          <label class="tooltip-label">Start Date:</label>
          <span class="tooltip-value">01/01/2024</span>
        </div>
        <div class="tooltip-row">
          <label class="tooltip-label">End Date:</label>
          <span class="tooltip-value">12/31/2024</span>
        </div>
      </div>
    </ng-template>
    <!-- Horizontal Stepper -->
    <mat-horizontal-stepper style="padding: 5px;  background-color:transparent;" [selectedIndex]="stepperSelectedIndex" (selectionChange)="onStepperChanged($event)" #stepper>
      <mat-step label="Smart Auth Check">
        <app-smartauthcheck>
        </app-smartauthcheck>
      </mat-step>

      <mat-step label="Request Details">
        <div class="content" style="padding-top: 5px;">
          <div class="main-form" style="padding: 0;">
            <!-- Wrap dynamic form in an NgForm -->
            <form #authForm="ngForm">
              <!-- Enrollment Details Card -->
              <mat-card style="width: 100%;">
                <div class="card-header" (click)="isExpanded = !isExpanded" style="display: flex; align-items: center; justify-content: space-between;">
                  <div style="display: flex; align-items: center;">
                    <mat-icon>{{ isExpanded ? 'expand_less' : 'expand_more' }}</mat-icon>
                    <h6 style="color: #007BFF; font-weight: bold; margin: 0; padding-right: 30px;">Enrollment Details</h6>
                    <div style="display: flex; align-items: center; gap: 10px;" (click)="$event.stopPropagation();">
                      <mat-button-toggle-group class="status-group" appearance="legacy" value="active">
                        <mat-button-toggle value="active">Active</mat-button-toggle>
                        <mat-button-toggle value="inactive">Inactive</mat-button-toggle>
                      </mat-button-toggle-group>
                    </div>
                  </div>
                </div>
                <div class="selection-container" *ngIf="isExpanded">
                  <!-- Rounded selection boxes -->
                  <div class="rounded-box tooltip-wrapper" (click)="selectDiv(1)" [ngClass]="{ 'selected': selectedDiv === 1 }">
                    <!--<div class="tooltip-panel">
                      <div class="tooltip-row"><label class="tooltip-label">LOB:</label><span>Medicare</span></div>
                      <div class="tooltip-row"><label class="tooltip-label">Account:</label><span>Microsoft</span></div>
                      <div class="tooltip-row"><label class="tooltip-label">Start Date:</label><span>01/01/2024</span></div>
                      <div class="tooltip-row"><label class="tooltip-label">End Date:</label><span>12/31/2024</span></div>
                    </div>-->

                    <div class="d-flex justify-content-between div-secondary">
                      <div>
                        <label class="label">LOB</label>
                        <label class="label">Account</label>
                        <label class="label">Start Date</label>
                        <label class="label">End Date</label>
                      </div>
                      <div>
                        <label class="label">Medicare</label>
                        <label class="label">Microsoft</label>
                        <label class="label">01/01/2024</label>
                        <label class="label">12/31/2024</label>
                      </div>
                    </div>
                    <!--<div class="selectedBox"></div>-->
                  </div>
                  <div class="rounded-box tooltip-wrapper" (click)="selectDiv(2)" [ngClass]="{ 'selected': selectedDiv === 2 }">
                    <div class="d-flex justify-content-between div-secondary">
                      <div>
                        <label class="label">LOB</label>
                        <label class="label">Account</label>
                        <label class="label">Start Date</label>
                        <label class="label">End Date</label>
                      </div>
                      <div>
                        <label class="label">Medicare</label>
                        <label class="label">Microsoft</label>
                        <label class="label">01/01/2024</label>
                        <label class="label">12/31/2024</label>
                      </div>
                    </div>
                  </div>
                  <div class="rounded-box tooltip-wrapper" (click)="selectDiv(3)" [ngClass]="{ 'selected': selectedDiv === 3 }">
                    <div class="d-flex justify-content-between div-secondary">
                      <div>
                        <label class="label">LOB</label>
                        <label class="label">Account</label>
                        <label class="label">Start Date</label>
                        <label class="label">End Date</label>
                      </div>
                      <div>
                        <label class="label">Medicare</label>
                        <label class="label">Microsoft</label>
                        <label class="label">01/01/2024</label>
                        <label class="label">12/31/2024</label>
                      </div>
                    </div>
                  </div>
                </div>
              </mat-card>

              <!-- Dynamic Sections: rendered when enrollmentSelect is true -->
              <div *ngIf="enrollmentSelect">
                <!--<mat-card *ngFor="let section of sectionOrder">-->
                <ng-container *ngFor="let section of sectionOrder">
                  <ng-container *ngIf="shouldDisplaySection(section)">
                    <mat-card [id]="'section-' + section"
                              [ngClass]="{ 'section-error': serviceOverlapMessages.length > 0 && section === 'Service Details' }">
                      <div class="card-header" (click)="toggleSection(section)" style="display: flex; align-items: center;">
                        <mat-icon>{{ formData[section]?.expanded ? 'expand_less' : 'expand_more' }}</mat-icon>
                        <h6 style="color: #007BFF; font-weight: bold; margin: 0; padding-right: 50px;">{{ section | titlecase }}</h6>
                        <!-- Show Auth Type dropdown only for Auth Details -->

                        <div style="width:350px; padding-left:10px;" class="position-relative" *ngIf="section === 'Auth Details'">
                          <label for="authClass" class="form-label" style="position: absolute; top: -8px; left: 18px; background: white; padding: 0 4px; font-size: 12px; color: #3f51b5;">
                            Auth Case
                          </label>
                          <select class="form-select" id="authClass" name="authClass"
                                  [(ngModel)]="selectedAuthClassId"
                                  (change)="onAuthClassChange();$event.stopPropagation();">
                            <option *ngFor="let item of authClass" [value]="item.id">
                              {{ item.authClass  }}
                            </option>
                          </select>
                        </div>


                        <div style="width:350px; padding-left:10px;" class="position-relative" *ngIf="section === 'Auth Details'">
                          <label for="authType" class="form-label" style="position: absolute; top: -8px; left: 18px; background: white; padding: 0 4px; font-size: 12px; color: #3f51b5;">
                            Auth Type
                          </label>
                          <select class="form-select" id="authType" name="authType"
                                  [(ngModel)]="selectedTemplateId"
                                  [disabled]="!selectedAuthClassId || selectedAuthClassId === 0"
                                  (change)="onAuthTypeChange(); $event.stopPropagation();">
                            <option *ngFor="let template of authTemplates" [value]="template.Id">
                              {{ template.TemplateName }}
                            </option>
                          </select>
                        </div>
                        <div class="position-relative" *ngIf="section === 'Provider Details'">
                          <div class="row" style="width:auto !important;">
                            <div class="col-12">
                              <div class="provider-buttons-container d-flex flex-wrap align-items-center mb-2" style="gap: 10px;">
                                <ng-container *ngFor="let field of getFieldsByType(config[section].fields, 'button')">
                                  <button mat-raised-button
                                          class="provider-button"
                                          (click)="openButtonDialog(field, section, selectedProviderRowIndex); $event.stopPropagation()">
                                    {{ field.buttonText }}
                                  </button>
                                </ng-container>
                              </div>
                            </div>
                          </div>

                        </div>
                      </div>

                      <!-- Accordion Content -->
                      <div class="accordion-content" *ngIf="formData[section]?.expanded && selectedTemplateId !== 0">
                        <!-- Load specific components for Notes and Documents -->
                        <ng-container *ngIf="shouldDisplaySection(section)">
                          <ng-container *ngIf="section === 'Authorization Notes'">

                            <app-umauthnotes [notesFields]="authorizationNotesFields"
                                             [notesData]="authorizationNotesData"
                                             (NotesSaved)="handleAuthNotesSaved($event)">></app-umauthnotes>
                          </ng-container>
                        </ng-container>
                        <ng-container *ngIf="shouldDisplaySection(section)">
                          <ng-container *ngIf="section === 'Authorization Documents'">

                            <app-umauthdocuments [documentFields]="authorizationDocumentFields"
                                                 [documentData]="authorizationDocumentData"
                                                 (DocumentSaved)="handleAuthDocumentSaved($event)"></app-umauthdocuments>
                          </ng-container>
                        </ng-container>

                        <!-- Additional Details Section rendering remains unchanged -->
                        <ng-container *ngIf="shouldDisplaySection(section)">
                          <div *ngIf="section === 'Additional Details'">
                            <div *ngFor="let subSection of getAdditionalDetailsKeys(); let subIndex = index">
                              <!-- Subsection Divider -->
                              <hr *ngIf="subIndex !== 0" class="entry-divider my-3" />
                              <div *ngFor="let entry of formData['Additional Details']?.[subSection]?.entries; let i = index" class="row align-items-center mb-3">
                                <!-- Show divider before each entry except the first -->
                                <hr *ngIf="i !== 0" class="entry-divider my-3" />
                                <div class="col-5-layout mb-3" *ngFor="let field of config['Additional Details'].subsections[subSection].fields">
                                  <div class="form-outline">
                                    <label [for]="field.id + '_' + i" class="form-label">
                                      {{ field.displayName }}<span *ngIf="field.required" class="text-danger"> * </span>
                                    </label>
                                    <div class="form-group">
                                      <ng-container [ngSwitch]="field.type">
                                        <ng-container *ngSwitchDefault>
                                          <input class="form-control"
                                                 [type]="field.type"
                                                 [id]="field.id + '_' + i"
                                                 name="{{ field.id + '_' + i }}"
                                                 [(ngModel)]="entry[field.id]"
                                                 placeholder="{{ field.displayName }}"
                                                 [required]="field.required"
                                                 #fieldModel="ngModel" />
                                          <div *ngIf="field.required && fieldModel.invalid && (fieldModel.dirty || fieldModel.touched)" class="text-danger">
                                            {{ field.requiredMsg ? field.requiredMsg : (field.displayName + " is required.") }}
                                          </div>
                                        </ng-container>
                                        <ng-container *ngSwitchCase="'datetime-local'">
                                          <div class="form-outline position-relative">
                                            <!-- Floating label -->
                                            <label [for]="field.id + '_' + i"
                                                   class="floating-label"
                                                   [class.label-error]="field.required && fieldModel.invalid && (fieldModel.dirty || fieldModel.touched)">
                                              {{ field.displayName }}
                                              <span *ngIf="field.required" class="text-danger"> *</span>
                                            </label>
                                            <div class="d-flex align-items-center position-relative">
                                              <!-- Text input for D, D+N, manual date -->
                                              <input class="form-control pe-5"
                                                     type="text"
                                                     [id]="field.id + '_' + i"
                                                     name="{{ field.id + '_' + i }}"
                                                     [(ngModel)]="entry[field.id]"
                                                     [value]="field.dateOnly ? entry[field.id] : formatForInput(entry[field.id])"
                                                     (blur)="handleDateTimeBlur(entry, field.id, field)"
                                                     (keydown.enter)="$event.preventDefault()"
                                                     placeholder="Enter date or D+N (e.g., D+2)"
                                                     [required]="field.required"
                                                     #fieldModel="ngModel" />

                                              <!-- Icon button inside input field -->
                                              <button type="button"
                                                      class="btn btn-light position-absolute"
                                                      style="right: 10px; padding: 0;"
                                                      (click)="triggerPicker(field.id + '_' + i)">
                                                📅
                                              </button>
                                            </div>
                                            <!-- Hidden datetime-local picker -->
                                            <input type="datetime-local"
                                                   [id]="'native_' + field.id + '_' + i"
                                                   [value]="field.dateOnly ? entry[field.id] : formatForInput(entry[field.id])"
                                                   (change)="handleNativePicker($event, entry, field.id, field)"
                                                   style="position: absolute; visibility: hidden; height: 0; width: 0; pointer-events: none;" />

                                            <!-- Validation -->
                                            <div *ngIf="field.required && fieldModel.invalid && (fieldModel.dirty || fieldModel.touched)" class="text-danger mt-1">
                                              {{ field.requiredMsg ? field.requiredMsg : (field.displayName + " is required.") }}
                                            </div>
                                          </div>

                                        </ng-container>


                                        <ng-container *ngSwitchCase="'select'">
                                          <div class="form-outline">
                                            <!-- Floating Label -->
                                            <label [for]="field.id + '_' + i" class="form-label">
                                              {{ field.displayName }}
                                              <span *ngIf="field.required" class="text-danger"> *</span>
                                            </label>

                                            <!-- Input with Autocomplete Behavior -->
                                            <input type="text"
                                                   class="form-control"
                                                   [id]="field.id + '_' + i"
                                                   name="{{ field.id + '_' + i }}"
                                                   [required]="field.required"
                                                   [attr.autocomplete]="'off'"
                                                   [value]="displayLabels[field.id + '_' + i + '_' + section] || getOptionLabel(field, entry[field.id]) || ''"
                                                   (input)="onInputChange($event, field, section, i)"
                                                   (focus)="onFocus(field, section, i)"
                                                   (blur)="onBlur(field, section, i)"
                                                   (keydown)="handleKeydown($event, field, section, i, entry)" />


                                            <!-- Hidden ngModel binding -->
                                            <input type="hidden"
                                                   name="{{ field.id + '_' + i }}"
                                                   [(ngModel)]="entry[field.id]"
                                                   #fieldModel="ngModel" />

                                            <!-- Autocomplete Dropdown -->
                                            <div class="autocomplete-dropdown shadow-sm"
                                                 *ngIf="showDropdown[section + '_' + i + '_' + field.id] && filteredOptions[section + '_' + i + '_' + field.id]?.length">
                                              <div class="autocomplete-option"
                                                   *ngFor="let option of filteredOptions[section + '_' + i + '_' + field.id]; let optIndex = index"
                                                   [class.active]="hoveredIndexMap[section + '_' + i + '_' + field.id] === optIndex"
                                                   (mousedown)="selectOption(option.label, entry, field.id, section, i)">
                                                {{ option.label }}
                                              </div>
                                            </div>

                                            <!-- Dropdown icon -->
                                            <mat-icon class="custom-dropdown-arrow">arrow_drop_down</mat-icon>

                                            <!-- Validation -->
                                            <div *ngIf="field.required && fieldModel.invalid && (fieldModel.dirty || fieldModel.touched)"
                                                 class="text-danger mt-1">
                                              {{ field.requiredMsg ? field.requiredMsg : (field.displayName + ' is required.') }}
                                            </div>
                                          </div>

                                        </ng-container>

                                        <ng-container *ngSwitchCase="'textarea'">
                                          <textarea class="form-control"
                                                    [id]="field.id + '_' + i"
                                                    name="{{ field.id + '_' + i }}"
                                                    [(ngModel)]="entry[field.id]"
                                                    rows="3"
                                                    placeholder="{{ field.displayName }}"
                                                    [required]="field.required"
                                                    #fieldModel="ngModel"></textarea>
                                          <div *ngIf="field.required && fieldModel.invalid && (fieldModel.dirty || fieldModel.touched)" class="text-danger">
                                            {{ field.requiredMsg ? field.requiredMsg : (field.displayName + " is required.") }}
                                          </div>
                                        </ng-container>
                                      </ng-container>
                                    </div>
                                  </div>
                                </div>
                                <!-- Add & Remove Buttons for Additional Details -->
                                <div class="col-5-layout mb-3" *ngIf="subSection !== 'Additional Info'">
                                  <button mat-icon-button color="primary"
                                          *ngIf="i === formData['Additional Details']?.[subSection]?.entries?.length - 1"
                                          (click)="addEntry('Additional Details.' + subSection, i)">
                                    <mat-icon>add_circle</mat-icon>
                                  </button>
                                  <button mat-icon-button color="warn"
                                          *ngIf="formData['Additional Details']?.[subSection]?.entries?.length > 1"
                                          (click)="removeEntry('Additional Details.' + subSection, i)">
                                    <mat-icon>remove_circle</mat-icon>
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        </ng-container>
                        <!-- Other Sections (Auth, Provider, Diagnosis, Services) -->
                        <div *ngIf="section !== 'Additional Details' && section !== 'Authorization Notes' && section !== 'Authorization Documents'">
                          <!-- Special rendering for providerDetails -->
                          <ng-container *ngIf="isProviderSection(section); else normalSection">
                            <!-- Render remaining non-button fields -->
                            <div *ngIf="section !== 'Authorization Notes' && section !== 'Authorization Documents'">
                              <div *ngFor="let entry of formData[section].entries; let i = index" class="row align-items-center mb-3" (click)="selectedProviderRowIndex = i" [ngClass]="{'selected-row': i === selectedProviderRowIndex}">
                                <!-- Show divider before each entry except the first -->
                                <hr *ngIf="i !== 0" class="entry-divider my-3" />
                                <div class="col-5-layout mb-3" *ngFor="let field of getNonButtonFields(config[section].fields); let j = index">
                                  <div class="form-outline" *ngIf="providerFieldsVisible">
                                    <label [for]="field.id + '_' + i" class="form-label">
                                      {{ field.displayName }}<span *ngIf="field.required" class="text-danger"> * </span>
                                    </label>

                                    <div class="form-group">
                                      <ng-container [ngSwitch]="field.type">
                                        <ng-container *ngSwitchDefault>
                                          <div class="form-outline position-relative" *ngIf="providerFieldsVisible">
                                            <input class="form-control"
                                                   [type]="field.type"
                                                   [id]="field.id + '_' + i"
                                                   name="{{ field.id + '_' + i }}"
                                                   [(ngModel)]="entry[field.id]"
                                                   placeholder="{{ field.displayName }}"
                                                   [required]="field.required"
                                                   #fieldModel="ngModel"
                                                   [attr.autocomplete]="'off'"
                                                   [value]="displayLabels[field.id + '_' + i + '_' + section] || getOptionLabel(field, entry[field.id]) || ''"
                                                   (input)="filterOptions(field, entry[field.id], section, i)"
                                                   (focus)="onFocus(field, section, i)"
                                                   (blur)="onBlur(field, section, i)"
                                                   (keydown)="handleKeydown($event, field, section, i, entry)" />

                                            <!-- ✅ Move label *after* input for best floating effect -->
                                            <label class="form-label" [for]="field.id + '_' + i">
                                              {{ field.displayName }}
                                              <span *ngIf="field.required" class="text-danger"> *</span>
                                            </label>
                                          </div>
                                        </ng-container>

                                        <ng-container *ngSwitchCase="'datetime-local'">
                                          <div class="form-outline position-relative">
                                            <!-- Floating label -->
                                            <label [for]="field.id + '_' + i"
                                                   class="floating-label"
                                                   [class.label-error]="field.required && fieldModel.invalid && (fieldModel.dirty || fieldModel.touched)">
                                              {{ field.displayName }}
                                              <span *ngIf="field.required" class="text-danger"> *</span>
                                            </label>
                                            <div class="d-flex align-items-center position-relative">
                                              <!-- Text input for D, D+N, manual date -->
                                              <input class="form-control pe-5"
                                                     type="text"
                                                     [id]="field.id + '_' + i"
                                                     name="{{ field.id + '_' + i }}"
                                                     [(ngModel)]="entry[field.id]"
                                                     [value]="field.dateOnly ? entry[field.id] : formatForInput(entry[field.id])"
                                                     (blur)="handleDateTimeBlur(entry, field.id, field)"
                                                     (keydown.enter)="$event.preventDefault()"
                                                     placeholder="Enter date or D+N (e.g., D+2)"
                                                     [required]="field.required"
                                                     #fieldModel="ngModel" />

                                              <!-- Icon button inside input field -->
                                              <!-- Icon button inside input field -->
                                              <button type="button"
                                                      class="btn btn-light position-absolute"
                                                      style="right: 10px; padding: 0;"
                                                      (click)="triggerPicker(field.id + '_' + i)">
                                                📅
                                              </button>
                                            </div>

                                            <!-- Hidden datetime-local picker -->
                                            <input type="datetime-local"
                                                   [id]="'native_' + field.id + '_' + i"
                                                   [value]="field.dateOnly ? entry[field.id] : formatForInput(entry[field.id])"
                                                   (change)="handleNativePicker($event, entry, field.id, field)"
                                                   style="position: absolute; visibility: hidden; height: 0; width: 0; pointer-events: none;" />

                                            <!-- Validation -->
                                            <div *ngIf="field.required && fieldModel.invalid && (fieldModel.dirty || fieldModel.touched)" class="text-danger mt-1">
                                              {{ field.requiredMsg ? field.requiredMsg : (field.displayName + " is required.") }}
                                            </div>
                                          </div>

                                        </ng-container>
                                        <ng-container *ngSwitchCase="'select'">
                                          <div class="form-outline">
                                            <!-- Floating Label -->
                                            <label [for]="field.id + '_' + i" class="form-label">
                                              {{ field.displayName }}
                                              <span *ngIf="field.required" class="text-danger"> *</span>
                                            </label>

                                            <!-- Input with Autocomplete Behavior -->
                                            <input type="text"
                                                   class="form-control"
                                                   [id]="field.id + '_' + i"
                                                   name="{{ field.id + '_' + i }}"
                                                   [(ngModel)]="displayLabels[field.id + '_' + i + '_' + section]"
                                                   placeholder="{{ field.displayName }}"
                                                   [required]="field.required"
                                                   [attr.autocomplete]="'off'"
                                                   (input)="onInputChange($event, field, section, i)"
                                                   (focus)="onFocus(field, section, i)"
                                                   (blur)="onBlur(field, section, i)"
                                                   (keydown)="handleKeydown($event, field, section, i, entry)" />



                                            <!-- Hidden ngModel binding -->
                                            <input type="hidden"
                                                   name="{{ field.id + '_' + i }}"
                                                   [(ngModel)]="entry[field.id]"
                                                   #fieldModel="ngModel" />

                                            <!-- Autocomplete Dropdown -->
                                            <div class="autocomplete-dropdown shadow-sm"
                                                 *ngIf="showDropdown[section + '_' + i + '_' + field.id] && filteredOptions[section + '_' + i + '_' + field.id]?.length">
                                              <div class="autocomplete-option"
                                                   *ngFor="let option of filteredOptions[section + '_' + i + '_' + field.id]; let optIndex = index"
                                                   [class.active]="hoveredIndexMap[section + '_' + i + '_' + field.id] === optIndex"
                                                   (mousedown)="selectOption(option.label, entry, field.id, section, i)">
                                                {{ option.label }}
                                              </div>
                                            </div>

                                            <!-- Dropdown icon -->
                                            <mat-icon class="custom-dropdown-arrow">arrow_drop_down</mat-icon>

                                            <!-- Validation -->
                                            <div *ngIf="field.required && fieldModel.invalid && (fieldModel.dirty || fieldModel.touched)"
                                                 class="text-danger mt-1">
                                              {{ field.requiredMsg ? field.requiredMsg : (field.displayName + ' is required.') }}
                                            </div>
                                          </div>

                                        </ng-container>
                                        <ng-container *ngSwitchCase="'textarea'">
                                          <textarea class="form-control"
                                                    [id]="field.id + '_' + i"
                                                    name="{{ field.id + '_' + i }}"
                                                    [(ngModel)]="entry[field.id]"
                                                    rows="3"
                                                    placeholder="{{ field.displayName }}"
                                                    [required]="field.required"
                                                    #fieldModel="ngModel"></textarea>
                                          <div *ngIf="field.required && fieldModel.invalid && (fieldModel.dirty || fieldModel.touched)" class="text-danger">
                                            {{ field.requiredMsg ? field.requiredMsg : (field.displayName + " is required.") }}
                                          </div>
                                        </ng-container>
                                        <ng-container *ngSwitchCase="'checkbox'">
                                          <div class="form-outline">
                                            <label [for]="field.id + '_' + i" class="form-label">
                                              {{ field.displayName }}<span *ngIf="field.required" class="text-danger"> * </span>
                                            </label>
                                            <div class="form-group d-flex align-items-center">
                                              <input type="checkbox" class="form-check-input"
                                                     [id]="field.id + '_' + i"
                                                     name="{{ field.id + '_' + i }}" [(ngModel)]="entry[field.id]" />
                                            </div>
                                          </div>
                                        </ng-container>
                                      </ng-container>
                                    </div>
                                  </div>

                                </div>
                                <div *ngIf="!providerFieldsVisible">
                                  <span>"Please search for the provider. You can select a provider from above search options".</span>
                                </div>
                                <!-- Primary Radio Button for Diagnosis Section -->
                                <div class="col-5-layout mb-3" *ngIf="isDiagnosisSection(section)">
                                  <label class="form-label">Primary</label>
                                  <input type="radio" name="primary_{{section}}"
                                         [value]="i" [(ngModel)]="formData[section].primaryIndex"
                                         (change)="setPrimary(section, i)">
                                </div>
                                <!-- Add & Remove Buttons for Diagnosis, Provider, Services -->
                                <div class="col-5-layout mb-3" *ngIf="isSpecialSection(section)">
                                  <button mat-icon-button color="warn"
                                          *ngIf="formData[section].entries.length > 1"
                                          (click)="removeEntry(section, i)">
                                    <mat-icon>remove_circle</mat-icon>
                                  </button>
                                  <button mat-icon-button color="primary"
                                          *ngIf="i === formData[section].entries.length - 1"
                                          (click)="addEntry(section, i)">
                                    <mat-icon>add_circle</mat-icon>
                                  </button>
                                </div>
                              </div>
                            </div>
                          </ng-container>
                          <ng-template #normalSection>
                            <!-- Normal rendering for sections other than providerDetails -->
                            <div *ngIf="section !== 'Authorization Notes' && section !== 'Authorization Documents'">

                              <div *ngFor="let entry of formData[section].entries; let i = index" class="row align-items-center mb-3">
                                <!-- Show divider before each entry except the first -->
                                <hr *ngIf="i !== 0" class="entry-divider my-3" />
                                <div class="col-5-layout mb-3" *ngFor="let field of config[section].fields; let j = index">
                                  <div class="form-outline">
                                    <label [for]="field.id + '_' + i" class="form-label">
                                      {{ field.displayName }}<span *ngIf="field.required" class="text-danger"> * </span>
                                    </label>
                                    <div class="form-group">
                                      <ng-container *ngIf="!field.layout">
                                        <ng-container [ngSwitch]="field.type">
                                          <ng-container *ngSwitchDefault>
                                            <input class="form-control"
                                                   [type]="field.type"
                                                   [id]="field.id + '_' + i"
                                                   name="{{ field.id + '_' + i }}"
                                                   [(ngModel)]="entry[field.id]"
                                                   placeholder="{{ field.displayName }}"
                                                   [required]="field.required"
                                                   #fieldModel="ngModel" />
                                            <div *ngIf="field.required && fieldModel.invalid && (fieldModel.dirty || fieldModel.touched)" class="text-danger">
                                              {{ field.requiredMsg ? field.requiredMsg : (field.displayName + " is required.") }}
                                            </div>
                                          </ng-container>

                                          <ng-container *ngSwitchCase="'datetime-local'">
                                            <div class="form-outline position-relative">
                                              <!-- Floating label -->
                                              <label [for]="field.id + '_' + i"
                                                     class="floating-label"
                                                     [class.label-error]="field.required && fieldModel.invalid && (fieldModel.dirty || fieldModel.touched)">
                                                {{ field.displayName }}
                                                <span *ngIf="field.required" class="text-danger"> *</span>
                                              </label>
                                              <div class="d-flex align-items-center position-relative">
                                                <!-- Text input for D, D+N, manual date -->
                                                <input class="form-control pe-5"
                                                       type="text"
                                                       [id]="field.id + '_' + i"
                                                       name="{{ field.id + '_' + i }}"
                                                       (input)="onServiceDetailChange()"
                                                       [(ngModel)]="entry[field.id]"
                                                       (blur)="handleDateTimeBlur(entry, field.id, field)"
                                                       (keydown.enter)="$event.preventDefault()"
                                                       placeholder="Enter date or D+N (e.g., D+2)"
                                                       [required]="field.required"
                                                       #fieldModel="ngModel" />
                                                <!-- Icon button inside input field -->
                                                <button type="button"
                                                        class="btn btn-light position-absolute"
                                                        style="right: 10px; padding: 0;"
                                                        (click)="triggerPicker(field.id + '_' + i)">
                                                  📅
                                                </button>
                                              </div>
                                              <!--[value]="field.dateOnly ? entry[field.id] : formatForInput(entry[field.id])"-->
                                              <!-- Hidden datetime-local picker -->
                                              <input type="datetime-local"
                                                     [id]="'native_' + field.id + '_' + i"
                                                     [value]="field.dateOnly ? entry[field.id] : formatForInput(entry[field.id])"
                                                     (change)="handleNativePicker($event, entry, field.id, field)"
                                                     style="position: absolute; visibility: hidden; height: 0; width: 0; pointer-events: none;" />

                                              <!-- Validation -->
                                              <div *ngIf="field.required && fieldModel.invalid && (fieldModel.dirty || fieldModel.touched)" class="text-danger mt-1">
                                                {{ field.requiredMsg ? field.requiredMsg : (field.displayName + " is required.") }}
                                              </div>
                                            </div>

                                          </ng-container>

                                          <ng-container *ngSwitchCase="'select'">
                                            <div class="form-outline">
                                              <!-- Floating Label -->
                                              <label [for]="field.id + '_' + i" class="form-label">
                                                {{ field.displayName }}
                                                <span *ngIf="field.required" class="text-danger"> *</span>
                                              </label>

                                              <!-- Input with Autocomplete Behavior -->
                                              <input type="text"
                                                     class="form-control"
                                                     [id]="field.id + '_' + i"
                                                     name="{{ field.id + '_' + i }}"
                                                     [required]="field.required"
                                                     [disabled]="field.isEnabled === false"
                                                     [attr.autocomplete]="'off'"
                                                     [value]="displayLabels[field.id + '_' + i + '_' + section] || getOptionLabel(field, entry[field.id]) || ''"
                                                     (input)="onInputChange($event, field, section, i)"
                                                     (focus)="onFocus(field, section, i)"
                                                     (blur)="onBlur(field, section, i)"
                                                     (keydown)="handleKeydown($event, field, section, i, entry)" />


                                              <!-- Hidden ngModel binding -->
                                              <input type="hidden"
                                                     name="{{ field.id + '_' + i }}"
                                                     [(ngModel)]="entry[field.id]"
                                                     #fieldModel="ngModel" />

                                              <!-- Autocomplete Dropdown -->
                                              <div class="autocomplete-dropdown shadow-sm"
                                                   *ngIf="showDropdown[section + '_' + i + '_' + field.id] && filteredOptions[section + '_' + i + '_' + field.id]?.length">
                                                <div class="autocomplete-option"
                                                     *ngFor="let option of filteredOptions[section + '_' + i + '_' + field.id]; let optIndex = index"
                                                     [class.active]="hoveredIndexMap[section + '_' + i + '_' + field.id] === optIndex"
                                                     (mousedown)="selectOption(option.label, entry, field.id, section, i)">
                                                  {{ option.label }}
                                                </div>
                                              </div>

                                              <!-- Dropdown icon -->
                                              <mat-icon class="custom-dropdown-arrow">arrow_drop_down</mat-icon>

                                              <!-- Validation -->
                                              <div *ngIf="field.required && fieldModel.invalid && (fieldModel.dirty || fieldModel.touched)"
                                                   class="text-danger mt-1">
                                                {{ field.requiredMsg ? field.requiredMsg : (field.displayName + ' is required.') }}
                                              </div>
                                            </div>

                                          </ng-container>
                                          <ng-container *ngSwitchCase="'textarea'">
                                            <textarea class="form-control"
                                                      [id]="field.id + '_' + i"
                                                      name="{{ field.id + '_' + i }}"
                                                      [(ngModel)]="entry[field.id]"
                                                      rows="3"
                                                      placeholder="{{ field.displayName }}"
                                                      [required]="field.required"
                                                      #fieldModel="ngModel"></textarea>
                                            <div *ngIf="field.required && fieldModel.invalid && (fieldModel.dirty || fieldModel.touched)" class="text-danger">
                                              {{ field.requiredMsg ? field.requiredMsg : (field.displayName + " is required.") }}
                                            </div>
                                          </ng-container>
                                          <ng-container *ngSwitchCase="'checkbox'">
                                            <div class="form-outline">
                                              <label [for]="field.id + '_' + i" class="form-label">
                                                {{ field.displayName }}<span *ngIf="field.required" class="text-danger"> * </span>
                                              </label>
                                              <div class="form-group d-flex align-items-center">
                                                <input type="checkbox" class="form-check-input"
                                                       [id]="field.id + '_' + i"
                                                       name="{{ field.id + '_' + i }}" [(ngModel)]="entry[field.id]" />
                                              </div>
                                            </div>
                                          </ng-container>
                                        </ng-container>
                                      </ng-container>
                                      <!-- If the field has a row layout, render its sub-fields inline -->
                                      <ng-container *ngIf="field.layout === 'row'">
                                        <div class="row g-3 mb-3">
                                          <ng-container *ngFor="let subField of field.fields">
                                            <div class="col">
                                              <div class="form-outline w-100">
                                                <!-- Label (skip for checkboxes) -->
                                                <ng-container *ngIf="subField.type !== 'checkbox'">
                                                  <label [for]="subField.id + '_' + i" class="form-label" style="left:0px;">
                                                    {{ subField.displayName }}
                                                    <span *ngIf="subField.required" class="text-danger"> * </span>
                                                  </label>
                                                </ng-container>

                                                <!-- Field rendering -->
                                                <div class="form-group w-100">
                                                  <ng-container [ngSwitch]="subField.type">
                                                    <ng-container *ngSwitchDefault>
                                                      <input class="form-control w-100" [type]="subField.type"
                                                             [id]="subField.id + '_' + i" name="{{ subField.id + '_' + i }}"
                                                             [(ngModel)]="entry[subField.id]" placeholder="{{ subField.displayName }}"
                                                             [required]="subField.required" #subFieldModel="ngModel" />
                                                    </ng-container>

                                                    <ng-container *ngSwitchCase="'select'">
                                                      <select class="form-control w-100" style="width:220px !important;margin-left:-12px;"
                                                              [id]="subField.id + '_' + i" name="{{ subField.id + '_' + i }}"
                                                              [(ngModel)]="entry[subField.id]" [required]="subField.required"
                                                              #subFieldModel="ngModel">
                                                        <option *ngFor="let option of subField.options" [value]="option.value">
                                                          {{ option.label }}
                                                        </option>
                                                      </select>
                                                      <mat-icon class="custom-dropdown-arrow">arrow_drop_down</mat-icon>
                                                    </ng-container>

                                                    <ng-container *ngSwitchCase="'textarea'">
                                                      <textarea class="form-control w-100" rows="3"
                                                                [id]="subField.id + '_' + i" name="{{ subField.id + '_' + i }}"
                                                                [(ngModel)]="entry[subField.id]" placeholder="{{ subField.displayName }}"
                                                                [required]="subField.required" #subFieldModel="ngModel">
                                                      </textarea>
                                                    </ng-container>

                                                    <ng-container *ngSwitchCase="'checkbox'">
                                                      <div class="form-outline">
                                                        <label [for]="subField.id + '_' + i" class="form-label">
                                                          <span *ngIf="subField.required" class="text-danger"> * </span>
                                                        </label>
                                                        <div class="form-group d-flex align-items-center">
                                                          <input type="checkbox" class="form-check-input"
                                                                 [id]="subField.id + '_' + i" name="{{ subField.id + '_' + i }}"
                                                                 [(ngModel)]="entry[subField.id]" />
                                                        </div>
                                                      </div>
                                                    </ng-container>
                                                  </ng-container>
                                                </div>
                                              </div>
                                            </div>
                                          </ng-container>
                                        </div>
                                      </ng-container>
                                    </div>
                                  </div>
                                </div>
                                <!-- Primary Radio Button for Diagnosis Section -->
                                <div class="col-5-layout mb-3" *ngIf="isDiagnosisSection(section)">
                                  <div class="d-flex align-items-center">
                                    <input type="radio"
                                           class="me-2"
                                           name="primary_{{section}}"
                                           [value]="i"
                                           [(ngModel)]="formData[section].primaryIndex"
                                           (change)="setPrimary(section, i)" />
                                    <label class="form-label mb-0">Primary</label>
                                  </div>
                                </div>
                                <!-- Add & Remove Buttons for Diagnosis, Provider, Services -->
                                <div class="col-5-layout mb-3" *ngIf="isSpecialSection(section)">
                                  <button mat-icon-button color="warn"
                                          *ngIf="formData[section].entries.length > 1"
                                          (click)="removeEntry(section, i)">
                                    <mat-icon>remove_circle</mat-icon>
                                  </button>
                                  <button mat-icon-button color="accent" *ngIf="section === 'Service Details'"
                                          (click)="copyEntry(section, i)">
                                    <mat-icon>content_copy</mat-icon>
                                  </button>
                                  <button mat-icon-button color="primary"
                                          *ngIf="i === formData[section].entries.length - 1"
                                          (click)="addEntry(section, i)">
                                    <mat-icon>add_circle</mat-icon>
                                  </button>
                                </div>
                              </div>
                              <!-- Show overlapping service codes error -->
                              <!-- Inside Service Details mat-card or after entries -->
                              <div *ngIf="overlappingServiceCodes.length > 0" class="service-overlap-error mt-2">
                                <p><strong>❌ Overlapping Service Dates Found:</strong></p>
                                <ul class="mb-0">
                                  <li *ngFor="let overlap of overlappingServiceCodes">
                                    Overlap between <strong>{{ overlap.fromCode }}</strong> and <strong>{{ overlap.toCode }}</strong>
                                  </li>
                                </ul>
                              </div>
                              <div *ngIf="sectionValidationMessages[section]?.length" class="validation-messages">
                                <div *ngFor="let msg of sectionValidationMessages[section]" class="text-danger" style="padding-left:40px;">
                                  {{ msg }}
                                </div>
                              </div>

                            </div>
                          </ng-template>
                        </div>
                      </div>
                      <div *ngIf="section === 'Service Details' && serviceOverlapMessages.length > 0" class="service-overlap-error mt-2">
                        <p><strong>❌ Overlapping Service Dates Found:</strong></p>
                        <ul class="mb-0">
                          <li *ngFor="let msg of serviceOverlapMessages">
                            {{ msg }}
                          </li>
                        </ul>
                      </div>

                    </mat-card>
                  </ng-container>
                </ng-container>
                <!-- Save Button -->
                <div class="text-center">
                  <button mat-raised-button class="auth-button " [disabled]="!hasPagePermission('Request Details', 'Edit')" (click)="saveData(authForm)">{{ (authNumber && authNumber !== 'DRAFT') ? 'Save and Review' : 'Save and Continue' }}</button>
                  <!--<button mat-raised-button class="auth-button " (click)="loadData()">Load</button>-->
                </div>

              </div>

            </form>
          </div>
        </div>
      </mat-step>
      <mat-step label="Decision Details"
                *ngIf="hasPagePermission('Decision Details', 'View')"
                [completed]="!!authNumber"
                [editable]="!!authNumber">
        <app-decisiondetails [decisionFields]="DecisionFields"
                             [decisionData]="decisionData"
                             [canAdd]="hasPagePermission('Decision Details', 'Add')"
                             [canEdit]="hasPagePermission('Decision Details', 'Edit')"
                             [canView]="hasPagePermission('Decision Details', 'View')"
                             (decisionSaved)="handleDecisionDataSaved($event)"
                             [authorizationNotesFields]="authorizationNotesFields"
                             [authorizationNotesData]="authorizationNotesData"
                             [runEnsure]="decisionEnsureSignal"
                             (goToMdReview)="handleGoToMdReview($event); stepper.selectedIndex = 2">
        </app-decisiondetails>
      </mat-step>

      <!--<mat-step label="MD Review" [completed]="!!authNumber" [editable]="!!authNumber"></mat-step>-->
      <mat-step label="MD Review"
                *ngIf="hasPagePermission('MD Review','View') && (mdReviewHasActivities || (forceShowMdReview && !!authDetailId))"
                [completed]="!!authNumber" [editable]="!!authNumber">
        <app-mdreview *ngIf="mdReviewLines?.length" [authDetailId]="authDetailId" [serviceLines]="mdReviewLines"></app-mdreview>
      </mat-step>


      <mat-step label="Activity" *ngIf="hasPagePermission('Auth Activity', 'View')" [completed]="!!authNumber" [editable]="!!authNumber">
        <app-umauthactivity *ngIf="authDetailId"
                            [authDetailId]="authDetailId"
                            [canAdd]="hasPagePermission('Auth Activity', 'Add')"
                            [canEdit]="hasPagePermission('Auth Activity', 'Edit')">
        </app-umauthactivity>
      </mat-step>

      <mat-step label="Notes"
                *ngIf="hasPagePermission('Auth Notes', 'View')"
                [completed]="!!authNumber"
                [editable]="!!authNumber">
        <app-umauthnotes [notesFields]="authorizationNotesFields"
                         [notesData]="authorizationNotesData"
                         [canAdd]="hasPagePermission('Auth Notes', 'Add')"
                         [canEdit]="hasPagePermission('Auth Notes', 'Edit')"
                         [canView]="hasPagePermission('Auth Notes', 'View')"
                         (NotesSaved)="handleAuthNotesSaved($event)">
        </app-umauthnotes>
      </mat-step>

      <mat-step label="Documents"
                *ngIf="hasPagePermission('Auth Documents', 'View')"
                [completed]="!!authNumber"
                [editable]="!!authNumber">
        <app-umauthdocuments [documentFields]="authorizationDocumentFields"
                             [documentData]="authorizationDocumentData"
                             [canAdd]="hasPagePermission('Auth Documents', 'Add')"
                             [canEdit]="hasPagePermission('Auth Documents', 'Edit')"
                             [canView]="hasPagePermission('Auth Documents', 'View')"
                             (DocumentSaved)="handleAuthDocumentSaved($event)">
        </app-umauthdocuments>
      </mat-step>

      <mat-step label="Close" [completed]="!!authNumber" [editable]="!!authNumber"></mat-step>
    </mat-horizontal-stepper>
  </div>
</div>
<div>
  <app-authdetails *ngIf="showAuthorizationComponent" [memberId]="memberId"></app-authdetails>
</div>
