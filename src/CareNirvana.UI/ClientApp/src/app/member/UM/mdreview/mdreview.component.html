<div class="auth-form">
  <form [formGroup]="mdrForm">
    <h5 *ngIf="hasSelection()">Send for Medical Director Reviewâ€‹</h5>
    <div class="form-grid" style="padding-top:5px;" *ngIf="hasSelection()">


      <!-- Assignment Type -->
      <div class="form-outline dropdown-container">
        <label class="floating-label">Assignment Type <span class="text-danger">*</span></label>
        <div class="input-with-icon">
          <input type="text" class="form-control" [value]="assignmentTypeDisplay"
                 (input)="onDropdownInput($event, 'assignmentType')"
                 (focus)="openDropdown('assignmentType')"
                 (blur)="closeDropdown('assignmentType')" />
          <span class="dropdown-arrow">&#9662;</span>
          <div class="autocomplete-dropdown" *ngIf="showDropdowns.assignmentType && filteredAssignmentTypes?.length">
            <div class="autocomplete-option" *ngFor="let option of filteredAssignmentTypes"
                 (mousedown)="selectDropdownOption('assignmentType', option)">
              {{ option.label }}
            </div>
          </div>
        </div>
      </div>

      <!-- Activity Type -->
      <div class="form-outline dropdown-container">
        <label class="floating-label">Activity Type <span class="text-danger">*</span></label>
        <div class="input-with-icon">
          <input type="text" class="form-control" [value]="activityTypeDisplay"
                 (input)="onDropdownInput($event, 'activityType')"
                 (focus)="openDropdown('activityType')"
                 (blur)="closeDropdown('activityType')" />
          <span class="dropdown-arrow">&#9662;</span>
          <div class="autocomplete-dropdown" *ngIf="showDropdowns.activityType && filteredActivityTypes?.length">
            <div class="autocomplete-option" *ngFor="let option of filteredActivityTypes"
                 (mousedown)="selectDropdownOption('activityType', option)">
              {{ option.label }}
            </div>
          </div>
        </div>
      </div>

      <!--<div class="compact-field">
        <mat-form-field appearance="outline" class="full-width compact-mat"
                        style="--mat-form-field-container-height:40px; --mat-form-field-container-vertical-padding:6px;">
          <mat-label>Priority</mat-label>

          <mat-select [formControl]="priorityCtrl"
                      (openedChange)="onOpen($event)"
                      (closed)="onClosed()"
                      panelClass="select-with-search-panel">-->
            <!-- Search row -->
            <!--<mat-option disabled class="search-option">
              <input #searchInput
                     matInput
                     type="text"
                     placeholder="Search..."
                     [formControl]="priorityFilterCtrl"
                     (click)="$event.stopPropagation()"
                     (keydown)="onSearchKeydown($event)">
            </mat-option>-->

            <!-- Filtered options -->
            <!--<mat-option *ngFor="let p of filteredPriorities$ | async" [value]="p">
              {{ p }}
            </mat-option>

            <mat-option *ngIf="(filteredPriorities$ | async)?.length === 0" disabled>
              No results
            </mat-option>
          </mat-select>
        </mat-form-field>

      </div>-->
      <!-- Priority -->
      <div class="form-outline dropdown-container">
        <label class="floating-label">Priority <span class="text-danger">*</span></label>
        <div class="input-with-icon">
          <input type="text" class="form-control" [value]="priorityDisplay"
                 (input)="onDropdownInput($event, 'priority')"
                 (focus)="openDropdown('priority')"
                 (blur)="closeDropdown('priority')" />
          <span class="dropdown-arrow">&#9662;</span>
          <div class="autocomplete-dropdown" *ngIf="showDropdowns.priority && filteredPriorities?.length">
            <div class="autocomplete-option" *ngFor="let option of filteredPriorities"
                 (mousedown)="selectDropdownOption('priority', option)">
              {{ option.label }}
            </div>
          </div>
        </div>
      </div>

      <!-- Assign To -->
      <div class="form-outline dropdown-container">
        <label class="floating-label">Assign To <span class="text-danger">*</span></label>
        <div class="input-with-icon">
          <input type="text" class="form-control" [value]="assignToDisplay"
                 (input)="onDropdownInput($event, 'assignTo')"
                 (focus)="openDropdown('assignTo')"
                 (blur)="closeDropdown('assignTo')" />
          <span class="dropdown-arrow">&#9662;</span>
          <div class="autocomplete-dropdown" *ngIf="showDropdowns.assignTo && filteredUsers?.length">
            <div class="autocomplete-option" *ngFor="let option of filteredUsers"
                 (mousedown)="selectDropdownOption('assignTo', option)">
              {{ option.label }}
            </div>
          </div>
        </div>
      </div>

      <!-- Scheduled Date -->
      <div class="form-outline position-relative">
        <label class="floating-label">Scheduled Date & Time <span class="text-danger">*</span></label>
        <div class="input-with-icon">
          <!-- remove formControlName here; this is purely the display/editor text -->
          <input type="text" class="form-control"
                 placeholder="Enter D, D+1, D-1 or select"
                 [value]="scheduledDateText"
                 (input)="onDateTextChange($event, 'scheduledDateTime')"
                 (blur)="handleDateBlur('scheduledDateTime')" />
          <button type="button" class="calendar-icon-btn" (click)="triggerCalendar('scheduled')">ðŸ“…</button>

          <!-- the actual control lives on the hidden native picker -->
          <input type="datetime-local" #scheduledPicker class="hidden-picker"
                 formControlName="scheduledDateTime"
                 (change)="handleCalendarChange($event, 'scheduledDateTime')" />
        </div>
      </div>

      <!-- Due Date -->
      <div class="form-outline position-relative">
        <label class="floating-label">Due Date & Time <span class="text-danger">*</span></label>
        <div class="input-with-icon">
          <input type="text" class="form-control"
                 placeholder="Enter D, D+1, D-1 or select"
                 [value]="dueDateText"
                 (input)="onDateTextChange($event, 'dueDateTime')"
                 (blur)="handleDateBlur('dueDateTime')" />
          <button type="button" class="calendar-icon-btn" (click)="triggerCalendar('due')">ðŸ“…</button>

          <input type="datetime-local" #duePicker class="hidden-picker"
                 formControlName="dueDateTime"
                 (change)="handleCalendarChange($event, 'dueDateTime')" />
        </div>
      </div>

      <!-- Work Basket -->
      <div class="form-outline dropdown-container" *ngIf="showWorkBasketFields">
        <label class="floating-label">Work Basket</label>
        <div class="input-with-icon">
          <input type="text" class="form-control" [value]="workBasketDisplay"
                 (input)="onDropdownInput($event, 'workBasket')"
                 (focus)="openDropdown('workBasket')"
                 (blur)="closeDropdown('workBasket')" />
          <span class="dropdown-arrow">&#9662;</span>
          <div class="autocomplete-dropdown" *ngIf="showDropdowns.workBasket && filteredWorkBaskets?.length">
            <div class="autocomplete-option" *ngFor="let option of filteredWorkBaskets"
                 (mousedown)="selectDropdownOption('workBasket', option)">
              {{ option.label }}
            </div>
          </div>
        </div>
      </div>

      <!-- Work Basket Users -->
      <div class="form-outline dropdown-container" *ngIf="showWorkBasketFields">
        <label class="floating-label">Work Basket Users</label>
        <div class="input-with-icon">
          <input type="text" class="form-control" [value]="workBasketUserDisplay"
                 [disabled]="!mdrForm.get('workBasket')?.value"
                 (input)="onDropdownInput($event, 'workBasketUser')"
                 (focus)="openDropdown('workBasketUser')"
                 (blur)="closeDropdown('workBasketUser')" />
          <span class="dropdown-arrow">&#9662;</span>
          <div class="autocomplete-dropdown" *ngIf="showDropdowns.workBasketUser && filteredUsers?.length">
            <div class="autocomplete-option" *ngFor="let option of filteredUsers"
                 (mousedown)="selectDropdownOption('workBasketUser', option)">
              {{ option.label }}
            </div>
          </div>
        </div>
      </div>

      <!-- Clinical Context -->
      <div class="form-outline full-width" style="grid-column: span 2;">
        <label class="floating-label">Clinical Context & Instructions</label>
        <textarea class="form-control" rows="3" formControlName="clinicalInstructions"></textarea>
      </div>
    </div>

    <h5>Select the service lines for review</h5>
    <div class="service-line-table-wrapper">
      <table class="service-line-table">
        <thead>
          <tr>
            <th><input type="checkbox" [checked]="isAllSelected()" [(ngModel)]="allSelected" (change)="toggleAllSelection($event)" /></th>
            <th>Service Code</th>
            <th>Service Description</th>
            <th>From Date</th>
            <th>To Date</th>
            <th>Requested</th>
            <th>Approved</th>
            <th>Denied</th>
            <th>Initial Recommendation</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let line of serviceLines; let i = index">
            <td>
              <input type="checkbox"
                     [(ngModel)]="line.selected"
                     [ngModelOptions]="{ standalone: true }"
                     name="lineSelect{{i}}" />
            </td>
            <td>{{ line.serviceCode }}</td>
            <td>{{ line.description }}</td>
            <td>{{ toDisplayFormat(line.fromDate) }}</td>
            <td>{{ toDisplayFormat(line.toDate) }}</td>
            <td>{{ line.requested }}</td>
            <td>{{ line.approved }}</td>
            <td>{{ line.denied }}</td>
            <td><button [ngClass]="getRecommendationClass(line.recommendation)">{{ line.recommendation }}</button></td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="button-group">
      <button type="button" (click)="submitReview()" [disabled]="!hasSelection()">Submit for Medical Director Review</button>
      <button type="button" (click)="cancelReview()" [disabled]="!hasSelection()">Cancel</button>
    </div>
  </form>
</div>
