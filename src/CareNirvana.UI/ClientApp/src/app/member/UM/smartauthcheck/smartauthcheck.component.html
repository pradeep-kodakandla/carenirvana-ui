<!-- smartauthcheck.component.html -->
<mat-card class="page-shell">

  <!-- Top Bar / Title -->
  <header class="page-header">
    <div class="title-wrap">
      <h2 class="page-title">Smart Authorization</h2>
      <p class="page-subtitle">Select an LOB & fill service details to continue.</p>
    </div>

    <!-- lightweight step indicator -->
    <div class="stepper-mini" aria-label="Progress">
      <span class="step active">1</span>
      <span class="line"></span>
      <span class="step">2</span>
      <span class="line"></span>
      <span class="step">3</span>
    </div>
  </header>

  <mat-divider></mat-divider>

  <!-- Context / Selection Cards -->
  <section class="section">
    <div class="section-head">
      <h3 class="section-title">Choose Coverage Context</h3>
      <span class="section-help">Pick the applicable LOB/account period.</span>
    </div>

    <div class="selection-container" >
      <div class="rounded-box tooltip-wrapper"
           *ngFor="let enr of memberEnrollments; let i = index"
           (click)="selectEnrollment(i)"
           [ngClass]="{ 'selected': selectedDiv === i + 1 }">
        <div class="d-flex justify-content-between div-secondary">
          <div>
            <!-- Left side labels -->
            <label class="label" *ngFor="let pair of getEnrollmentDisplayPairs(enr)">
              {{ pair.label }}
            </label>
          </div>
          <div>
            <!-- Right side values -->
            <label class="label" *ngFor="let pair of getEnrollmentDisplayPairs(enr)">
              {{ pair.value }}
            </label>
          </div>
        </div>
      </div>
    </div>
  </section>

  <mat-divider></mat-divider>

  <!-- Form -->
  <section class="section">
    <div class="section-head">
      <h3 class="section-title">Service Details</h3>
      <span class="section-help">Dates accept <code>D</code>, <code>D+1</code>, <code>D-1</code> or use the picker.</span>
    </div>

    <form [formGroup]="smartAuthCheckForm" class="form-surface">

      <!-- Row 1: Auth Case + Auth Type -->
      <div class="row-2">
        <!-- Auth Case -->
        <div class="form-field">
          <label class="floating-label">Auth Case</label>
          <select class="form-select"
                  [(ngModel)]="selectedAuthClassId"
                  [ngModelOptions]="{ standalone: true }"
                  (change)="onAuthClassChange(); $event.stopPropagation();">
            <option *ngFor="let item of authClass" [value]="item.id">
              {{ item.authClass }}
            </option>
          </select>
        </div>

        <!-- Auth Type -->
        <div class="form-field">
          <label class="floating-label">Auth Type</label>
          <select class="form-select"
                  [(ngModel)]="selectedTemplateId"
                  [ngModelOptions]="{ standalone: true }"
                  [disabled]="!selectedAuthClassId || selectedAuthClassId === 0"
                  (change)="$event.stopPropagation();">
            <option *ngFor="let template of authTemplates" [value]="template.Id">
              {{ template.TemplateName }}
            </option>
          </select>
        </div>
      </div>

      <!-- Row 2: From + To -->
      <div class="row-2">
        <!-- From -->
        <div class="form-field">
          <label class="floating-label">From Date <span class="req">*</span></label>
          <div class="input-with-icon">
            <input type="text"
                   class="form-control"
                   formControlName="scheduledDateTime"
                   [value]="scheduledDateText"
                   (input)="onScheduledTextChange($event)"
                   (blur)="handleDateTimeBlur('scheduledDateText', 'scheduledDateTime')"
                   [ngClass]="{'is-invalid': smartAuthCheckForm.get('scheduledDateTime')?.touched && smartAuthCheckForm.get('scheduledDateTime')?.invalid}"
                   placeholder="Enter D, D+1, D-1 or select" />
            <button type="button" class="calendar-icon-btn" (click)="triggerCalendar('scheduled')" tabindex="0">ðŸ“…</button>
            <input type="datetime-local" #scheduledPicker class="sr-only" (change)="handleCalendarChange($event, 'scheduledDateTime')">
          </div>
          <div *ngIf="smartAuthCheckForm.get('scheduledDateTime')?.touched && smartAuthCheckForm.get('scheduledDateTime')?.invalid" class="field-error">
            Scheduled date is required.
          </div>
        </div>

        <!-- To -->
        <div class="form-field">
          <label class="floating-label">To Date <span class="req">*</span></label>
          <div class="input-with-icon">
            <input type="text"
                   class="form-control"
                   formControlName="dueDateTime"
                   [value]="dueDateText"
                   (input)="onDueTextChange($event)"
                   (blur)="handleDateTimeBlur('dueDateText', 'dueDateTime')"
                   [ngClass]="{'is-invalid': smartAuthCheckForm.get('dueDateTime')?.touched && smartAuthCheckForm.get('dueDateTime')?.invalid}"
                   placeholder="Enter D, D+1, D-1 or select" />
            <button type="button" class="calendar-icon-btn" (click)="triggerCalendar('due')">ðŸ“…</button>
            <input type="datetime-local" #duePicker class="sr-only" (change)="handleCalendarChange($event, 'dueDateTime')">
          </div>
          <div *ngIf="smartAuthCheckForm.get('dueDateTime')?.touched && smartAuthCheckForm.get('dueDateTime')?.invalid" class="field-error">
            Due date is required.
          </div>
        </div>
      </div>

      <!-- Row 3+: ICD-10 rows (ICD-10 + Description) -->
      <div class="row-header">
        <!--<h4>ICD-10</h4>-->
        <!--<button type="button" class="add-btn" (click)="addIcdRow()" aria-label="Add ICD">ï¼‹</button>-->
      </div>
      <div formArrayName="icds" class="stacked-rows">
        <div class="row-2" *ngFor="let g of icds.controls; let i = index" [formGroupName]="i">
          <div class="form-field">
            <label class="floating-label">ICD-10</label>
            <input type="text" class="form-control" formControlName="icd10">
          </div>
          <div class="form-field with-actions">
            <label class="floating-label">ICD-10 Description</label>
            <div class="inline-field">
              <input type="text" class="form-control" formControlName="icd10Desc">
              <div class="row-actions">
                <button type="button" class="icon-btn" (click)="addIcdRow()" title="Add another ICD">ï¼‹</button>
                <button type="button" class="icon-btn danger" (click)="removeIcdRow(i)" [disabled]="icds.length === 1" title="Remove">âˆ’</button>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Row 4+: Service rows (Service Code + Description) -->
      <div class="row-header">
        <!--<h4>Service</h4>-->
        <!--<button type="button" class="add-btn" (click)="addServiceRow()" aria-label="Add Service">ï¼‹</button>-->
      </div>
      <div formArrayName="services" class="stacked-rows">
        <div class="row-2" *ngFor="let g of services.controls; let i = index" [formGroupName]="i">
          <div class="form-field">
            <label class="floating-label">Service Code</label>
            <input type="text" class="form-control" formControlName="serviceCode">
          </div>
          <div class="form-field with-actions">
            <label class="floating-label">Service Description</label>
            <div class="inline-field">
              <input type="text" class="form-control" formControlName="serviceDesc">
              <div class="row-actions">
                <button type="button" class="icon-btn" (click)="addServiceRow()" title="Add another Service">ï¼‹</button>
                <button type="button" class="icon-btn danger" (click)="removeServiceRow(i)" [disabled]="services.length === 1" title="Remove">âˆ’</button>
              </div>
            </div>


          </div>
        </div>
      </div>

      <!-- Validation summary -->
      <div class="validation-banner" *ngIf="smartAuthCheckForm.invalid && smartAuthCheckForm.touched">
        Please resolve the highlighted fields before continuing.
      </div>
    </form>

  </section>

  <!-- Sticky Action Bar -->
  <footer class="action-bar">
    <div class="bar-left">
      <button mat-stroked-button class="btn-ghost" type="button" (click)="onCancel()">Cancel</button>
    </div>
    <div class="bar-right">
      <button mat-button class="btn-secondary" type="button" (click)="onSaveDraft()">Save Draft</button>
      <button mat-raised-button color="primary" class="btn-primary" type="button"
              [disabled]="smartAuthCheckForm.invalid"
              (click)="onNextContinue()">
        Next / Continue
      </button>
      <button mat-raised-button color="accent" class="btn-accent" type="button"
              [disabled]="smartAuthCheckForm.invalid"
              (click)="onCompleteAuth()">
        Complete Auth
      </button>
    </div>
  </footer>
</mat-card>
