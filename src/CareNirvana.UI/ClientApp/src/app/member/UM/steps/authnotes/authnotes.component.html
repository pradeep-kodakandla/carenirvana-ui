
<div class="notes-container"
     [class.notes-container--add-only]="isAddOnly"
     [class.notes-container--single-pane]="singlePane && !isAddOnly">
  <!-- Left Side - Notes Timeline/List (AuthActivity style) -->
  <div class="notes-left" *ngIf="!isAddOnly && !(singlePane && (showEditor || selectedNoteId))">
    <!--<div class="notes-titlebar">
      <div class="notes-title">Authorization Notes</div>
    </div>-->
    <!-- Top Search + Action Bar -->
    <div class="left-controls">
      <input type="text"
             placeholder="üîç Search notes..."
             [(ngModel)]="searchTerm"
             (input)="applySearch()"
             class="search-input"
             [disabled]="loading" />

      <div class="right-actions">
        <div class="sort-wrapper" (mouseenter)="showSort = true" (mouseleave)="showSort = false">
          <button class="sort-icon" type="button" aria-label="Sort">‚áÖ</button>
          <div class="sort-menu" *ngIf="showSort">
            <div class="sort-option" (click)="applySort('created_desc')">Newest first</div>
            <div class="sort-option" (click)="applySort('created_asc')">Oldest first</div>
            <div class="sort-option" (click)="applySort('type_asc')">Note Type (A‚ÄìZ)</div>
            <div class="sort-option" (click)="applySort('type_desc')">Note Type (Z‚ÄìA)</div>
            <div class="sort-option" (click)="applySort('alerts_first')">Alerts first</div>
          </div>
        </div>

        <button class="add-btn" (click)="onAddClick()" [disabled]="loading || saving">‚ûï Add Note</button>
      </div>
    </div>

    <div class="alert alert-danger py-2" *ngIf="errorMsg">
      {{ errorMsg }}
    </div>

    <div *ngIf="loading" class="py-3 px-2">
      Loading...
    </div>

    <!-- Notes list -->
    <div *ngIf="!loading && (!notes || notes.length === 0)" class="text-muted py-3 px-2">
      No Notes found. Click "Add Notes" to create one.
    </div>

    <div class="timeline-list" *ngIf="!loading && notes && notes.length > 0">
      <article class="timeline-item"
               *ngFor="let n of filteredNotes; trackBy: trackByNoteId"
               [ngClass]="{ 'selected': (selectedNoteId && (selectedNoteId === getNoteId(n))) }">

        <div class="timeline-content" (click)="onEdit(n)">
          <div class="timeline-header">
            <div class="timeline-title">
              {{ getNoteTypeLabel(n) || 'Note' }}
              <span *ngIf="isAlert(n)">‚ö†Ô∏è</span>
            </div>

            <div class="timeline-actions" (click)="$event.stopPropagation()">
              <button class="icon-btn" type="button" title="Edit" (click)="onEdit(n)" [disabled]="saving">‚úèÔ∏è</button>
              <button class="icon-btn" type="button" title="Delete" (click)="onDelete(n)" [disabled]="saving">üóëÔ∏è</button>
            </div>
          </div>

          <div class="timeline-summary">
            <span class="pill pill-warn" *ngIf="isAlert(n)">Alert</span>
            <span class="resp-time">{{ getCreatedOn(n) | date: 'short' }}</span>
          </div>

          <div class="note-snippet">{{ getNoteText(n) }}</div>
        </div>
      </article>
    </div>
  </div>

  <!-- Right Side - Editor / Selected Note / Summary -->
  <div class="notes-right" *ngIf="isAddOnly || !singlePane || (showEditor || selectedNoteId)">
    <!-- Embedded header (add-only mode) -->
    <div class="embed-notes-header" *ngIf="isAddOnly">
      <!--<div class="embed-title">Add Notes</div>-->
      <div class="embed-actions">
        <button type="button"
                class="btn btn-sm btn-link"
                (click)="emitViewAll()"
                [disabled]="loading || saving">
          View all notes ({{ notes?.length || 0 }})
        </button>
      </div>
    </div>

    <!-- Editor -->
    <div class="section-card" *ngIf="showEditor">

      <form [formGroup]="form">
        <div class="grid">
          <ng-container *ngFor="let f of noteEditorFields; trackBy: trackByField">
            <ng-container *ngIf="form.get(f.controlName) as ctrl">
              <ng-container *ngIf="shouldShowEditorField(f)">

                <!-- CHECKBOX -->
                <ng-container *ngIf="f.type === 'checkbox'; else outlinedTpl">
                  <div class="ff-field">
                    <div class="ff-checkbox">
                      <input type="checkbox"
                             class="form-check-input"
                             [formControlName]="f.controlName" />
                      <label class="form-check-label">
                        {{ f.displayName }}
                        <span class="req-star" *ngIf="isRequired(ctrl, f)">*</span>
                      </label>
                    </div>

                    <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">
                      {{ f.requiredMsg || (f.displayName + ' is required') }}
                    </div>
                  </div>
                </ng-container>

                <!-- OUTLINED -->
                <ng-template #outlinedTpl>
                  <div class="ff-field" [class.ff-span-all]="isFullWidthField(f)">
                    <div class="ff-outline"
                         [class.ff-disabled]="ctrl.disabled"
                         [class.ff-invalid]="ctrl.touched && ctrl.invalid">

                      <div class="ff-float-label">
                        {{ f.displayName }}
                        <span class="req-star" *ngIf="isRequired(ctrl, f)">*</span>
                      </div>

                      <div class="ff-body">
                        <ng-container [ngSwitch]="f.type">

                          <!-- Dropdown -->
                          <ng-container *ngSwitchCase="'select'">
                            <ui-smart-dropdown class="ff-ui"
                                               label=""
                                               placeholder="Select..."
                                               [options]="getDropdownOptions(f.controlName)"
                                               [formControlName]="f.controlName">
                            </ui-smart-dropdown>
                          </ng-container>

                          <!-- Datetime -->
                          <ng-container *ngSwitchCase="'datetime-local'">
                            <ui-datetime-picker class="ff-ui"
                                                placeholderDate="mm/dd/yyyy"
                                                placeholderDateTime="mm/dd/yyyy --:--"
                                                [formControlName]="f.controlName">
                            </ui-datetime-picker>
                          </ng-container>

                          <!-- Textarea -->
                          <ng-container *ngSwitchCase="'textarea'">
                            <textarea class="ff-input ff-textarea"
                                      rows="5"
                                      [formControlName]="f.controlName"></textarea>
                          </ng-container>

                          <!-- Default text -->
                          <ng-container *ngSwitchDefault>
                            <input class="ff-input" type="text" [formControlName]="f.controlName" />
                          </ng-container>

                        </ng-container>
                      </div>
                    </div>

                    <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">
                      {{ f.requiredMsg || (f.displayName + ' is required') }}
                    </div>
                  </div>
                </ng-template>

              </ng-container>
            </ng-container>
          </ng-container>
        </div>

        <div class="case-savebar">
          <button type="button" class="btn btn-outline-secondary me-2" (click)="clearSelection()">Cancel</button>
          <button type="button" class="btn btn-primary" [disabled]="saving" (click)="onSave()">Save</button>
        </div>
      </form>
    </div>

    <!-- Selected note preview -->
    <!-- Selected note preview -->
    <ng-container *ngIf="!showEditor && !isAddOnly">
      <div class="section-card" *ngIf="getSelectedNote() as sn; else notesSummary">

        <!-- Top meta pills -->
        <div class="resp-meta mb-3">
          <span class="pill pill-primary">Type ¬∑ {{ getNoteTypeLabel(sn) }}</span>
          <span class="pill pill-warn" *ngIf="isAlert(sn)">Alert</span>
          <span class="resp-time">{{ getCreatedOn(sn) | date: 'short' }}</span>
        </div>

        <!-- √¢≈ì‚Ä¶ Display fields (read-only) -->
        <div class="grid">
          <ng-container *ngFor="let f of getDisplayFieldsForSelected(sn); trackBy: trackByField">
            <div class="ff-field"
                 *ngIf="shouldShowDisplayField(sn, f)"
                 [class.ff-span-all]="isFullWidthField(f)">
              <div class="ff-outline">
                <div class="ff-float-label">{{ f.displayName }}</div>
                <div class="ff-body">
                  <div class="ff-readonly">
                    {{ getSelectedFieldDisplayValue(sn, f) }}
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>

      <!-- √¢≈ì‚Ä¶ Default summary (no selection) -->
      <ng-template #notesSummary>
        <div class="ai-summary">
          <h3>üìù Notes Summary</h3>
          <p><strong>Total Notes:</strong> {{ notes.length || 0 }}</p>
          <p><strong>Alerts:</strong> {{ getAlertCount() }}</p>
          <p class="text-muted" style="margin-top: 10px;">
            Select a note on the left to view its details here, or click ‚ÄúAdd Note‚Äù.
          </p>
        </div>
      </ng-template>
    </ng-container>

  </div>
</div>
