<!-- ============================================================
     AuthDecision — Updated HTML Template
     Changes:
     1. Buttons moved from case-savebar into content-header bar
     2. Content-header shows "Decision #N — CODE" + status badge + buttons
     3. Tab layout updated: line1 + badge, code line, date line, reason line
     4. Border gap between tab and content panel is preserved
     ============================================================ -->

<!-- OLD save bar removed (buttons now live in the content header) -->
<!-- <div class="case-savebar">...</div>  ← DELETE THIS -->

<div class="decision-details-layout" *ngIf="!loading && tabs.length">

  <!-- ===== LEFT: Tab Rail ===== -->
  <div class="tabs-container">
    <div class="tabs">
      <div
        *ngFor="let tab of tabs; let i = index"
        class="tab"
        [class.active]="tab.id === selectedTabId"
        [class.before-active]="isTabBeforeActive(i)"
        [ngClass]="[
          tab.statusClass,
          isTabBeforeActive(i) ? 'before-status-' + getActiveStatusKey() : ''
        ]"
        (click)="selectTab(tab.id)">

        <!-- Row 1: Title + Status Badge -->
        <div class="tab-header-row">
          <span class="tab-line1">{{ tab.line1 }}</span>
          <span class="tab-status-badge"
                [ngClass]="tab.statusClass.replace('status-','status-') + '-badge'">
            {{ tab.line3 }}
          </span>
        </div>

        <!-- Row 2: Procedure Code -->
        <div class="tab-code-line" *ngIf="tab.procedureCode">
          Code: {{ tab.procedureCode }}
        </div>

        <!-- Row 3: Date Range (MM/DD → MM/DD/YYYY) -->
        <div class="tab-line2" *ngIf="tab.line2">{{ tab.line2 }}</div>

        <!-- Row 4: Status Reason (italic) -->
        <div class="tab-line4" *ngIf="tab.line4">{{ tab.line4 }}</div>
      </div>
    </div>
  </div>

  <!-- ===== RIGHT: Content Panel ===== -->
  <div class="tab-content"
       *ngIf="activeState"
       [ngClass]="'status-' + getActiveStatusKey() + '-panel'">

    <!-- ★ NEW: Content Header Bar (replaces old case-savebar) -->
    <div class="content-header" [ngClass]="contentHeaderClass">
      <div class="content-header-left">
        <span class="content-header-title">{{ contentHeaderTitle }}</span>
        <span class="content-header-badge" [ngClass]="contentHeaderBadgeClass">
          {{ contentHeaderStatusText }}
        </span>
      </div>
      <div class="content-header-actions">

        <button class="btn btn-outline-secondary btn-sm" (click)="saveCurrentTab()" [disabled]="saving">
          Bulk Save
        </button>
        <button class="btn btn-outline-secondary btn-sm" (click)="saveCurrentTab()" [disabled]="saving">
          Save
        </button>
        <button class="btn btn-outline-secondary btn-sm" (click)="openMdReview()">
          MD Review
        </button>
        <button class="btn btn-outline-danger btn-sm" (click)="deleteCurrentTab()" [disabled]="saving">
          Delete
        </button>
      </div>
    </div>

    <!-- Sections (Decision Details, Request & Treatment, etc.) -->
    <ng-container *ngFor="let section of activeState.sections">
      <div class="section-card"
           *ngIf="isSectionVisible(activeState, section)"
           [class.collapsed]="section._collapsed">

        <div class="section-header" (click)="section._collapsed = !section._collapsed">
          <div class="section-icon">
            <!-- icon per section -->
          </div>
          <span class="section-title">{{ section.sectionName }}</span>
          <span class="section-chevron">
            <svg viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
            </svg>
          </span>
        </div>

        <div class="section-body">
          <div class="grid">
            <ng-container *ngFor="let field of section.fields">
              <div class="ff-field"
                   *ngIf="isVisible(activeState, field)"
                   [class.ff-span-all]="field.type === 'textarea'">

                <!-- Text / Number / DateTime inputs -->
                <div class="ff-outline"
                     *ngIf="field.type !== 'select' && field.type !== 'checkbox' && field.type !== 'textarea'"
                     [class.ff-disabled]="!field.isEnabled"
                     [class.ff-invalid]="isInvalidField(field)">
                  <label class="ff-float-label">
                    {{ field.displayName }}
                    <span class="req-star" *ngIf="field.required || field.isRequired">*</span>
                  </label>
                  <div class="ff-body">
                    <input class="ff-input"
                           [type]="field.type"
                           [formControl]="getCtrl(field.controlName)"
                           [attr.placeholder]="field.type === 'datetime-local' ? 'mm/dd/yyyy' : '—'" />
                  </div>
                </div>

                <!-- Textarea -->
                <div class="ff-outline"
                     *ngIf="field.type === 'textarea'"
                     [class.ff-disabled]="!field.isEnabled"
                     [class.ff-invalid]="isInvalidField(field)">
                  <label class="ff-float-label">
                    {{ field.displayName }}
                    <span class="req-star" *ngIf="field.required || field.isRequired">*</span>
                  </label>
                  <div class="ff-body">
                    <textarea class="ff-input ff-textarea"
                              [formControl]="getCtrl(field.controlName)"></textarea>
                  </div>
                </div>

                <!-- Select (dropdown) -->
                <div class="ff-outline"
                     *ngIf="field.type === 'select'"
                     [class.ff-disabled]="!field.isEnabled"
                     [class.ff-invalid]="isInvalidField(field)">
                  <label class="ff-float-label">
                    {{ field.displayName }}
                    <span class="req-star" *ngIf="field.required || field.isRequired">*</span>
                  </label>
                  <div class="ff-ui">
                    <ui-smart-dropdown
                      [formControl]="getCtrl(field.controlName)"
                      [options]="getDropdownOptions(field.controlName)"
                      placeholder="Select...">
                    </ui-smart-dropdown>
                  </div>
                </div>

                <!-- Checkbox -->
                <div class="ff-checkbox" *ngIf="field.type === 'checkbox'">
                  <input type="checkbox" class="form-check-input"
                         [formControl]="getCtrl(field.controlName)"
                         [id]="field.controlName" />
                  <label class="form-check-label" [for]="field.controlName">
                    {{ field.displayName }}
                  </label>
                </div>

                <!-- Validation error -->
                <div class="ff-error" *ngIf="isInvalidField(field)">
                  {{ field.requiredMsg || (field.displayName + ' is required') }}
                </div>

              </div>
            </ng-container>
          </div>
        </div>
      </div>
    </ng-container>

  </div>
</div>

<!-- Loading / Error states -->
<div *ngIf="loading" style="padding:40px;text-align:center;color:#94A3B8">
  Loading decisions…
</div>
<div *ngIf="!loading && errorMsg" style="padding:20px;color:#dc3545">
  {{ errorMsg }}
</div>
