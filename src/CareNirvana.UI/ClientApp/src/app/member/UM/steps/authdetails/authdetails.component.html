<form class="auth-details" [formGroup]="form">

  <!-- Enrollment Details -->
  <div class="section-card">
    <div class="section-header">
      <span class="section-icon"><mat-icon>badge</mat-icon></span>
      <span class="section-acc-icon open">▸</span>
      <div class="section-title">Enrollment Details</div>
    </div>

    <div class="selection-container">
      <div class="rounded-box"
           *ngFor="let enr of memberEnrollments; let i = index"
           (click)="selectEnrollment(i)"
           [ngClass]="{ 'selected': selectedDiv === (i + 1) }">

        <div class="pairs">
          <div class="pair-row" *ngFor="let pair of getEnrollmentDisplayPairs(enr)">
            <label class="label key">{{ pair.label }}</label>
            <label class="label value" [title]="pair.value">{{ pair.value }}</label>
          </div>
        </div>
      </div>
    </div>

    <div class="ff-error" *ngIf="!enrollmentSelect">
      Please select an Enrollment card.
    </div>
  </div>

  <!-- Auth Case + Auth Type -->
  <div class="section-card">
    <!--<div class="section-header">
      <span class="section-acc-icon open">▸</span>
      <div class="section-title">Auth Details</div>
    </div>-->

    <div class="grid" >
      <div class="ff-field">
        <div class="ff-outline"
             [class.ff-invalid]="form.get('authClassId')?.touched && form.get('authClassId')?.invalid">
          <div class="ff-float-label">Auth Case <span class="req-star">*</span></div>
          <div class="ff-body">
            <ui-smart-dropdown class="ff-ui"
                               label=""
                               placeholder="Select..."
                               [options]="authClassOptions"
                               formControlName="authClassId">
            </ui-smart-dropdown>
          </div>
        </div>
        <div class="ff-error" *ngIf="form.get('authClassId')?.touched && form.get('authClassId')?.invalid">
          Auth Case is required.
        </div>
      </div>

      <div class="ff-field">
        <div class="ff-outline"
             [class.ff-disabled]="!form.get('authClassId')?.value"
             [class.ff-invalid]="form.get('authTypeId')?.touched && form.get('authTypeId')?.invalid">
          <div class="ff-float-label">Auth Type <span class="req-star">*</span></div>
          <div class="ff-body">
            <ui-smart-dropdown class="ff-ui"
                               label=""
                               placeholder="Select..."
                               [options]="authTypeOptions"
                               formControlName="authTypeId">
            </ui-smart-dropdown>
          </div>
        </div>
        <div class="ff-error" *ngIf="form.get('authTypeId')?.touched && form.get('authTypeId')?.invalid">
          Auth Type is required.
        </div>
      </div>
      <div class="ff-hint" *ngIf="showAuthTypeFirstLoadHint">
        <span class="hint-icon">i</span>
        <span>Please select the <strong>Auth Case & Auth Type</strong> to continue.</span>
      </div>
    </div>
  </div>

  <!-- Dynamic Sections + Subsections -->
  <ng-container *ngIf="(templateId ?? 0) > 0">

    <ng-container *ngFor="let sec of renderSections">
      <div class="section-card" [attr.id]="sectionDomId(sec)">
        <div class="section-header" (click)="toggleSection(sec)">
          <span class="section-icon"><mat-icon>{{ getSectionIcon(sec.title) }}</mat-icon></span>
          <span class="section-acc-icon" [class.open]="sec.expanded">▸</span>
          <div class="section-title">{{ sec.title }}</div>
          <ng-container *ngIf="isProviderSection(sec) && getProviderRepeatSub(sec) as ps">
            <button type="button" class="pc-add-btn"
                    [disabled]="!canAddRepeat(ps)"
                    (click)="addRepeat(ps); $event.stopPropagation()">
              <mat-icon>person_add</mat-icon> Add Provider
            </button>
          </ng-container>
          <ng-container *ngIf="isDiagnosisSection(sec) && getDiagnosisRepeatSub(sec) as ds">
            <button type="button" class="dc-add-btn"
                    [disabled]="!canAddRepeat(ds)"
                    (click)="addRepeat(ds); $event.stopPropagation()">
              <mat-icon>add_circle</mat-icon> Add Diagnosis
            </button>
          </ng-container>
          <ng-container *ngIf="isServiceSection(sec) && getServiceRepeatSub(sec) as ss">
            <button type="button" class="sc-add-btn"
                    [disabled]="!canAddRepeat(ss)"
                    (click)="addRepeat(ss); $event.stopPropagation()">
              <mat-icon>add_circle</mat-icon> Add Procedure
            </button>
          </ng-container>
        </div>

        <ng-container *ngIf="sec.expanded">

          <div *ngIf="sectionValidationMessages[sec.title]?.length" class="validation-messages">
            <div *ngFor="let msg of sectionValidationMessages[sec.title]" class="text-danger">
              {{ msg }}
            </div>
          </div>


          <!-- Section-level action buttons (hidden for provider — moved into cards) -->
          <ng-container *ngIf="!isProviderSection(sec)">
            <ng-container *ngIf="getActionButtons(sec.fields) as secBtns">
              <div class="ff-buttonbar" *ngIf="secBtns.length">
                <button type="button" class="ff-action-btn"
                        *ngFor="let b of secBtns"
                        [disabled]="!isActionButtonEnabled(b)"
                        (click)="onActionButtonClick(b)">
                  {{ b.buttonText || b.displayName }}
                </button>
              </div>
            </ng-container>
          </ng-container>

          <!-- =========================
               SECTION FIELDS (NON-REPEAT)
          ========================= -->
          <ng-container *ngIf="!sec.repeat?.enabled; else sectionRepeatTpl">
            <div class="grid">
              <ng-container *ngFor="let f of getNonActionFields(sec.fields)">
                <ng-container *ngIf="isVisible(f)">
                  <ng-container *ngIf="form.get(f.controlName) as ctrl">

                    <!-- Checkbox -->
                    <ng-container *ngIf="f.type === 'checkbox'; else outlinedField">
                      <div class="ff-field">
                        <div class="ff-checkbox" [class.ff-disabled]="ctrl.disabled">
                          <input type="checkbox" class="form-check-input" [formControlName]="f.controlName" />
                          <label class="form-check-label ff-checkbox-text">
                            {{ f.displayName }}
                            <span class="req-star" *ngIf="f.required">*</span>
                          </label>
                        </div>
                        <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">
                          {{ f.requiredMsg || (f.displayName + ' is required') }}
                        </div>
                      </div>
                    </ng-container>

                    <!-- Outlined -->
                    <ng-template #outlinedField>
                      <div class="ff-field"
                           [class.ff-span-all]="isFullRowField(f) && f.type !== 'search'"
                           [class.ff-span-2]="f.type === 'search'">
                        <div class="ff-outline" [class.ff-disabled]="ctrl.disabled" [class.ff-invalid]="ctrl.touched && ctrl.invalid">
                          <div class="ff-float-label">
                            {{ f.displayName }}
                            <span class="req-star" *ngIf="f.required">*</span>
                          </div>

                          <div class="ff-body">
                            <ng-container [ngSwitch]="f.type">

                              <ng-container *ngSwitchCase="'select'">
                                <ui-smart-dropdown class="ff-ui"
                                                   label=""
                                                   placeholder="Select..."
                                                   [options]="getDropdownOptions(f.controlName)"
                                                   [formControlName]="f.controlName">
                                </ui-smart-dropdown>
                              </ng-container>

                              <ng-container *ngSwitchCase="'datetime-local'">
                                <ui-datetime-picker class="ff-ui"
                                                    placeholderDate="mm/dd/yyyy"
                                                    placeholderDateTime="mm/dd/yyyy --:--"
                                                    [dateOnly]="!!f.dateOnly"
                                                    [formControlName]="f.controlName">
                                </ui-datetime-picker>
                              </ng-container>

                              <ng-container *ngSwitchCase="'textarea'">
                                <textarea class="ff-input ff-textarea"
                                          rows="3"
                                          [formControlName]="f.controlName"></textarea>
                              </ng-container>

                              <!-- SEARCH -->
                              <ng-container *ngSwitchCase="'search'">
                                <ui-smart-lookup class="ff-ui ff-lookup"
                                                 [placeholder]="getLookupPlaceholder(f)"
                                                 [minChars]="getLookupMinChars(f)"
                                                 [debounceMs]="getLookupDebounceMs(f)"
                                                 [limit]="getLookupLimit(f)"
                                                 [searchFn]="getLookupSearchFn(f)"
                                                 [displayWith]="getLookupDisplayWith(f)"
                                                 [trackBy]="getLookupTrackBy(f)"
                                                 [formControlName]="f.controlName"
                                                 (selected)="onLookupSelected(f, $event)"
                                                 (textChange)="onLookupTextChange(f, $event)"
                                                 (cleared)="onLookupCleared(f)">
                                </ui-smart-lookup>
                              </ng-container>

                              <ng-container *ngSwitchDefault>
                                <input class="ff-input" type="text" [formControlName]="f.controlName" />
                              </ng-container>

                            </ng-container>
                          </div>
                        </div>

                        <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">
                          {{ f.requiredMsg || (f.displayName + ' is required') }}
                        </div>
                      </div>
                    </ng-template>

                  </ng-container>
                </ng-container>
              </ng-container>
            </div>
          </ng-container>

          <!-- =========================
               SECTION FIELDS (REPEAT)
          ========================= -->
          <ng-template #sectionRepeatTpl>

            <!-- Provider card layout (section-level) -->
            <ng-container *ngIf="isProviderRepeatGroup(sec); else diagOrNormalSecRepeat">
              <div class="pc-grid">
                <ng-container *ngFor="let inst of sec.instances; trackBy: trackProvIdx">
                  <div class="pc">
                    <div class="pc-card" [class.pc-card--filled]="hasProviderData(inst)"
                         [class.pc-card--oon]="getProviderNetworkStatus(inst) === 'Out-of-Network'">

                      <!-- Top row: role dropdown + edit + delete -->
                      <div class="pc-card-top">
                        <ng-container *ngIf="getProvRoleField(inst) as rf">
                          <ng-container *ngIf="form.get(rf.controlName) as rc">
                            <div class="pc-role-wrap pc-role-bordered">
                              <ui-smart-dropdown class="ff-ui pc-dropdown" label="{{ rf.displayName }}" placeholder="Select role..."
                                [options]="getDropdownOptions(rf.controlName)" [formControlName]="rf.controlName">
                              </ui-smart-dropdown>
                            </div>
                          </ng-container>
                        </ng-container>
                        <div class="dc-top-actions">
                          <button type="button" class="dc-top-btn dc-top-btn--edit"
                                  *ngIf="hasProviderData(inst) && !isProviderInEditMode(inst)"
                                  (click)="editProvider(inst)" title="Edit">
                            <mat-icon class="dc-action-icon">edit</mat-icon>
                          </button>
                          <button type="button" class="dc-top-btn dc-top-btn--delete"
                                  (click)="hasProviderData(inst) ? clearProviderData(inst) : removeRepeat(sec, inst.index)">
                            <mat-icon class="dc-action-icon">delete</mat-icon>
                          </button>
                        </div>
                      </div>

                      <!-- Search: visible when NO provider selected OR in edit mode -->
                      <ng-container *ngIf="!hasProviderSelected(inst)">
                        <ng-container *ngIf="getProvSearchField(inst) as sf">
                          <ng-container *ngIf="form.get(sf.controlName) as sc">
                            <div class="dc-search-row">
                              <div class="pc-search pc-search-bordered">
                                <ui-smart-lookup class="ff-ui pc-search-input"
                                  [placeholder]="getLookupPlaceholder(sf)" [minChars]="getLookupMinChars(sf)"
                                  [debounceMs]="getLookupDebounceMs(sf)" [limit]="getLookupLimit(sf)"
                                  [searchFn]="getLookupSearchFn(sf)" [displayWith]="getLookupDisplayWith(sf)"
                                  [trackBy]="getLookupTrackBy(sf)" [formControlName]="sf.controlName"
                                  (selected)="onProviderLookupSelected(sf, inst, $event)"
                                  (textChange)="onLookupTextChange(sf, $event)"
                                  (cleared)="onLookupCleared(sf)">
                                </ui-smart-lookup>
                              </div>
                              <button type="button" class="dc-cancel-btn"
                                      *ngIf="isProviderInEditMode(inst)"
                                      (click)="cancelEditProvider(inst)">
                                Cancel
                              </button>
                            </div>
                          </ng-container>
                        </ng-container>
                        <ng-container *ngIf="getProvCardBtns(sec, inst) as cbtns">
                          <div class="pc-actions" *ngIf="cbtns.length">
                            <button type="button" class="pc-action-btn" *ngFor="let b of cbtns"
                                    [disabled]="!isActionButtonEnabled(b)" (click)="onActionButtonClick(b)">
                              {{ b.buttonText || b.displayName }}
                            </button>
                          </div>
                        </ng-container>

                        <!-- Show current provider info while editing -->
                        <ng-container *ngIf="isProviderInEditMode(inst)">
                          <div class="pc-info pc-info--editing">
                            <div class="pc-info-header">
                              <div class="pc-info-name-row">
                                <span class="pc-info-name">{{ getProviderFullName(inst) }}</span>
                              </div>
                            </div>
                            <div class="pc-info-details">
                              <div class="pc-info-line"><strong>NPI:</strong> {{ getProviderNpi(inst) || '-' }}</div>
                              <div class="pc-info-line"><strong>Phone:</strong> {{ getProviderPhone(inst) }} <span class="pc-info-sep">&middot;</span> <strong>Fax:</strong> {{ getProviderFax(inst) }}</div>
                            </div>
                          </div>
                        </ng-container>

                        <!-- Empty state when not editing -->
                        <div class="pc-empty-state" *ngIf="!isProviderInEditMode(inst)">
                          <mat-icon class="pc-empty-icon">person_search</mat-icon>
                          <span>Search and select a provider</span>
                        </div>
                      </ng-container>

                      <!-- Provider Info Card: visible when provider IS selected and NOT in edit mode -->
                      <ng-container *ngIf="hasProviderSelected(inst)">
                        <div class="pc-info">
                          <div class="pc-info-header">
                            <div class="pc-info-name-row">
                              <span class="pc-info-name">{{ getProviderFullName(inst) }}</span>
                              <span class="pc-network-badge"
                                    [class.pc-badge--in]="getProviderNetworkStatus(inst) === 'In-Network'"
                                    [class.pc-badge--out]="getProviderNetworkStatus(inst) === 'Out-of-Network'">
                                <span class="pc-badge-dot"></span>
                                {{ getProviderNetworkStatus(inst) }}
                              </span>
                            </div>
                          </div>
                          <div class="pc-info-details">
                            <div class="pc-info-line" *ngIf="getProviderNpi(inst) || getProviderSpecialty(inst)">
                              <span *ngIf="getProviderNpi(inst)"><strong>NPI:</strong> {{ getProviderNpi(inst) }}</span>
                              <span *ngIf="getProviderNpi(inst) && getProviderSpecialty(inst)" class="pc-info-sep">&middot;</span>
                              <span *ngIf="getProviderSpecialty(inst)">{{ getProviderSpecialty(inst) }}</span>
                            </div>
                            <div class="pc-info-line">
                              <strong>Phone:</strong> {{ getProviderPhone(inst) }}
                              <span class="pc-info-sep">&middot;</span>
                              <strong>Fax:</strong> {{ getProviderFax(inst) }}
                            </div>
                            <div class="pc-info-line pc-info-org" *ngIf="getProviderOrganization(inst)">
                              {{ getProviderOrganization(inst) }}
                            </div>
                            <div class="pc-info-line pc-info-addr" *ngIf="getProviderAddress(inst)">
                              {{ getProviderAddress(inst) }}
                            </div>
                          </div>
                          <div class="pc-oon-warning" *ngIf="getProviderNetworkStatus(inst) === 'Out-of-Network'">
                            <mat-icon class="pc-oon-icon">info</mat-icon>
                            <span>Out-of-Network provider — additional member cost share may apply</span>
                          </div>
                        </div>
                      </ng-container>

                    </div>
                  </div>
                </ng-container>
              </div>
            </ng-container>

            <!-- ═══ DIAGNOSIS / ICD CARDS (section-level) ═══ -->
            <ng-template #diagOrNormalSecRepeat>
              <ng-container *ngIf="isDiagnosisRepeatGroup(sec); else serviceOrNormalSecRepeat">
                <div class="dc-grid">
                  <ng-container *ngFor="let inst of sec.instances; trackBy: trackProvIdx">
                    <div class="dc">
                      <div class="dc-card"
                           [class.dc-card--filled]="hasDiagnosisSelected(inst)"
                           [class.dc-card--primary]="isDiagnosisPrimary(inst)">

                        <!-- Top row: Code Type + Primary + Edit + Delete — all in one row -->
                        <div class="dc-card-top">
                          <ng-container *ngIf="getDiagCodeTypeField(inst) as ctf">
                            <ng-container *ngIf="form.get(ctf.controlName) as ctc">
                              <div class="dc-codetype-wrap">
                                <ui-smart-dropdown class="ff-ui dc-dropdown"
                                  label="{{ ctf.displayName }}" placeholder="Select code type..."
                                  [options]="getDropdownOptions(ctf.controlName)"
                                  [formControlName]="ctf.controlName">
                                </ui-smart-dropdown>
                              </div>
                            </ng-container>
                          </ng-container>

                          <label class="dc-primary-radio" [class.dc-primary-radio--active]="isDiagnosisPrimary(inst)">
                            <input type="radio" name="primaryDiagnosis"
                                   [checked]="isDiagnosisPrimary(inst)"
                                   (change)="setDiagnosisPrimary(inst)" />
                            <span class="dc-primary-label">Primary</span>
                          </label>

                          <div class="dc-top-actions">
                            <button type="button" class="dc-top-btn dc-top-btn--edit"
                                    *ngIf="hasDiagnosisSelected(inst)"
                                    (click)="editDiagnosis(inst)" title="Edit">
                              <mat-icon class="dc-action-icon">edit</mat-icon>
                            </button>
                            <button type="button" class="dc-top-btn dc-top-btn--delete"
                                    (click)="hasDiagnosisSelected(inst) ? clearDiagnosisData(inst) : removeRepeat(sec, inst.index)">
                              <mat-icon class="dc-action-icon">delete</mat-icon>
                            </button>
                          </div>
                        </div>

                        <!-- Search: visible when NO ICD selected OR in edit mode -->
                        <ng-container *ngIf="!hasDiagnosisSelected(inst)">
                          <ng-container *ngIf="getDiagSearchField(inst) as sf">
                            <ng-container *ngIf="form.get(sf.controlName) as sc">
                              <div class="dc-search-row">
                                <div class="dc-search dc-search-bordered">
                                  <ui-smart-lookup class="ff-ui dc-search-input"
                                    [placeholder]="getLookupPlaceholder(sf)"
                                    [minChars]="getLookupMinChars(sf)"
                                    [debounceMs]="getLookupDebounceMs(sf)"
                                    [limit]="getLookupLimit(sf)"
                                    [searchFn]="getLookupSearchFn(sf)"
                                    [displayWith]="getLookupDisplayWith(sf)"
                                    [trackBy]="getLookupTrackBy(sf)"
                                    [formControlName]="sf.controlName"
                                    (selected)="onDiagnosisLookupSelected(sf, inst, $event)"
                                    (textChange)="onLookupTextChange(sf, $event)"
                                    (cleared)="onDiagnosisLookupCleared(sf, inst)">
                                  </ui-smart-lookup>
                                </div>
                                <button type="button" class="dc-cancel-btn"
                                        *ngIf="isDiagnosisInEditMode(inst)"
                                        (click)="cancelEditDiagnosis(inst)">
                                  Cancel
                                </button>
                              </div>
                            </ng-container>
                          </ng-container>
                          <div class="dc-empty-state" *ngIf="!isDiagnosisInEditMode(inst)">
                            <mat-icon class="dc-empty-icon">search</mat-icon>
                            <span>Search for an ICD code</span>
                          </div>
                        </ng-container>

                        <!-- ICD Info: visible when ICD IS selected and NOT in edit mode -->
                        <ng-container *ngIf="hasDiagnosisSelected(inst)">
                          <div class="dc-info">
                            <div class="dc-info-inline">
                              <span class="dc-icd-code">{{ getDiagnosisCode(inst) }}</span>
                              <span class="dc-icd-desc">{{ getDiagnosisDescription(inst) }}</span>
                              <span class="dc-primary-badge" *ngIf="isDiagnosisPrimary(inst)">Primary</span>
                            </div>
                            <!--<div class="dc-info-meta" *ngIf="getDiagnosisCodeType(inst)">
                              <span class="dc-meta-label">Code Type:</span>
                              <span class="dc-meta-value">{{ getDiagnosisCodeType(inst) }}</span>
                            </div>-->
                          </div>
                        </ng-container>

                      </div>
                    </div>
                  </ng-container>
                </div>
              </ng-container>
            </ng-template>

            <!-- ═══ SERVICE / PROCEDURE CARDS (section-level) ═══ -->
            <ng-template #serviceOrNormalSecRepeat>
              <ng-container *ngIf="isServiceRepeatGroup(sec); else normalSecRepeat">
                <div class="sc-list">
                  <ng-container *ngFor="let inst of sec.instances; trackBy: trackProvIdx">
                    <div class="sc-card" [class.sc-card--filled]="hasServiceData(inst)">
                      <div class="sc-card-top">
                        <!--<span class="sc-number">{{ sec.repeat?.instanceLabel }} #{{ inst.index }}</span>-->
                        <div class="dc-top-actions">
                          <button type="button" class="dc-top-btn dc-top-btn--edit" *ngIf="hasServiceData(inst) && !isServiceInEditMode(inst)" (click)="editService(inst)" title="Edit"><mat-icon class="dc-action-icon">edit</mat-icon></button>
                          <button type="button" class="dc-top-btn dc-top-btn--delete" (click)="hasServiceData(inst) ? clearServiceData(inst) : removeRepeat(sec, inst.index)"><mat-icon class="dc-action-icon">delete</mat-icon></button>
                        </div>
                      </div>
                      <ng-container *ngIf="!hasServiceSelected(inst)">
                        <ng-container *ngIf="getServiceSearchField(inst) as sf">
                          <ng-container *ngIf="form.get(sf.controlName) as sc">
                            <div class="dc-search-row"><div class="sc-search"><ui-smart-lookup class="ff-ui ff-lookup sc-search-input" [placeholder]="getLookupPlaceholder(sf)" [minChars]="getLookupMinChars(sf)" [debounceMs]="getLookupDebounceMs(sf)" [limit]="getLookupLimit(sf)" [searchFn]="getLookupSearchFn(sf)" [displayWith]="getLookupDisplayWith(sf)" [trackBy]="getLookupTrackBy(sf)" [formControlName]="sf.controlName" (selected)="onServiceLookupSelected(sf, inst, $event)" (textChange)="onLookupTextChange(sf, $event)" (cleared)="onServiceLookupCleared(sf, inst)"></ui-smart-lookup></div><button type="button" class="dc-cancel-btn" *ngIf="isServiceInEditMode(inst)" (click)="cancelEditService(inst)">Cancel</button></div>
                          </ng-container>
                        </ng-container>
                        <div class="sc-identity sc-identity--muted" *ngIf="isServiceInEditMode(inst)"><span class="sc-code">{{ getServiceCode(inst) }}</span><span class="sc-desc">{{ getServiceDescription(inst) }}</span></div>
                        <div class="sc-empty" *ngIf="!isServiceInEditMode(inst)"><mat-icon class="sc-empty-icon">search</mat-icon><span>Search for a procedure code</span></div>
                      </ng-container>
                      <ng-container *ngIf="hasServiceSelected(inst)">
                        <div class="sc-identity"><span class="sc-code">{{ getServiceCode(inst) }}</span><span class="sc-desc">{{ getServiceDescription(inst) }}</span></div>
                      </ng-container>
                      <div class="sc-body">
                        <ng-container *ngFor="let f of getServiceBodyFields(inst)">
                          <ng-container *ngIf="isVisible(f)">
                            <ng-container *ngIf="form.get(f.controlName) as ctrl">
                              <div class="sc-field" [ngClass]="{'sc-field--select': f.type === 'select', 'sc-field--date': f.type === 'datetime-local', 'sc-field--num': f.type === 'number'}">
                                <div class="ff-outline" [class.ff-disabled]="ctrl.disabled" [class.ff-invalid]="ctrl.touched && ctrl.invalid">
                                  <div class="ff-float-label">{{ f.displayName }}<span class="req-star" *ngIf="f.required">*</span></div>
                                  <div class="ff-body">
                                    <ng-container [ngSwitch]="f.type">
                                      <ui-smart-dropdown *ngSwitchCase="'select'" class="ff-ui" label="" placeholder="Select..." [options]="getDropdownOptions(f.controlName)" [formControlName]="f.controlName"></ui-smart-dropdown>
                                      <ui-datetime-picker *ngSwitchCase="'datetime-local'" class="ff-ui" placeholderDate="mm/dd/yyyy" [dateOnly]="!!f.dateOnly" [formControlName]="f.controlName"></ui-datetime-picker>
                                      <ui-smart-lookup *ngSwitchCase="'search'" class="ff-ui ff-lookup" [placeholder]="getLookupPlaceholder(f)" [minChars]="getLookupMinChars(f)" [debounceMs]="getLookupDebounceMs(f)" [limit]="getLookupLimit(f)" [searchFn]="getLookupSearchFn(f)" [displayWith]="getLookupDisplayWith(f)" [trackBy]="getLookupTrackBy(f)" [formControlName]="f.controlName" (selected)="onLookupSelected(f, $event)" (textChange)="onLookupTextChange(f, $event)" (cleared)="onLookupCleared(f)"></ui-smart-lookup>
                                      <textarea *ngSwitchCase="'textarea'" class="ff-input ff-textarea" rows="2" [formControlName]="f.controlName"></textarea>
                                      <input *ngSwitchDefault class="ff-input" [type]="f.type === 'number' ? 'number' : 'text'" [formControlName]="f.controlName" />
                                    </ng-container>
                                  </div>
                                </div>
                                <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">{{ f.requiredMsg || (f.displayName + ' is required') }}</div>
                              </div>
                            </ng-container>
                          </ng-container>
                        </ng-container>
                      </div>
                    </div>
                  </ng-container>
                </div>
              </ng-container>
            </ng-template>

            <!-- Normal section repeat (non-provider) -->
            <ng-template #normalSecRepeat>
            <div class="ff-repeat-wrap">
              <ng-container *ngFor="let inst of sec.instances">
                <div class="ff-repeat-group">
                  <div class="ff-repeat-header">
                    <div class="ff-repeat-title">{{ sec.repeat?.instanceLabel }} #{{ inst.index }}</div>
                  </div>
                  <ng-container *ngIf="getActionButtons(inst.fields) as repBtns">
                    <div class="ff-buttonbar" *ngIf="repBtns.length">
                      <button type="button" class="ff-action-btn" *ngFor="let b of repBtns"
                              [disabled]="!isActionButtonEnabled(b)" (click)="onActionButtonClick(b)">
                        {{ b.buttonText || b.displayName }}
                      </button>
                    </div>
                  </ng-container>
                  <div class="grid ff-repeat-grid">
                    <ng-container *ngFor="let f of getNonActionFields(inst.fields)">
                      <ng-container *ngIf="isVisible(f)">
                        <ng-container *ngIf="form.get(f.controlName) as ctrl">
                          <ng-container *ngIf="f.type === 'checkbox'; else outlinedRep">
                            <div class="ff-field">
                              <div class="ff-checkbox" [class.ff-disabled]="ctrl.disabled">
                                <input type="checkbox" class="form-check-input" [formControlName]="f.controlName" />
                                <label class="form-check-label ff-checkbox-text">{{ f.displayName }}<span class="req-star" *ngIf="f.required">*</span></label>
                              </div>
                            </div>
                          </ng-container>
                          <ng-template #outlinedRep>
                            <div class="ff-field" [class.ff-span-all]="isFullRowField(f) && f.type !== 'search'" [class.ff-span-2]="f.type === 'search'">
                              <div class="ff-outline" [class.ff-disabled]="ctrl.disabled" [class.ff-invalid]="ctrl.touched && ctrl.invalid">
                                <div class="ff-float-label">{{ f.displayName }}<span class="req-star" *ngIf="f.required">*</span></div>
                                <div class="ff-body">
                                  <ng-container [ngSwitch]="f.type">
                                    <ng-container *ngSwitchCase="'select'"><ui-smart-dropdown class="ff-ui" label="" placeholder="Select..." [options]="getDropdownOptions(f.controlName)" [formControlName]="f.controlName"></ui-smart-dropdown></ng-container>
                                    <ng-container *ngSwitchCase="'datetime-local'"><ui-datetime-picker class="ff-ui" placeholderDate="mm/dd/yyyy" placeholderDateTime="mm/dd/yyyy --:--" [dateOnly]="!!f.dateOnly" [formControlName]="f.controlName"></ui-datetime-picker></ng-container>
                                    <ng-container *ngSwitchCase="'textarea'"><textarea class="ff-input ff-textarea" rows="3" [formControlName]="f.controlName"></textarea></ng-container>
                                    <ng-container *ngSwitchCase="'search'"><ui-smart-lookup class="ff-ui ff-lookup" [placeholder]="getLookupPlaceholder(f)" [minChars]="getLookupMinChars(f)" [debounceMs]="getLookupDebounceMs(f)" [limit]="getLookupLimit(f)" [searchFn]="getLookupSearchFn(f)" [displayWith]="getLookupDisplayWith(f)" [trackBy]="getLookupTrackBy(f)" [formControlName]="f.controlName" (selected)="onLookupSelected(f, $event)" (textChange)="onLookupTextChange(f, $event)" (cleared)="onLookupCleared(f)"></ui-smart-lookup></ng-container>
                                    <ng-container *ngSwitchDefault><input class="ff-input" type="text" [formControlName]="f.controlName" /></ng-container>
                                  </ng-container>
                                </div>
                              </div>
                              <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">{{ f.requiredMsg || (f.displayName + ' is required') }}</div>
                            </div>
                          </ng-template>
                        </ng-container>
                      </ng-container>
                    </ng-container>
                    <div class="ff-repeat-cell" *ngIf="sec.repeat?.showControls">
                      <button type="button" class="ff-repeat-btn" [disabled]="!canAddRepeat(sec)" (click)="addRepeat(sec)" title="Add">+</button>
                      <button type="button" class="ff-repeat-btn danger" [disabled]="!canRemoveRepeat(sec)" (click)="removeRepeat(sec, inst.index)" title="Remove">−</button>
                    </div>
                  </div>
                </div>
              </ng-container>
            </div>
            </ng-template>
          </ng-template>

          <!-- Subsections (recursive) -->
          <ng-container *ngFor="let sub of sec.subsections">
            <ng-container *ngTemplateOutlet="subTpl; context: { $implicit: sub, depth: 0, parentSec: sec }"></ng-container>
          </ng-container>

        </ng-container>
      </div>
    </ng-container>

  </ng-container>

  <!-- Save button -->
  <!--<div class="ff-actions" style="display:flex; justify-content:flex-end; gap:10px; margin-top: 14px;">
    <button type="button" class="btn btn-primary" (click)="save()" [disabled]="isSaving">
      {{ isSaving ? 'Saving...' : 'Save' }}
    </button>
  </div>-->
  <!-- Recursive subsection template -->
  <ng-template #subTpl let-sub let-depth="depth" let-parentSec="parentSec">
    <div class="sub-card" [class.sub-nested]="depth > 0">
      <!--<div class="sub-float-label">{{ sub.title }}</div>-->
      <!-- Subsection-level action buttons -->
      <ng-container *ngIf="getActionButtons(sub.fields) as subBtns">
        <div class="ff-buttonbar" *ngIf="subBtns.length">
          <button type="button"
                  class="ff-action-btn"
                  *ngFor="let b of subBtns"
                  [disabled]="!isActionButtonEnabled(b)"
                  (click)="onActionButtonClick(b)">
            {{ b.buttonText || b.displayName }}
          </button>
        </div>
      </ng-container>



      <!-- =========================
           SUBSECTION FIELDS (NON-REPEAT)
      ========================= -->
      <ng-container *ngIf="!sub.repeat?.enabled; else subRepeatTpl">
        <div class="grid">
          <ng-container *ngFor="let f of getNonActionFields(sub.fields)">
            <ng-container *ngIf="isVisible(f)">
              <ng-container *ngIf="form.get(f.controlName) as ctrl">
                <!-- (same as your existing subsection field rendering) -->
                <!-- Checkbox + outlined controls exactly like before -->
                <!-- KEEP YOUR CURRENT BLOCK HERE if you prefer -->
                <ng-container *ngIf="f.type === 'checkbox'; else outlinedSub">
                  <div class="ff-field">
                    <div class="ff-checkbox" [class.ff-disabled]="ctrl.disabled">
                      <input type="checkbox" class="form-check-input" [formControlName]="f.controlName" />
                      <label class="form-check-label ff-checkbox-text">
                        {{ f.displayName }}
                        <span class="req-star" *ngIf="f.required">*</span>
                      </label>
                    </div>
                    <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">
                      {{ f.requiredMsg || (f.displayName + ' is required') }}
                    </div>
                  </div>
                </ng-container>

                <ng-template #outlinedSub>
                  <div class="ff-field"
                       [class.ff-span-all]="isFullRowField(f) && f.type !== 'search'"
                       [class.ff-span-2]="f.type === 'search'">
                    <div class="ff-outline" [class.ff-disabled]="ctrl.disabled" [class.ff-invalid]="ctrl.touched && ctrl.invalid">
                      <div class="ff-float-label">
                        {{ f.displayName }}
                        <span class="req-star" *ngIf="f.required">*</span>
                      </div>

                      <div class="ff-body">
                        <ng-container [ngSwitch]="f.type">

                          <ng-container *ngSwitchCase="'select'">
                            <ui-smart-dropdown class="ff-ui"
                                               label=""
                                               placeholder="Select..."
                                               [options]="getDropdownOptions(f.controlName)"
                                               [formControlName]="f.controlName">
                            </ui-smart-dropdown>
                          </ng-container>

                          <ng-container *ngSwitchCase="'datetime-local'">
                            <ui-datetime-picker class="ff-ui"
                                                placeholderDate="mm/dd/yyyy"
                                                placeholderDateTime="mm/dd/yyyy --:--"
                                                [dateOnly]="!!f.dateOnly"
                                                [formControlName]="f.controlName">
                            </ui-datetime-picker>
                          </ng-container>

                          <ng-container *ngSwitchCase="'textarea'">
                            <textarea class="ff-input ff-textarea"
                                      rows="3"
                                      [formControlName]="f.controlName"></textarea>
                          </ng-container>

                          <ng-container *ngSwitchCase="'search'">
                            <ui-smart-lookup class="ff-ui ff-lookup"
                                             [placeholder]="getLookupPlaceholder(f)"
                                             [minChars]="getLookupMinChars(f)"
                                             [debounceMs]="getLookupDebounceMs(f)"
                                             [limit]="getLookupLimit(f)"
                                             [searchFn]="getLookupSearchFn(f)"
                                             [displayWith]="getLookupDisplayWith(f)"
                                             [trackBy]="getLookupTrackBy(f)"
                                             [formControlName]="f.controlName"
                                             (selected)="onLookupSelected(f, $event)"
                                             (textChange)="onLookupTextChange(f, $event)"
                                             (cleared)="onLookupCleared(f)">
                            </ui-smart-lookup>
                          </ng-container>

                          <ng-container *ngSwitchDefault>
                            <input class="ff-input" type="text" [formControlName]="f.controlName" />
                          </ng-container>

                        </ng-container>
                      </div>
                    </div>

                    <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">
                      {{ f.requiredMsg || (f.displayName + ' is required') }}
                    </div>
                  </div>
                </ng-template>
              </ng-container>
            </ng-container>
          </ng-container>
        </div>
      </ng-container>

      <!-- =========================
           SUBSECTION FIELDS (REPEAT)
      ========================= -->
      <ng-template #subRepeatTpl>

        <!-- ═══ PROVIDER CARDS ═══ -->
        <ng-container *ngIf="isProviderRepeatGroup(sub); else diagOrNormalSubRepeat">
          <div class="pc-grid">
            <ng-container *ngFor="let inst of sub.instances; trackBy: trackProvIdx">
              <div class="pc">
                <div class="pc-card" [class.pc-card--filled]="hasProviderData(inst)"
                     [class.pc-card--oon]="getProviderNetworkStatus(inst) === 'Out-of-Network'">

                  <!-- Top row: role dropdown + edit + delete -->
                  <div class="pc-card-top">
                    <ng-container *ngIf="getProvRoleField(inst) as rf">
                      <ng-container *ngIf="form.get(rf.controlName) as rc">
                        <div class="pc-role-wrap pc-role-bordered">
                          <ui-smart-dropdown class="ff-ui pc-dropdown"
                            label="{{ rf.displayName }}" placeholder="Select role..."
                            [options]="getDropdownOptions(rf.controlName)"
                            [formControlName]="rf.controlName">
                          </ui-smart-dropdown>
                        </div>
                      </ng-container>
                    </ng-container>
                    <div class="dc-top-actions">
                      <button type="button" class="dc-top-btn dc-top-btn--edit"
                              *ngIf="hasProviderData(inst) && !isProviderInEditMode(inst)"
                              (click)="editProvider(inst)" title="Edit">
                        <mat-icon class="dc-action-icon">edit</mat-icon>
                      </button>
                      <button type="button" class="dc-top-btn dc-top-btn--delete"
                              (click)="hasProviderData(inst) ? clearProviderData(inst) : removeRepeat(sub, inst.index)">
                        <mat-icon class="dc-action-icon">delete</mat-icon>
                      </button>
                    </div>
                  </div>

                  <!-- Search: visible when NO provider selected OR in edit mode -->
                  <ng-container *ngIf="!hasProviderSelected(inst)">
                    <ng-container *ngIf="getProvSearchField(inst) as sf">
                      <ng-container *ngIf="form.get(sf.controlName) as sc">
                        <div class="dc-search-row">
                          <div class="pc-search pc-search-bordered">
                            <ui-smart-lookup class="ff-ui pc-search-input"
                              [placeholder]="getLookupPlaceholder(sf)"
                              [minChars]="getLookupMinChars(sf)"
                              [debounceMs]="getLookupDebounceMs(sf)"
                              [limit]="getLookupLimit(sf)"
                              [searchFn]="getLookupSearchFn(sf)"
                              [displayWith]="getLookupDisplayWith(sf)"
                              [trackBy]="getLookupTrackBy(sf)"
                              [formControlName]="sf.controlName"
                              (selected)="onProviderLookupSelected(sf, inst, $event)"
                              (textChange)="onLookupTextChange(sf, $event)"
                              (cleared)="onLookupCleared(sf)">
                            </ui-smart-lookup>
                          </div>
                          <button type="button" class="dc-cancel-btn"
                                  *ngIf="isProviderInEditMode(inst)"
                                  (click)="cancelEditProvider(inst)">
                            Cancel
                          </button>
                        </div>
                      </ng-container>
                    </ng-container>
                    <ng-container *ngIf="getProvCardBtns(parentSec, inst) as cbtns">
                      <div class="pc-actions" *ngIf="cbtns.length">
                        <button type="button" class="pc-action-btn"
                                *ngFor="let b of cbtns"
                                [disabled]="!isActionButtonEnabled(b)"
                                (click)="onActionButtonClick(b)">
                          {{ b.buttonText || b.displayName }}
                        </button>
                      </div>
                    </ng-container>

                    <!-- Show current provider info while editing -->
                    <ng-container *ngIf="isProviderInEditMode(inst)">
                      <div class="pc-info pc-info--editing">
                        <div class="pc-info-header">
                          <div class="pc-info-name-row">
                            <span class="pc-info-name">{{ getProviderFullName(inst) }}</span>
                          </div>
                        </div>
                        <div class="pc-info-details">
                          <div class="pc-info-line"><strong>NPI:</strong> {{ getProviderNpi(inst) || '-' }}</div>
                          <div class="pc-info-line"><strong>Phone:</strong> {{ getProviderPhone(inst) }} <span class="pc-info-sep">&middot;</span> <strong>Fax:</strong> {{ getProviderFax(inst) }}</div>
                        </div>
                      </div>
                    </ng-container>

                    <!-- Empty state when not editing -->
                    <div class="pc-empty-state" *ngIf="!isProviderInEditMode(inst)">
                      <mat-icon class="pc-empty-icon">person_search</mat-icon>
                      <span>Search and select a provider</span>
                    </div>
                  </ng-container>

                  <!-- Provider Info Card: visible when provider IS selected and NOT in edit mode -->
                  <ng-container *ngIf="hasProviderSelected(inst)">
                    <div class="pc-info">
                      <div class="pc-info-header">
                        <div class="pc-info-name-row">
                          <span class="pc-info-name">{{ getProviderFullName(inst) }}</span>
                          <span class="pc-network-badge"
                                [class.pc-badge--in]="getProviderNetworkStatus(inst) === 'In-Network'"
                                [class.pc-badge--out]="getProviderNetworkStatus(inst) === 'Out-of-Network'">
                            <span class="pc-badge-dot"></span>
                            {{ getProviderNetworkStatus(inst) }}
                          </span>
                        </div>
                      </div>
                      <div class="pc-info-details">
                        <div class="pc-info-line" *ngIf="getProviderNpi(inst) || getProviderSpecialty(inst)">
                          <span *ngIf="getProviderNpi(inst)"><strong>NPI:</strong> {{ getProviderNpi(inst) }}</span>
                          <span *ngIf="getProviderNpi(inst) && getProviderSpecialty(inst)" class="pc-info-sep">&middot;</span>
                          <span *ngIf="getProviderSpecialty(inst)">{{ getProviderSpecialty(inst) }}</span>
                        </div>
                        <div class="pc-info-line">
                          <strong>Phone:</strong> {{ getProviderPhone(inst) }}
                          <span class="pc-info-sep">&middot;</span>
                          <strong>Fax:</strong> {{ getProviderFax(inst) }}
                        </div>
                        <div class="pc-info-line pc-info-org" *ngIf="getProviderOrganization(inst)">
                          {{ getProviderOrganization(inst) }}
                        </div>
                        <div class="pc-info-line pc-info-addr" *ngIf="getProviderAddress(inst)">
                          {{ getProviderAddress(inst) }}
                        </div>
                      </div>
                      <div class="pc-oon-warning" *ngIf="getProviderNetworkStatus(inst) === 'Out-of-Network'">
                        <mat-icon class="pc-oon-icon">info</mat-icon>
                        <span>Out-of-Network provider — additional member cost share may apply</span>
                      </div>
                    </div>
                  </ng-container>

                </div>
              </div>
            </ng-container>
          </div>
        </ng-container>

        <!-- ═══ DIAGNOSIS / ICD CARDS (subsection-level) ═══ -->
        <ng-template #diagOrNormalSubRepeat>
          <ng-container *ngIf="isDiagnosisRepeatGroup(sub, parentSec); else serviceOrNormalSubRepeat">
            <div class="dc-grid">
              <ng-container *ngFor="let inst of sub.instances; trackBy: trackProvIdx">
                <div class="dc">
                  <div class="dc-card"
                       [class.dc-card--filled]="hasDiagnosisSelected(inst)"
                       [class.dc-card--primary]="isDiagnosisPrimary(inst)">

                    <!-- Top row: Code Type + Primary + Edit + Delete — all in one row -->
                    <div class="dc-card-top">
                      <ng-container *ngIf="getDiagCodeTypeField(inst) as ctf">
                        <ng-container *ngIf="form.get(ctf.controlName) as ctc">
                          <div class="dc-codetype-wrap">
                            <ui-smart-dropdown class="ff-ui dc-dropdown"
                              label="{{ ctf.displayName }}" placeholder="Select code type..."
                              [options]="getDropdownOptions(ctf.controlName)"
                              [formControlName]="ctf.controlName">
                            </ui-smart-dropdown>
                          </div>
                        </ng-container>
                      </ng-container>

                      <label class="dc-primary-radio" [class.dc-primary-radio--active]="isDiagnosisPrimary(inst)">
                        <input type="radio" name="primaryDiagnosisSub"
                               [checked]="isDiagnosisPrimary(inst)"
                               (change)="setDiagnosisPrimary(inst)" />
                        <span class="dc-primary-label">Primary</span>
                      </label>

                      <div class="dc-top-actions">
                        <button type="button" class="dc-top-btn dc-top-btn--edit"
                                *ngIf="hasDiagnosisSelected(inst)"
                                (click)="editDiagnosis(inst)" title="Edit">
                          <mat-icon class="dc-action-icon">edit</mat-icon>
                        </button>
                        <button type="button" class="dc-top-btn dc-top-btn--delete"
                                (click)="hasDiagnosisSelected(inst) ? clearDiagnosisData(inst) : removeRepeat(sub, inst.index)">
                          <mat-icon class="dc-action-icon">delete</mat-icon>
                        </button>
                      </div>
                    </div>

                    <!-- Search: visible when NO ICD selected OR in edit mode -->
                    <ng-container *ngIf="!hasDiagnosisSelected(inst)">
                      <ng-container *ngIf="getDiagSearchField(inst) as sf">
                        <ng-container *ngIf="form.get(sf.controlName) as sc">
                          <div class="dc-search-row">
                            <div class="dc-search dc-search-bordered">
                              <ui-smart-lookup class="ff-ui dc-search-input"
                                [placeholder]="getLookupPlaceholder(sf)"
                                [minChars]="getLookupMinChars(sf)"
                                [debounceMs]="getLookupDebounceMs(sf)"
                                [limit]="getLookupLimit(sf)"
                                [searchFn]="getLookupSearchFn(sf)"
                                [displayWith]="getLookupDisplayWith(sf)"
                                [trackBy]="getLookupTrackBy(sf)"
                                [formControlName]="sf.controlName"
                                (selected)="onDiagnosisLookupSelected(sf, inst, $event)"
                                (textChange)="onLookupTextChange(sf, $event)"
                                (cleared)="onDiagnosisLookupCleared(sf, inst)">
                              </ui-smart-lookup>
                            </div>
                            <button type="button" class="dc-cancel-btn"
                                    *ngIf="isDiagnosisInEditMode(inst)"
                                    (click)="cancelEditDiagnosis(inst)">
                              Cancel
                            </button>
                          </div>
                        </ng-container>
                      </ng-container>
                      <div class="dc-empty-state" *ngIf="!isDiagnosisInEditMode(inst)">
                        <mat-icon class="dc-empty-icon">search</mat-icon>
                        <span>Search for an ICD code</span>
                      </div>
                    </ng-container>

                    <!-- ICD Info: visible when ICD IS selected and NOT in edit mode -->
                    <ng-container *ngIf="hasDiagnosisSelected(inst)">
                      <div class="dc-info">
                        <div class="dc-info-inline">
                          <span class="dc-icd-code">{{ getDiagnosisCode(inst) }}</span>
                          <span class="dc-icd-desc">{{ getDiagnosisDescription(inst) }}</span>
                          <span class="dc-primary-badge" *ngIf="isDiagnosisPrimary(inst)">Primary</span>
                        </div>
                        <!--<div class="dc-info-meta" *ngIf="getDiagnosisCodeType(inst)">
                          <span class="dc-meta-label">Code Type:</span>
                          <span class="dc-meta-value">{{ getDiagnosisCodeType(inst) }}</span>
                        </div>-->
                      </div>
                    </ng-container>

                  </div>
                </div>
              </ng-container>
            </div>
          </ng-container>
        </ng-template>

        <!-- ═══ SERVICE / PROCEDURE CARDS (subsection-level) ═══ -->
        <ng-template #serviceOrNormalSubRepeat>
          <ng-container *ngIf="isServiceRepeatGroup(sub, parentSec); else normalSubRepeat">
            <div class="sc-list">
              <ng-container *ngFor="let inst of sub.instances; trackBy: trackProvIdx">
                <div class="sc-card" [class.sc-card--filled]="hasServiceData(inst)">
                  <!-- Top bar -->
                  <div class="sc-card-top">
                    <!--<span class="sc-number">{{ sub.repeat?.instanceLabel }} #{{ inst.index }}</span>-->
                    <div class="dc-top-actions">
                      <button type="button" class="dc-top-btn dc-top-btn--edit"
                              *ngIf="hasServiceData(inst) && !isServiceInEditMode(inst)"
                              (click)="editService(inst)" title="Edit">
                        <mat-icon class="dc-action-icon">edit</mat-icon>
                      </button>
                      <button type="button" class="dc-top-btn dc-top-btn--delete"
                              (click)="hasServiceData(inst) ? clearServiceData(inst) : removeRepeat(sub, inst.index)">
                        <mat-icon class="dc-action-icon">delete</mat-icon>
                      </button>
                    </div>
                  </div>

                  <!-- Search: when not selected or editing -->
                  <ng-container *ngIf="!hasServiceSelected(inst)">
                    <ng-container *ngIf="getServiceSearchField(inst) as sf">
                      <ng-container *ngIf="form.get(sf.controlName) as sc">
                        <div class="dc-search-row">
                          <div class="sc-search">
                            <ui-smart-lookup class="ff-ui ff-lookup sc-search-input"
                              [placeholder]="getLookupPlaceholder(sf)"
                              [minChars]="getLookupMinChars(sf)"
                              [debounceMs]="getLookupDebounceMs(sf)"
                              [limit]="getLookupLimit(sf)"
                              [searchFn]="getLookupSearchFn(sf)"
                              [displayWith]="getLookupDisplayWith(sf)"
                              [trackBy]="getLookupTrackBy(sf)"
                              [formControlName]="sf.controlName"
                              (selected)="onServiceLookupSelected(sf, inst, $event)"
                              (textChange)="onLookupTextChange(sf, $event)"
                              (cleared)="onServiceLookupCleared(sf, inst)">
                            </ui-smart-lookup>
                          </div>
                          <button type="button" class="dc-cancel-btn"
                                  *ngIf="isServiceInEditMode(inst)"
                                  (click)="cancelEditService(inst)">
                            Cancel
                          </button>
                        </div>
                      </ng-container>
                    </ng-container>
                    <!-- Current procedure display during edit -->
                    <div class="sc-identity sc-identity--muted" *ngIf="isServiceInEditMode(inst)">
                      <span class="sc-code">{{ getServiceCode(inst) }}</span>
                      <span class="sc-desc">{{ getServiceDescription(inst) }}</span>
                    </div>
                    <!-- Empty state -->
                    <div class="sc-empty" *ngIf="!isServiceInEditMode(inst)">
                      <mat-icon class="sc-empty-icon">search</mat-icon>
                      <span>Search for a procedure code</span>
                    </div>
                  </ng-container>

                  <!-- Selected procedure header -->
                  <ng-container *ngIf="hasServiceSelected(inst)">
                    <div class="sc-identity">
                      <span class="sc-code">{{ getServiceCode(inst) }}</span>
                      <span class="sc-desc">{{ getServiceDescription(inst) }}</span>
                    </div>
                  </ng-container>

                  <!-- Body fields: always editable -->
                  <div class="sc-body">
                    <ng-container *ngFor="let f of getServiceBodyFields(inst)">
                      <ng-container *ngIf="isVisible(f)">
                        <ng-container *ngIf="form.get(f.controlName) as ctrl">
                          <div class="sc-field"
                               [ngClass]="{'sc-field--select': f.type === 'select',
                                           'sc-field--date': f.type === 'datetime-local',
                                           'sc-field--num': f.type === 'number',
                                           'sc-field--search': f.type === 'search'}">
                            <div class="ff-outline"
                                 [class.ff-disabled]="ctrl.disabled"
                                 [class.ff-invalid]="ctrl.touched && ctrl.invalid">
                              <div class="ff-float-label">
                                {{ f.displayName }}
                                <span class="req-star" *ngIf="f.required">*</span>
                              </div>
                              <div class="ff-body">
                                <ng-container [ngSwitch]="f.type">
                                  <ui-smart-dropdown *ngSwitchCase="'select'" class="ff-ui"
                                    label="" placeholder="Select..."
                                    [options]="getDropdownOptions(f.controlName)"
                                    [formControlName]="f.controlName">
                                  </ui-smart-dropdown>
                                  <ui-datetime-picker *ngSwitchCase="'datetime-local'" class="ff-ui"
                                    placeholderDate="mm/dd/yyyy"
                                    [dateOnly]="!!f.dateOnly"
                                    [formControlName]="f.controlName">
                                  </ui-datetime-picker>
                                  <ui-smart-lookup *ngSwitchCase="'search'" class="ff-ui ff-lookup"
                                    [placeholder]="getLookupPlaceholder(f)"
                                    [minChars]="getLookupMinChars(f)"
                                    [debounceMs]="getLookupDebounceMs(f)"
                                    [limit]="getLookupLimit(f)"
                                    [searchFn]="getLookupSearchFn(f)"
                                    [displayWith]="getLookupDisplayWith(f)"
                                    [trackBy]="getLookupTrackBy(f)"
                                    [formControlName]="f.controlName"
                                    (selected)="onLookupSelected(f, $event)"
                                    (textChange)="onLookupTextChange(f, $event)"
                                    (cleared)="onLookupCleared(f)">
                                  </ui-smart-lookup>
                                  <textarea *ngSwitchCase="'textarea'" class="ff-input ff-textarea"
                                    rows="2" [formControlName]="f.controlName"></textarea>
                                  <input *ngSwitchDefault class="ff-input"
                                    [type]="f.type === 'number' ? 'number' : 'text'"
                                    [formControlName]="f.controlName" />
                                </ng-container>
                              </div>
                            </div>
                            <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">
                              {{ f.requiredMsg || (f.displayName + ' is required') }}
                            </div>
                          </div>
                        </ng-container>
                      </ng-container>
                    </ng-container>
                  </div>
                </div>
              </ng-container>
            </div>
          </ng-container>
        </ng-template>

        <!-- ═══ NORMAL REPEAT (non-provider) — unchanged ═══ -->
        <ng-template #normalSubRepeat>
        <div class="ff-repeat-wrap">
          <ng-container *ngFor="let inst of sub.instances">
            <div class="ff-repeat-group">
              <div class="ff-repeat-header">
                <div class="ff-repeat-title">{{ sub.repeat?.instanceLabel }} #{{ inst.index }}</div>
              </div>
              <ng-container *ngIf="getActionButtons(inst.fields) as repBtns">
                <div class="ff-buttonbar" *ngIf="repBtns.length">
                  <button type="button" class="ff-action-btn"
                    *ngFor="let b of repBtns"
                    [disabled]="!isActionButtonEnabled(b)"
                    (click)="onActionButtonClick(b)">
                    {{ b.buttonText || b.displayName }}
                  </button>
                </div>
              </ng-container>
              <div class="grid ff-repeat-grid">
                <ng-container *ngFor="let f of getNonActionFields(inst.fields)">
                  <ng-container *ngIf="isVisible(f)">
                    <ng-container *ngIf="form.get(f.controlName) as ctrl">
                      <ng-container *ngIf="f.type === 'checkbox'; else outlinedSubRep">
                        <div class="ff-field">
                          <div class="ff-checkbox" [class.ff-disabled]="ctrl.disabled">
                            <input type="checkbox" class="form-check-input" [formControlName]="f.controlName" />
                            <label class="form-check-label ff-checkbox-text">{{ f.displayName }}<span class="req-star" *ngIf="f.required">*</span></label>
                          </div>
                        </div>
                      </ng-container>
                      <ng-template #outlinedSubRep>
                        <div class="ff-field" [class.ff-span-all]="isFullRowField(f) && f.type !== 'search'" [class.ff-span-2]="f.type === 'search'">
                          <div class="ff-outline" [class.ff-disabled]="ctrl.disabled" [class.ff-invalid]="ctrl.touched && ctrl.invalid">
                            <div class="ff-float-label">{{ f.displayName }}<span class="req-star" *ngIf="f.required">*</span></div>
                            <div class="ff-body">
                              <ng-container [ngSwitch]="f.type">
                                <ng-container *ngSwitchCase="'select'"><ui-smart-dropdown class="ff-ui" label="" placeholder="Select..." [options]="getDropdownOptions(f.controlName)" [formControlName]="f.controlName"></ui-smart-dropdown></ng-container>
                                <ng-container *ngSwitchCase="'datetime-local'"><ui-datetime-picker class="ff-ui" placeholderDate="mm/dd/yyyy" placeholderDateTime="mm/dd/yyyy --:--" [dateOnly]="!!f.dateOnly" [formControlName]="f.controlName"></ui-datetime-picker></ng-container>
                                <ng-container *ngSwitchCase="'textarea'"><textarea class="ff-input ff-textarea" rows="3" [formControlName]="f.controlName"></textarea></ng-container>
                                <ng-container *ngSwitchCase="'search'"><ui-smart-lookup class="ff-ui ff-lookup" [placeholder]="getLookupPlaceholder(f)" [minChars]="getLookupMinChars(f)" [debounceMs]="getLookupDebounceMs(f)" [limit]="getLookupLimit(f)" [searchFn]="getLookupSearchFn(f)" [displayWith]="getLookupDisplayWith(f)" [trackBy]="getLookupTrackBy(f)" [formControlName]="f.controlName" (selected)="onLookupSelected(f, $event)" (textChange)="onLookupTextChange(f, $event)" (cleared)="onLookupCleared(f)"></ui-smart-lookup></ng-container>
                                <ng-container *ngSwitchDefault><input class="ff-input" type="text" [formControlName]="f.controlName" /></ng-container>
                              </ng-container>
                            </div>
                          </div>
                          <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">{{ f.requiredMsg || (f.displayName + ' is required') }}</div>
                        </div>
                      </ng-template>
                    </ng-container>
                  </ng-container>
                </ng-container>
                <div class="ff-repeat-cell" *ngIf="sub.repeat?.showControls">
                  <button type="button" class="ff-repeat-btn" [disabled]="!canAddRepeat(sub)" (click)="addRepeat(sub)" title="Add">+</button>
                  <button type="button" class="ff-repeat-btn danger" [disabled]="!canRemoveRepeat(sub)" (click)="removeRepeat(sub, inst.index)" title="Remove">−</button>
                </div>
              </div>
            </div>
          </ng-container>
        </div>
        </ng-template>
      </ng-template>

      <!-- nested subsections -->
      <ng-container *ngFor="let child of sub.subsections">
        <ng-container *ngTemplateOutlet="subTpl; context: { $implicit: child, depth: depth + 1, parentSec: parentSec }"></ng-container>
      </ng-container>
    </div>
  </ng-template>


</form>
