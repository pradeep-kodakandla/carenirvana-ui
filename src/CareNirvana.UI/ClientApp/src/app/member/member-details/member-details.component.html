<mat-menu #menu="matMenu">
  <button mat-menu-item class="row-menu-item row-menu-item--primary">
    <span class="row-menu-icon">
      <mat-icon>add</mat-icon>
    </span>
    <span class="row-menu-label">Add Activity</span>
  </button>

  <button mat-menu-item class="row-menu-item">
    <span class="row-menu-icon">
      <mat-icon>edit_note</mat-icon>
    </span>
    <span class="row-menu-label">Add Notes</span>
  </button>

  <button mat-menu-item class="row-menu-item">
    <span class="row-menu-icon">
      <mat-icon>assignment</mat-icon>
    </span>
    <span class="row-menu-label">Run Assessment</span>
  </button>

  <button mat-menu-item class="row-menu-item">
    <span class="row-menu-icon">
      <mat-icon>description</mat-icon>
    </span>
    <span class="row-menu-label">Add Documents</span>
  </button>

  <button mat-menu-item class="row-menu-item">
    <span class="row-menu-icon">
      <mat-icon>outgoing_mail</mat-icon>
    </span>
    <span class="row-menu-label">Send Letter</span>
  </button>

  <button mat-menu-item class="row-menu-item">
    <span class="row-menu-icon">
      <mat-icon>mail</mat-icon>
    </span>
    <span class="row-menu-label">Send Message</span>
  </button>

  <button mat-menu-item class="row-menu-item">
    <span class="row-menu-icon">
      <mat-icon>summarize</mat-icon>
    </span>
    <span class="row-menu-label">Auth Summary </span>
  </button>
</mat-menu>
<mat-menu #alertsMenu="matMenu" class="history-popover" yPosition="below" [overlapTrigger]="false" [hasBackdrop]="true" [backdropClass]="'cdk-overlay-dark-backdrop'" matMenuTriggerRestoreFocus="false">
  <div class="messages-wrap" (click)="$event.stopPropagation()">
    <app-member-alerts [showTable]="true"></app-member-alerts>
  </div>
</mat-menu>
<div style="display:flex;">
  <div class="sidebar" [class.collapsed]="isCollapse" [class.collapsed-ready]="isCollapseReady">
    <!-- Expand/Collapse Button -->
    <div class="sidebar-toolbar" [class.collapsed]="isCollapse">
      <!-- Menu (always visible) -->
      <button mat-icon-button
              style="border: 1px solid #e2e5ea;height:auto;"
              class="toggle-button"
              aria-label="Menu"
              matTooltip="Click to view actions"
              [matMenuTriggerFor]="menu">

        <mat-icon>more_vert</mat-icon>

      </button>

      <!-- Alerts (always visible) -->
      <button mat-icon-button
              class="toggle-button"
              aria-label="Alerts"
              #messagesTrigger="matMenuTrigger"
              [matMenuTriggerFor]="alertsMenu"
              matTooltip="Click to view alerts"
              (click)="openMessagesMenu(messagesTrigger)">
        <mat-icon aria-hidden="false" matBadge="{{member?.alertCount}}">notifications</mat-icon>
      </button>

      <!-- Spacer only when expanded -->
      <div class="flex-spacer" *ngIf="!isCollapse"></div>

      <!-- Collapse / Expand -->
      <button class="toggle-button collapse-toggle"
              (click)="toggleSidebar()"
              matTooltip="Expand/Collapse Sidebar"
              aria-label="Toggle member sidebar">
        <mat-icon>{{ isCollapse ? 'chevron_right' : 'chevron_left' }}</mat-icon>
      </button>
    </div>

    <!-- Collapsed member name (vertical) — shown only after collapse finishes -->
    <div class="sidebar-collapsed-summary" *ngIf="isCollapseReady">
      <div class="collapsed-member-name"
           [attr.title]="(member?.firstName || '') + ' ' + (member?.lastName || '')">
        {{ member?.firstName }} {{ member?.lastName }} - ID: {{ member?.memberId }} · DOB: {{ member?.dob }} ({{ getAge(member?.dob) }} Yrs), {{ member?.gender }}
      </div>
    </div>


    <div class="sidebar-content" *ngIf="!isCollapse">
      <!-- Header -->
      <div class="member-card">
        <div class="member-avatar">
          {{ member?.firstName?.charAt(0) }}{{ member?.lastName?.charAt(0) }}
        </div>
        <div>
          <a class="member-name-link"
             href="#"
             (click)="onMemberNameClick($event)"
             matTooltip="Open member details">
            {{ member?.firstName }} {{ member?.lastName }}
          </a>
          <div class="member-sub">
            ID: {{ member?.memberId }} · DOB: {{ member?.dob }} ({{ getAge(member?.dob) }} Yrs), {{ member?.gender }}
          </div>
        </div>
      </div>

      <!-- Enrollment & Risk -->
      <div class="section m-top-6">
        <div class="section-title">Enrollment</div>
        <span [ngClass]="member?.EndDate ? 'pill-red' : 'badge-green'">
          {{ getLevelValue(member?.levelMap, 'LOB') }}
          ({{ member?.endDate ? 'Inactive' : 'Active' }})
        </span>
      </div>

      <div class="section m-top-6">
        <div class="section-title">Risk Level</div>
        <div>
          <span class="risk-chip compact" [ngClass]="(member?.riskLevelCode || '').toLowerCase()">{{ member?.riskLevelCode || 'No Risk' }}</span>
        </div>
      </div>

      <!-- Programs -->
      <div class="section m-top-6" *ngIf="programsList.length">
        <div class="section-title">Programs</div>
        <span class="chip" *ngFor="let prog of programsList">{{ prog }}</span>
      </div>

      <!-- Contact Information -->
      <!-- Contact Information -->
      <div class="section m-top-6">
        <div class="section-title">Contact Information</div>

        <div class="row">
          <mat-icon>call</mat-icon>
          <div>
            <ng-container *ngIf="primaryPhoneNumber; else noPhones">
              <div>
                {{ formatPhone(primaryPhoneNumber?.phonenumber ?? primaryPhoneNumber?.phoneNumber) }}
                <ng-container *ngIf="primaryPhoneNumber?.extension"> x{{ primaryPhoneNumber.extension }}</ng-container>
                <span *ngIf="isPrimary(primaryPhoneNumber)"> </span>
                <span *ngIf="!isPrimary(primaryPhoneNumber) && isPreferred(primaryPhoneNumber)"> (Preferred)</span>
              </div>
            </ng-container>
            <ng-template #noPhones>N/A</ng-template>
          </div>
        </div>

        <div class="row">
          <mat-icon>mail</mat-icon>
          <div>
            <ng-container *ngIf="primaryEmail; else noEmails">
              <div>
                {{ (primaryEmail?.emailaddress ?? primaryEmail?.emailAddress) || 'N/A' }}
                <span *ngIf="isPrimary(primaryEmail)"> </span>
                <span *ngIf="!isPrimary(primaryEmail) && isPreferred(primaryEmail)"> (Preferred)</span>
              </div>
            </ng-container>
            <ng-template #noEmails>N/A</ng-template>
          </div>
        </div>

        <div class="row">
          <mat-icon>location_on</mat-icon>
          <div>
            <ng-container *ngIf="primaryAddress; else noAddresses">
              <div>
                <div *ngFor="let line of primaryAddressLines">{{ line }}</div>
                <span *ngIf="isPrimary(primaryAddress)"> </span>
                <span *ngIf="!isPrimary(primaryAddress) && isPreferred(primaryAddress)"> (Preferred)</span>
              </div>
            </ng-container>
            <ng-template #noAddresses>N/A</ng-template>
          </div>
        </div>
      </div>


      <!-- Care Team -->
      <div class="section m-top-6">
        <div class="section-title">Care Team</div>

        <div class="team-row">
          <div class="team-role">Care Manager</div>
          <div class="team-name">{{loggedInUser}}</div>
        </div>

        <div class="team-row">
          <div class="team-role">PCP</div>
          <div class="team-name">N/A</div>
        </div>
      </div>

      <!-- Communication -->
      <div class="section m-top-6">
        <div class="section-title">Communication</div>

        <div class="team-row">
          <div class="team-role">Preferences</div>
          <div class="team-name">Phone and Email</div>
        </div>

        <div class="team-row">
          <div class="team-role">Language</div>
          <div class="team-name">English</div>
        </div>
      </div>
    </div>


    <!-- Show 'People' Icon when Collapsed -->
    <!--<div class="collapsed-icon" [matMenuTriggerFor]="menu" *ngIf="isCollapse">
      <mat-icon>menu</mat-icon>
    </div>-->
  </div>
  <div class="main-content">
    <div class="sidenav-content" style="padding-right:5px;">
      <!--<app-member [memberId]="memberId"></app-member>-->
      <router-outlet></router-outlet>
    </div>
  </div>
</div>
