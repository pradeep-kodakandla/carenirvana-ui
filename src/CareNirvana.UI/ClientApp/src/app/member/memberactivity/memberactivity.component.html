<!-- Call type header -->
<div class="call-type-header" role="tablist">
  <div class="call-type-item"
       [ngClass]="{ 'selected': callType === 'Scheduled' }"
       (click)="setCallType('Scheduled')"
       role="tab"
       [attr.aria-selected]="callType === 'Scheduled'">
    Scheduled
  </div>

  <div class="call-type-item"
       [ngClass]="{ 'selected': callType === 'CompletedCall' }"
       (click)="setCallType('CompletedCall')"
       role="tab"
       [attr.aria-selected]="callType === 'CompletedCall'">
    Complete Call
  </div>

  <div class="call-type-item"
       [ngClass]="{ 'selected': callType === 'ConferenceCall' }"
       (click)="setCallType('ConferenceCall')"
       role="tab"
       [attr.aria-selected]="callType === 'ConferenceCall'">
    Conference Call
  </div>
</div>

<form [formGroup]="activityForm"
      class="activity-form-grid"
      (ngSubmit)="onSubmit()" style="padding-left:5px; padding-right:5px;">

  <!-- Activity Type -->
  <div class="form-outline dropdown-container"
       [ngClass]="{'has-error': activityForm.get('activityType')?.touched &&
                                activityForm.get('activityType')?.invalid}">
    <label class="floating-label">
      Activity Type <span class="required-star">*</span>
    </label>
    <ui-dropdown formControlName="activityType"
                 [options]="activityTypeOptions"
                 [compareWith]="compareId"
                 placeholder="Select activity type">
    </ui-dropdown>
    <div *ngIf="activityForm.get('activityType')?.touched &&
                activityForm.get('activityType')?.invalid"
         class="field-error">
      Activity Type is required.
    </div>
  </div>

  <!-- Priority -->
  <div class="form-outline dropdown-container"
       [ngClass]="{'has-error': activityForm.get('priority')?.touched &&
                                activityForm.get('priority')?.invalid}">
    <label class="floating-label">
      Priority <span class="required-star">*</span>
    </label>
    <ui-dropdown formControlName="priority"
                 [options]="priorityOptions"
                 [compareWith]="compareId"
                 placeholder="Select priority">
    </ui-dropdown>
    <div *ngIf="activityForm.get('priority')?.touched &&
                activityForm.get('priority')?.invalid"
         class="field-error">
      Priority is required.
    </div>
  </div>

  <!-- Contact With -->
  <div class="form-outline dropdown-container">
    <label class="floating-label">Contact With</label>
    <ui-dropdown formControlName="contactWith"
                 [options]="contactWithOptions"
                 [compareWith]="compareId"
                 placeholder="Select contact with">
    </ui-dropdown>
  </div>

  <!-- Contact Mode -->
  <div class="form-outline dropdown-container">
    <label class="floating-label">Contact Mode</label>
    <ui-dropdown formControlName="contactMode"
                 [options]="contactModeOptions"
                 [compareWith]="compareId"
                 placeholder="Select contact mode">
    </ui-dropdown>
  </div>

  <!-- Scheduled Date & Time -->
  <div class="form-outline position-relative"
       [ngClass]="{'has-error': activityForm.get('followUpDateTime')?.touched &&
                                activityForm.get('followUpDateTime')?.invalid}">
    <label class="floating-label">
      Scheduled Date &amp; Time <span class="required-star">*</span>
    </label>
    <ui-datetime-picker formControlName="followUpDateTime"
                        placeholderDate="Select date"
                        placeholderTime="Select time">
    </ui-datetime-picker>
    <div *ngIf="activityForm.get('followUpDateTime')?.touched &&
                activityForm.get('followUpDateTime')?.invalid"
         class="field-error">
      Scheduled date is required.
    </div>
  </div>

  <!-- Due Date & Time -->
  <div class="form-outline position-relative"
       [ngClass]="{'has-error': activityForm.get('dueDate')?.touched &&
                                activityForm.get('dueDate')?.invalid}">
    <label class="floating-label">
      Due Date &amp; Time <span class="required-star">*</span>
    </label>
    <ui-datetime-picker formControlName="dueDate"
                        placeholderDate="Select date"
                        placeholderTime="Select time">
    </ui-datetime-picker>
    <div *ngIf="activityForm.get('dueDate')?.touched &&
                activityForm.get('dueDate')?.invalid"
         class="field-error">
      Due date is required.
    </div>
  </div>

  <!-- Assign To + Work basket activity toggle -->
  <div class="assign-to-row">
    <div class="form-outline dropdown-container flex-fill"
         [ngClass]="{'has-error': activityForm.get('assignTo')?.touched &&
                                  activityForm.get('assignTo')?.invalid &&
                                  !activityForm.get('isWorkBasketActivity')?.value}">
      <label class="floating-label">
        Assign To <span class="required-star">*</span>
      </label>
      <ui-dropdown formControlName="assignTo"
                   [options]="assignToOptions"
                   [compareWith]="compareId"
                   placeholder="Select user">
      </ui-dropdown>
      <div *ngIf="activityForm.get('assignTo')?.touched &&
                  activityForm.get('assignTo')?.invalid &&
                  !activityForm.get('isWorkBasketActivity')?.value"
           class="field-error">
        Assign To is required.
      </div>
    </div>

    <div class="workbasket-toggle" *ngIf="!isView">
      <label class="form-check-label">
        <input type="checkbox"
               class="form-check-input"
               formControlName="isWorkBasketActivity" />
        Work Basket
      </label>
    </div>
  </div>

  <!-- Show these ONLY when Work Basket is checked -->
  <ng-container *ngIf="activityForm.get('isWorkBasketActivity')?.value && !isView">

    <!-- Work Group -->
    <div class="form-outline dropdown-container">
      <label class="floating-label">Work Group</label>
      <ui-multi-check-dropdown formControlName="workGroups"
                               [options]="workGroupOptions"
                               [defaultSelect]="true"
                               [showChips]="false"
                               placeholder="Select work groups">
      </ui-multi-check-dropdown>
    </div>

    <!-- Work Basket -->
    <div class="form-outline dropdown-container">
      <label class="floating-label">Work Basket</label>
      <ui-multi-check-dropdown formControlName="workBasket"
                               [options]="workBasketOptions"
                               [defaultSelect]="true"
                               [showChips]="false"
                               placeholder="Select work basket">
      </ui-multi-check-dropdown>
    </div>

    <!-- Work Basket Users -->
    <div class="form-outline dropdown-container">
      <label class="floating-label">Work Basket Users</label>
      <ui-multi-check-dropdown formControlName="workBasketUser"
                               [options]="workBasketUserOptions"
                               [defaultSelect]="true"
                               [showChips]="false"
                               placeholder="Select work basket user">
      </ui-multi-check-dropdown>
    </div>

  </ng-container>

  <!-- spacer cell for grid alignment -->
  <div></div>

  <!-- ********** Outcome / Contact Section ********** -->
  <ng-container *ngIf="callType === 'CompletedCall'">

    <!-- Section divider -->
    <div class="outcome-section-divider">
      <span>Call Outcome</span>
    </div>

    <!-- Activity Outcome Type -->
    <div class="form-outline dropdown-container">
      <label class="floating-label">Activity Outcome Type</label>
      <ui-dropdown formControlName="activityOutcomeType"
                   [options]="activityOutcomeTypeOptions"
                   [compareWith]="compareId"
                   placeholder="Select outcome type">
      </ui-dropdown>
    </div>

    <!-- Activity Outcome -->
    <div class="form-outline dropdown-container">
      <label class="floating-label">Activity Outcome</label>
      <ui-dropdown formControlName="activityOutcome"
                   [options]="activityOutcomeOptions"
                   [compareWith]="compareId"
                   placeholder="Select outcome">
      </ui-dropdown>
    </div>

    <!-- Activity Duration -->
    <div class="form-outline">
      <label class="floating-label">Activity Duration (minutes)</label>
      <input type="number"
             class="form-control"
             min="0"
             formControlName="activityDuration"
             placeholder="Enter duration in minutes" />
    </div>

    <!-- Outcome Notes -->
    <div class="form-outline">
      <label class="floating-label">Outcome Notes</label>
      <textarea class="form-control"
                formControlName="outcomeNotes"
                rows="3"
                placeholder="Add notes about the outcome...">
      </textarea>
    </div>
  </ng-container>
  <!-- ********** END: Outcome / Contact Section ********** -->

  <!-- Comments -->
  <div class="form-outline full-width" style="grid-column: span 2;"
       [ngClass]="{'has-error': activityForm.get('comments')?.touched &&
                                activityForm.get('comments')?.invalid}">
    <label class="floating-label">
      Comments <span class="required-star">*</span>
    </label>
    <textarea class="form-control" style="height:200px;"
              formControlName="comments"
              rows="3"
              placeholder="Enter comments..."
              [ngClass]="{'is-invalid': activityForm.get('comments')?.touched &&
                                      activityForm.get('comments')?.invalid}">
    </textarea>
    <div *ngIf="activityForm.get('comments')?.touched &&
                activityForm.get('comments')?.invalid"
         class="field-error">
      Comments are required.
    </div>
  </div>

  <!-- Assigned Users (View mode) -->
  <div *ngIf="isView && assignedUsers && assignedUsers.length"
       class="assigned-users-container"
       style="grid-column: span 2; margin-top: 10px;">

    <h5>Assigned Users</h5>

    <table class="table table-sm table-bordered assigned-users-table">
      <thead>
        <tr>
          <th>User</th>
          <th class="text-center">Status</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let u of assignedUsers">
          <td>{{ u.userFullName || ('User ' + u.userId) }}</td>
          <td class="text-center">
            <span class="status-pill"
                  [ngClass]="{
                  'status-accepted': u.status === 'Accepted',
                  'status-rejected': u.status === 'Rejected',
                  'status-request': !u.status || u.status === 'Request'
                }">
              {{ u.status || 'Request' }}
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Actions -->
  <div class="form-actions" style="grid-column: span 2;" *ngIf="!isView">
    <button type="submit"
            class="btn btn-primary"
            [disabled]="activityForm.invalid">
      Save Activity
    </button>
    <button type="button" *ngIf="noCancel"
            class="btn btn-secondary ms-2"
            (click)="onCancel()">
      Cancel
    </button>
  </div>
</form>
