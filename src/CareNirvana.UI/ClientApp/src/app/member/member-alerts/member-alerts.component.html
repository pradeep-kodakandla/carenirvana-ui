<div *ngIf="showTable !== true" class="activity-container">
  <!-- LEFT: Alerts timeline -->
  <div class="activity-left">
    <div class="left-controls">
      <input type="text"
             placeholder="ğŸ” Search alerts/member/statusâ€¦"
             [(ngModel)]="searchTerm"
             (input)="applyFilter()"
             class="search-input" />

      <div class="right-actions">
        <div class="sort-wrapper" (mouseenter)="showSort = true" (mouseleave)="showSort = false">
          <button class="sort-icon" type="button">â‡…</button>
          <div class="sort-menu" *ngIf="showSort">
            <div class="sort-option" (click)="applySort('date_desc')">Newest first</div>
            <div class="sort-option" (click)="applySort('date_asc')">Oldest first</div>
            <div class="sort-option" (click)="applySort('name_asc')">Member (Aâ€“Z)</div>
            <div class="sort-option" (click)="applySort('name_desc')">Member (Zâ€“A)</div>
            <div class="sort-option" (click)="applySort('status_asc')">Status (Aâ€“Z)</div>
            <div class="sort-option" (click)="applySort('status_desc')">Status (Zâ€“A)</div>
          </div>
        </div>

        <!-- reserved for future "Add alert" (if you choose to create from UI) -->
        <!--<button class="add-btn" type="button" (click)="openFormForAdd()" disabled>â• Add Alert</button>-->
      </div>
    </div>

    <div class="timeline-list">
      <div *ngFor="let a of filtered; trackBy: trackById"
           class="timeline-item"
           [class.selected]="a.memberAlertId === selectedId">
        <div class="timeline-content" (click)="editItem(a)">
          <div class="timeline-header">
            <div class="timeline-title">
              {{ a.cfgAlertName || ('Alert #' + a.alertId) }}

              <ng-container *ngIf="a.activeFlag === false"> â€¢ <em>Inactive</em></ng-container>
            </div>
            <span class="activity-actions" (click)="$event.stopPropagation()">
              <button type="button" class="icon-btn" title="Acknowledge" (click)="acknowledge(a)">âœ…</button>
              <button type="button" class="icon-btn" title="Dismiss" (click)="dismiss(a)">ğŸ—™</button>
              <!--<button type="button" class="icon-btn" title="Clear dates" (click)="clearDates(a)">ğŸ§¹</button>-->
              <button type="button" class="icon-btn" title="Edit" (click)="editItem(a)">âœï¸</button>
            </span>
          </div>

          <div class="timeline-summary">
            <!--<strong>Member:</strong>
            {{ (a.memberLastName || '') + (a.memberFirstName ? ', ' + a.memberFirstName : '') || 'â€”' }}-->
            <ng-container *ngIf="a.alertStatusName"> <span class="timeline-title">Status: </span>{{ a.alertStatusName }}</ng-container>
            â€¢ <span class="timeline-title"> Date:</span> {{ a.alertDate | date:'MM/dd/yyyy h:mm:ss a' }}
            <ng-container *ngIf="a.acknowledgedDate"> â€¢ <span class="timeline-title">Ack:</span> {{ a.acknowledgedDate | date:'MM/dd/yyyy h:mm:ss a' }}</ng-container>
            <ng-container *ngIf="a.dismissedDate"> â€¢ <span class="timeline-title">Dismissed:</span> {{ a.dismissedDate | date:'MM/dd/yyyy h:mm:ss a' }}</ng-container>
          </div>
        </div>
      </div>

      <!-- Empty state -->
      <div *ngIf="!loading && filtered.length === 0" class="timeline-item">
        <div class="timeline-content">
          <div class="timeline-header">
            <div class="timeline-title">No alerts found</div>
          </div>
          <div class="timeline-summary">Try a different search filter.</div>
        </div>
      </div>
    </div>

    <!-- Pager -->
    <!--<div class="d-flex" style="gap:.5rem; margin-top:.5rem;">
      <button class="icon-btn" type="button" (click)="prevPage()" [disabled]="page<=1">â¬…ï¸ Prev</button>
      <div style="align-self:center;">Page {{ page }} â€¢ {{ total }} total</div>
      <button class="icon-btn" type="button" (click)="nextPage()" [disabled]="page*pageSize >= total">Next â¡ï¸</button>
    </div>-->
  </div>

  <!-- RIGHT: Form / Summary -->
  <div class="activity-right">
    <ng-container *ngIf="selectedAlert; else summaryTpl">
      <div class="alert-details-card">
        <h3>{{ selectedAlert.cfgAlertName || ('Alert #' + selectedAlert.alertId) }}</h3>

        <div class="details-grid">
          <p><strong>Source:</strong> {{ selectedAlert.alertSourceName || 'â€”' }}</p>
          <p><strong>Type:</strong> {{ selectedAlert.alertTypeName || 'â€”' }}</p>
          <p><strong>Status:</strong> {{ selectedAlert.alertStatusCode || 'â€”' }}</p>
          <p>
            <strong>Alert Date:</strong>
            {{ selectedAlert.alertDate ? (selectedAlert.alertDate | date:'MM/dd/yyyy h:mm:ss a') : 'â€”' }}
          </p>
          <p>
            <strong>Acknowledged:</strong>
            {{ selectedAlert.acknowledgedDate ? (selectedAlert.acknowledgedDate | date:'MM/dd/yyyy h:mm:ss a') : 'â€”' }}
          </p>
          <p>
            <strong>Dismissed:</strong>
            {{ selectedAlert.dismissedDate ? (selectedAlert.dismissedDate | date:'MM/dd/yyyy h:mm:ss a') : 'â€”' }}
          </p>
        </div>

        <div class="actions">
          <button class="btn-primary" type="button" (click)="acknowledge(selectedAlert)">Acknowledge</button>
          <button class="btn-warn" type="button" (click)="dismiss(selectedAlert)">Dismiss</button>
          <button class="btn-outline" type="button" (click)="cancelForm()">Cancel</button>
        </div>
      </div>
    </ng-container>

    <ng-template #summaryTpl>
      <div class="ai-summary">
        <h3>ğŸ”” Alerts Summary</h3>
        <p><strong>Total:</strong> {{ total }}</p>
        <p><strong>Showing page:</strong> {{ page }}</p>
        <p><strong>Search:</strong> {{ searchTerm || 'â€”' }}</p>
      </div>
    </ng-template>
  </div>

</div>

<!-- TABLE MODE: show only if the input [showTable]="true" is provided -->
<div *ngIf="showTable === true">
  <table mat-table [dataSource]="dataSource"
         matSort
         multiTemplateDataRows
         [trackBy]="trackById"
         class="mat-elevation-z1 full-width-table pro-table mng-table">

    <!-- Alert Name -->
    <ng-container matColumnDef="alertname">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Alert Name</th>
      <td mat-cell *matCellDef="let m">
        {{ m.cfgAlertName || ('Alert #' + (m.alertId ?? m.memberAlertId)) }}
      </td>
    </ng-container>

    <!-- Alert Source -->
    <ng-container matColumnDef="alertsource">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Alert Source</th>
      <td mat-cell *matCellDef="let m">{{ m.alertSourceName || 'â€”' }}</td>
    </ng-container>

    <!-- Alert Type -->
    <ng-container matColumnDef="alerttype">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Alert Type</th>
      <td mat-cell *matCellDef="let m">{{ m.alertTypeName || 'â€”' }}</td>
    </ng-container>

    <!-- Alert Status -->
    <ng-container matColumnDef="alertstatus">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Alert Status</th>
      <td mat-cell *matCellDef="let m">
        {{ m.alertStatusName || m.alertStatusCode || 'â€”' }}
      </td>
    </ng-container>

    <!-- Alert Date -->
    <ng-container matColumnDef="alertdate">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Alert Date</th>
      <td mat-cell *matCellDef="let m">
        {{ m.alertDate | date:'MM/dd/yyyy h:mm:ss a' }}
      </td>
    </ng-container>

    <!-- End Date -->
    <!--<ng-container matColumnDef="enddate">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>End Date</th>
      <td mat-cell *matCellDef="let m">
        {{ m.endDate ? (m.endDate | date:'MM/dd/yyyy h:mm:ss a') : 'â€”' }}
      </td>
    </ng-container>-->
    <!-- Acknowledged Date -->
    <ng-container matColumnDef="acknowledgeddate">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Acknowledged</th>
      <td mat-cell *matCellDef="let m">
        {{ m.acknowledgedDate ? (m.acknowledgedDate | date:'MM/dd/yyyy h:mm:ss a') : 'â€”' }}
      </td>
    </ng-container>

    <!-- Dismissed Date -->
    <!--<ng-container matColumnDef="dismisseddate">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Dismissed</th>
      <td mat-cell *matCellDef="let m">
        {{ m.dismissedDate ? (m.dismissedDate | date:'MM/dd/yyyy h:mm:ss a') : 'â€”' }}
      </td>
    </ng-container>-->
    <!-- Actions -->
    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef class="is-center">Actions</th>
      <td mat-cell *matCellDef="let m" class="is-center">
        <div class="editor-actions">
          <button mat-icon-button matTooltip="Acknowledge" (click)="acknowledge(m)">
            <mat-icon>task_alt</mat-icon>
          </button>
          <button mat-icon-button matTooltip="Dismiss" (click)="dismiss(m)">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </td>
    </ng-container>

    <!-- Header / Rows -->
    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row
        *matRowDef="let row; columns: displayedColumns;"
        [attr.data-id]="row.memberAlertId">
    </tr>

  </table>
</div>
