<div class="activity-container">
  <!-- LEFT: Care Team â€œtimelineâ€ -->
  <div class="activity-left">
    <div class="left-controls">
      <input type="text"
             placeholder="ğŸ” Search by name/role..."
             [(ngModel)]="searchTerm"
             (input)="applyFilter()"
             class="search-input" />

      <div class="right-actions">
        <div class="sort-wrapper" (mouseenter)="showSort = true" (mouseleave)="showSort = false">
          <button class="sort-icon" type="button">â‡…</button>
          <div class="sort-menu" *ngIf="showSort">
            <div class="sort-option" (click)="applySort('userName_asc')">User (Aâ€“Z)</div>
            <div class="sort-option" (click)="applySort('userName_desc')">User (Zâ€“A)</div>
            <div class="sort-option" (click)="applySort('roleName_asc')">Role (Aâ€“Z)</div>
            <div class="sort-option" (click)="applySort('roleName_desc')">Role (Zâ€“A)</div>
            <div class="sort-option" (click)="applySort('isPrimary_desc')">Primary First</div>
          </div>
        </div>

        <button class="add-btn" type="button" (click)="openFormForAdd()" [disabled]="!canAdd">â• Add Care Team</button>
      </div>
    </div>

    <div class="timeline-list">
      <div *ngFor="let item of filtered; trackBy: trackById"
           class="timeline-item"
           [class.selected]="item.memberCareStaffId === selectedId">
        <div class="timeline-content" (click)="editItem(item)">
          <div class="timeline-header">
            <div class="timeline-title">
              {{ item.userName || ('User #' + item.userId) }}
              <ng-container *ngIf="item.isPrimary"> â€¢ <strong>Primary</strong></ng-container>
              <ng-container *ngIf="item.activeFlag === false"> â€¢ <em>Inactive</em></ng-container>
            </div>

            <span class="activity-actions" (click)="$event.stopPropagation()">
              <button type="button" class="icon-btn" title="Edit" [disabled]="!canEdit" (click)="editItem(item)">âœï¸</button>
              <button type="button" class="icon-btn" title="Delete" [disabled]="!canDelete" (click)="deleteItem(item)">ğŸ—‘ï¸</button>
            </span>
          </div>

          <div class="timeline-summary">
            <strong>Role:</strong> {{ item.roleName || 'â€”' }} â€¢
            <strong>User ID:</strong> {{ item.userId }}
          </div>
        </div>
      </div>

      <!-- Empty state -->
      <div *ngIf="!loading && filtered.length === 0" class="timeline-item">
        <div class="timeline-content">
          <div class="timeline-header">
            <div class="timeline-title">No care team members found</div>
          </div>
          <div class="timeline-summary">Try a different search or click â€œAdd Care Teamâ€.</div>
        </div>
      </div>
    </div>

    <!-- PAGER -->
    <div class="d-flex" style="gap:.5rem; margin-top: .5rem;">
      <button class="icon-btn" type="button" (click)="prevPage()" [disabled]="page<=1">â¬…ï¸ Prev</button>
      <div style="align-self:center;">Page {{ page }} â€¢ {{ total }} total</div>
      <button class="icon-btn" type="button" (click)="nextPage()" [disabled]="page*pageSize >= total">Next â¡ï¸</button>
    </div>
  </div>

  <!-- RIGHT: Form / Summary -->
  <div class="activity-right">
    <ng-container *ngIf="isFormVisible; else summaryTpl">
      <div class="ct-form">
        <form #ctForm="ngForm" (ngSubmit)="saveItem()">
          <div class="form-grid">
            <!-- User (required) -->
            <div class="form-outline">
              <label class="floating-label">User ID <span class="text-danger">*</span></label>
              <input class="form-control"
                     name="userId"
                     [(ngModel)]="form.userId"
                     type="number" required />
              <div class="invalid-feedback" *ngIf="showValidationErrors && !form.userId">User is required.</div>
            </div>

            <!-- Role -->
            <div class="form-outline">
              <label class="floating-label">Role ID</label>
              <input class="form-control"
                     name="roleId"
                     [(ngModel)]="form.roleId"
                     type="number" />
            </div>

            <!-- Primary -->
            <div class="form-outline">
              <label class="floating-label">Primary</label>
              <select class="form-control" name="isPrimary" [(ngModel)]="form.isPrimary">
                <option [ngValue]="true">Yes</option>
                <option [ngValue]="false">No</option>
              </select>
            </div>

            <!-- Active -->
            <div class="form-outline">
              <label class="floating-label">Active</label>
              <select class="form-control" name="activeFlag" [(ngModel)]="form.activeFlag">
                <option [ngValue]="true">Yes</option>
                <option [ngValue]="false">No</option>
              </select>
            </div>
          </div>

          <div class="button-group">
            <button type="submit" [disabled]="saving">{{ form.memberCareStaffId ? 'Update' : 'Save' }}</button>
            <button type="button" (click)="cancelForm()">Cancel</button>
          </div>
        </form>
      </div>
    </ng-container>

    <ng-template #summaryTpl>
      <div class="ai-summary">
        <h3>ğŸ‘©â€âš•ï¸ Care Team Summary</h3>
        <p><strong>Total:</strong> {{ total }}</p>
        <p><strong>Primary Count:</strong> {{ summary.primary }}</p>
        <p><strong>Active:</strong> {{ summary.active }}</p>
      </div>
    </ng-template>
  </div>
</div>
