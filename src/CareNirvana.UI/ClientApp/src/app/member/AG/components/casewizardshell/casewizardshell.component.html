<!-- Fixed shell layout -->
<div class="cw-shell">
  <div class="cw-top">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CASE HEADER (redesigned) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="cw-header-card">

      <!-- Row 1: Primary info + Actions -->
      <div class="cw-header-row">

        <!-- Case identity block -->
        <div class="cw-header-identity">
          <div class="cw-case-icon">AG</div>
          <div class="cw-header-field">
            <span class="cw-field-label">Case Number</span>
            <span class="cw-field-value cw-case-number">{{ getCaseNumber(aggregate$ | async) || '‚Äî' }}</span>
          </div>
        </div>

        <div class="cw-header-divider"></div>

        <!-- Meta fields -->
        <div class="cw-header-fields">

          <div class="cw-header-field">
            <span class="cw-field-label">Case Type</span>
            <span class="cw-field-value">{{ getCaseTypeLabel(headerForm.get('caseType')?.value) || '‚Äî' }}</span>
          </div>

          <div class="cw-header-field">
            <span class="cw-field-label">Level</span>
            <span class="cw-field-value cw-level-value">
              <span class="cw-level-dot"></span>
              {{ getLevelLabel(activeLevelId$ | async) || '‚Äî' }}
            </span>
          </div>

          <div class="cw-header-field">
            <span class="cw-field-label">Status</span>
            <span class="cw-status-badge"
                  [ngClass]="'cw-status--' + getStatusSlug(aggregate$ | async)">
              <span class="cw-status-dot"></span>
              {{ getStatus(aggregate$ | async) || '‚Äî' }}
            </span>
          </div>

          <div class="cw-header-field">
            <span class="cw-field-label">Priority</span>
            <span class="cw-priority-badge"
                  [ngClass]="'cw-priority--' + getPrioritySlug(aggregate$ | async)">
              {{ getPriority(aggregate$ | async) || '‚Äî' }}
            </span>
          </div>

          <div class="cw-header-field">
            <span class="cw-field-label">Due Date</span>
            <span class="cw-field-value"
                  [class.cw-due-warning]="isDueSoon(aggregate$ | async)"
                  [class.cw-due-overdue]="isOverdue(aggregate$ | async)">
              {{ getDueDate(aggregate$ | async) ? (getDueDate(aggregate$ | async) | date:'MM/dd/yyyy') : '‚Äî' }}
            </span>
          </div>

          <div class="cw-header-field">
            <span class="cw-field-label">Assignee</span>
            <span class="cw-field-value cw-assignee">
              <span class="cw-avatar" *ngIf="getAssignee(aggregate$ | async)">
                {{ getAssigneeInitials(aggregate$ | async) }}
              </span>
              {{ getAssignee(aggregate$ | async) || '‚Äî' }}
            </span>
          </div>

          <div class="cw-header-field">
            <span class="cw-field-label">Received</span>
            <span class="cw-field-value">
              {{ getReceivedOn(aggregate$ | async) ? (getReceivedOn(aggregate$ | async) | date:'MM/dd/yyyy hh:mm a') : '‚Äî' }}
            </span>
          </div>

          <div class="cw-header-field">
            <span class="cw-field-label">Created</span>
            <span class="cw-field-value">
              {{ getCreatedOn(aggregate$ | async) ? (getCreatedOn(aggregate$ | async) | date:'MM/dd/yyyy hh:mm a') : '‚Äî' }}
            </span>
          </div>
        </div>

        <div class="cw-header-divider"></div>

        <!-- Action buttons -->
        <div class="cw-header-actions">
          <button type="button"
                  class="cw-btn cw-btn-escalate"
                  (click)="toggleEscalateConfirm()"
                  [disabled]="!getCaseNumber(aggregate$ | async)"
                  title="Escalate case">
            ‚ö° Escalate
          </button>

          <button type="button"
                  class="btn btn-primary"
                  (click)="saveFromTop()"
                  [disabled]="!headerForm.get('caseType')?.value || savingTop">
            {{ savingTop ? 'Saving...' : 'Save' }}
          </button>

          <!-- AI Panel toggle -->
          <button type="button"
                  class="cw-btn-ai-toggle"
                  [class.active]="aiPanelOpen"
                  (click)="toggleAiPanel()"
                  [disabled]="!getCaseNumber(aggregate$ | async)"
                  title="Toggle AI Assistant">
            ü§ñ
            <span class="cw-ai-online-dot" *ngIf="getCaseNumber(aggregate$ | async)"></span>
          </button>
        </div>
      </div>

      <!-- Escalate confirmation bar -->
      <div class="cw-escalate-bar" *ngIf="showEscalateConfirm">
        <span class="cw-escalate-msg">
          Escalate this case to the next level? This will notify the supervisor.
        </span>
        <button type="button" class="cw-btn cw-btn-escalate-confirm" (click)="confirmEscalate()">
          Confirm Escalate
        </button>
        <button type="button" class="cw-btn cw-btn-cancel" (click)="cancelEscalate()">
          Cancel
        </button>
      </div>
    </div>

    <!-- Save banner (global) -->
    <div *ngIf="saveBannerText"
         class="cw-save-banner alert alert-success py-1 px-2 mb-2 d-flex align-items-center justify-content-between">
      <span>{{ saveBannerText }}</span>
      <button type="button" class="btn-close" aria-label="Close" (click)="clearSaveBanner()"></button>
    </div>

    <!-- Level Tabs -->
    <ul class="nav nav-tabs mb-2" *ngIf="(tabs$ | async) as tabs">
      <li class="nav-item" *ngFor="let t of tabs">
        <button class="nav-link"
                type="button"
                [class.active]="(activeLevelId$ | async) === t.levelId"
                (click)="selectLevel(t.levelId)">
          {{ t.title }}
        </button>
      </li>
    </ul>

    <!-- Chevron Stepper -->
    <caseChevronStepper [steps]="steps"
                        [activeStepId]="activeStepId"
                        (stepSelected)="onStepSelected($event)">
    </caseChevronStepper>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BODY: content + AI panel ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="cw-body">

    <!-- Scrollable step content -->
    <div class="cw-content caseWizardBody" [class.cw-content--ai-open]="aiPanelOpen">
      <ng-template #stepContainer></ng-template>
    </div>

    <!-- AI Suggestions Side Panel -->
    <div class="cw-ai-panel" [class.cw-ai-panel--open]="aiPanelOpen">

      <!-- Panel header -->
      <div class="cw-ai-panel-header">
        <div class="cw-ai-panel-title-block">
          <span class="cw-ai-panel-icon">ü§ñ</span>
          <div>
            <div class="cw-ai-panel-title">AI Assistant</div>
            <div class="cw-ai-panel-subtitle">Case Intelligence</div>
          </div>
        </div>
        <button class="cw-ai-close" (click)="toggleAiPanel()">‚úï</button>
      </div>

      <!-- Panel scrollable body -->
      <div class="cw-ai-panel-body">

        <!-- SLA Tracker -->
        <div class="cw-ai-section">
          <div class="cw-ai-section-header">
            <span class="cw-ai-section-label">‚è± SLA Tracker</span>
            <span class="cw-ai-badge cw-ai-badge--warning" *ngIf="slaAtRiskCount > 0">
              {{ slaAtRiskCount }} at risk
            </span>
          </div>
          <div class="cw-sla-list">
            <div class="cw-sla-item" *ngFor="let sla of slaItems"
                 [ngClass]="'cw-sla--' + sla.status">
              <div class="cw-sla-info">
                <div class="cw-sla-label">{{ sla.label }}</div>
                <div class="cw-sla-deadline">Due: {{ sla.deadline }}</div>
              </div>
              <div class="cw-sla-remaining">{{ sla.remaining }}</div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="cw-ai-section">
          <div class="cw-ai-section-header">
            <span class="cw-ai-section-label">‚ö° Quick Actions</span>
          </div>
          <div class="cw-quick-actions-grid">
            <button class="cw-quick-action" *ngFor="let action of quickActions"
                    (click)="onQuickAction(action)">
              <span class="cw-qa-icon">{{ action.icon }}</span>
              <span class="cw-qa-label">{{ action.label }}</span>
              <span class="cw-qa-desc">{{ action.description }}</span>
            </button>
          </div>
        </div>

        <!-- AI Suggestions -->
        <div class="cw-ai-section">
          <div class="cw-ai-section-header">
            <span class="cw-ai-section-label">üß† AI Insights</span>
            <span class="cw-ai-badge cw-ai-badge--info">
              {{ aiSuggestions.length }} suggestions
            </span>
          </div>
          <div class="cw-ai-suggestions-list">
            <div class="cw-ai-card" *ngFor="let suggestion of aiSuggestions"
                 [ngClass]="'cw-ai-card--' + suggestion.type">
              <div class="cw-ai-card-header">
                <div class="cw-ai-card-title-row">
                  <span class="cw-ai-card-icon">{{ suggestion.icon }}</span>
                  <span class="cw-ai-card-title">{{ suggestion.title }}</span>
                </div>
                <span class="cw-ai-confidence" [ngClass]="'cw-ai-confidence--' + suggestion.type">
                  {{ suggestion.confidence }}% conf.
                </span>
              </div>
              <p class="cw-ai-card-body">{{ suggestion.body }}</p>
              <div class="cw-ai-card-actions" *ngIf="suggestion.actionLabel">
                <button class="cw-btn cw-btn-ai-action" (click)="onAiAction(suggestion)">
                  {{ suggestion.actionLabel }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Panel footer: Ask AI -->
      <div class="cw-ai-panel-footer">
        <div class="cw-ai-input-wrap">
          <span class="cw-ai-input-icon">üí¨</span>
          <input type="text"
                 class="cw-ai-input"
                 placeholder="Ask AI about this case..."
                 [(ngModel)]="aiQuery"
                 (keydown.enter)="askAi()" />
          <button class="cw-ai-send" (click)="askAi()" [disabled]="!aiQuery?.trim()">‚Üí</button>
        </div>
      </div>
    </div>
  </div>
</div>
