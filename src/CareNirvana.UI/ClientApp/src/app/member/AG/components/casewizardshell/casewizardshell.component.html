<!-- Fixed shell layout -->
<div class="cw-shell">
  <div class="cw-top">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CASE HEADER (redesigned) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="cw-header-card">

      <!-- Row 1: Primary info + Actions -->
      <div class="cw-header-row">

        <!-- Case identity block -->
        <div class="cw-header-identity">
          <div class="cw-header-field">
            <span class="cw-field-label">Case Number</span>
            <span class="cw-field-value cw-case-number">{{ getCaseNumber(aggregate$ | async) || '‚Äî' }}</span>
          </div>
        </div>

        <div class="cw-header-divider"></div>

        <!-- Meta fields -->
        <div class="cw-header-fields">

          <div class="cw-header-field">
            <span class="cw-field-label">Case Type</span>
            <span class="cw-field-value">{{ getCaseTypeLabel(headerForm.get('caseType')?.value) || '‚Äî' }}</span>
          </div>

          <div class="cw-header-field">
            <span class="cw-field-label">Level</span>
            <span class="cw-field-value cw-level-value">
              <span class="cw-level-dot"></span>
              {{ getLevelLabel(activeLevelId$ | async) || '‚Äî' }}
            </span>
          </div>

          <div class="cw-header-field">
            <span class="cw-field-label">Status</span>
            <span class="cw-status-badge"
                  [ngClass]="'cw-status--' + getStatusSlug(aggregate$ | async)">
              <span class="cw-status-dot"></span>
              {{ getStatus(aggregate$ | async) || '‚Äî' }}
            </span>
          </div>

          <div class="cw-header-field">
            <span class="cw-field-label">Priority</span>
            <span class="cw-priority-badge"
                  [ngClass]="'cw-priority--' + getPrioritySlug(aggregate$ | async)">
              {{ getPriority(aggregate$ | async) || '‚Äî' }}
            </span>
          </div>

          <div class="cw-header-field">
            <span class="cw-field-label">Due Date</span>
            <span class="cw-field-value"
                  [class.cw-due-warning]="isDueSoon(aggregate$ | async)"
                  [class.cw-due-overdue]="isOverdue(aggregate$ | async)">
              {{ getDueDate(aggregate$ | async) ? (getDueDate(aggregate$ | async) | date:'MM/dd/yyyy') : '‚Äî' }}
            </span>
          </div>

          <div class="cw-header-field">
            <span class="cw-field-label">Assignee</span>
            <span class="cw-field-value cw-assignee">
              <!--<span class="cw-avatar" *ngIf="getAssignee(aggregate$ | async)">
                {{ getAssigneeInitials(aggregate$ | async) }}
              </span>-->
              {{ getAssignee(aggregate$ | async) || '‚Äî' }}
            </span>
          </div>

          <div class="cw-header-field">
            <span class="cw-field-label">Received</span>
            <span class="cw-field-value">
              {{ getReceivedOn(aggregate$ | async) ? (getReceivedOn(aggregate$ | async) | date:'MM/dd/yyyy hh:mm a') : '‚Äî' }}
            </span>
          </div>

          <div class="cw-header-field">
            <span class="cw-field-label">Created</span>
            <span class="cw-field-value">
              {{ getCreatedOn(aggregate$ | async) ? (getCreatedOn(aggregate$ | async) | date:'MM/dd/yyyy hh:mm a') : '‚Äî' }}
            </span>
          </div>

          <!-- Level Stepper ‚Äî Escalation History (horizontal, fixed 5 levels) -->
          <div class="cw-level-section" *ngIf="(tabs$ | async) as tabs">
            <div class="cw-level-stepper">

              <span class="cw-level-stepper-label">LEVEL</span>

              <div class="cw-level-stepper-track">
                <ng-container *ngFor="let lvl of allLevelSlots; let i = index; let last = last">

                  <!-- Step node ‚Äî clickable only if level exists in data -->
                  <div class="cw-lstep"
                       [class.cw-lstep--completed]="isCompletedLevel(lvl)"
                       [class.cw-lstep--active]="(activeLevelId$ | async) === lvl"
                       [class.cw-lstep--future]="!levelExists(lvl) && (activeLevelId$ | async) !== lvl"
                       (click)="levelExists(lvl) ? selectLevel(lvl) : null"
                       (mouseenter)="hoveredLevelId = lvl"
                       (mouseleave)="hoveredLevelId = null">

                    <!-- Circle -->
                    <div class="cw-lstep-circle">
                      <!-- Completed: checkmark -->
                      <svg *ngIf="isCompletedLevel(lvl)" class="cw-lstep-check" viewBox="0 0 16 16" fill="none">
                        <path d="M3.5 8.5L6.5 11.5L12.5 4.5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                      <!-- Not completed: level number -->
                      <span *ngIf="!isCompletedLevel(lvl)" class="cw-lstep-number">{{ lvl }}</span>
                    </div>

                    <!-- Hover tooltip (only for levels that exist in data) -->
                    <div class="cw-lstep-tooltip" *ngIf="hoveredLevelId === lvl && levelExists(lvl)">
                      <div class="cw-lstep-tooltip-title">Level {{ lvl }}</div>
                      <div class="cw-lstep-tooltip-row" *ngIf="getLevelDate(lvl)">
                        <span class="cw-lstep-tooltip-label">Date:</span>
                        <span>{{ getLevelDate(lvl) }}</span>
                      </div>
                      <div class="cw-lstep-tooltip-row">
                        <span class="cw-lstep-tooltip-label">Status:</span>
                        <span class="cw-lstep-tooltip-status"
                              [ngClass]="'cw-lstep-ts--' + getLevelStatusSlug(lvl)">
                          {{ getLevelStatus(lvl) || '‚Äî' }}
                        </span>
                      </div>
                      <div class="cw-lstep-tooltip-row" *ngIf="getLevelReviewer(lvl)">
                        <span class="cw-lstep-tooltip-label">Reviewer:</span>
                        <span>{{ getLevelReviewer(lvl) }}</span>
                      </div>
                      <div class="cw-lstep-tooltip-hint" *ngIf="!isLatestLevel(lvl)">üîí View only</div>
                    </div>
                  </div>

                  <!-- Connector line (between nodes, not after last) -->
                  <div class="cw-lstep-connector"
                       *ngIf="!last"
                       [class.cw-lstep-connector--done]="isCompletedLevel(lvl)">
                  </div>

                </ng-container>
              </div>

              <!-- "X of N" badge -->
              <span class="cw-level-stepper-counter">
                {{ (activeLevelId$ | async) || 1 }} of {{ getTotalLevels() }}
              </span>

            </div>
          </div>
        </div>

        <div class="cw-header-divider"></div>

        <!-- Action buttons -->
        <div class="cw-header-actions">
          <button type="button"
                  class="cw-btn cw-btn-escalate"
                  (click)="toggleEscalateConfirm()"
                  [disabled]="!getCaseNumber(aggregate$ | async) || isReadOnly"
                  title="Escalate case">
            ‚ö° Escalate
          </button>

          <button type="button"
                  class="btn btn-primary"
                  (click)="saveFromTop()"
                  [disabled]="!headerForm.get('caseType')?.value || savingTop || isReadOnly">
            {{ savingTop ? 'Saving...' : isReadOnly ? 'üîí View Only' : 'Save' }}
          </button>

          <!-- AI Panel toggle -->
          <button type="button"
                  class="cw-btn-ai-toggle"
                  [class.active]="rightPanelMode === 'ai'"
                  (click)="openRightPanel('ai')"
                  [disabled]="!getCaseNumber(aggregate$ | async)"
                  title="Toggle AI Assistant">
            ü§ñ
            <span class="cw-ai-online-dot" *ngIf="getCaseNumber(aggregate$ | async)"></span>
          </button>
        </div>
      </div>

      <!-- Escalate confirmation bar -->
      <div class="cw-escalate-bar" *ngIf="showEscalateConfirm">
        <span class="cw-escalate-msg">
          Escalate this case to the next level? This will notify the supervisor.
        </span>
        <button type="button" class="cw-btn cw-btn-escalate-confirm" (click)="confirmEscalate()">
          Confirm Escalate
        </button>
        <button type="button" class="cw-btn cw-btn-cancel" (click)="cancelEscalate()">
          Cancel
        </button>
      </div>
    </div>

    <!-- Save banner (global) -->
    <div *ngIf="saveBannerText"
         class="cw-save-banner alert alert-success py-1 px-2 mb-2 d-flex align-items-center justify-content-between">
      <span>{{ saveBannerText }}</span>
      <button type="button" class="btn-close" aria-label="Close" (click)="clearSaveBanner()"></button>
    </div>



    <!-- Read-only banner -->
    <div class="cw-readonly-banner" *ngIf="isReadOnly">
      <span class="cw-readonly-icon">üîí</span>
      <span class="cw-readonly-text">
        You are viewing a previous level (read-only). Switch to <strong>Level {{ latestLevelId }}</strong> to edit.
      </span>
    </div>

    <!-- Chevron Stepper -->
    <caseChevronStepper [steps]="steps"
                        [activeStepId]="activeStepId"
                        (stepSelected)="onStepSelected($event)">
    </caseChevronStepper>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BODY: content + right panel ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="cw-body">

    <!-- Scrollable step content -->
    <div class="cw-content caseWizardBody"
         [class.cw-content--panel-open]="rightPanelOpen"
         [class.cw-content--panel-expanded]="rightPanelExpanded">
      <ng-template #stepContainer></ng-template>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         UNIFIED RIGHT PANEL
         Modes: 'ai' | 'auth' | 'claim'
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="cw-right-panel"
         [class.cw-right-panel--open]="rightPanelOpen"
         [class.cw-right-panel--expanded]="rightPanelExpanded">

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AI MODE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <ng-container *ngIf="rightPanelMode === 'ai'">

        <!-- Panel header -->
        <div class="cw-rpanel-header cw-rpanel-header--ai">
          <div class="cw-rpanel-title-block">
            <span class="cw-rpanel-icon cw-rpanel-icon--ai">ü§ñ</span>
            <div>
              <div class="cw-rpanel-title">AI Assistant</div>
              <div class="cw-rpanel-subtitle">Case Intelligence</div>
            </div>
          </div>
          <div class="cw-rpanel-actions">
            <button class="cw-rpanel-btn" (click)="togglePanelExpand()"
                    [title]="rightPanelExpanded ? 'Collapse' : 'Expand'">
              <span class="material-icons-outlined">{{ rightPanelExpanded ? 'chevron_right' : 'chevron_left' }}</span>
            </button>
            <button class="cw-rpanel-btn" (click)="closeRightPanel()">
              <span class="material-icons-outlined">close</span>
            </button>
          </div>
        </div>

        <!-- AI Panel scrollable body -->
        <div class="cw-rpanel-body">

          <!-- SLA Tracker -->
          <div class="cw-ai-section">
            <div class="cw-ai-section-header">
              <span class="cw-ai-section-label">‚è± SLA Tracker</span>
              <span class="cw-ai-badge cw-ai-badge--warning" *ngIf="slaAtRiskCount > 0">
                {{ slaAtRiskCount }} at risk
              </span>
            </div>
            <div class="cw-sla-list">
              <div class="cw-sla-item" *ngFor="let sla of slaItems"
                   [ngClass]="'cw-sla--' + sla.status">
                <div class="cw-sla-info">
                  <div class="cw-sla-label">{{ sla.label }}</div>
                  <div class="cw-sla-deadline">Due: {{ sla.deadline }}</div>
                </div>
                <div class="cw-sla-remaining">{{ sla.remaining }}</div>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="cw-ai-section">
            <div class="cw-ai-section-header">
              <span class="cw-ai-section-label">‚ö° Quick Actions</span>
            </div>
            <div class="cw-quick-actions-grid">
              <button class="cw-quick-action" *ngFor="let action of quickActions"
                      (click)="onQuickAction(action)">
                <span class="cw-qa-icon">{{ action.icon }}</span>
                <span class="cw-qa-label">{{ action.label }}</span>
                <span class="cw-qa-desc">{{ action.description }}</span>
              </button>
            </div>
          </div>

          <!-- AI Suggestions -->
          <div class="cw-ai-section">
            <div class="cw-ai-section-header">
              <span class="cw-ai-section-label">üß† AI Insights</span>
              <span class="cw-ai-badge cw-ai-badge--info">
                {{ aiSuggestions.length }} suggestions
              </span>
            </div>
            <div class="cw-ai-suggestions-list">
              <div class="cw-ai-card" *ngFor="let suggestion of aiSuggestions"
                   [ngClass]="'cw-ai-card--' + suggestion.type">
                <div class="cw-ai-card-header">
                  <div class="cw-ai-card-title-row">
                    <span class="cw-ai-card-icon">{{ suggestion.icon }}</span>
                    <span class="cw-ai-card-title">{{ suggestion.title }}</span>
                  </div>
                  <span class="cw-ai-confidence" [ngClass]="'cw-ai-confidence--' + suggestion.type">
                    {{ suggestion.confidence }}% conf.
                  </span>
                </div>
                <p class="cw-ai-card-body">{{ suggestion.body }}</p>
                <div class="cw-ai-card-actions" *ngIf="suggestion.actionLabel">
                  <button class="cw-btn cw-btn-ai-action" (click)="onAiAction(suggestion)">
                    {{ suggestion.actionLabel }}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- AI Panel footer: Ask AI -->
        <div class="cw-rpanel-footer">
          <div class="cw-ai-input-wrap">
            <span class="cw-ai-input-icon">üí¨</span>
            <input type="text"
                   class="cw-ai-input"
                   placeholder="Ask AI about this case..."
                   [(ngModel)]="aiQuery"
                   (keydown.enter)="askAi()" />
            <button class="cw-ai-send" (click)="askAi()" [disabled]="!aiQuery?.trim()">‚Üí</button>
          </div>
        </div>
      </ng-container>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTHORIZATION MODE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <ng-container *ngIf="rightPanelMode === 'auth'">

        <div class="cw-rpanel-header cw-rpanel-header--auth">
          <div class="cw-rpanel-title-block">
            <span class="cw-rpanel-icon cw-rpanel-icon--auth">
              <span class="material-icons-outlined" style="font-size:14px">verified_user</span>
            </span>
            <div>
              <div class="cw-rpanel-title">Authorization</div>
              <div class="cw-rpanel-subtitle">{{ selectedAuthNumber }}</div>
            </div>
          </div>
          <div class="cw-rpanel-actions">
            <button class="cw-rpanel-btn" (click)="togglePanelExpand()"
                    [title]="rightPanelExpanded ? 'Collapse' : 'Expand'">
              <span class="material-icons-outlined">{{ rightPanelExpanded ? 'chevron_right' : 'chevron_left' }}</span>
            </button>
            <button class="cw-rpanel-btn" (click)="closeRightPanel()">
              <span class="material-icons-outlined">close</span>
            </button>
          </div>
        </div>

        <div class="cw-rpanel-body cw-rpanel-body--flush">
          <app-authorization-details [authNumber]="selectedAuthNumber"
                                     [embedded]="true"
                                     (closed)="closeRightPanel()">
          </app-authorization-details>
        </div>
      </ng-container>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CLAIM MODE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <ng-container *ngIf="rightPanelMode === 'claim'">

        <div class="cw-rpanel-header cw-rpanel-header--claim">
          <div class="cw-rpanel-title-block">
            <span class="cw-rpanel-icon cw-rpanel-icon--claim">
              <span class="material-icons-outlined" style="font-size:14px">receipt_long</span>
            </span>
            <div>
              <div class="cw-rpanel-title">Claim</div>
              <div class="cw-rpanel-subtitle">{{ selectedClaimNumber }}</div>
            </div>
          </div>
          <div class="cw-rpanel-actions">
            <button class="cw-rpanel-btn" (click)="togglePanelExpand()"
                    [title]="rightPanelExpanded ? 'Collapse' : 'Expand'">
              <span class="material-icons-outlined">{{ rightPanelExpanded ? 'chevron_right' : 'chevron_left' }}</span>
            </button>
            <button class="cw-rpanel-btn" (click)="closeRightPanel()">
              <span class="material-icons-outlined">close</span>
            </button>
          </div>
        </div>

        <div class="cw-rpanel-body cw-rpanel-body--flush">
          <app-claim-details [claimNumber]="selectedClaimNumber"
                             [embedded]="true"
                             (closed)="closeRightPanel()">
          </app-claim-details>
        </div>
      </ng-container>

    </div><!-- /cw-right-panel -->

  </div>
</div>
