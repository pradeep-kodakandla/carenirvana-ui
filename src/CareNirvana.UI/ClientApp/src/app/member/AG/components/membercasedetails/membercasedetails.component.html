<mat-menu #menu="matMenu">
  <button mat-menu-item *ngIf="hasPermission('Add Case Activity', 'add')">
    <span>Add Case Activity</span>
  </button>
  <button mat-menu-item *ngIf="hasPermission('Run Case Assessment', 'add')">
    <span>Run Case Assessment</span>
  </button>
  <button mat-menu-item *ngIf="hasPermission('Transfer Case', 'add')">
    <span>Transfer Case</span>
  </button>
  <button mat-menu-item *ngIf="hasPermission('Send Case Message', 'add')">
    <span>Send Case Message</span>
  </button>
  <button mat-menu-item *ngIf="hasPermission('Add Case Notes', 'add')">
    <span>Add Case Notes</span>
  </button>
  <button mat-menu-item *ngIf="hasPermission('Case Summary', 'view')">
    <span>Case Summary</span>
  </button>
  <button mat-menu-item *ngIf="hasPermission('Case History', 'view')">
    <span>Case History</span>
  </button>
</mat-menu>

<!-- ðŸ” Search + Add + View Toggles -->
<div class="d-flex justify-content-between align-items-center w-100 pb-2"
     style="padding-right:12px;padding-left:5px; padding-top:5px;">

  <!-- Search Box -->
  <div class="search-section">
    <input type="text" placeholder="ðŸ” Search..." (input)="applyFilter($event)" class="search-input" #input />
  </div>

  <!-- Add & Toggles -->
  <div class="d-flex align-items-center ms-3">
    <button matTooltip="Click to add a new case"
            class="btn btn-primary ms-2"
            (click)="onAddCaseClick()" [disabled]="!hasPagePermission('add')">
      Add Case
    </button>

    <!-- Toggle View Mode -->
    <button mat-icon-button (click)="toggleViewMode()" matTooltip="Toggle View">
      <mat-icon>{{ viewMode === 'card' ? 'table_chart' : 'view_module' }}</mat-icon>
    </button>

    <!-- Toggle Compact Mode -->
    <button mat-icon-button (click)="toggleCompactMode()" matTooltip="Toggle Compact Mode">
      <mat-icon>{{ compactMode ? 'zoom_out' : 'zoom_in' }}</mat-icon>
    </button>
  </div>
</div>

<!-- ðŸ” CARD VIEW -->
<div *ngIf="viewMode === 'card'" class="d-flex flex-column" style="margin: 0 10px;">
  <div class="row g-3">
    <div class="col-lg-4 col-md-6" *ngFor="let row of pagedCardData">
      <mat-card [ngClass]="{ 'case-card': true, 'compact': compactMode }">

        <!-- Header: Case Number | Chips | Menu -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <a class="case-link" (click)="onCaseClick(row.caseNumber)">
            {{ row.caseNumber }}
          </a>

          <div class="d-flex align-items-center">
            <span class="case-chip me-2 type">
              {{ row.caseTypeText || row.caseType || 'â€”' }}
            </span>
            <span class="case-chip me-2 status">
              {{ row.caseStatusText || 'â€”' }}
            </span>
            <button mat-icon-button [matMenuTriggerFor]="menu">
              <mat-icon>more_vert</mat-icon>
            </button>
          </div>
        </div>

        <!-- Body -->
        <div class="d-flex flex-column gap-1">
          <!--<div class="text-sm">
            <mat-icon class="me-1" fontIcon="person" inline></mat-icon>
            <strong>Member:</strong>&nbsp; {{ row.memberName || 'â€”' }}
            <span class="muted">({{ row.memberId || 'â€”' }})</span>
          </div>-->

          <div class="text-sm">
            <mat-icon class="me-1" fontIcon="flag" inline></mat-icon>
            <strong>Priority: </strong>&nbsp; {{ row.casePriorityText || row.casePriority || 'â€”' }}
          </div>

          <div class="text-sm">
            <mat-icon class="me-1" fontIcon="layers" inline></mat-icon>
            <strong>Level: </strong>&nbsp; {{ row.caseLevelId || row.levelId || 'â€”' }}
          </div>

          <div class="text-sm">
            <mat-icon class="me-1" fontIcon="schedule" inline></mat-icon>
            <strong>Received: </strong>&nbsp;
            {{ row.receivedDateTime ? (row.receivedDateTime | date:'MM/dd/yyyy HH:mm') : 'â€”' }}
          </div>

          <div class="text-sm">
            <mat-icon class="me-1" fontIcon="event" inline></mat-icon>
            <strong>Last Update: </strong>&nbsp;
            {{ row.lastDetailOn ? (row.lastDetailOn | date:'MM/dd/yyyy HH:mm') : 'â€”' }}
          </div>

          <div class="text-sm">
            <mat-icon class="me-1" fontIcon="account_circle" inline></mat-icon>
            <strong>Created: </strong>&nbsp;
            {{ row.createdByUserName || 'â€”' }}
            <span class="muted">â€¢ {{ row.createdOn | date:'MM/dd/yyyy HH:mm' }}</span>
          </div>
        </div>

      </mat-card>
    </div>
  </div>
</div>

<!-- ðŸ” TABLE VIEW -->
<div *ngIf="viewMode === 'table'" class="d-flex flex-column"
     style="margin-left:10px; margin-right:10px; width: 100%;">
  <table class="responsive-table" mat-table [dataSource]="dataSource" multiTemplateDataRows matSort>

    <!-- Action Column -->
    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let row">
        <button mat-icon-button [matMenuTriggerFor]="menu">
          <mat-icon>list</mat-icon>
        </button>
      </td>
    </ng-container>

    <ng-container matColumnDef="caseNumber">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Case # </th>
      <td mat-cell *matCellDef="let row">
        <a mat-button (click)="onCaseClick(row.caseNumber)">{{ row.caseNumber }}</a>
      </td>
    </ng-container>

    <ng-container matColumnDef="caseTypeText">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Case Type </th>
      <td mat-cell *matCellDef="let row"> {{ row.caseTypeText || row.caseType || '' }} </td>
    </ng-container>

    <!--<ng-container matColumnDef="memberName">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Member </th>
      <td mat-cell *matCellDef="let row"> {{ row.memberName || '' }} </td>
    </ng-container>-->

    <ng-container matColumnDef="casePriorityText">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Priority </th>
      <td mat-cell *matCellDef="let row"> {{ row.casePriorityText || row.casePriority || '' }} </td>
    </ng-container>

    <ng-container matColumnDef="caseStatusText">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Status </th>
      <td mat-cell *matCellDef="let row"> {{ row.caseStatusText || '' }} </td>
    </ng-container>

    <ng-container matColumnDef="receivedDateTime">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Received </th>
      <td mat-cell *matCellDef="let row">
        {{ row.receivedDateTime ? (row.receivedDateTime | date:'MM/dd/yyyy HH:mm') : '' }}
      </td>
    </ng-container>

    <ng-container matColumnDef="lastDetailOn">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Last Update </th>
      <td mat-cell *matCellDef="let row">
        {{ row.lastDetailOn ? (row.lastDetailOn | date:'MM/dd/yyyy HH:mm') : '' }}
      </td>
    </ng-container>

    <ng-container matColumnDef="createdOn">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Created On </th>
      <td mat-cell *matCellDef="let row">
        {{ row.createdOn ? (row.createdOn | date:'MM/dd/yyyy HH:mm') : '' }}
      </td>
    </ng-container>

    <ng-container matColumnDef="createdByUserName">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Created By </th>
      <td mat-cell *matCellDef="let row"> {{ row.createdByUserName || '' }} </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
  </table>
</div>

<!-- ðŸ›‘ No Data State -->
<div *ngIf="isEmpty && !isLoading" class="text-center w-100 mt-3 no-data">
  <p class="text-muted">No data available</p>
</div>

<!-- Pagination -->
<mat-paginator #paginator
               [pageSizeOptions]="[5, 10, 15, 20]"
               showFirstLastButtons
               [length]="viewMode === 'card' ? dataSource.filteredData.length : dataSource.data.length"
               [pageSize]="pageSize"
               [pageIndex]="pageIndex"
               (page)="onPageChange($event)">
</mat-paginator>
