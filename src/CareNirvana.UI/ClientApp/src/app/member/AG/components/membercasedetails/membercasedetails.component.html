<!-- â”€â”€â”€ Context Menu (shared by card + table) â”€â”€â”€ -->
<mat-menu #menu="matMenu">
  <button mat-menu-item *ngIf="hasPermission('Add Case Activity', 'add')">
    <mat-icon>add_task</mat-icon>
    <span>Add Case Activity</span>
  </button>
  <button mat-menu-item *ngIf="hasPermission('Run Case Assessment', 'add')">
    <mat-icon>assessment</mat-icon>
    <span>Run Case Assessment</span>
  </button>
  <button mat-menu-item *ngIf="hasPermission('Transfer Case', 'add')">
    <mat-icon>swap_horiz</mat-icon>
    <span>Transfer Case</span>
  </button>
  <button mat-menu-item *ngIf="hasPermission('Send Case Message', 'add')">
    <mat-icon>mail</mat-icon>
    <span>Send Case Message</span>
  </button>
  <button mat-menu-item *ngIf="hasPermission('Add Case Notes', 'add')">
    <mat-icon>note_add</mat-icon>
    <span>Add Case Notes</span>
  </button>
  <button mat-menu-item *ngIf="hasPermission('Case Summary', 'view')">
    <mat-icon>summarize</mat-icon>
    <span>Case Summary</span>
  </button>
  <button mat-menu-item *ngIf="hasPermission('Case History', 'view')">
    <mat-icon>history</mat-icon>
    <span>Case History</span>
  </button>
</mat-menu>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TOOLBAR: Search + Stats + Actions
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="mcd-toolbar">

  <!-- Search -->
  <div class="mcd-search" matTooltip="Filter cases by number, type, status, or creator">
    <mat-icon class="mcd-search-icon">search</mat-icon>
    <input type="text"
           class="mcd-search-input"
           placeholder="Search cases..."
           (input)="applyFilter($event)"
           #input />
    <button class="mcd-search-clear"
            *ngIf="input.value"
            (click)="input.value = ''; applyFilter($event)"
            matTooltip="Clear search">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Quick stats -->
  <div class="mcd-stats">
    <div class="mcd-stat" matTooltip="Total number of cases for this member">
      <span class="mcd-stat-dot mcd-stat-dot--total"></span>
      <span class="mcd-stat-label">Total</span>
      <span class="mcd-stat-value">{{ dataSource.data.length }}</span>
    </div>
    <div class="mcd-stat" *ngIf="getStatusCount('In Progress') > 0"
         matTooltip="Cases currently being reviewed">
      <span class="mcd-stat-dot mcd-stat-dot--inprogress"></span>
      <span class="mcd-stat-label">In Progress</span>
      <span class="mcd-stat-value">{{ getStatusCount('In Progress') }}</span>
    </div>
    <div class="mcd-stat" *ngIf="getStatusCount('On Hold') > 0"
         matTooltip="Cases temporarily paused">
      <span class="mcd-stat-dot mcd-stat-dot--onhold"></span>
      <span class="mcd-stat-label">On Hold</span>
      <span class="mcd-stat-value">{{ getStatusCount('On Hold') }}</span>
    </div>
    <div class="mcd-stat" *ngIf="getStatusCount('Pending') > 0"
         matTooltip="Cases awaiting action or information">
      <span class="mcd-stat-dot mcd-stat-dot--pending"></span>
      <span class="mcd-stat-label">Pending</span>
      <span class="mcd-stat-value">{{ getStatusCount('Pending') }}</span>
    </div>
  </div>

  <!-- Actions -->
  <div class="mcd-actions">
    <button class="mcd-icon-btn"
            (click)="toggleViewMode()"
            [matTooltip]="viewMode === 'card' ? 'Switch to table view' : 'Switch to card view'">
      <mat-icon>{{ viewMode === 'card' ? 'table_chart' : 'view_module' }}</mat-icon>
    </button>

    <button class="mcd-icon-btn"
            *ngIf="viewMode === 'card'"
            (click)="toggleCompactMode()"
            [class.mcd-icon-btn--active]="compactMode"
            [matTooltip]="compactMode ? 'Expand cards to show full details' : 'Collapse cards to compact view'">
      <mat-icon>{{ compactMode ? 'zoom_out' : 'zoom_in' }}</mat-icon>
    </button>

    <button class="mcd-btn-add"
            (click)="onAddCaseClick()"
            [disabled]="!hasPagePermission('add')"
            matTooltip="Create a new case for this member">
      <mat-icon>add</mat-icon>
      Add Case
    </button>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CARD VIEW
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div *ngIf="viewMode === 'card'" class="mcd-card-grid">
  <div *ngFor="let row of pagedCardData; trackBy: trackByCaseNumber"
       class="mcd-case-card"
       [class.mcd-case-card--compact]="compactMode">

    <!-- Card header: Case # + Status + Menu -->
    <div class="mcd-card-header">
      <div class="mcd-card-identity">
        <a class="mcd-case-link"
           (click)="onCaseClick(row.caseNumber)"
           [matTooltip]="'Open case ' + row.caseNumber">
          {{ row.caseNumber }}
        </a>
        <span class="mcd-status-badge"
              [ngClass]="'mcd-status--' + getStatusSlug(row)"
              [matTooltip]="'Status: ' + (row.caseStatusText || 'â€”')">
          <span class="mcd-status-dot"></span>
          {{ row.caseStatusText || 'â€”' }}
        </span>
      </div>

      <button mat-icon-button class="mcd-card-menu"
              [matMenuTriggerFor]="menu"
              matTooltip="Case actions">
        <mat-icon>more_vert</mat-icon>
      </button>
    </div>

    <!-- Badges row: Type + Priority -->
    <div class="mcd-card-badges">
      <span class="mcd-type-badge"
            [ngClass]="'mcd-type--' + getTypeSlug(row)"
            [matTooltip]="'Case type: ' + (row.caseTypeText || row.caseType || 'â€”')">
        {{ row.caseTypeText || row.caseType || 'â€”' }}
      </span>
      <span class="mcd-priority-badge"
            [ngClass]="'mcd-priority--' + getPrioritySlug(row)"
            [matTooltip]="'Priority: ' + (row.casePriorityText || row.casePriority || 'â€”')">
        {{ row.casePriorityText || row.casePriority || 'â€”' }}
      </span>
    </div>

    <!-- Level Stepper with pure-CSS hover tooltips (no flicker) -->
    <div class="mcd-level-row">
      <span class="mcd-level-label">Level</span>
      <div class="mcd-level-stepper">
        <ng-container *ngFor="let step of getLevelSteps(row); let last = last">
          <div class="mcd-level-step-wrapper">
            <div class="mcd-level-step"
                 [ngClass]="{
                   'mcd-level--completed': step.status === 'completed',
                   'mcd-level--current':   step.status === 'current',
                   'mcd-level--future':    step.status === 'future'
                 }">
              <mat-icon *ngIf="step.status === 'completed'" class="mcd-level-check">check</mat-icon>
              <span *ngIf="step.status !== 'completed'">{{ step.number }}</span>
            </div>

            <!-- Tooltip â€” always in DOM, shown/hidden via CSS :hover -->
            <div class="mcd-lstep-tooltip">
              <div class="mcd-lstep-tooltip-title">Level {{ step.number }}</div>
              <div class="mcd-lstep-tooltip-row">
                <span class="mcd-lstep-tooltip-label">Status:</span>
                <span class="mcd-lstep-tooltip-status"
                      [ngClass]="'mcd-lstep-ts--' + step.status">
                  {{ getLevelStepStatusLabel(step) }}
                </span>
              </div>
              <div class="mcd-lstep-tooltip-row" *ngIf="step.status === 'current' && row.caseStatusText">
                <span class="mcd-lstep-tooltip-label">Case Status:</span>
                <span>{{ row.caseStatusText }}</span>
              </div>
              <div class="mcd-lstep-tooltip-row" *ngIf="step.status === 'current' && row.createdByUserName">
                <span class="mcd-lstep-tooltip-label">Reviewer:</span>
                <span>{{ row.createdByUserName }}</span>
              </div>
              <div class="mcd-lstep-tooltip-row" *ngIf="step.status === 'current' && row.receivedDateTime">
                <span class="mcd-lstep-tooltip-label">Date:</span>
                <span>{{ row.receivedDateTime | date:'MM/dd/yyyy' }}</span>
              </div>
              <div class="mcd-lstep-tooltip-hint" *ngIf="step.status === 'completed'">âœ… Escalated to next level</div>
              <div class="mcd-lstep-tooltip-hint" *ngIf="step.status === 'future'">ðŸ”’ Not yet reached</div>
            </div>
          </div>

          <div class="mcd-level-connector"
               *ngIf="!last"
               [ngClass]="{ 'mcd-connector--done': step.status === 'completed' }">
          </div>
        </ng-container>
      </div>
      <span class="mcd-level-count"
            [matTooltip]="'Currently at level ' + (row.caseLevelId || 1) + ' of ' + getTotalLevels(row)">
        {{ row.caseLevelId || 1 }} of {{ getTotalLevels(row) }}
      </span>
    </div>

    <!-- Detail rows (hidden in compact) â€” COLORED ICONS -->
    <div class="mcd-card-details" *ngIf="!compactMode">

      <div class="mcd-detail-row" matTooltip="Date and time the case was received">
        <mat-icon class="mcd-detail-icon mcd-detail-icon--received">schedule</mat-icon>
        <span class="mcd-detail-label">Received</span>
        <span class="mcd-detail-value">
          {{ row.receivedDateTime ? (row.receivedDateTime | date:'MM/dd/yyyy HH:mm:ss a') : 'â€”' }}
        </span>
      </div>

      <div class="mcd-detail-row" matTooltip="Most recent update to this case">
        <mat-icon class="mcd-detail-icon mcd-detail-icon--updated">update</mat-icon>
        <span class="mcd-detail-label">Updated</span>
        <span class="mcd-detail-value">
          {{ row.lastDetailOn ? (row.lastDetailOn | date:'MM/dd/yyyy HH:mm:ss a') : 'â€”' }}
        </span>
      </div>

      <div class="mcd-detail-row" matTooltip="User who created this case">
        <mat-icon class="mcd-detail-icon mcd-detail-icon--created">person</mat-icon>
        <span class="mcd-detail-label">Created</span>
        <span class="mcd-detail-value">
          {{ row.createdByUserName || 'â€”' }}
          <span class="mcd-detail-muted">Â· {{ row.createdOn | date:'MM/dd/yyyy HH:mm:ss a' }}</span>
        </span>
      </div>

    </div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TABLE VIEW
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div *ngIf="viewMode === 'table'" class="mcd-table-wrap">
  <table class="mcd-table" mat-table [dataSource]="dataSource" matSort>

    <!-- Actions -->
    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef class="mcd-th mcd-th--actions"></th>
      <td mat-cell *matCellDef="let row" class="mcd-td mcd-td--actions">
        <button mat-icon-button class="mcd-table-menu"
                [matMenuTriggerFor]="menu"
                matTooltip="Case actions">
          <mat-icon>more_vert</mat-icon>
        </button>
      </td>
    </ng-container>

    <!-- Case # -->
    <ng-container matColumnDef="caseNumber">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="mcd-th">Case #</th>
      <td mat-cell *matCellDef="let row" class="mcd-td">
        <a class="mcd-case-link"
           (click)="onCaseClick(row.caseNumber)"
           [matTooltip]="'Open case ' + row.caseNumber">
          {{ row.caseNumber }}
        </a>
      </td>
    </ng-container>

    <!-- Type -->
    <ng-container matColumnDef="caseTypeText">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="mcd-th">Type</th>
      <td mat-cell *matCellDef="let row" class="mcd-td">
        <span class="mcd-type-badge mcd-type-badge--sm"
              [ngClass]="'mcd-type--' + getTypeSlug(row)"
              [matTooltip]="'Case type: ' + (row.caseTypeText || row.caseType || '')">
          {{ row.caseTypeText || row.caseType || '' }}
        </span>
      </td>
    </ng-container>

    <!-- Status -->
    <ng-container matColumnDef="caseStatusText">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="mcd-th">Status</th>
      <td mat-cell *matCellDef="let row" class="mcd-td">
        <span class="mcd-status-badge mcd-status-badge--sm"
              [ngClass]="'mcd-status--' + getStatusSlug(row)"
              [matTooltip]="'Status: ' + (row.caseStatusText || '')">
          <span class="mcd-status-dot"></span>
          {{ row.caseStatusText || '' }}
        </span>
      </td>
    </ng-container>

    <!-- Priority -->
    <ng-container matColumnDef="casePriorityText">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="mcd-th">Priority</th>
      <td mat-cell *matCellDef="let row" class="mcd-td">
        <span class="mcd-priority-badge mcd-priority-badge--sm"
              [ngClass]="'mcd-priority--' + getPrioritySlug(row)"
              [matTooltip]="'Priority: ' + (row.casePriorityText || row.casePriority || '')">
          {{ row.casePriorityText || row.casePriority || '' }}
        </span>
      </td>
    </ng-container>

    <!-- Level (stepper circles with matTooltip) -->
    <ng-container matColumnDef="caseLevelId">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="mcd-th">Level</th>
      <td mat-cell *matCellDef="let row" class="mcd-td">
        <div class="mcd-level-stepper mcd-level-stepper--sm">
          <ng-container *ngFor="let step of getLevelSteps(row); let last = last">
            <div class="mcd-level-step mcd-level-step--sm"
                 [ngClass]="{
                   'mcd-level--completed': step.status === 'completed',
                   'mcd-level--current':   step.status === 'current',
                   'mcd-level--future':    step.status === 'future'
                 }"
                 [matTooltip]="'Level ' + step.number + ' â€” ' + getLevelStepStatusLabel(step)">
              <mat-icon *ngIf="step.status === 'completed'" class="mcd-level-check mcd-level-check--sm">check</mat-icon>
              <span *ngIf="step.status !== 'completed'">{{ step.number }}</span>
            </div>
            <div class="mcd-level-connector mcd-level-connector--sm"
                 *ngIf="!last"
                 [ngClass]="{ 'mcd-connector--done': step.status === 'completed' }">
            </div>
          </ng-container>
        </div>
      </td>
    </ng-container>

    <!-- Received -->
    <ng-container matColumnDef="receivedDateTime">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="mcd-th">Received</th>
      <td mat-cell *matCellDef="let row" class="mcd-td mcd-td--date"
          [matTooltip]="row.receivedDateTime ? (row.receivedDateTime | date:'MM/dd/yyyy HH:mm:ss a') : ''">
        {{ row.receivedDateTime ? (row.receivedDateTime | date:'MM/dd/yyyy HH:mm') : '' }}
      </td>
    </ng-container>

    <!-- Last Update -->
    <ng-container matColumnDef="lastDetailOn">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="mcd-th">Last Update</th>
      <td mat-cell *matCellDef="let row" class="mcd-td mcd-td--date"
          [matTooltip]="row.lastDetailOn ? (row.lastDetailOn | date:'MM/dd/yyyy HH:mm:ss a') : ''">
        {{ row.lastDetailOn ? (row.lastDetailOn | date:'MM/dd/yyyy HH:mm') : '' }}
      </td>
    </ng-container>

    <!-- Created By -->
    <ng-container matColumnDef="createdByUserName">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="mcd-th">Created By</th>
      <td mat-cell *matCellDef="let row" class="mcd-td"
          [matTooltip]="row.createdByUserName ? ('Created by ' + row.createdByUserName + (row.createdOn ? ' on ' + (row.createdOn | date:'MM/dd/yyyy') : '')) : ''">
        {{ row.createdByUserName || '' }}
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"
        class="mcd-table-row"></tr>
  </table>
</div>


<!-- â•â•â• Empty State â•â•â• -->
<div *ngIf="isEmpty && !isLoading" class="mcd-empty">
  <mat-icon class="mcd-empty-icon">folder_open</mat-icon>
  <div class="mcd-empty-title">No cases found</div>
  <div class="mcd-empty-desc">Try adjusting your search or add a new case.</div>
</div>

<!-- â•â•â• Loading â•â•â• -->
<div *ngIf="isLoading" class="mcd-loading">
  <mat-spinner diameter="32"></mat-spinner>
  <span>Loading cases...</span>
</div>

<!-- â•â•â• Pagination â•â•â• -->
<mat-paginator #paginator
               class="mcd-paginator"
               [pageSizeOptions]="[5, 10, 15, 20]"
               showFirstLastButtons
               [length]="viewMode === 'card' ? dataSource.filteredData.length : dataSource.data.length"
               [pageSize]="pageSize"
               [pageIndex]="pageIndex"
               (page)="onPageChange($event)">
</mat-paginator>
