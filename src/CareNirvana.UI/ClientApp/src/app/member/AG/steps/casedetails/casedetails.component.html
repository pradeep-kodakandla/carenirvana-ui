<form class="case-details" [formGroup]="form">

  <ng-container *ngFor="let sec of renderSections; let i = index; trackBy: trackBySection">
    <div class="section-card" *ngIf="visibleSection(sec) && shouldShowSection(sec)">

      <div class="section-header"
           role="button"
           tabindex="0"
           (click)="toggleSection(sec, i)"
           (keydown.enter)="toggleSection(sec, i)"
           (keydown.space)="$event.preventDefault(); toggleSection(sec, i)"
           [attr.aria-expanded]="isSectionOpen(sec, i)">

        <span class="section-acc-icon" [class.open]="isSectionOpen(sec, i)">‚ñ∏</span>
        <div class="section-title">{{ sec.title }}</div>
      </div>

      <ng-container *ngIf="isSectionOpen(sec, i)">

        <!-- =========================
             SECTION FIELDS (NON-REPEAT)
        ========================= -->
        <ng-container *ngIf="!sec.repeat?.enabled; else sectionRepeatTpl">
          <div class="grid" style="padding-bottom:15px;">
            <ng-container *ngFor="let f of sec.fields; trackBy: trackByField">
              <ng-container *ngIf="visibleField(f, sec)">
                <ng-container *ngIf="form.get(f.controlName) as ctrl">

                  <!-- CHECKBOX -->
                  <ng-container *ngIf="f.type === 'checkbox'; else outlinedSec">
                    <div class="ff-field">
                      <div class="ff-checkbox">
                        <input type="checkbox"
                               class="form-check-input"
                               [formControlName]="f.controlName" />
                        <label class="form-check-label ff-checkbox-text">
                          {{ f.displayName }}
                          <span class="req-star" *ngIf="isRequired(ctrl, f)">*</span>
                        </label>
                      </div>

                      <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">
                        {{ f.requiredMsg || (f.displayName + ' is required') }}
                      </div>
                    </div>
                  </ng-container>

                  <!-- OUTLINED (text/select/datetime/textarea/search) -->
                  <ng-template #outlinedSec>
                    <div class="ff-field">
                      <div class="ff-outline"
                           [class.ff-disabled]="ctrl.disabled"
                           [class.ff-invalid]="ctrl.touched && ctrl.invalid"
                           (click)="selectField(f)"
                           (focusin)="selectField(f)"
                           [ngClass]="{
                                       'ff-selected': isSelected(f),
                                       'ff-changed': isChangedField(f),
                                       'ff-unchanged': !isChangedField(f)
                                     }"
                           tabindex="-1">

                        <div class="ff-float-label">
                          {{ f.displayName }}
                          <span class="req-star" *ngIf="isRequired(ctrl, f)">*</span>

                          <span class="edited-badge"
                                *ngIf="isChangedField(f)"
                                title="Value changed">
                            Edited
                          </span>
                        </div>

                        <div class="ff-body">
                          <ng-container [ngSwitch]="f.type">

                            <!-- Dropdown -->
                            <ng-container *ngSwitchCase="'select'">
                              <ui-smart-dropdown class="ff-ui"
                                                 label=""
                                                 placeholder="Select..."
                                                 [options]="getDropdownOptions(f.controlName)"
                                                 [formControlName]="f.controlName">
                              </ui-smart-dropdown>
                            </ng-container>

                            <!-- Datetime -->
                            <ng-container *ngSwitchCase="'datetime-local'">
                              <ui-datetime-picker class="ff-ui"
                                                  placeholderDate="mm/dd/yyyy"
                                                  placeholderDateTime="mm/dd/yyyy --:--"
                                                  [formControlName]="f.controlName">
                              </ui-datetime-picker>
                            </ng-container>

                            <!-- JSON typo variant -->
                            <ng-container *ngSwitchCase="'datatime-local'">
                              <ui-datetime-picker class="ff-ui"
                                                  placeholderDate="mm/dd/yyyy"
                                                  placeholderDateTime="mm/dd/yyyy --:--"
                                                  [formControlName]="f.controlName">
                              </ui-datetime-picker>
                            </ng-container>

                            <!-- Textarea -->
                            <ng-container *ngSwitchCase="'textarea'">
                              <textarea class="ff-input ff-textarea"
                                        rows="3"
                                        [formControlName]="f.controlName"></textarea>
                            </ng-container>

                            <!-- SEARCH (full width) -->
                            <ng-container *ngSwitchCase="'search'">
                              <div class="ff-field ff-span-all">
                                <div class="ff-searchbar"
                                     (click)="selectField(f)"
                                     (focusin)="selectField(f)">
                                  <span class="ff-search-icon" aria-hidden="true">
                                    <svg viewBox="0 0 24 24" width="18" height="18" focusable="false">
                                      <path d="M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16Zm11.7 2.3-5.4-5.4a9.5 9.5 0 1 0-1.4 1.4l5.4 5.4a1 1 0 0 0 1.4-1.4Z"></path>
                                    </svg>
                                  </span>

                                  <input class="ff-search-input"
                                         type="search"
                                         [attr.placeholder]="(f.label || '').trim() || 'Search...'"
                                         [formControlName]="f.controlName" />
                                </div>
                              </div>
                            </ng-container>

                            <!-- Default text -->
                            <ng-container *ngSwitchDefault>
                              <input class="ff-input"
                                     type="text"
                                     [formControlName]="f.controlName" />
                            </ng-container>

                          </ng-container>
                        </div>
                      </div>

                      <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">
                        {{ f.requiredMsg || (f.label + ' is required') }}
                      </div>
                    </div>
                  </ng-template>

                </ng-container>
              </ng-container>
            </ng-container>
          </div>
        </ng-container>

        <!-- =========================
             SECTION FIELDS (REPEAT)
        ========================= -->
        <ng-template #sectionRepeatTpl>
          <div class="ff-repeat-wrap">
            <ng-container *ngFor="let inst of sec.instances; trackBy: trackByRepeatInst">
              <div class="ff-repeat-group">
                <div class="ff-repeat-header">
                  <div class="ff-repeat-title">{{ sec.repeat?.instanceLabel }} #{{ inst.index }}</div>
                </div>

                <div class="grid ff-repeat-grid">
                  <ng-container *ngFor="let f of inst.fields; trackBy: trackByField">
                    <ng-container *ngIf="visibleField(f, sec, undefined, { repeatPrefix: sec.repeatPrefix!, repeatIndex: inst.index })">
                      <ng-container *ngIf="form.get(f.controlName) as ctrl">

                        <!-- CHECKBOX -->
                        <ng-container *ngIf="f.type === 'checkbox'; else outlinedSecRep">
                          <div class="ff-field">
                            <div class="ff-checkbox">
                              <input type="checkbox"
                                     class="form-check-input"
                                     [formControlName]="f.controlName" />
                              <label class="form-check-label ff-checkbox-text">
                                {{ f.displayName }}
                                <span class="req-star" *ngIf="isRequired(ctrl, f)">*</span>
                              </label>
                            </div>

                            <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">
                              {{ f.requiredMsg || (f.displayName + ' is required') }}
                            </div>
                          </div>
                        </ng-container>

                        <!-- OUTLINED -->
                        <ng-template #outlinedSecRep>
                          <div class="ff-field" [class.ff-span-all]="f.type==='search'">
                            <div class="ff-outline"
                                 [class.ff-disabled]="ctrl.disabled"
                                 [class.ff-invalid]="ctrl.touched && ctrl.invalid"
                                 (click)="selectField(f)"
                                 (focusin)="selectField(f)"
                                 [ngClass]="{
                                       'ff-selected': isSelected(f),
                                       'ff-changed': isChangedField(f),
                                       'ff-unchanged': !isChangedField(f)
                                     }"
                                 tabindex="-1">

                              <div class="ff-float-label">
                                {{ f.displayName }}
                                <span class="req-star" *ngIf="isRequired(ctrl, f)">*</span>
                              </div>

                              <div class="ff-body">
                                <ng-container [ngSwitch]="f.type">

                                  <!-- Dropdown -->
                                  <ng-container *ngSwitchCase="'select'">
                                    <ui-smart-dropdown class="ff-ui"
                                                       label=""
                                                       placeholder="Select..."
                                                       [options]="getDropdownOptions(f.controlName)"
                                                       [formControlName]="f.controlName">
                                    </ui-smart-dropdown>
                                  </ng-container>

                                  <!-- Datetime -->
                                  <ng-container *ngSwitchCase="'datetime-local'">
                                    <ui-datetime-picker class="ff-ui"
                                                        placeholderDate="mm/dd/yyyy"
                                                        placeholderDateTime="mm/dd/yyyy --:--"
                                                        [formControlName]="f.controlName">
                                    </ui-datetime-picker>
                                  </ng-container>

                                  <ng-container *ngSwitchCase="'datatime-local'">
                                    <ui-datetime-picker class="ff-ui"
                                                        placeholderDate="mm/dd/yyyy"
                                                        placeholderDateTime="mm/dd/yyyy --:--"
                                                        [formControlName]="f.controlName">
                                    </ui-datetime-picker>
                                  </ng-container>

                                  <!-- Textarea -->
                                  <ng-container *ngSwitchCase="'textarea'">
                                    <textarea class="ff-input ff-textarea"
                                              rows="3"
                                              [formControlName]="f.controlName"></textarea>
                                  </ng-container>

                                  <!-- SEARCH -->
                                  <ng-container *ngSwitchCase="'search'">
                                    <div class="ff-searchbar"
                                         (click)="selectField(f)"
                                         (focusin)="selectField(f)">
                                      <span class="ff-search-icon" aria-hidden="true">
                                        <svg viewBox="0 0 24 24" width="18" height="18" focusable="false">
                                          <path d="M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16Zm11.7 2.3-5.4-5.4a9.5 9.5 0 1 0-1.4 1.4l5.4 5.4a1 1 0 0 0 1.4-1.4Z"></path>
                                        </svg>
                                      </span>

                                      <input class="ff-search-input"
                                             type="search"
                                             [attr.placeholder]="(f.label || '').trim() || 'Search...'"
                                             [formControlName]="f.controlName" />
                                    </div>
                                  </ng-container>

                                  <!-- Default text -->
                                  <ng-container *ngSwitchDefault>
                                    <input class="ff-input"
                                           type="text"
                                           [formControlName]="f.controlName" />
                                  </ng-container>

                                </ng-container>
                              </div>
                            </div>

                            <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">
                              {{ f.requiredMsg || (f.displayName + ' is required') }}
                            </div>
                          </div>
                        </ng-template>

                      </ng-container>
                    </ng-container>
                  </ng-container>

                  <!-- Repeat controls in last cell -->
                  <div class="ff-repeat-cell" *ngIf="sec.repeat?.showControls">
                    <button type="button"
                            class="ff-repeat-btn"
                            [disabled]="!canAddRepeat(sec)"
                            (click)="addRepeat(sec)"
                            title="Add">
                      +
                    </button>
                    <button type="button"
                            class="ff-repeat-btn danger"
                            [disabled]="!canRemoveRepeat(sec)"
                            (click)="removeRepeat(sec, inst.index)"
                            title="Remove this group">
                      ‚àí
                    </button>
                  </div>

                </div>
              </div>
            </ng-container>
          </div>
        </ng-template>

        <!-- =========================
             SUBSECTIONS (recursive)
        ========================= -->
        <ng-container *ngFor="let sub of sec.subsections; trackBy: trackBySub">
          <ng-container *ngTemplateOutlet="subTpl; context: { $implicit: sub, sec: sec, depth: 0 }"></ng-container>
        </ng-container>

      </ng-container>
    </div>
  </ng-container>

  <!-- =========================
       Recursive subsection template
  ========================= -->
  <ng-template #subTpl let-sub let-sec="sec" let-depth="depth">
    <div class="sub-card"
         [class.sub-nested]="depth > 0"
         *ngIf="visibleSubsection(sub, sec)">
      <!--[style.marginLeft.px]="depth * 12"-->
      <div class="sub-float-label">{{ sub.title }}</div>

      <!-- Non-repeat subsection fields -->
      <ng-container *ngIf="!sub.repeat?.enabled; else subRepeatTpl">
        <div class="grid">
          <ng-container *ngFor="let f of sub.fields; trackBy: trackByField">
            <ng-container *ngIf="visibleField(f, sec, sub)">
              <ng-container *ngIf="form.get(f.controlName) as ctrl">

                <!-- CHECKBOX -->
                <ng-container *ngIf="f.type === 'checkbox'; else outlinedSub">
                  <div class="ff-field">
                    <div class="ff-checkbox">
                      <input type="checkbox"
                             class="form-check-input"
                             [formControlName]="f.controlName" />
                      <label class="form-check-label ff-checkbox-text">
                        {{ f.displayName }}
                        <span class="req-star" *ngIf="isRequired(ctrl, f)">*</span>
                      </label>
                    </div>

                    <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">
                      {{ f.requiredMsg || (f.displayName + ' is required') }}
                    </div>
                  </div>
                </ng-container>

                <!-- OUTLINED -->
                <ng-template #outlinedSub>
                  <div class="ff-field" [class.ff-span-all]="f.type==='search'">
                    <div class="ff-outline"
                         [class.ff-disabled]="ctrl.disabled"
                         [class.ff-invalid]="ctrl.touched && ctrl.invalid"
                         (click)="selectField(f)"
                         (focusin)="selectField(f)"
                         [ngClass]="{
                                        'ff-selected': isSelected(f),
                                        'ff-changed': isChangedField(f),
                                        'ff-unchanged': !isChangedField(f)
                                      }"
                         tabindex="-1">

                      <div class="ff-float-label">
                        {{ f.displayName }}
                        <span class="req-star" *ngIf="isRequired(ctrl, f)">*</span>
                      </div>

                      <div class="ff-body">
                        <ng-container [ngSwitch]="f.type">

                          <!-- Dropdown -->
                          <ng-container *ngSwitchCase="'select'">
                            <ui-smart-dropdown class="ff-ui"
                                               label=""
                                               placeholder="Select..."
                                               [options]="getDropdownOptions(f.controlName)"
                                               [formControlName]="f.controlName">
                            </ui-smart-dropdown>
                          </ng-container>

                          <!-- Datetime -->
                          <ng-container *ngSwitchCase="'datetime-local'">
                            <ui-datetime-picker class="ff-ui"
                                                placeholderDate="mm/dd/yyyy"
                                                placeholderDateTime="mm/dd/yyyy --:--"
                                                [formControlName]="f.controlName">
                            </ui-datetime-picker>
                          </ng-container>

                          <ng-container *ngSwitchCase="'datatime-local'">
                            <ui-datetime-picker class="ff-ui"
                                                placeholderDate="mm/dd/yyyy"
                                                placeholderDateTime="mm/dd/yyyy --:--"
                                                [formControlName]="f.controlName">
                            </ui-datetime-picker>
                          </ng-container>

                          <ng-container *ngSwitchCase="'textarea'">
                            <textarea class="ff-input ff-textarea"
                                      rows="3"
                                      [formControlName]="f.controlName"></textarea>
                          </ng-container>

                          <ng-container *ngSwitchCase="'search'">
                            <div class="ff-searchbar"
                                 (click)="selectField(f)"
                                 (focusin)="selectField(f)">
                              <span class="ff-search-icon" aria-hidden="true">
                                <!--<svg viewBox="0 0 24 24" width="18" height="18" focusable="false">
                              <path d="M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16Zm11.7 2.3-5.4-5.4a9.5 9.5 0 1 0-1.4 1.4l5.4 5.4a1 1 0 0 0 1.4-1.4Z"></path>
                            </svg>-->
                                üîç
                              </span>

                              <input class="ff-search-input"
                                     type="search"
                                     [attr.placeholder]="(f.label || '').trim() || 'Search...'"
                                     [formControlName]="f.controlName" />
                            </div>
                          </ng-container>

                          <ng-container *ngSwitchDefault>
                            <input class="ff-input"
                                   type="text"
                                   [formControlName]="f.controlName" />
                          </ng-container>

                        </ng-container>
                      </div>
                    </div>

                    <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">
                      {{ f.requiredMsg || (f.displayName + ' is required') }}
                    </div>
                  </div>
                </ng-template>

              </ng-container>
            </ng-container>
          </ng-container>
        </div>
      </ng-container>

      <!-- Repeat subsection fields -->
      <ng-template #subRepeatTpl>
        <div class="ff-repeat-wrap">
          <ng-container *ngFor="let inst of sub.instances; trackBy: trackByRepeatInst">
            <div class="ff-repeat-group">
              <div class="ff-repeat-header">
                <div class="ff-repeat-title">{{ sub.repeat?.instanceLabel }} #{{ inst.index }}</div>
              </div>

              <div class="grid ff-repeat-grid">
                <ng-container *ngFor="let f of inst.fields; trackBy: trackByField">
                  <ng-container *ngIf="visibleField(f, sec, sub, { repeatPrefix: sub.repeatPrefix!, repeatIndex: inst.index })">
                    <ng-container *ngIf="form.get(f.controlName) as ctrl">

                      <!-- CHECKBOX -->
                      <ng-container *ngIf="f.type === 'checkbox'; else outlinedSubRep">
                        <div class="ff-field">
                          <div class="ff-checkbox">
                            <input type="checkbox"
                                   class="form-check-input"
                                   [formControlName]="f.controlName" />
                            <label class="form-check-label ff-checkbox-text">
                              {{ f.displayName }}
                              <span class="req-star" *ngIf="isRequired(ctrl, f)">*</span>
                            </label>
                          </div>

                          <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">
                            {{ f.requiredMsg || (f.displayName + ' is required') }}
                          </div>
                        </div>
                      </ng-container>

                      <!-- OUTLINED -->
                      <ng-template #outlinedSubRep>
                        <div class="ff-field" [class.ff-span-all]="f.type==='search'">
                          <div class="ff-outline"
                               [class.ff-disabled]="ctrl.disabled"
                               [class.ff-invalid]="ctrl.touched && ctrl.invalid"
                               (click)="selectField(f)"
                               (focusin)="selectField(f)"
                               [ngClass]="{
                                        'ff-selected': isSelected(f),
                                        'ff-changed': isChangedField(f),
                                        'ff-unchanged': !isChangedField(f)
                                      }"
                               tabindex="-1">

                            <div class="ff-float-label">
                              {{ f.displayName }}
                              <span class="req-star" *ngIf="isRequired(ctrl, f)">*</span>
                            </div>

                            <div class="ff-body">
                              <ng-container [ngSwitch]="f.type">

                                <!-- Dropdown -->
                                <ng-container *ngSwitchCase="'select'">
                                  <ui-smart-dropdown class="ff-ui"
                                                     label=""
                                                     placeholder="Select..."
                                                     [options]="getDropdownOptions(f.controlName)"
                                                     [formControlName]="f.controlName">
                                  </ui-smart-dropdown>
                                </ng-container>

                                <!-- Datetime -->
                                <ng-container *ngSwitchCase="'datetime-local'">
                                  <ui-datetime-picker class="ff-ui"
                                                      placeholderDate="mm/dd/yyyy"
                                                      placeholderDateTime="mm/dd/yyyy --:--"
                                                      [formControlName]="f.controlName">
                                  </ui-datetime-picker>
                                </ng-container>

                                <ng-container *ngSwitchCase="'datatime-local'">
                                  <ui-datetime-picker class="ff-ui"
                                                      placeholderDate="mm/dd/yyyy"
                                                      placeholderDateTime="mm/dd/yyyy --:--"
                                                      [formControlName]="f.controlName">
                                  </ui-datetime-picker>
                                </ng-container>

                                <ng-container *ngSwitchCase="'textarea'">
                                  <textarea class="ff-input ff-textarea"
                                            rows="3"
                                            [formControlName]="f.controlName"></textarea>
                                </ng-container>

                                <ng-container *ngSwitchCase="'search'">
                                  <div class="ff-searchbar"
                                       (click)="selectField(f)"
                                       (focusin)="selectField(f)">
                                    <span class="ff-search-icon" aria-hidden="true">
                                      <!--<svg viewBox="0 0 24 24" width="18" height="18" focusable="false">
                                    <path d="M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16Zm11.7 2.3-5.4-5.4a9.5 9.5 0 1 0-1.4 1.4l5.4 5.4a1 1 0 0 0 1.4-1.4Z"></path>
                                  </svg>-->
                                      üîç
                                    </span>

                                    <input class="ff-search-input"
                                           type="search"
                                           [attr.placeholder]="(f.label || '').trim() || 'Search...'"
                                           [formControlName]="f.controlName" />
                                  </div>
                                </ng-container>

                                <ng-container *ngSwitchDefault>
                                  <input class="ff-input"
                                         type="text"
                                         [formControlName]="f.controlName" />
                                </ng-container>

                              </ng-container>
                            </div>
                          </div>

                          <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">
                            {{ f.requiredMsg || (f.displayName + ' is required') }}
                          </div>
                        </div>
                      </ng-template>

                    </ng-container>
                  </ng-container>
                </ng-container>

                <!-- Repeat controls in last cell -->
                <div class="ff-repeat-cell" *ngIf="sub.repeat?.showControls">
                  <button type="button"
                          class="ff-repeat-btn"
                          [disabled]="!canAddRepeat(sub)"
                          (click)="addRepeat(sub)"
                          title="Add">
                    +
                  </button>
                  <button type="button"
                          class="ff-repeat-btn danger"
                          [disabled]="!canRemoveRepeat(sub)"
                          (click)="removeRepeat(sub, inst.index)"
                          title="Remove this group">
                    ‚àí
                  </button>
                </div>

              </div>
            </div>
          </ng-container>
        </div>
      </ng-template>

      <!-- Nested subsections -->
      <ng-container *ngFor="let child of sub.subsections; trackBy: trackBySub">
        <ng-container *ngTemplateOutlet="subTpl; context: { $implicit: child, sec: sec, depth: depth + 1 }"></ng-container>
      </ng-container>

    </div>
  </ng-template>

</form>
