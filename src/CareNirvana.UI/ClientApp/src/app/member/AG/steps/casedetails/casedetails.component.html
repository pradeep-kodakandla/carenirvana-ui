<form class="case-details" [formGroup]="form" [class.cw-readonly]="readOnly">

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Enrollment Details ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="section-card">
    <div class="section-header">
      <span class="section-icon"><mat-icon>badge</mat-icon></span>
      <span class="section-acc-icon open">‚ñ∏</span>
      <div class="section-title">Enrollment Details</div>
    </div>

    <div class="selection-container">
      <div class="rounded-box"
           *ngFor="let enr of memberEnrollments; let i = index"
           (click)="!readOnly && selectEnrollment(i)"
           [ngClass]="{ 'selected': selectedDiv === (i + 1) }">
        <div class="pairs">
          <div class="pair-row" *ngFor="let pair of getEnrollmentDisplayPairs(enr)">
            <label class="label key">{{ pair.label }}</label>
            <label class="label value" [title]="pair.value">{{ pair.value }}</label>
          </div>
        </div>
      </div>
    </div>

    <div class="ff-error" *ngIf="!enrollmentSelect" style="padding: 0 18px 12px;">
      Please select an Enrollment card.
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Case Type ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="section-card">
    <div class="grid">
      <div class="ff-field case-type-field">
        <div class="ff-outline"
             [class.ff-disabled]="isCaseTypeLocked()"
             [class.ff-invalid]="caseTypeCtrl.touched && caseTypeCtrl.invalid">
          <div class="ff-float-label">
            Case Type <span class="req-star">*</span>
          </div>
          <div class="ff-body">
            <ui-smart-dropdown class="ff-ui"
                               label=""
                               placeholder="Select Case Type..."
                               [options]="caseTypeOptions"
                               [formControl]="caseTypeCtrl"
                               [disabled]="isCaseTypeLocked()">
            </ui-smart-dropdown>
          </div>
        </div>
        <div class="ff-hint" *ngIf="showCaseTypeFirstLoadHint">
          <span class="hint-icon">i</span>
          <span>Please select the <strong>Case Type</strong> to continue.</span>
        </div>
        <div class="ff-error" *ngIf="caseTypeCtrl.touched && caseTypeCtrl.invalid">
          Case Type is required.
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Dynamic Sections ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <ng-container *ngFor="let sec of renderSections; let i = index; trackBy: trackBySection">
    <div class="section-card" *ngIf="visibleSection(sec) && shouldShowSection(sec)">

      <div class="section-header"
           role="button"
           tabindex="0"
           (click)="toggleSection(sec, i)"
           (keydown.enter)="toggleSection(sec, i)"
           (keydown.space)="$event.preventDefault(); toggleSection(sec, i)"
           [attr.aria-expanded]="isSectionOpen(sec, i)">
        <span class="section-icon"><mat-icon>{{ getSectionIcon(sec.title) }}</mat-icon></span>
        <span class="section-acc-icon" [class.open]="isSectionOpen(sec, i)">‚ñ∏</span>
        <div class="section-title">{{ sec.title }}</div>
      </div>

      <ng-container *ngIf="isSectionOpen(sec, i)">

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SECTION FIELDS (non-repeat) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <ng-container *ngIf="!sec.repeat?.enabled; else sectionRepeatTpl">
          <div class="grid">
            <ng-container *ngFor="let f of sec.fields; trackBy: trackByField">
              <ng-container *ngIf="visibleField(f, sec)">
                <ng-container *ngIf="form.get(f.controlName) as ctrl">

                  <ng-container *ngIf="f.type === 'checkbox'; else outlinedSec">
                    <div class="ff-field">
                      <div class="ff-checkbox">
                        <input type="checkbox" class="form-check-input" [formControlName]="f.controlName" />
                        <label class="form-check-label ff-checkbox-text">
                          {{ f.displayName }}
                          <span class="req-star" *ngIf="isRequired(ctrl, f)">*</span>
                        </label>
                      </div>
                      <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">
                        {{ f.requiredMsg || (f.displayName + ' is required') }}
                      </div>
                    </div>
                  </ng-container>

                  <ng-template #outlinedSec>
                    <!-- Search fields span 2 cols in section grids (NOT full row) -->
                    <div class="ff-field" [class.ff-span-search]="f.type==='search'">
                      <div class="ff-outline"
                           [class.ff-disabled]="ctrl.disabled"
                           [class.ff-invalid]="ctrl.touched && ctrl.invalid"
                           (click)="selectField(f)"
                           (focusin)="selectField(f)"
                           [ngClass]="{
                             'ff-selected': isSelected(f),
                             'ff-changed': isChangedField(f),
                             'ff-unchanged': !isChangedField(f)
                           }"
                           tabindex="-1">
                        <div class="ff-float-label">
                          {{ f.displayName }}
                          <span class="req-star" *ngIf="isRequired(ctrl, f)">*</span>
                          <span class="edited-badge" *ngIf="isChangedField(f)" title="Value changed">Edited</span>
                        </div>
                        <div class="ff-body">
                          <ng-container [ngSwitch]="f.type">
                            <ng-container *ngSwitchCase="'select'">
                              <ui-smart-dropdown class="ff-ui" label="" placeholder="Select..."
                                [options]="getDropdownOptions(f.controlName)" [formControlName]="f.controlName">
                              </ui-smart-dropdown>
                            </ng-container>
                            <ng-container *ngSwitchCase="'datetime-local'">
                              <ui-datetime-picker class="ff-ui" placeholderDate="mm/dd/yyyy"
                                placeholderDateTime="mm/dd/yyyy --:--" [formControlName]="f.controlName">
                              </ui-datetime-picker>
                            </ng-container>
                            <ng-container *ngSwitchCase="'datatime-local'">
                              <ui-datetime-picker class="ff-ui" placeholderDate="mm/dd/yyyy"
                                placeholderDateTime="mm/dd/yyyy --:--" [formControlName]="f.controlName">
                              </ui-datetime-picker>
                            </ng-container>
                            <ng-container *ngSwitchCase="'textarea'">
                              <textarea class="ff-input ff-textarea" rows="3" [formControlName]="f.controlName"></textarea>
                            </ng-container>
                            <ng-container *ngSwitchCase="'search'">
                              <ui-smart-lookup class="ff-ui ff-lookup"
                                [placeholder]="getLookupPlaceholder(f)" [minChars]="getLookupMinChars(f)"
                                [debounceMs]="getLookupDebounceMs(f)" [limit]="getLookupLimit(f)"
                                [searchFn]="getLookupSearchFn(f)" [displayWith]="getLookupDisplayWith(f)"
                                [trackBy]="getLookupTrackBy(f)" [formControlName]="f.controlName"
                                (selected)="onLookupSelected(f, $event)"
                                (textChange)="onLookupTextChange(f, $event)"
                                (cleared)="onLookupCleared(f)">
                              </ui-smart-lookup>
                            </ng-container>
                            <ng-container *ngSwitchDefault>
                              <input class="ff-input" type="text" [formControlName]="f.controlName" />
                            </ng-container>
                          </ng-container>
                        </div>
                      </div>
                      <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">
                        {{ f.requiredMsg || (f.label + ' is required') }}
                      </div>
                    </div>
                  </ng-template>

                </ng-container>
              </ng-container>
            </ng-container>
          </div>
        </ng-container>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SECTION FIELDS (repeat) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <ng-template #sectionRepeatTpl>
          <div class="ff-repeat-wrap">
            <ng-container *ngFor="let inst of sec.instances; trackBy: trackByRepeatInst">
              <div class="ff-repeat-group">

                <!-- Repeat header WITH +/- buttons inline -->
                <div class="ff-repeat-header">
                  <div class="ff-repeat-title">{{ sec.repeat?.instanceLabel }} #{{ inst.index }}</div>
                  <div class="ff-repeat-actions" *ngIf="sec.repeat?.showControls">
                    <button type="button" class="ff-repeat-btn" [disabled]="!canAddRepeat(sec)" (click)="addRepeat(sec)" title="Add">+</button>
                    <button type="button" class="ff-repeat-btn danger" [disabled]="!canRemoveRepeat(sec)" (click)="removeRepeat(sec, inst.index)" title="Remove">‚àí</button>
                  </div>
                </div>

                <!-- Fields grid (NO +/- inside grid anymore) -->
                <div class="grid ff-repeat-grid">
                  <ng-container *ngFor="let f of inst.fields; trackBy: trackByField">
                    <ng-container *ngIf="visibleField(f, sec, undefined, { repeatPrefix: sec.repeatPrefix!, repeatIndex: inst.index })">
                      <ng-container *ngIf="form.get(f.controlName) as ctrl">

                        <ng-container *ngIf="f.type === 'checkbox'; else outlinedSecRep">
                          <div class="ff-field">
                            <div class="ff-checkbox">
                              <input type="checkbox" class="form-check-input" [formControlName]="f.controlName" />
                              <label class="form-check-label ff-checkbox-text">
                                {{ f.displayName }}
                                <span class="req-star" *ngIf="isRequired(ctrl, f)">*</span>
                              </label>
                            </div>
                            <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">
                              {{ f.requiredMsg || (f.displayName + ' is required') }}
                            </div>
                          </div>
                        </ng-container>

                        <ng-template #outlinedSecRep>
                          <!-- NO ff-span-all in repeat grids ‚Äî search gets normal column -->
                          <div class="ff-field">
                            <div class="ff-outline"
                                 [class.ff-disabled]="ctrl.disabled"
                                 [class.ff-invalid]="ctrl.touched && ctrl.invalid"
                                 (click)="selectField(f)"
                                 (focusin)="selectField(f)"
                                 [ngClass]="{
                                   'ff-selected': isSelected(f),
                                   'ff-changed': isChangedField(f),
                                   'ff-unchanged': !isChangedField(f)
                                 }"
                                 tabindex="-1">
                              <div class="ff-float-label">
                                {{ f.displayName }}
                                <span class="req-star" *ngIf="isRequired(ctrl, f)">*</span>
                              </div>
                              <div class="ff-body">
                                <ng-container [ngSwitch]="f.type">
                                  <ng-container *ngSwitchCase="'select'">
                                    <ui-smart-dropdown class="ff-ui" label="" placeholder="Select..."
                                      [options]="getDropdownOptions(f.controlName)" [formControlName]="f.controlName">
                                    </ui-smart-dropdown>
                                  </ng-container>
                                  <ng-container *ngSwitchCase="'datetime-local'">
                                    <ui-datetime-picker class="ff-ui" placeholderDate="mm/dd/yyyy"
                                      placeholderDateTime="mm/dd/yyyy --:--" [formControlName]="f.controlName">
                                    </ui-datetime-picker>
                                  </ng-container>
                                  <ng-container *ngSwitchCase="'datatime-local'">
                                    <ui-datetime-picker class="ff-ui" placeholderDate="mm/dd/yyyy"
                                      placeholderDateTime="mm/dd/yyyy --:--" [formControlName]="f.controlName">
                                    </ui-datetime-picker>
                                  </ng-container>
                                  <ng-container *ngSwitchCase="'textarea'">
                                    <textarea class="ff-input ff-textarea" rows="3" [formControlName]="f.controlName"></textarea>
                                  </ng-container>
                                  <ng-container *ngSwitchCase="'search'">
                                    <ui-smart-lookup class="ff-ui ff-lookup"
                                      [placeholder]="getLookupPlaceholder(f)" [minChars]="getLookupMinChars(f)"
                                      [debounceMs]="getLookupDebounceMs(f)" [limit]="getLookupLimit(f)"
                                      [searchFn]="getLookupSearchFn(f)" [displayWith]="getLookupDisplayWith(f)"
                                      [trackBy]="getLookupTrackBy(f)" [formControlName]="f.controlName"
                                      (selected)="onLookupSelected(f, $event, { repeatPrefix: sec.repeatPrefix!, repeatIndex: inst.index })"
                                      (textChange)="onLookupTextChange(f, $event, { repeatPrefix: sec.repeatPrefix!, repeatIndex: inst.index })"
                                      (cleared)="onLookupCleared(f, { repeatPrefix: sec.repeatPrefix!, repeatIndex: inst.index })">
                                    </ui-smart-lookup>
                                  </ng-container>
                                  <ng-container *ngSwitchDefault>
                                    <input class="ff-input" type="text" [formControlName]="f.controlName" />
                                  </ng-container>
                                </ng-container>
                              </div>
                            </div>
                            <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">
                              {{ f.requiredMsg || (f.displayName + ' is required') }}
                            </div>
                          </div>
                        </ng-template>

                      </ng-container>
                    </ng-container>
                  </ng-container>
                </div>
              </div>
            </ng-container>
          </div>
        </ng-template>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SUBSECTIONS (recursive) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <ng-container *ngFor="let sub of sec.subsections; trackBy: trackBySub">
          <ng-container *ngTemplateOutlet="subTpl; context: { $implicit: sub, sec: sec, depth: 0 }"></ng-container>
        </ng-container>

      </ng-container>
    </div>
  </ng-container>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Recursive Subsection Template ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <ng-template #subTpl let-sub let-sec="sec" let-depth="depth">
    <div class="sub-card"
         [class.sub-nested]="depth > 0"
         *ngIf="visibleSubsection(sub, sec)">

      <div class="sub-float-label">{{ sub.title }}</div>

      <!-- Non-repeat subsection fields -->
      <ng-container *ngIf="!sub.repeat?.enabled; else subRepeatTpl">
        <div class="grid">
          <ng-container *ngFor="let f of sub.fields; trackBy: trackByField">
            <ng-container *ngIf="visibleField(f, sec, sub)">
              <ng-container *ngIf="form.get(f.controlName) as ctrl">

                <ng-container *ngIf="f.type === 'checkbox'; else outlinedSub">
                  <div class="ff-field">
                    <div class="ff-checkbox">
                      <input type="checkbox" class="form-check-input" [formControlName]="f.controlName" />
                      <label class="form-check-label ff-checkbox-text">
                        {{ f.displayName }}
                        <span class="req-star" *ngIf="isRequired(ctrl, f)">*</span>
                      </label>
                    </div>
                    <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">
                      {{ f.requiredMsg || (f.displayName + ' is required') }}
                    </div>
                  </div>
                </ng-container>

                <ng-template #outlinedSub>
                  <!-- Search spans 2 cols in subsection grids -->
                  <div class="ff-field" [class.ff-span-search]="f.type==='search'">
                    <div class="ff-outline"
                         [class.ff-disabled]="ctrl.disabled"
                         [class.ff-invalid]="ctrl.touched && ctrl.invalid"
                         (click)="selectField(f)"
                         (focusin)="selectField(f)"
                         [ngClass]="{
                           'ff-selected': isSelected(f),
                           'ff-changed': isChangedField(f),
                           'ff-unchanged': !isChangedField(f)
                         }"
                         tabindex="-1">
                      <div class="ff-float-label">
                        {{ f.displayName }}
                        <span class="req-star" *ngIf="isRequired(ctrl, f)">*</span>
                        <span class="edited-badge" *ngIf="isChangedField(f)" title="Value changed">Edited</span>
                      </div>
                      <div class="ff-body">
                        <ng-container [ngSwitch]="f.type">
                          <ng-container *ngSwitchCase="'select'">
                            <ui-smart-dropdown class="ff-ui" label="" placeholder="Select..."
                              [options]="getDropdownOptions(f.controlName)" [formControlName]="f.controlName">
                            </ui-smart-dropdown>
                          </ng-container>
                          <ng-container *ngSwitchCase="'datetime-local'">
                            <ui-datetime-picker class="ff-ui" placeholderDate="mm/dd/yyyy"
                              placeholderDateTime="mm/dd/yyyy --:--" [formControlName]="f.controlName">
                            </ui-datetime-picker>
                          </ng-container>
                          <ng-container *ngSwitchCase="'datatime-local'">
                            <ui-datetime-picker class="ff-ui" placeholderDate="mm/dd/yyyy"
                              placeholderDateTime="mm/dd/yyyy --:--" [formControlName]="f.controlName">
                            </ui-datetime-picker>
                          </ng-container>
                          <ng-container *ngSwitchCase="'textarea'">
                            <textarea class="ff-input ff-textarea" rows="3" [formControlName]="f.controlName"></textarea>
                          </ng-container>
                          <ng-container *ngSwitchCase="'search'">
                            <ui-smart-lookup class="ff-ui ff-lookup"
                              [placeholder]="getLookupPlaceholder(f)" [minChars]="getLookupMinChars(f)"
                              [debounceMs]="getLookupDebounceMs(f)" [limit]="getLookupLimit(f)"
                              [searchFn]="getLookupSearchFn(f)" [displayWith]="getLookupDisplayWith(f)"
                              [trackBy]="getLookupTrackBy(f)" [formControlName]="f.controlName"
                              (selected)="onLookupSelected(f, $event)"
                              (textChange)="onLookupTextChange(f, $event)"
                              (cleared)="onLookupCleared(f)">
                            </ui-smart-lookup>
                          </ng-container>
                          <ng-container *ngSwitchDefault>
                            <input class="ff-input" type="text" [formControlName]="f.controlName" />
                          </ng-container>
                        </ng-container>
                      </div>
                    </div>
                    <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">
                      {{ f.requiredMsg || (f.displayName + ' is required') }}
                    </div>
                  </div>
                </ng-template>

              </ng-container>
            </ng-container>
          </ng-container>
        </div>

        <!-- ‚îÄ‚îÄ Multi-Select Claim Cards Grid ‚îÄ‚îÄ -->
        <ng-container *ngIf="getSelectedClaims(sub).length > 0">
          <div class="ff-claims-header">
            <span class="ff-claims-count">{{ getSelectedClaims(sub).length + ' claim' + (getSelectedClaims(sub).length > 1 ? 's' : '') + ' selected' }}</span>
            <button type="button"
                    class="ff-claims-clear-all"
                    (click)="clearAllSelectedClaims(sub)"
                    *ngIf="getSelectedClaims(sub).length > 1">
              Clear all
            </button>
          </div>
          <div class="ff-claims-grid">
            <div class="ff-claim-card"
                 *ngFor="let claim of getSelectedClaims(sub); let ci = index; trackBy: trackByClaimId">

              <button type="button"
                      class="ff-claim-card__dismiss"
                      (click)="removeSelectedClaim(sub, ci)"
                      title="Remove this claim">&times;</button>

              <!-- Row 1: Claim # + badge -->
              <div class="ff-claim-card__top">
                <span class="ff-claim-card__id">{{ claim.claimNumber }}</span>
                <span class="ff-claim-card__badge">Claim</span>
              </div>

              <!-- Row 2: Provider + DOS -->
              <div class="ff-claim-card__details">
                <div class="ff-claim-card__row">
                  <span class="ff-claim-card__icon">üë®‚Äç‚öïÔ∏è</span>
                  <span class="ff-claim-card__value">{{ claim.providerName || '‚Äî' }}</span>
                </div>
                <div class="ff-claim-card__row">
                  <span class="ff-claim-card__icon">üìÖ</span>
                  <span class="ff-claim-card__value ff-claim-card__value--muted">
                    {{ formatCardDate(claim.dosFrom) }}
                    <ng-container *ngIf="claim.dosFrom !== claim.dosTo"> ‚Äî {{ formatCardDate(claim.dosTo) }}</ng-container>
                  </span>
                </div>
                <div class="ff-claim-card__row" *ngIf="claim.reasonForVisit">
                  <span class="ff-claim-card__icon">üìã</span>
                  <span class="ff-claim-card__value ff-claim-card__value--muted">{{ claim.reasonForVisit }}</span>
                </div>
              </div>

              <!-- Row 3: Amount pills -->
              <div class="ff-claim-card__amounts">
                <div class="ff-claim-card__amt">
                  <span class="ff-claim-card__amt-lbl">Billed</span>
                  <span class="ff-claim-card__amt-val">{{ formatCurrency(claim.billed) }}</span>
                </div>
                <div class="ff-claim-card__amt">
                  <span class="ff-claim-card__amt-lbl">Allowed</span>
                  <span class="ff-claim-card__amt-val">{{ formatCurrency(claim.allowedAmount) }}</span>
                </div>
                <div class="ff-claim-card__amt">
                  <span class="ff-claim-card__amt-lbl">Copay</span>
                  <span class="ff-claim-card__amt-val">{{ formatCurrency(claim.copayAmount) }}</span>
                </div>
                <div class="ff-claim-card__amt">
                  <span class="ff-claim-card__amt-lbl">Paid</span>
                  <span class="ff-claim-card__amt-val"
                        [class.ff-claim-card__amt-val--zero]="!claim.paid || claim.paid === 0">
                    {{ formatCurrency(claim.paid) }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- ‚îÄ‚îÄ Multi-Select Authorization Cards ‚îÄ‚îÄ -->
        <ng-container *ngIf="getSelectedAuths(sub).length > 0">
          <div class="ff-lookup-header">
            <span class="ff-lookup-count ff-lookup-count--auth">
              {{ getSelectedAuths(sub).length + ' authorization' + (getSelectedAuths(sub).length > 1 ? 's' : '') + ' selected' }}
            </span>
            <button type="button" class="ff-lookup-clear-all"
                    (click)="clearAllSelectedAuths(sub)"
                    *ngIf="getSelectedAuths(sub).length > 1">Clear all</button>
          </div>
          <div class="ff-lookup-grid">
            <div class="ff-lk-card ff-lk-card--auth"
                 *ngFor="let auth of getSelectedAuths(sub); let ai = index; trackBy: trackByAuthId">
              <button type="button" class="ff-lk-card__dismiss"
                      (click)="removeSelectedAuth(sub, ai)" title="Remove">&times;</button>
              <div class="ff-lk-card__top">
                <span class="ff-lk-card__id">{{ auth.authnumber || '‚Äî' }}</span>
                <span class="ff-lk-badge" [ngClass]="getAuthStatusClass(auth.overallstatus)">{{ auth.overallstatus || 'Auth' }}</span>
                <span class="ff-lk-badge ff-lk-badge--auth-type" *ngIf="auth.authtype">{{ auth.authtype }}</span>
              </div>
              <div class="ff-lk-card__details">
                <div class="ff-lk-card__row" *ngIf="auth.enrollmenthierarchy">
                  <span class="ff-lk-card__icon">üìã</span>
                  <span class="ff-lk-card__val">{{ auth.enrollmenthierarchy }}</span>
                </div>
                <div class="ff-lk-card__row" *ngIf="auth.icdcode">
                  <span class="ff-lk-card__icon">üî¨</span>
                  <span class="ff-lk-card__val ff-lk-card__val--muted">{{ auth.icdcode }} ‚Äî {{ auth.icddescription }}</span>
                </div>
                <div class="ff-lk-card__row" *ngIf="auth.servicecode">
                  <span class="ff-lk-card__icon">ü©∫</span>
                  <span class="ff-lk-card__val ff-lk-card__val--muted">{{ auth.servicecode }} ‚Äî {{ auth.servicedescription }}</span>
                </div>
                <div class="ff-lk-card__row" *ngIf="auth.fromdate || auth.todate">
                  <span class="ff-lk-card__icon">üìÖ</span>
                  <span class="ff-lk-card__val ff-lk-card__val--muted">
                    {{ formatCardDate(auth.fromdate) }}
                    <ng-container *ngIf="auth.todate"> ‚Äî {{ formatCardDate(auth.todate) }}</ng-container>
                  </span>
                </div>
                <div class="ff-lk-card__row" *ngIf="auth.reviewtype">
                  <span class="ff-lk-card__icon">üëÅÔ∏è</span>
                  <span class="ff-lk-card__val ff-lk-card__val--muted">{{ auth.reviewtype }}</span>
                </div>
              </div>
              <div class="ff-lk-card__footer" *ngIf="auth.decisionstatus || auth.denialreason">
                <span class="ff-lk-pill ff-lk-pill--green" *ngIf="auth.decisionstatus">
                  <span class="ff-lk-pill__lbl">Decision</span> {{ auth.decisionstatus }}
                </span>
                <span class="ff-lk-pill ff-lk-pill--red" *ngIf="auth.denialreason">
                  <span class="ff-lk-pill__lbl">Denial</span> {{ auth.denialreason }}
                </span>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- ‚îÄ‚îÄ Multi-Select Provider Cards ‚îÄ‚îÄ -->
        <ng-container *ngIf="getSelectedProviders(sub).length > 0">
          <div class="ff-lookup-header">
            <span class="ff-lookup-count ff-lookup-count--provider">
              {{ getSelectedProviders(sub).length + ' provider' + (getSelectedProviders(sub).length > 1 ? 's' : '') + ' selected' }}
            </span>
            <button type="button" class="ff-lookup-clear-all"
                    (click)="clearAllSelectedProviders(sub)"
                    *ngIf="getSelectedProviders(sub).length > 1">Clear all</button>
          </div>
          <div class="ff-lookup-grid">
            <div class="ff-lk-card ff-lk-card--provider"
                 *ngFor="let prov of getSelectedProviders(sub); let pi = index; trackBy: trackByProviderId">
              <button type="button" class="ff-lk-card__dismiss"
                      (click)="removeSelectedProvider(sub, pi)" title="Remove">&times;</button>
              <div class="ff-lk-card__top">
                <span class="ff-lk-card__id">{{ getProviderDisplayName(prov) }}</span>
                <span class="ff-lk-badge ff-lk-badge--provider">Provider</span>
              </div>
              <div class="ff-lk-card__details">
                <div class="ff-lk-card__row" *ngIf="prov.npi">
                  <span class="ff-lk-card__icon">üÜî</span>
                  <span class="ff-lk-card__val">NPI: {{ prov.npi }}</span>
                </div>
                <div class="ff-lk-card__row" *ngIf="prov.organizationname">
                  <span class="ff-lk-card__icon">üè¢</span>
                  <span class="ff-lk-card__val ff-lk-card__val--muted">{{ prov.organizationname }}</span>
                </div>
                <div class="ff-lk-card__row" *ngIf="getProviderAddress(prov)">
                  <span class="ff-lk-card__icon">üìç</span>
                  <span class="ff-lk-card__val ff-lk-card__val--muted">{{ getProviderAddress(prov) }}</span>
                </div>
                <div class="ff-lk-card__row" *ngIf="prov.phone">
                  <span class="ff-lk-card__icon">üìû</span>
                  <span class="ff-lk-card__val ff-lk-card__val--muted">{{ prov.phone }}</span>
                </div>
                <div class="ff-lk-card__row" *ngIf="prov.email">
                  <span class="ff-lk-card__icon">‚úâÔ∏è</span>
                  <span class="ff-lk-card__val ff-lk-card__val--muted">{{ prov.email }}</span>
                </div>
              </div>
              <div class="ff-lk-card__footer" *ngIf="prov.taxid">
                <span class="ff-lk-pill ff-lk-pill--blue">
                  <span class="ff-lk-pill__lbl">Tax ID</span> {{ prov.taxid }}
                </span>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- ‚îÄ‚îÄ Multi-Select Member Cards ‚îÄ‚îÄ -->
        <ng-container *ngIf="getSelectedMembers(sub).length > 0">
          <div class="ff-lookup-header">
            <span class="ff-lookup-count ff-lookup-count--member">
              {{ getSelectedMembers(sub).length + ' member' + (getSelectedMembers(sub).length > 1 ? 's' : '') + ' selected' }}
            </span>
            <button type="button" class="ff-lookup-clear-all"
                    (click)="clearAllSelectedMembers(sub)"
                    *ngIf="getSelectedMembers(sub).length > 1">Clear all</button>
          </div>
          <div class="ff-lookup-grid">
            <div class="ff-lk-card ff-lk-card--member"
                 *ngFor="let mem of getSelectedMembers(sub); let mi = index; trackBy: trackByMemberId">
              <button type="button" class="ff-lk-card__dismiss"
                      (click)="removeSelectedMember(sub, mi)" title="Remove">&times;</button>
              <div class="ff-lk-card__top">
                <span class="ff-lk-card__id">{{ getMemberDisplayName(mem) }}</span>
                <span class="ff-lk-badge ff-lk-badge--member">Member</span>
              </div>
              <div class="ff-lk-card__details">
                <div class="ff-lk-card__row" *ngIf="mem.memberid">
                  <span class="ff-lk-card__icon">üÜî</span>
                  <span class="ff-lk-card__val">ID: {{ mem.memberid }}</span>
                </div>
                <div class="ff-lk-card__row" *ngIf="mem.birthdate">
                  <span class="ff-lk-card__icon">üéÇ</span>
                  <span class="ff-lk-card__val ff-lk-card__val--muted">DOB: {{ formatCardDate(mem.birthdate) }}</span>
                </div>
                <div class="ff-lk-card__row" *ngIf="mem.gender">
                  <span class="ff-lk-card__icon">‚öß</span>
                  <span class="ff-lk-card__val ff-lk-card__val--muted">{{ mem.gender }}</span>
                </div>
                <div class="ff-lk-card__row" *ngIf="mem.city">
                  <span class="ff-lk-card__icon">üìç</span>
                  <span class="ff-lk-card__val ff-lk-card__val--muted">{{ mem.city }}</span>
                </div>
                <div class="ff-lk-card__row" *ngIf="mem.phone">
                  <span class="ff-lk-card__icon">üìû</span>
                  <span class="ff-lk-card__val ff-lk-card__val--muted">{{ mem.phone }}</span>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- ‚îÄ‚îÄ Multi-Select Staff Cards ‚îÄ‚îÄ -->
        <ng-container *ngIf="getSelectedStaff(sub).length > 0">
          <div class="ff-lookup-header">
            <span class="ff-lookup-count ff-lookup-count--staff">
              {{ getSelectedStaff(sub).length + ' staff member' + (getSelectedStaff(sub).length > 1 ? 's' : '') + ' selected' }}
            </span>
            <button type="button" class="ff-lookup-clear-all"
                    (click)="clearAllSelectedStaff(sub)"
                    *ngIf="getSelectedStaff(sub).length > 1">Clear all</button>
          </div>
          <div class="ff-lookup-grid">
            <div class="ff-lk-card ff-lk-card--staff"
                 *ngFor="let stf of getSelectedStaff(sub); let si = index; trackBy: trackByStaffId">
              <button type="button" class="ff-lk-card__dismiss"
                      (click)="removeSelectedStaffItem(sub, si)" title="Remove">&times;</button>
              <div class="ff-lk-card__top">
                <span class="ff-lk-card__id">{{ getStaffDisplayName(stf) }}</span>
                <span class="ff-lk-badge ff-lk-badge--staff">Staff</span>
              </div>
              <div class="ff-lk-card__details">
                <div class="ff-lk-card__row" *ngIf="stf.role">
                  <span class="ff-lk-card__icon">üßë‚Äçüíº</span>
                  <span class="ff-lk-card__val">{{ stf.role }}</span>
                </div>
                <div class="ff-lk-card__row" *ngIf="stf.username">
                  <span class="ff-lk-card__icon">üë§</span>
                  <span class="ff-lk-card__val ff-lk-card__val--muted">{{ '@' + stf.username }}</span>
                </div>
                <div class="ff-lk-card__row" *ngIf="stf.email">
                  <span class="ff-lk-card__icon">‚úâÔ∏è</span>
                  <span class="ff-lk-card__val ff-lk-card__val--muted">{{ stf.email }}</span>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- ‚îÄ‚îÄ Multi-Select ICD Inline Rows ‚îÄ‚îÄ -->
        <ng-container *ngIf="getSelectedIcds(sub).length > 0">
          <div class="ff-lookup-header">
            <span class="ff-lookup-count ff-lookup-count--icd">
              {{ getSelectedIcds(sub).length + ' ICD code' + (getSelectedIcds(sub).length > 1 ? 's' : '') + ' selected' }}
            </span>
            <button type="button" class="ff-lookup-clear-all"
                    (click)="clearAllSelectedIcds(sub)"
                    *ngIf="getSelectedIcds(sub).length > 1">Clear all</button>
          </div>
          <div class="ff-inline-list">
            <div class="ff-inline-row ff-inline-row--icd"
                 *ngFor="let icd of getSelectedIcds(sub); let ii = index; trackBy: trackByIcdId">
              <span class="ff-inline-type">{{ icd.type || 'ICD' }}</span>
              <span class="ff-inline-code">{{ icd.code || '‚Äî' }}</span>
              <span class="ff-inline-sep">‚Äî</span>
              <span class="ff-inline-desc">{{ icd.codeDesc || icd.codeShortDesc || '‚Äî' }}</span>
              <button type="button" class="ff-inline-dismiss"
                      (click)="removeSelectedIcd(sub, ii)" title="Remove">&times;</button>
            </div>
          </div>
        </ng-container>

        <!-- ‚îÄ‚îÄ Multi-Select Procedure Inline Rows ‚îÄ‚îÄ -->
        <ng-container *ngIf="getSelectedProcedures(sub).length > 0">
          <div class="ff-lookup-header">
            <span class="ff-lookup-count ff-lookup-count--procedure">
              {{ getSelectedProcedures(sub).length + ' procedure' + (getSelectedProcedures(sub).length > 1 ? 's' : '') + ' selected' }}
            </span>
            <button type="button" class="ff-lookup-clear-all"
                    (click)="clearAllSelectedProcedures(sub)"
                    *ngIf="getSelectedProcedures(sub).length > 1">Clear all</button>
          </div>
          <div class="ff-inline-list">
            <div class="ff-inline-row ff-inline-row--procedure"
                 *ngFor="let proc of getSelectedProcedures(sub); let pi = index; trackBy: trackByProcedureId">
              <span class="ff-inline-type">{{ proc.type || 'CPT' }}</span>
              <span class="ff-inline-code">{{ proc.code || '‚Äî' }}</span>
              <span class="ff-inline-sep">‚Äî</span>
              <span class="ff-inline-desc">{{ proc.codeDesc || proc.codeShortDesc || '‚Äî' }}</span>
              <button type="button" class="ff-inline-dismiss"
                      (click)="removeSelectedProcedure(sub, pi)" title="Remove">&times;</button>
            </div>
          </div>
        </ng-container>

        <!-- ‚îÄ‚îÄ Multi-Select Medication Inline Rows ‚îÄ‚îÄ -->
        <ng-container *ngIf="getSelectedMedications(sub).length > 0">
          <div class="ff-lookup-header">
            <span class="ff-lookup-count ff-lookup-count--medication">
              {{ getSelectedMedications(sub).length + ' medication' + (getSelectedMedications(sub).length > 1 ? 's' : '') + ' selected' }}
            </span>
            <button type="button" class="ff-lookup-clear-all"
                    (click)="clearAllSelectedMedications(sub)"
                    *ngIf="getSelectedMedications(sub).length > 1">Clear all</button>
          </div>
          <div class="ff-inline-list">
            <div class="ff-inline-row ff-inline-row--medication"
                 *ngFor="let med of getSelectedMedications(sub); let mi = index; trackBy: trackByMedicationId">
              <span class="ff-inline-type">NDC</span>
              <span class="ff-inline-code">{{ med.ndc || '‚Äî' }}</span>
              <span class="ff-inline-sep">‚Äî</span>
              <span class="ff-inline-desc">{{ med.drugName || '‚Äî' }}</span>
              <button type="button" class="ff-inline-dismiss"
                      (click)="removeSelectedMedication(sub, mi)" title="Remove">&times;</button>
            </div>
          </div>
        </ng-container>

      </ng-container>
      <ng-template #subRepeatTpl>
        <div class="ff-repeat-wrap">
          <ng-container *ngFor="let inst of sub.instances; trackBy: trackByRepeatInst">
            <div class="ff-repeat-group">

              <!-- Compact header: title + inline +/- buttons -->
              <div class="ff-repeat-header">
                <div class="ff-repeat-title">{{ sub.repeat?.instanceLabel }} #{{ inst.index }}</div>
                <div class="ff-repeat-actions" *ngIf="sub.repeat?.showControls">
                  <button type="button" class="ff-repeat-btn" [disabled]="!canAddRepeat(sub)" (click)="addRepeat(sub)" title="Add">+</button>
                  <button type="button" class="ff-repeat-btn danger" [disabled]="!canRemoveRepeat(sub)" (click)="removeRepeat(sub, inst.index)" title="Remove">‚àí</button>
                </div>
              </div>

              <!-- Fields grid ‚Äî NO full-width search, NO +/- inside grid -->
              <div class="grid ff-repeat-grid">
                <ng-container *ngFor="let f of inst.fields; trackBy: trackByField">
                  <ng-container *ngIf="visibleField(f, sec, sub, { repeatPrefix: sub.repeatPrefix!, repeatIndex: inst.index })">
                    <ng-container *ngIf="form.get(f.controlName) as ctrl">

                      <ng-container *ngIf="f.type === 'checkbox'; else outlinedSubRep">
                        <div class="ff-field">
                          <div class="ff-checkbox">
                            <input type="checkbox" class="form-check-input" [formControlName]="f.controlName" />
                            <label class="form-check-label ff-checkbox-text">
                              {{ f.displayName }}
                              <span class="req-star" *ngIf="isRequired(ctrl, f)">*</span>
                            </label>
                          </div>
                          <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">
                            {{ f.requiredMsg || (f.displayName + ' is required') }}
                          </div>
                        </div>
                      </ng-container>

                      <ng-template #outlinedSubRep>
                        <!-- NO span-all ‚Äî search fields are normal-width in repeat grids -->
                        <div class="ff-field">
                          <div class="ff-outline"
                               [class.ff-disabled]="ctrl.disabled"
                               [class.ff-invalid]="ctrl.touched && ctrl.invalid"
                               (click)="selectField(f)"
                               (focusin)="selectField(f)"
                               [ngClass]="{
                                 'ff-selected': isSelected(f),
                                 'ff-changed': isChangedField(f),
                                 'ff-unchanged': !isChangedField(f)
                               }"
                               tabindex="-1">
                            <div class="ff-float-label">
                              {{ f.displayName }}
                              <span class="req-star" *ngIf="isRequired(ctrl, f)">*</span>
                            </div>
                            <div class="ff-body">
                              <ng-container [ngSwitch]="f.type">
                                <ng-container *ngSwitchCase="'select'">
                                  <ui-smart-dropdown class="ff-ui" label="" placeholder="Select..."
                                    [options]="getDropdownOptions(f.controlName)" [formControlName]="f.controlName">
                                  </ui-smart-dropdown>
                                </ng-container>
                                <ng-container *ngSwitchCase="'datetime-local'">
                                  <ui-datetime-picker class="ff-ui" placeholderDate="mm/dd/yyyy"
                                    placeholderDateTime="mm/dd/yyyy --:--" [formControlName]="f.controlName">
                                  </ui-datetime-picker>
                                </ng-container>
                                <ng-container *ngSwitchCase="'datatime-local'">
                                  <ui-datetime-picker class="ff-ui" placeholderDate="mm/dd/yyyy"
                                    placeholderDateTime="mm/dd/yyyy --:--" [formControlName]="f.controlName">
                                  </ui-datetime-picker>
                                </ng-container>
                                <ng-container *ngSwitchCase="'textarea'">
                                  <textarea class="ff-input ff-textarea" rows="3" [formControlName]="f.controlName"></textarea>
                                </ng-container>
                                <ng-container *ngSwitchCase="'search'">
                                  <ui-smart-lookup class="ff-ui ff-lookup"
                                    [placeholder]="getLookupPlaceholder(f)" [minChars]="getLookupMinChars(f)"
                                    [debounceMs]="getLookupDebounceMs(f)" [limit]="getLookupLimit(f)"
                                    [searchFn]="getLookupSearchFn(f)" [displayWith]="getLookupDisplayWith(f)"
                                    [trackBy]="getLookupTrackBy(f)" [formControlName]="f.controlName"
                                    (selected)="onLookupSelected(f, $event, { repeatPrefix: sub.repeatPrefix!, repeatIndex: inst.index })"
                                    (textChange)="onLookupTextChange(f, $event, { repeatPrefix: sub.repeatPrefix!, repeatIndex: inst.index })"
                                    (cleared)="onLookupCleared(f, { repeatPrefix: sub.repeatPrefix!, repeatIndex: inst.index })">
                                  </ui-smart-lookup>
                                </ng-container>
                                <ng-container *ngSwitchDefault>
                                  <input class="ff-input" type="text" [formControlName]="f.controlName" />
                                </ng-container>
                              </ng-container>
                            </div>
                          </div>
                          <div class="ff-error" *ngIf="ctrl.touched && ctrl.invalid">
                            {{ f.requiredMsg || (f.displayName + ' is required') }}
                          </div>
                        </div>
                      </ng-template>

                    </ng-container>
                  </ng-container>
                </ng-container>
              </div>

              <!-- ‚ïê‚ïê Multi-Select Lookup Cards (inside repeat instances) ‚ïê‚ïê -->

              <!-- Claims Cards -->
              <ng-container *ngIf="getSelectedClaims(inst).length > 0">
                <div class="ff-lookup-header">
                  <span class="ff-claims-count">{{ getSelectedClaims(inst).length + ' claim' + (getSelectedClaims(inst).length > 1 ? 's' : '') + ' selected' }}</span>
                  <button type="button" class="ff-claims-clear" (click)="clearAllSelectedClaims(inst)" *ngIf="getSelectedClaims(inst).length > 1">Clear all</button>
                </div>
                <div class="ff-claims-grid">
                  <div class="ff-claim-card" *ngFor="let claim of getSelectedClaims(inst); let ci = index; trackBy: trackByClaimId">
                    <button type="button" class="ff-claim-card__dismiss" (click)="removeSelectedClaim(inst, ci)" title="Remove">&times;</button>
                    <div class="ff-claim-card__top">
                      <span class="ff-claim-card__num">{{ claim.claimNumber || claim.claimnumber || '‚Äî' }}</span>
                      <span class="ff-claim-card__badge" *ngIf="claim.claimStatus || claim.claimstatus">{{ claim.claimStatus || claim.claimstatus }}</span>
                    </div>
                    <div class="ff-claim-card__details">
                      <div class="ff-claim-card__row" *ngIf="claim.providerName || claim.providername">
                        <span class="ff-claim-card__icon">üè•</span>
                        <span class="ff-claim-card__val">{{ claim.providerName || claim.providername }}</span>
                      </div>
                      <div class="ff-claim-card__row" *ngIf="claim.dosFrom || claim.dosfrom">
                        <span class="ff-claim-card__icon">üìÖ</span>
                        <span class="ff-claim-card__val ff-claim-card__val--muted">
                          {{ formatCardDate(claim.dosFrom || claim.dosfrom) }}
                          <ng-container *ngIf="(claim.dosTo || claim.dosto) && (claim.dosTo || claim.dosto) !== (claim.dosFrom || claim.dosfrom)"> ‚Äî {{ formatCardDate(claim.dosTo || claim.dosto) }}</ng-container>
                        </span>
                      </div>
                    </div>
                    <div class="ff-claim-card__amounts">
                      <div class="ff-claim-card__amt">
                        <span class="ff-claim-card__amt-lbl">Billed</span>
                        <span class="ff-claim-card__amt-val" [class.ff-claim-card__amt-val--zero]="!(claim.billed || claim.billedAmount)">{{ formatCurrency(claim.billed || claim.billedAmount || 0) }}</span>
                      </div>
                      <div class="ff-claim-card__amt">
                        <span class="ff-claim-card__amt-lbl">Allowed</span>
                        <span class="ff-claim-card__amt-val" [class.ff-claim-card__amt-val--zero]="!(claim.allowedAmount || claim.allowed)">{{ formatCurrency(claim.allowedAmount || claim.allowed || 0) }}</span>
                      </div>
                      <div class="ff-claim-card__amt">
                        <span class="ff-claim-card__amt-lbl">Paid</span>
                        <span class="ff-claim-card__amt-val" [class.ff-claim-card__amt-val--zero]="!(claim.paid || claim.paidAmount)">{{ formatCurrency(claim.paid || claim.paidAmount || 0) }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-container>

              <!-- Authorization Cards -->
              <ng-container *ngIf="getSelectedAuths(inst).length > 0">
                <div class="ff-lookup-header">
                  <span class="ff-lookup-count ff-lookup-count--auth">{{ getSelectedAuths(inst).length + ' authorization' + (getSelectedAuths(inst).length > 1 ? 's' : '') + ' selected' }}</span>
                  <button type="button" class="ff-lookup-clear-all" (click)="clearAllSelectedAuths(inst)" *ngIf="getSelectedAuths(inst).length > 1">Clear all</button>
                </div>
                <div class="ff-lookup-grid">
                  <div class="ff-lk-card ff-lk-card--auth" *ngFor="let auth of getSelectedAuths(inst); let ai = index; trackBy: trackByAuthId">
                    <button type="button" class="ff-lk-card__dismiss" (click)="removeSelectedAuth(inst, ai)" title="Remove">&times;</button>
                    <div class="ff-lk-card__top">
                      <span class="ff-lk-card__id">{{ auth.authnumber || '‚Äî' }}</span>
                      <span class="ff-lk-badge" [ngClass]="getAuthStatusClass(auth.overallstatus)">{{ auth.overallstatus || 'Auth' }}</span>
                      <span class="ff-lk-badge ff-lk-badge--auth-type" *ngIf="auth.authtype">{{ auth.authtype }}</span>
                    </div>
                    <div class="ff-lk-card__details">
                      <div class="ff-lk-card__row" *ngIf="auth.enrollmenthierarchy"><span class="ff-lk-card__icon">üìã</span><span class="ff-lk-card__val">{{ auth.enrollmenthierarchy }}</span></div>
                      <div class="ff-lk-card__row" *ngIf="auth.icdcode"><span class="ff-lk-card__icon">üî¨</span><span class="ff-lk-card__val ff-lk-card__val--muted">{{ auth.icdcode }} ‚Äî {{ auth.icddescription }}</span></div>
                      <div class="ff-lk-card__row" *ngIf="auth.servicecode"><span class="ff-lk-card__icon">ü©∫</span><span class="ff-lk-card__val ff-lk-card__val--muted">{{ auth.servicecode }} ‚Äî {{ auth.servicedescription }}</span></div>
                      <div class="ff-lk-card__row" *ngIf="auth.fromdate || auth.todate"><span class="ff-lk-card__icon">üìÖ</span><span class="ff-lk-card__val ff-lk-card__val--muted">{{ formatCardDate(auth.fromdate) }}<ng-container *ngIf="auth.todate"> ‚Äî {{ formatCardDate(auth.todate) }}</ng-container></span></div>
                      <div class="ff-lk-card__row" *ngIf="auth.reviewtype"><span class="ff-lk-card__icon">üëÅÔ∏è</span><span class="ff-lk-card__val ff-lk-card__val--muted">{{ auth.reviewtype }}</span></div>
                    </div>
                    <div class="ff-lk-card__footer" *ngIf="auth.decisionstatus || auth.denialreason">
                      <span class="ff-lk-pill ff-lk-pill--green" *ngIf="auth.decisionstatus"><span class="ff-lk-pill__lbl">Decision</span> {{ auth.decisionstatus }}</span>
                      <span class="ff-lk-pill ff-lk-pill--red" *ngIf="auth.denialreason"><span class="ff-lk-pill__lbl">Denial</span> {{ auth.denialreason }}</span>
                    </div>
                  </div>
                </div>
              </ng-container>

              <!-- Provider Cards -->
              <ng-container *ngIf="getSelectedProviders(inst).length > 0">
                <div class="ff-lookup-header">
                  <span class="ff-lookup-count ff-lookup-count--provider">{{ getSelectedProviders(inst).length + ' provider' + (getSelectedProviders(inst).length > 1 ? 's' : '') + ' selected' }}</span>
                  <button type="button" class="ff-lookup-clear-all" (click)="clearAllSelectedProviders(inst)" *ngIf="getSelectedProviders(inst).length > 1">Clear all</button>
                </div>
                <div class="ff-lookup-grid">
                  <div class="ff-lk-card ff-lk-card--provider" *ngFor="let prov of getSelectedProviders(inst); let pi = index; trackBy: trackByProviderId">
                    <button type="button" class="ff-lk-card__dismiss" (click)="removeSelectedProvider(inst, pi)" title="Remove">&times;</button>
                    <div class="ff-lk-card__top">
                      <span class="ff-lk-card__id">{{ getProviderDisplayName(prov) }}</span>
                      <span class="ff-lk-badge ff-lk-badge--provider">Provider</span>
                    </div>
                    <div class="ff-lk-card__details">
                      <div class="ff-lk-card__row" *ngIf="prov.npi"><span class="ff-lk-card__icon">üÜî</span><span class="ff-lk-card__val">NPI: {{ prov.npi }}</span></div>
                      <div class="ff-lk-card__row" *ngIf="prov.organizationname"><span class="ff-lk-card__icon">üè¢</span><span class="ff-lk-card__val ff-lk-card__val--muted">{{ prov.organizationname }}</span></div>
                      <div class="ff-lk-card__row" *ngIf="getProviderAddress(prov)"><span class="ff-lk-card__icon">üìç</span><span class="ff-lk-card__val ff-lk-card__val--muted">{{ getProviderAddress(prov) }}</span></div>
                      <div class="ff-lk-card__row" *ngIf="prov.phone"><span class="ff-lk-card__icon">üìû</span><span class="ff-lk-card__val ff-lk-card__val--muted">{{ prov.phone }}</span></div>
                      <div class="ff-lk-card__row" *ngIf="prov.email"><span class="ff-lk-card__icon">‚úâÔ∏è</span><span class="ff-lk-card__val ff-lk-card__val--muted">{{ prov.email }}</span></div>
                    </div>
                    <div class="ff-lk-card__footer" *ngIf="prov.taxid">
                      <span class="ff-lk-pill ff-lk-pill--blue"><span class="ff-lk-pill__lbl">Tax ID</span> {{ prov.taxid }}</span>
                    </div>
                  </div>
                </div>
              </ng-container>

              <!-- Member Cards -->
              <ng-container *ngIf="getSelectedMembers(inst).length > 0">
                <div class="ff-lookup-header">
                  <span class="ff-lookup-count ff-lookup-count--member">{{ getSelectedMembers(inst).length + ' member' + (getSelectedMembers(inst).length > 1 ? 's' : '') + ' selected' }}</span>
                  <button type="button" class="ff-lookup-clear-all" (click)="clearAllSelectedMembers(inst)" *ngIf="getSelectedMembers(inst).length > 1">Clear all</button>
                </div>
                <div class="ff-lookup-grid">
                  <div class="ff-lk-card ff-lk-card--member" *ngFor="let mem of getSelectedMembers(inst); let mi = index; trackBy: trackByMemberId">
                    <button type="button" class="ff-lk-card__dismiss" (click)="removeSelectedMember(inst, mi)" title="Remove">&times;</button>
                    <div class="ff-lk-card__top">
                      <span class="ff-lk-card__id">{{ getMemberDisplayName(mem) }}</span>
                      <span class="ff-lk-badge ff-lk-badge--member">Member</span>
                    </div>
                    <div class="ff-lk-card__details">
                      <div class="ff-lk-card__row" *ngIf="mem.memberid"><span class="ff-lk-card__icon">üÜî</span><span class="ff-lk-card__val">ID: {{ mem.memberid }}</span></div>
                      <div class="ff-lk-card__row" *ngIf="mem.birthdate"><span class="ff-lk-card__icon">üéÇ</span><span class="ff-lk-card__val ff-lk-card__val--muted">DOB: {{ formatCardDate(mem.birthdate) }}</span></div>
                      <div class="ff-lk-card__row" *ngIf="mem.gender"><span class="ff-lk-card__icon">‚öß</span><span class="ff-lk-card__val ff-lk-card__val--muted">{{ mem.gender }}</span></div>
                      <div class="ff-lk-card__row" *ngIf="mem.city"><span class="ff-lk-card__icon">üìç</span><span class="ff-lk-card__val ff-lk-card__val--muted">{{ mem.city }}</span></div>
                      <div class="ff-lk-card__row" *ngIf="mem.phone"><span class="ff-lk-card__icon">üìû</span><span class="ff-lk-card__val ff-lk-card__val--muted">{{ mem.phone }}</span></div>
                    </div>
                  </div>
                </div>
              </ng-container>

              <!-- Staff Cards -->
              <ng-container *ngIf="getSelectedStaff(inst).length > 0">
                <div class="ff-lookup-header">
                  <span class="ff-lookup-count ff-lookup-count--staff">{{ getSelectedStaff(inst).length + ' staff member' + (getSelectedStaff(inst).length > 1 ? 's' : '') + ' selected' }}</span>
                  <button type="button" class="ff-lookup-clear-all" (click)="clearAllSelectedStaff(inst)" *ngIf="getSelectedStaff(inst).length > 1">Clear all</button>
                </div>
                <div class="ff-lookup-grid">
                  <div class="ff-lk-card ff-lk-card--staff" *ngFor="let stf of getSelectedStaff(inst); let si = index; trackBy: trackByStaffId">
                    <button type="button" class="ff-lk-card__dismiss" (click)="removeSelectedStaffItem(inst, si)" title="Remove">&times;</button>
                    <div class="ff-lk-card__top">
                      <span class="ff-lk-card__id">{{ getStaffDisplayName(stf) }}</span>
                      <span class="ff-lk-badge ff-lk-badge--staff">Staff</span>
                    </div>
                    <div class="ff-lk-card__details">
                      <div class="ff-lk-card__row" *ngIf="stf.role"><span class="ff-lk-card__icon">üßë‚Äçüíº</span><span class="ff-lk-card__val">{{ stf.role }}</span></div>
                      <div class="ff-lk-card__row" *ngIf="stf.username"><span class="ff-lk-card__icon">üë§</span><span class="ff-lk-card__val ff-lk-card__val--muted">{{ '@' + stf.username }}</span></div>
                      <div class="ff-lk-card__row" *ngIf="stf.email"><span class="ff-lk-card__icon">‚úâÔ∏è</span><span class="ff-lk-card__val ff-lk-card__val--muted">{{ stf.email }}</span></div>
                    </div>
                  </div>
                </div>
              </ng-container>

              <!-- ICD Inline Rows -->
              <ng-container *ngIf="getSelectedIcds(inst).length > 0">
                <div class="ff-lookup-header">
                  <span class="ff-lookup-count ff-lookup-count--icd">{{ getSelectedIcds(inst).length + ' ICD code' + (getSelectedIcds(inst).length > 1 ? 's' : '') + ' selected' }}</span>
                  <button type="button" class="ff-lookup-clear-all" (click)="clearAllSelectedIcds(inst)" *ngIf="getSelectedIcds(inst).length > 1">Clear all</button>
                </div>
                <div class="ff-inline-list">
                  <div class="ff-inline-row ff-inline-row--icd" *ngFor="let icd of getSelectedIcds(inst); let ii = index; trackBy: trackByIcdId">
                    <span class="ff-inline-type">{{ icd.type || 'ICD' }}</span>
                    <span class="ff-inline-code">{{ icd.code || '‚Äî' }}</span>
                    <span class="ff-inline-sep">‚Äî</span>
                    <span class="ff-inline-desc">{{ icd.codeDesc || icd.codeShortDesc || '‚Äî' }}</span>
                    <button type="button" class="ff-inline-dismiss" (click)="removeSelectedIcd(inst, ii)" title="Remove">&times;</button>
                  </div>
                </div>
              </ng-container>

              <!-- Procedure Inline Rows -->
              <ng-container *ngIf="getSelectedProcedures(inst).length > 0">
                <div class="ff-lookup-header">
                  <span class="ff-lookup-count ff-lookup-count--procedure">{{ getSelectedProcedures(inst).length + ' procedure' + (getSelectedProcedures(inst).length > 1 ? 's' : '') + ' selected' }}</span>
                  <button type="button" class="ff-lookup-clear-all" (click)="clearAllSelectedProcedures(inst)" *ngIf="getSelectedProcedures(inst).length > 1">Clear all</button>
                </div>
                <div class="ff-inline-list">
                  <div class="ff-inline-row ff-inline-row--procedure" *ngFor="let proc of getSelectedProcedures(inst); let pi = index; trackBy: trackByProcedureId">
                    <span class="ff-inline-type">{{ proc.type || 'CPT' }}</span>
                    <span class="ff-inline-code">{{ proc.code || '‚Äî' }}</span>
                    <span class="ff-inline-sep">‚Äî</span>
                    <span class="ff-inline-desc">{{ proc.codeDesc || proc.codeShortDesc || '‚Äî' }}</span>
                    <button type="button" class="ff-inline-dismiss" (click)="removeSelectedProcedure(inst, pi)" title="Remove">&times;</button>
                  </div>
                </div>
              </ng-container>

              <!-- Medication Inline Rows -->
              <ng-container *ngIf="getSelectedMedications(inst).length > 0">
                <div class="ff-lookup-header">
                  <span class="ff-lookup-count ff-lookup-count--medication">{{ getSelectedMedications(inst).length + ' medication' + (getSelectedMedications(inst).length > 1 ? 's' : '') + ' selected' }}</span>
                  <button type="button" class="ff-lookup-clear-all" (click)="clearAllSelectedMedications(inst)" *ngIf="getSelectedMedications(inst).length > 1">Clear all</button>
                </div>
                <div class="ff-inline-list">
                  <div class="ff-inline-row ff-inline-row--medication" *ngFor="let med of getSelectedMedications(inst); let mi = index; trackBy: trackByMedicationId">
                    <span class="ff-inline-type">NDC</span>
                    <span class="ff-inline-code">{{ med.ndc || '‚Äî' }}</span>
                    <span class="ff-inline-sep">‚Äî</span>
                    <span class="ff-inline-desc">{{ med.drugName || '‚Äî' }}</span>
                    <button type="button" class="ff-inline-dismiss" (click)="removeSelectedMedication(inst, mi)" title="Remove">&times;</button>
                  </div>
                </div>
              </ng-container>

            </div>
          </ng-container>
        </div>
      </ng-template>

      <!-- Nested subsections -->
      <ng-container *ngFor="let child of sub.subsections; trackBy: trackBySub">
        <ng-container *ngTemplateOutlet="subTpl; context: { $implicit: child, sec: sec, depth: depth + 1 }"></ng-container>
      </ng-container>

    </div>
  </ng-template>

</form>
