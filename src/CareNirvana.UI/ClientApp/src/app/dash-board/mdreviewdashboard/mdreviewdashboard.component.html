<div class="main-wrapper">
  <div class="container" style="margin:0px !important;" [ngClass]="{ 'summary-on': showSummary, 'summary-off': !showSummary }">
    <!-- LEFT COLUMN (20%) -->
    <div class="col-left" [ngClass]="{ 'full-width': !selectedAuth, 'minimized': !!selectedAuth }">
      <div class="top-bar" style="display:flex;align-items:center;gap:10px;margin:8px 0;">
        <div class="search-section" style="display:flex;align-items:center;gap:8px;flex:1;">
          <input type="text"
                 placeholder="ðŸ” Search activitiesâ€¦"
                 (input)="onQuickSearch($event)"
                 class="search-input"
                 style="flex:1; padding:10px 12px; border:1px solid #e1e5ea; border-radius:10px; outline:none;" />
          <button class="filter-btn"
                  type="button"
                  (click)="toggleFilters()"
                  title="Filters">
            <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M3 5h18v2l-7 7v5l-4 2v-7L3 7z"></path>
            </svg>
          </button>
        </div>

        <div class="filters-col" *ngIf="!selectedAuth">
          <div class="chip-list">
            <button type="button" class="pill red" [class.active]="isDueSelected('OVERDUE')" (click)="setDueChip('OVERDUE')">
              <span class="dot red"></span> Over Due
              <span class="count">{{ overdueCount  }}</span>
            </button>
            <button type="button" class="pill amber" [class.active]="isDueSelected('TODAY')" (click)="setDueChip('TODAY')">
              <span class="dot amber"></span> Due today
              <span class="count">{{ dueTodayCount  }}</span>
            </button>
            <button type="button" class="pill green" [class.active]="isDueSelected('FUTURE')" (click)="setDueChip('FUTURE')">
              <span class="dot green"></span> Due in future
              <span class="count">{{ dueFutureCount }}</span>
            </button>
            <button type="button" class="pill" [class.active]="isStatusSelected('APPROVED')"
                    (click)="setStatusChip('APPROVED')">
              <span class="dot blue"></span> Approved
            </button>
          </div>
          <div class="chip-list" style="margin-top:8px;">
            <!--<button type="button" class="pill" [class.active]="isStatusSelected('PENDING_OR_INPROGRESS')"
                    (click)="setStatusChip('PENDING_OR_INPROGRESS')">
              <span class="dot amber"></span> Pending / In Progress
            </button>-->


          </div>
        </div>
      </div>

      <div *ngIf="!selectedAuth">
        <div class="table-wrapper">
          <table mat-table [dataSource]="dataSource" matSort
                 multiTemplateDataRows
                 class="mat-elevation-z1 full-width-table pro-table mng-table">

            <!-- Module -->
            <ng-container matColumnDef="module">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Module</th>
              <td mat-cell *matCellDef="let row">
                <div class="status-cell">
                  {{ row.module || '-' }}
                </div>
              </td>
            </ng-container>

            <!-- Member (FirstName LastName + ID) -->
            <ng-container matColumnDef="member">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Member</th>
              <td mat-cell *matCellDef="let m">
                <div class="name-cell">
                  <div class="sub-name">
                    <a href="#" (click)="onMemberClick(m.memberId, m.firstName + ' ' + m.lastName,m.memberDetailsId); $event.preventDefault()">{{ m.firstName }} {{ m.lastName }}</a>
                  </div>
                  <div class="sub-id">ID: {{ m.memberId }}</div>
                </div>
              </td>
            </ng-container>

            <!-- Auth Number -->
            <ng-container matColumnDef="authNumber">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Auth #</th>
              <td mat-cell *matCellDef="let row">
                <a href="#" (click)="onAuthClick(row.authNumber, row.memberId); $event.preventDefault()">
                  {{ row.authNumber }}
                </a>
              </td>
            </ng-container>

            <!-- Created On -->
            <ng-container matColumnDef="createdOn">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Created On</th>
              <td mat-cell *matCellDef="let row">{{ row.createdOn | date }}</td>
            </ng-container>

            <!-- Refer To (username + id) -->
            <ng-container matColumnDef="referredTo">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Refer To</th>
              <td mat-cell *matCellDef="let row">
                <div>{{ row.userName || '-' }}</div>
                <!--<div style="font-size:12px;color:#6b7280;">ID: {{ row.referredTo }}</div>-->
              </td>
            </ng-container>

            <!-- Activity Type -->
            <ng-container matColumnDef="activityType">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Activity Type</th>
              <td mat-cell *matCellDef="let row">{{ row.activityType || '-' }}</td>
            </ng-container>

            <!-- Follow Up Date -->
            <ng-container matColumnDef="followUpDate">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Follow Up Date</th>
              <td mat-cell *matCellDef="let row">{{ row.followUpDateTime | date }}</td>
            </ng-container>

            <!-- Due Date with colors + days-left -->
            <ng-container matColumnDef="dueDate">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Due Date</th>
              <td mat-cell *matCellDef="let row">
                <span class="risk-chip compact" [ngClass]="getDueDateClass(row.dueDate)">
                  <div class="date-value">
                    {{ row.dueDate | date }}
                  </div>
                  <div class="days-left">
                    {{ getDaysLeftLabel(row.dueDate) }}
                  </div>
                </span>
              </td>
            </ng-container>

            <!-- Status -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
              <td mat-cell *matCellDef="let row">{{ row.status || '-' }}</td>
            </ng-container>
            <ng-container matColumnDef="review">
              <th mat-header-cell *matHeaderCellDef>Review</th>
              <td mat-cell *matCellDef="let row">
                <button mat-stroked-button color="primary"
                        (click)="onReviewClick(row); $event.stopPropagation()">
                  Review
                </button>
              </td>
            </ng-container>
            <!-- Expanded placeholder (kept for parity) -->
            <ng-container matColumnDef="expandedDetail">
              <td mat-cell *matCellDef="let row" [attr.colspan]="displayedColumns.length">
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"
                class="example-element-row"
                [class.example-expanded-row]="expandedElement === row"
                (click)="expandedElement = expandedElement === row ? null : row">
            </tr>
            <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>

            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell" [attr.colspan]="displayedColumns.length">No data</td>
            </tr>
          </table>

          <mat-paginator [pageSizeOptions]="[10, 25, 100]" aria-label="Select page"></mat-paginator>
        </div>
      </div>
      <!-- CARD LIST VIEW (when reviewing) -->
      <div class="card-list" *ngIf="selectedAuth">
        <div class="mini-card"
             *ngFor="let row of navList; let i = index; trackBy: trackByAuth"
             [class.selected]="isSame(row, selectedAuthRaw)"
             (click)="onCardSelect(row, i)">
          <div class="mini-card-title">
            {{ row.AuthNumber || row.authNumber || 'â€”' }}

          </div>
          <div class="mini-card-sub">
            {{ (row.firstName || '') + ' ' + (row.lastName || '') }}
          </div>
          <div class="mini-card-meta">
            <span class="chip" [ngClass]="dueChipClass(row)">{{ dueChipText(row) }}</span>
            <span class="dim">Due: {{ getDate(row?.authDueDate || row?.dueDate) }}</span>
            <span class="dim">Activty Type: {{ (row?.activityType || row?.activityType) }}</span>
          </div>
        </div>
      </div>


    </div>

    <!-- MIDDLE COLUMN (40%) -->
    <div class="col-middle" *ngIf="selectedAuth">
      <div class="review-header-bar" *ngIf="selectedAuth">
        <h2>Authorization Review</h2>
        <div class="review-controls">
          <button (click)="onPrevious()" [disabled]="!canPrev">&lt; Previous</button>
          <span>Review {{ (selectedIndex + 1) }} of {{ navList.length }}</span>
          <button (click)="onNext()" [disabled]="!canNext">Next &gt;</button>
          <button type="button" (click)="toggleSummary()">
            {{ showSummary ? 'Hide Summary' : 'Show Summary' }}
          </button>
        </div>
      </div>

      <div class="review-header">
        <p>Review Due Date: {{ selectedAuth.dueDate ? (selectedAuth.dueDate | date:'MM/dd/yyyy HH:mm:ss a') : 'N/A' }} | Review Priority: {{ selectedAuth.priority || 'N/A' }}</p>
        <!--<p style="color:green;"><strong>Overall Initial Recommendation:</strong> {{ selectedAuth.recommendation }}</p>-->
        <p class="overall-ir">
          <strong>Overall Initial Recommendation:</strong>
          <span class="md-badge" [ngClass]="getOverallIrClass()">
            {{ overallInitialRecommendation || 'Not Reviewed' }}
          </span>
        </p>
      </div>

      <div class="review-content">
        <h6 class="section-title" style="display:flex;align-items:center;gap:10px;">
          <span>Clinical Context & Instructions: </span>
          <span *ngIf="firstServiceLineComment as c"
                style="font-weight:700;color:black;">
            {{ c }}
          </span>
        </h6>
        <h6>Clinical Documents</h6>
        <div class="clinical-documents">
          <div class="field">
            <label>Member ID:</label>
            <span>{{ selectedAuth.memberId }}</span>
          </div>

          <div class="field">
            <label>Member Name:</label>
            <span>{{ selectedAuth.memberName }}</span>
          </div>
          <div class="field">
            <label>Auth #:</label>
            <span>{{ selectedAuth.authNumber }}</span>
          </div>
          <!--<div class="field">
            <label>Auth Type:</label>
            <span>{{ selectedAuth.authType }}</span>
          </div>-->
          <div class="field">
            <label>Facility:</label>
            <span>{{ selectedAuth.facility }}</span>
          </div>
          <div class="field">
            <label>Network Status:</label>
            <span>{{ selectedAuth.networkStatus }}</span>
          </div>
        </div>


        <!-- Service Lines (AUTH-LIKE REVIEW TABLE) -->
        <div class="lines-header" style="margin-top:12px;">
          <div class="lines-title">Service Lines</div>
          <div class="lines-actions">
            <label class="muted" style="display:flex; align-items:center; gap:8px; margin:0;">
              <input #selectAllReview type="checkbox"
                     (change)="toggleSelectAllReviewLines(selectAllReview.checked)" />
              Select all
            </label>
          </div>
        </div>

        <div class="table-responsive" *ngIf="selectedAuth?.lines?.length; else noLines">
          <table class="table mdr-table">
            <thead>
              <tr>
                <th style="width:40px;"></th>
                <th>Service Code</th>
                <th>Description</th>
                <th>From</th>
                <th>To</th>
                <th>Req</th>
                <th>Appr</th>
                <th>Den</th>
                <th>Initial Recommendation</th>
                <th>MD Review Status</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let l of selectedAuth.lines; trackBy: trackByLineId">
                <td>
                  <input type="checkbox"
                         [checked]="!!l.selected"
                         (change)="onToggleReviewLine(l, $any($event.target).checked)" />
                </td>
                <td>{{ l.serviceCode }}</td>
                <td>{{ l.serviceDescription }}</td>
                <td>{{ l.fromDate | date:'MM/dd/yyyy' }}</td>
                <td>{{ l.toDate | date:'MM/dd/yyyy' }}</td>
                <td class="num">{{ l.requested ?? '-' }}</td>
                <td class="num">{{ l.approved ?? '-' }}</td>
                <td class="num">{{ l.denied ?? '-' }}</td>
                <td>{{ l.initialRecommendation || '-' }}</td>
                <td><span class="pill">{{ l.status || '-' }}</span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <ng-template #noLines>
          <div class="muted">No service lines found.</div>
        </ng-template>

        <!-- Medical Director's Decision (AUTH-LIKE) -->
        <div class="lines-title" style="margin-top:18px;">Medical Director's Decision</div>
        <hr />

        <div class="decision-grid">

          <div class="ff-field">
            <div class="ff-outline">
              <div class="ff-float-label">Decision Status <span class="req">*</span></div>
              <div class="ff-body">
                <ui-smart-dropdown class="ff-ui"
                                   label=""
                                   placeholder="Select"
                                   [options]="decisionStatusOptions"
                                   [(ngModel)]="overallDecisionStatus"
                                   (ngModelChange)="onDecisionStatusChanged()">
                </ui-smart-dropdown>
              </div>
            </div>
          </div>

          <div class="ff-field">
            <div class="ff-outline">
              <div class="ff-float-label">Decision Status Code</div>
              <div class="ff-body">
                <ui-smart-dropdown class="ff-ui"
                                   label=""
                                   placeholder="Select"
                                   [options]="decisionStatusCodeOptions"
                                   [(ngModel)]="overallDecisionStatusCode">
                </ui-smart-dropdown>
              </div>
            </div>
          </div>

          <div class="ff-field" style="display:flex; align-items:center;">
            <label class="muted" style="display:flex; align-items:center; gap:8px; margin:0;">
              <input type="checkbox" [(ngModel)]="requestMoreInformation" />
              Request more information
            </label>
          </div>

          <div class="ff-field field-wide">
            <div class="ff-outline">
              <div class="ff-float-label">Comments and Recommendations</div>
              <div class="ff-body">
                <textarea class="ff-input ff-textarea"
                          rows="6"
                          placeholder=""
                          [(ngModel)]="mdNotesText"></textarea>
              </div>
            </div>
          </div>

        </div>

        <div class="footer-row">
          <button class="btn primary"
                  type="button"
                  (click)="submitDecision()"
                  [disabled]="!hasSelectedReviewLines()">
            Submit Decision
          </button>

          <button class="btn"
                  type="button"
                  (click)="saveAndContinue()"
                  [disabled]="!hasSelectedReviewLines()">
            Save &amp; Continue
          </button>

          <button class="btn danger"
                  type="button"
                  (click)="closeReview()">
            Close
          </button>
        </div>

      </div>
    </div>


    <!-- RIGHT COLUMN (40%) -->
    <div class="col-summary" *ngIf="selectedAuth && showSummary">
      <h3>Auth Summary</h3>
      <p><strong>Member ID:</strong> {{ selectedAuthData.memberId }}</p>
      <p><strong>Member Name:</strong> {{ selectedAuthData.memberName }}</p>
      <p><strong>Auth #:</strong> {{ selectedAuthData.authNumber }}</p>
      <p><strong>Auth Type:</strong> {{ selectedAuthData.authType }}</p>
      <p><strong>Facility:</strong> {{ selectedAuthData.facility }}</p>
      <p><strong>Request Date:</strong> {{ selectedAuthData.requestDate }}</p>
      <p><strong>Expected Admission:</strong> {{ selectedAuthData.expectedAdmissionDatetime }}</p>
      <p><strong>Expected Discharge:</strong> {{ selectedAuthData.expectedDischargeDatetime }}</p>

      <h4>Diagnosis</h4>
      <ul>
        <li *ngFor="let dx of selectedAuthData.diagnosisDetails">{{ dx.icd10Code }} - {{ dx.icd10Description }}</li>
      </ul>

      <h4>Notes</h4>
      <ul>
        <li *ngFor="let note of selectedAuthData.authorizationNotes">
          <strong>{{ note.authorizationNoteTypeLabel }}:</strong> {{ note.authorizationNotes }}
        </li>
      </ul>
    </div>
  </div>
</div>
