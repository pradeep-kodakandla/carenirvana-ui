<div class="main-wrapper">
  <div class="container" style="margin:0px !important;" [ngClass]="{ 'summary-on': showSummary, 'summary-off': !showSummary }">
    <!-- LEFT COLUMN (20%) -->
    <div class="col-left" [ngClass]="{ 'full-width': !selectedAuth, 'minimized': !!selectedAuth }">
      <div class="top-bar" style="display:flex;align-items:center;gap:10px;margin:8px 0;">
        <div class="search-section" style="display:flex;align-items:center;gap:8px;flex:1;">
          <input type="text"
                 placeholder="🔍 Search activities…"
                 (input)="onQuickSearch($event)"
                 class="search-input"
                 style="flex:1; padding:10px 12px; border:1px solid #e1e5ea; border-radius:10px; outline:none;" />
          <button class="filter-btn"
                  type="button"
                  (click)="toggleFilters()"
                  title="Filters">
            <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M3 5h18v2l-7 7v5l-4 2v-7L3 7z"></path>
            </svg>
          </button>
        </div>

        <div class="filters-col" *ngIf="!selectedAuth">
          <div class="chip-list">
            <button type="button" class="pill red" [class.active]="dueChip==='OVERDUE'" (click)="setDueChip('OVERDUE')">
              <span class="dot red"></span> Over Due
              <span class="count">{{ overdueCount  }}</span>
            </button>
            <button type="button" class="pill amber" [class.active]="dueChip==='TODAY'" (click)="setDueChip('TODAY')">
              <span class="dot amber"></span> Due today
              <span class="count">{{ dueTodayCount  }}</span>
            </button>
            <button type="button" class="pill green" [class.active]="dueChip==='FUTURE'" (click)="setDueChip('FUTURE')">
              <span class="dot green"></span> Due in future
              <span class="count">{{ dueFutureCount }}</span>
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="!selectedAuth">
        <div class="table-wrapper">
          <table mat-table [dataSource]="dataSource" matSort
                 multiTemplateDataRows
                 class="mat-elevation-z1 full-width-table pro-table mng-table">

            <!-- Module -->
            <ng-container matColumnDef="module">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Module</th>
              <td mat-cell *matCellDef="let row">
                <div class="status-cell">
                  {{ row.Module || '-' }}
                </div>
              </td>
            </ng-container>

            <!-- Member (FirstName LastName + ID) -->
            <ng-container matColumnDef="member">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Member</th>
              <td mat-cell *matCellDef="let row">
                <div class="name-cell">
                  <div class="sub-name">
                    <a href="#" (click)="onMemberClick(row.MemberId, (row.FirstName || '') + ' ' + (row.LastName || '')); $event.preventDefault()">
                      {{ (row.FirstName || '') + ' ' + (row.LastName || '') }}
                    </a>
                  </div>
                  <div class="sub-id">ID: {{ row.MemberId }}</div>
                </div>
              </td>
            </ng-container>

            <!-- Auth Number -->
            <ng-container matColumnDef="authNumber">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Auth #</th>
              <td mat-cell *matCellDef="let row">
                <a href="#" (click)="onAuthClick(row.AuthNumber, row.MemberId); $event.preventDefault()">
                  {{ row.AuthNumber }}
                </a>
              </td>
            </ng-container>

            <!-- Created On -->
            <ng-container matColumnDef="createdOn">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Created On</th>
              <td mat-cell *matCellDef="let row">{{ row.CreatedOn | date:'MM/dd/yyyy HH:mm:ss' }}</td>
            </ng-container>

            <!-- Refer To (username + id) -->
            <ng-container matColumnDef="referredTo">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Refer To</th>
              <td mat-cell *matCellDef="let row">
                <div>{{ row.UserName || '-' }}</div>
                <!--<div style="font-size:12px;color:#6b7280;">ID: {{ row.ReferredTo }}</div>-->
              </td>
            </ng-container>

            <!-- Activity Type -->
            <ng-container matColumnDef="activityType">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Activity Type</th>
              <td mat-cell *matCellDef="let row">{{ row.ActivityType || '-' }}</td>
            </ng-container>

            <!-- Follow Up Date -->
            <ng-container matColumnDef="followUpDate">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Follow Up Date</th>
              <td mat-cell *matCellDef="let row">{{ row.FollowUpDateTime | date:'MM/dd/yyyy HH:mm:ss' }}</td>
            </ng-container>

            <!-- Due Date with colors + days-left -->
            <ng-container matColumnDef="dueDate">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Due Date</th>
              <td mat-cell *matCellDef="let row">
                <span class="risk-chip compact" [ngClass]="getDueDateClass(row.DueDate)">
                  <div class="date-value">
                    {{ row.DueDate | date:'MM/dd/yyyy HH:mm:ss' }}
                  </div>
                  <div class="days-left">
                    {{ getDaysLeftLabel(row.DueDate) }}
                  </div>
                </span>
              </td>
            </ng-container>

            <!-- Status -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
              <td mat-cell *matCellDef="let row">{{ row.Status || '-' }}</td>
            </ng-container>
            <ng-container matColumnDef="review">
              <th mat-header-cell *matHeaderCellDef>Review</th>
              <td mat-cell *matCellDef="let row">
                <button mat-stroked-button color="primary"
                        (click)="onReviewClick(row); $event.stopPropagation()">
                  Review
                </button>
              </td>
            </ng-container>
            <!-- Expanded placeholder (kept for parity) -->
            <ng-container matColumnDef="expandedDetail">
              <td mat-cell *matCellDef="let row" [attr.colspan]="displayedColumns.length">
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"
                class="example-element-row"
                [class.example-expanded-row]="expandedElement === row"
                (click)="expandedElement = expandedElement === row ? null : row">
            </tr>
            <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>

            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell" [attr.colspan]="displayedColumns.length">No data</td>
            </tr>
          </table>

          <mat-paginator [pageSizeOptions]="[10, 25, 100]" aria-label="Select page"></mat-paginator>
        </div>
      </div>
      <!-- CARD LIST VIEW (when reviewing) -->
      <div class="card-list" *ngIf="selectedAuth">
        <div class="mini-card"
             *ngFor="let row of navList; let i = index; trackBy: trackByAuth"
             [class.selected]="isSame(row, selectedAuthRaw)"
             (click)="onCardSelect(row, i)">
          <div class="mini-card-title">
            {{ row.AuthNumber || row.authNumber || '—' }}

          </div>
          <div class="mini-card-sub">
            {{ (row.FirstName || '') + ' ' + (row.LastName || '') }}
          </div>
          <div class="mini-card-meta">
            <span class="chip" [ngClass]="dueChipClass(row)">{{ dueChipText(row) }}</span>
            <span class="dim">Due: {{ getDate(row?.AuthDueDate || row?.DueDate) }}</span>
            <span class="dim">Activty Type: {{ (row?.ActivityType || row?.ActivityType) }}</span>
          </div>
        </div>
      </div>


    </div>

    <!-- MIDDLE COLUMN (40%) -->
    <div class="col-middle" *ngIf="selectedAuth">
      <div class="review-header-bar" *ngIf="selectedAuth">
        <h2>Authorization Review</h2>
        <div class="review-controls">
          <button (click)="onPrevious()" [disabled]="!canPrev">&lt; Previous</button>
          <span>Review {{ (selectedIndex + 1) }} of {{ navList.length }}</span>
          <button (click)="onNext()" [disabled]="!canNext">Next &gt;</button>
          <button type="button" (click)="toggleSummary()">
            {{ showSummary ? 'Hide Summary' : 'Show Summary' }}
          </button>
        </div>
      </div>

      <div class="review-header">
        <p>Review Due Date: {{ selectedAuth.dueDate }} | Review Priority: {{ selectedAuth.priority }}</p>
        <!--<p style="color:green;"><strong>Overall Initial Recommendation:</strong> {{ selectedAuth.recommendation }}</p>-->
        <p class="overall-ir">
          <strong>Overall Initial Recommendation:</strong> {{ overallInitialRecommendation }}
        </p>
      </div>

      <div class="review-content">
        <h6>Clinical Context & Instructions</h6>
        <h6>Clinical Documents</h6>
        <div class="clinical-documents">
          <div class="field">
            <label>Member ID:</label>
            <span>{{ selectedAuth.memberId }}</span>
          </div>

          <div class="field">
            <label>Member Name:</label>
            <span>{{ selectedAuth.memberName }}</span>
          </div>
          <div class="field">
            <label>Auth #:</label>
            <span>{{ selectedAuth.authNumber }}</span>
          </div>
          <div class="field">
            <label>Auth Type:</label>
            <span>{{ selectedAuth.authType }}</span>
          </div>
          <div class="field">
            <label>Facility:</label>
            <span>{{ selectedAuth.facility }}</span>
          </div>
          <div class="field">
            <label>Network Status:</label>
            <span>{{ selectedAuth.networkStatus }}</span>
          </div>
        </div>


        <h6>Service Lines</h6>
        <div class="table-wrapper">
          <table mat-table
                 [dataSource]="serviceLinesDS"
                 class="mat-elevation-z1 full-width-table pro-table mng-table">

            <ng-container matColumnDef="select">
              <th mat-header-cell *matHeaderCellDef class="col-select">
                <mat-checkbox (change)="masterToggle()"
                              [checked]="isAllSelected()"
                              [indeterminate]="selection.hasValue() && !isAllSelected()"
                              [disabled]="!hasSelectableRows()"
                              [aria-label]="checkboxLabel()">
                </mat-checkbox>
              </th>
              <td mat-cell *matCellDef="let line" class="col-select">
                <mat-checkbox (click)="$event.stopPropagation()"
                              (change)="$event ? selection.toggle(line) : null"
                              [checked]="selection.isSelected(line)"
                              [disabled]="!isLineSelectable(line)"
                              [aria-label]="checkboxLabel(line)">
                </mat-checkbox>
              </td>
            </ng-container>
            <!-- Service Code -->
            <ng-container matColumnDef="serviceCode">
              <th mat-header-cell *matHeaderCellDef>Service Code</th>
              <td mat-cell *matCellDef="let line">{{ line.ServiceCode || '—' }}</td>
            </ng-container>

            <!-- Description -->
            <ng-container matColumnDef="description">
              <th mat-header-cell *matHeaderCellDef>Description</th>
              <td mat-cell *matCellDef="let line">{{ line.Description || '—' }}</td>
            </ng-container>

            <!-- From -->
            <ng-container matColumnDef="fromDate">
              <th mat-header-cell *matHeaderCellDef>From</th>
              <td mat-cell *matCellDef="let line">{{ line.FromDate | date:'MM/dd/yyyy' }}</td>
            </ng-container>

            <!-- To -->
            <ng-container matColumnDef="toDate">
              <th mat-header-cell *matHeaderCellDef>To</th>
              <td mat-cell *matCellDef="let line">{{ line.ToDate | date:'MM/dd/yyyy' }}</td>
            </ng-container>

            <!-- Requested -->
            <ng-container matColumnDef="requested">
              <th mat-header-cell *matHeaderCellDef>Req.</th>
              <td mat-cell *matCellDef="let line">{{ line.Requested }}</td>
            </ng-container>

            <!-- Approved -->
            <ng-container matColumnDef="approved">
              <th mat-header-cell *matHeaderCellDef>Appr.</th>
              <td mat-cell *matCellDef="let line">{{ line.Approved }}</td>
            </ng-container>

            <!-- Denied -->
            <ng-container matColumnDef="denied">
              <th mat-header-cell *matHeaderCellDef>Den.</th>
              <td mat-cell *matCellDef="let line">{{ line.Denied }}</td>
            </ng-container>

            <!-- Initial Recommendation -->
            <ng-container matColumnDef="initial">
              <th mat-header-cell *matHeaderCellDef>Initial Recommendation</th>
              <td mat-cell *matCellDef="let line">{{ line.InitialRecommendation || '—' }}</td>
            </ng-container>

            <!-- MD Decision -->
            <ng-container matColumnDef="mdDecision">
              <th mat-header-cell *matHeaderCellDef>MD Decision</th>
              <!--<td mat-cell *matCellDef="let line">{{ line.MdDecision || 'Not Reviewed' }}</td>-->
              <td mat-cell *matCellDef="let line">
                <span class="md-badge" [ngClass]="mdDecisionClass(line.MdDecision)">
                  {{ line.MdDecision || 'Not Reviewed' }}
                </span>
              </td>
            </ng-container>

            <!-- MD Notes -->
            <ng-container matColumnDef="mdNotes">
              <th mat-header-cell *matHeaderCellDef>MD Notes</th>
              <td mat-cell *matCellDef="let line">{{ line.MdNotes || '—' }}</td>
            </ng-container>

            <!-- Header / Rows -->
            <tr mat-header-row *matHeaderRowDef="displayedServiceColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedServiceColumns;"></tr>

            <!-- Empty state -->
            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell dim" [attr.colspan]="displayedServiceColumns.length">
                No service lines found.
              </td>
            </tr>
          </table>
        </div>


        <h6>Medical Director's Decision</h6>
        <div class="decision-options">
          <div class="form-outline dropdown-container">
            <label class="floating-label">Decision Status <span class="text-danger">*</span></label>

            <div class="input-with-icon">
              <input type="text"
                     class="form-control"
                     [value]="DecisionStatusDisplay"
                     (input)="onTypeaheadInput($event)"
                     (keydown)="handleDropdownKeydown($event, 'DecisionStatus')"
                     (focus)="openDropdown('DecisionStatus')"
                     (focusout)="closeDropdown('DecisionStatus')">
              <!--[ngClass]="{'is-invalid': activityForm.get('DecisionStatus')?.touched && activityForm.get('DecisionStatus')?.invalid}"-->

              <span class="dropdown-arrow">&#9662;</span>

              <div class="autocomplete-dropdown" *ngIf="showDropdowns.DecisionStatus && filteredDecisionStatus?.length">
                <div class="autocomplete-option"
                     *ngFor="let option of filteredDecisionStatus; let i = index"
                     [ngClass]="{'highlighted': i === highlightedIndex}"
                     (mousedown)="selectDropdownOption('DecisionStatus', option)">
                  {{ option.label }}
                </div>

              </div>
            </div>

            <!--<div *ngIf="activityForm.get('DecisionStatus')?.touched && activityForm.get('DecisionStatus')?.invalid" class="text-danger">
              Activity Type is required.
            </div>-->
          </div>
          <!--<label><input type="radio" name="decision"> <span class="green">Approve</span></label><br />-->
          <!--<label><input type="radio" name="decision"> <span class="red">Deny</span></label><br />-->
          <label><input type="radio" name="decision"> <span class="blue">Request more information</span></label>
        </div>

        <textarea rows="4" placeholder="Comments and Recommendations" [(ngModel)]="mdNotesText"></textarea>

        <div class="action-buttons">
          <button class="submit" (click)="onSaveSelection()">Submit Decision</button>
          <button class="save" (click)="onSaveSelection()">Save & Continue</button>
          <button class="close" (click)="closeReview()">Close</button>
        </div>
      </div>
    </div>


    <!-- RIGHT COLUMN (40%) -->
    <div class="col-summary" *ngIf="selectedAuth && showSummary">
      <h3>Auth Summary</h3>
      <p><strong>Member ID:</strong> {{ selectedAuthData.memberId }}</p>
      <p><strong>Member Name:</strong> {{ selectedAuthData.memberName }}</p>
      <p><strong>Auth #:</strong> {{ selectedAuthData.authNumber }}</p>
      <p><strong>Auth Type:</strong> {{ selectedAuthData.authType }}</p>
      <p><strong>Facility:</strong> {{ selectedAuthData.facility }}</p>
      <p><strong>Request Date:</strong> {{ selectedAuthData.requestDate }}</p>
      <p><strong>Expected Admission:</strong> {{ selectedAuthData.expectedAdmissionDatetime }}</p>
      <p><strong>Expected Discharge:</strong> {{ selectedAuthData.expectedDischargeDatetime }}</p>

      <h4>Diagnosis</h4>
      <ul>
        <li *ngFor="let dx of selectedAuthData.diagnosisDetails">{{ dx.icd10Code }} - {{ dx.icd10Description }}</li>
      </ul>

      <h4>Notes</h4>
      <ul>
        <li *ngFor="let note of selectedAuthData.authorizationNotes">
          <strong>{{ note.authorizationNoteTypeLabel }}:</strong> {{ note.authorizationNotes }}
        </li>
      </ul>
    </div>
  </div>
</div>
