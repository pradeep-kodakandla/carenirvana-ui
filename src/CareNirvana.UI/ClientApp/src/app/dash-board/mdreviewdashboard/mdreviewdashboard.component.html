
<div class="main-wrapper">
  <div class="container" style="margin:0px !important;">
    <!-- LEFT COLUMN (20%) -->
    <div class="col-left" [ngClass]="{ 'full-width': !selectedAuth }">
      <!--<div class="top-bar">
        <div class="search-section">
          <input type="text" placeholder="🔍 Search..." (input)="onSearch($event)" class="search-input" />
        </div>-->
      <!-- Summary Cards -->
      <!--<div class="summary-container" style="padding-left:10px;" *ngIf="!selectedAuth">
          <mat-card class="summary-card" *ngFor="let item of summaryStats">
            <div class="summary-row">
              <mat-icon>{{ item.icon }}</mat-icon>
              <span class="stat-label">{{ item.label }}:</span>
              <span class="stat-value">{{ item.value }}</span>
            </div>
          </mat-card>
        </div>
      </div>-->

      <div class="top-bar" style="display:flex;align-items:center;gap:10px;margin:8px 0;">
        <div class="search-section" style="display:flex;align-items:center;gap:8px;flex:1;">
          <input type="text"
                 placeholder="🔍 Search activities…"
                 (input)="onQuickSearch($event)"
                 class="search-input"
                 style="flex:1; padding:10px 12px; border:1px solid #e1e5ea; border-radius:10px; outline:none;" />
          <button class="filter-btn"
                  type="button"
                  (click)="toggleFilters()"
                  title="Filters">
            <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M3 5h18v2l-7 7v5l-4 2v-7L3 7z"></path>
            </svg>
          </button>
        </div>

        <div class="filters-col" *ngIf="!selectedAuth">
          <div class="chip-list">
            <button type="button" class="pill red" [class.active]="dueChip==='OVERDUE'" (click)="setDueChip('OVERDUE')">
              <span class="dot red"></span> Over Due
              <span class="count">{{ overdueCount  }}</span>
            </button>
            <button type="button" class="pill amber" [class.active]="dueChip==='TODAY'" (click)="setDueChip('TODAY')">
              <span class="dot amber"></span> Due today
              <span class="count">{{ dueTodayCount  }}</span>
            </button>
            <button type="button" class="pill green" [class.active]="dueChip==='FUTURE'" (click)="setDueChip('FUTURE')">
              <span class="dot green"></span> Due in future
              <span class="count">{{ dueFutureCount }}</span>
            </button>
          </div>
        </div>
      </div>


      <div class="table-wrapper">
        <table mat-table [dataSource]="dataSource" matSort
               multiTemplateDataRows
               class="mat-elevation-z1 full-width-table pro-table mng-table">

          <!-- Module -->
          <ng-container matColumnDef="module">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Module</th>
            <td mat-cell *matCellDef="let row">
              <div class="status-cell">
                {{ row.Module || '-' }}
              </div>
            </td>
          </ng-container>

          <!-- Member (FirstName LastName + ID) -->
          <ng-container matColumnDef="member">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Member</th>
            <td mat-cell *matCellDef="let row">
              <div class="name-cell">
                <div class="sub-name">
                  <a href="#" (click)="onMemberClick(row.MemberId, (row.FirstName || '') + ' ' + (row.LastName || '')); $event.preventDefault()">
                    {{ (row.FirstName || '') + ' ' + (row.LastName || '') }}
                  </a>
                </div>
                <div class="sub-id">ID: {{ row.MemberId }}</div>
              </div>
            </td>
          </ng-container>

          <!-- Auth Number -->
          <ng-container matColumnDef="authNumber">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Auth #</th>
            <td mat-cell *matCellDef="let row">{{ row.AuthNumber }}</td>
          </ng-container>

          <!-- Created On -->
          <ng-container matColumnDef="createdOn">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Created On</th>
            <td mat-cell *matCellDef="let row">{{ row.CreatedOn | date:'MM/dd/yyyy HH:mm:ss' }}</td>
          </ng-container>

          <!-- Refer To (username + id) -->
          <ng-container matColumnDef="referredTo">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Refer To</th>
            <td mat-cell *matCellDef="let row">
              <div>{{ row.UserName || '-' }}</div>
              <!--<div style="font-size:12px;color:#6b7280;">ID: {{ row.ReferredTo }}</div>-->
            </td>
          </ng-container>

          <!-- Activity Type -->
          <ng-container matColumnDef="activityType">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Activity Type</th>
            <td mat-cell *matCellDef="let row">{{ row.ActivityType || '-' }}</td>
          </ng-container>

          <!-- Follow Up Date -->
          <ng-container matColumnDef="followUpDate">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Follow Up Date</th>
            <td mat-cell *matCellDef="let row">{{ row.FollowUpDateTime | date:'MM/dd/yyyy HH:mm:ss' }}</td>
          </ng-container>

          <!-- Due Date with colors + days-left -->
          <ng-container matColumnDef="dueDate">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Due Date</th>
            <td mat-cell *matCellDef="let row">
              <span class="risk-chip compact" [ngClass]="getDueDateClass(row.DueDate)">
                <div class="date-value">
                  {{ row.DueDate | date:'MM/dd/yyyy HH:mm:ss' }}
                </div>
                <div class="days-left">
                  {{ getDaysLeftLabel(row.DueDate) }}
                </div>
              </span>
            </td>
          </ng-container>

          <!-- Status -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
            <td mat-cell *matCellDef="let row">{{ row.Status || '-' }}</td>
          </ng-container>

          <!-- Expanded placeholder (kept for parity) -->
          <ng-container matColumnDef="expandedDetail">
            <td mat-cell *matCellDef="let row" [attr.colspan]="displayedColumns.length">
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"
              class="example-element-row"
              [class.example-expanded-row]="expandedElement === row"
              (click)="expandedElement = expandedElement === row ? null : row">
          </tr>
          <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>

          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell" [attr.colspan]="displayedColumns.length">No data</td>
          </tr>
        </table>

        <mat-paginator [pageSizeOptions]="[10, 25, 100]" aria-label="Select page"></mat-paginator>
      </div>
    </div>

    <!-- MIDDLE COLUMN (40%) -->
    <div class="col-middle" *ngIf="selectedAuth">
      <div class="review-header-bar">
        <h2>Authorization Review</h2>
        <div class="review-controls">
          <button (click)="onPrevious()" [disabled]="selectedIndex === 0">&lt; Previous</button>
          <span>Review {{ selectedIndex! + 1 }} of {{ auths.length }}</span>
          <button (click)="onNext()" [disabled]="selectedIndex === auths.length - 1">Next &gt;</button>
        </div>
      </div>

      <div class="review-header">
        <p>Review Due Date: {{ selectedAuth.dueDate }} | Review Priority: {{ selectedAuth.priority }}</p>
        <p style="color:green;"><strong>Overall Initial Recommendation:</strong> {{ selectedAuth.recommendation }}</p>
      </div>

      <div class="review-content">
        <h6>Clinical Context & Instructions</h6>
        <h6>Clinical Documents</h6>
        <div class="clinical-documents">
          <div class="field">
            <label>Member ID:</label>
            <span>{{ selectedAuth.memberId }}</span>
          </div>

          <div class="field">
            <label>Member Name:</label>
            <span>{{ selectedAuth.memberId }}</span>
          </div>
          <div class="field">
            <label>Auth #:</label>
            <span>{{ selectedAuth.authNumber }}</span>
          </div>
          <div class="field">
            <label>Auth Type:</label>
            <span>{{ selectedAuth.authType }}</span>
          </div>
          <div class="field">
            <label>Facility:</label>
            <span>{{ selectedAuth.facility }}</span>
          </div>
          <div class="field">
            <label>Network Status:</label>
            <span>{{ selectedAuth.networkStatus }}</span>
          </div>
        </div>


        <h6>Service Lines</h6>
        <table class="service-table">
          <thead>
            <tr>
              <th>Code</th>
              <th>Description</th>
              <th>From</th>
              <th>To</th>
              <th>Req.</th>
              <th>Appr.</th>
              <th>Denied</th>
              <th>Initial Recommendation</th>
              <th>MD's Recommendation</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let line of selectedAuth.serviceLines">
              <td><a href="#">{{ line.code }}</a></td>
              <td>{{ line.desc }}</td>
              <td>{{ line.from }}</td>
              <td>{{ line.to }}</td>
              <td>{{ line.req }}</td>
              <td>{{ line.appr }}</td>
              <td>{{ line.denied }}</td>
              <td>{{ line.initial }}</td>
              <td>{{ line.director }}</td>
            </tr>
          </tbody>
        </table>

        <h6>Medical Director's Decision</h6>
        <div class="decision-options">
          <label><input type="radio" name="decision"> <span class="green">Approve</span></label><br />
          <label><input type="radio" name="decision"> <span class="red">Deny</span></label><br />
          <label><input type="radio" name="decision"> <span class="blue">Request more information</span></label>
        </div>

        <textarea rows="4" placeholder="Comments and Recommendations"></textarea>

        <div class="action-buttons">
          <button class="submit">Submit Decision</button>
          <button class="save">Save & Continue</button>
          <button class="close" (click)="closeReview()">Close</button>
        </div>
      </div>
    </div>


    <!-- RIGHT COLUMN (40%) -->
    <div class="col-summary" *ngIf="selectedAuth">
      <h3>Auth Summary</h3>
      <p><strong>Member ID:</strong> {{ selectedAuthData.memberId }}</p>
      <p><strong>Member Name:</strong> {{ selectedAuthData.memberName }}</p>
      <p><strong>Auth #:</strong> {{ selectedAuthData.authNumber }}</p>
      <p><strong>Auth Type:</strong> {{ selectedAuthData.authType }}</p>
      <p><strong>Facility:</strong> {{ selectedAuthData.facility }}</p>
      <p><strong>Request Date:</strong> {{ selectedAuthData.requestDate }}</p>
      <p><strong>Expected Admission:</strong> {{ selectedAuthData.expectedAdmissionDatetime }}</p>
      <p><strong>Expected Discharge:</strong> {{ selectedAuthData.expectedDischargeDatetime }}</p>

      <h4>Diagnosis</h4>
      <ul>
        <li *ngFor="let dx of selectedAuthData.diagnosisDetails">{{ dx.icd10Code }} - {{ dx.icd10Description }}</li>
      </ul>

      <h4>Notes</h4>
      <ul>
        <li *ngFor="let note of selectedAuthData.authorizationNotes">
          <strong>{{ note.authorizationNoteTypeLabel }}:</strong> {{ note.authorizationNotes }}
        </li>
      </ul>
    </div>
  </div>
</div>

