<mat-menu #menu="matMenu">
  <button mat-menu-item><span>Add Activity</span></button>
  <button mat-menu-item disabled><span>Run Assessment</span></button>
  <button mat-menu-item><span>Messages</span></button>
  <button mat-menu-item><span>Add Notes</span></button>
  <button mat-menu-item disabled><span>Send Letter</span></button>
  <button mat-menu-item><span>Unassign</span></button>
  <button mat-menu-item><span>Summary</span></button>
</mat-menu>

<mat-drawer-container class="sidenav-container" autosize>
  <mat-drawer-content mode="side" opened>
    <!-- Top bar: search + filter toggle + due chips -->
    <div class="top-bar" style="display:flex;align-items:center;gap:10px;margin:8px 0;">
      <div class="search-section" style="display:flex;align-items:center;gap:8px;flex:1;">
        <input type="text"
               placeholder="🔍 Search authorizations…"
               (input)="onQuickSearch($event)"
               class="search-input"
               style="flex:1; padding:10px 12px; border:1px solid #e1e5ea; border-radius:10px; outline:none;" />
        <button class="filter-btn"
                type="button"
                (click)="toggleFilters()"
                title="Filters">
          <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M3 5h18v2l-7 7v5l-4 2v-7L3 7z"></path>
          </svg>
        </button>
      </div>

      <div class="filters-col">
        <div class="chip-list">
          <button type="button" class="pill red" [class.active]="dueChip==='OVERDUE'" (click)="setDueChip('OVERDUE')">
            <span class="dot red"></span> Over Due
            <span class="count">{{ overdueCount  }}</span>
          </button>
          <button type="button" class="pill amber" [class.active]="dueChip==='TODAY'" (click)="setDueChip('TODAY')">
            <span class="dot amber"></span> Due today
            <span class="count">{{ dueTodayCount  }}</span>
          </button>
          <button type="button" class="pill green" [class.active]="dueChip==='FUTURE'" (click)="setDueChip('FUTURE')">
            <span class="dot green"></span> Due in future
            <span class="count">{{ dueFutureCount }}</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Inline Filters Drawer -->
    <section class="filters-wrapper" *ngIf="showFilters" style="margin:8px 0;">
      <form [formGroup]="filtersForm" class="filters-panel"
            style="border:1px solid #e1e5ea;border-radius:12px;padding:12px;background:#fff;">
        <div class="filters-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <h3 style="margin:0;font-weight:600;">Filters</h3>
          <div style="display:flex;gap:8px;">
            <button type="button" (click)="resetFilters()" class="reset-btn"
                    style="border:1px solid #e1e5ea;border-radius:10px;padding:6px 10px;background:#fff;cursor:pointer;">
              Reset
            </button>
            <button type="button" (click)="applyAdvancedFilters()" class="apply-btn"
                    style="border:0;border-radius:10px;padding:6px 12px;background:#1b72e8;color:#fff;cursor:pointer;">
              Apply
            </button>
            <button type="button" (click)="toggleFilters()" class="close-btn"
                    style="border:0;border-radius:10px;padding:6px 12px;background:#6b7280;color:#fff;cursor:pointer;">
              Close
            </button>
          </div>
        </div>

        <!-- Grid -->
        <div class="filters-grid" style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;">
          <mat-form-field appearance="outline">
            <mat-label>Auth Type</mat-label>
            <input matInput formControlName="authType" placeholder="e.g., Inpatient, Outpatient">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Treatment Type</mat-label>
            <input matInput formControlName="treatmentType" placeholder="e.g., Physical Therapy">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Auth Priority</mat-label>
            <input matInput formControlName="authPriority" placeholder="e.g., Routine, Urgent">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Auth Status</mat-label>
            <input matInput formControlName="authStatus" placeholder="e.g., Open, Closed, Denied">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Service From Date</mat-label>
            <input matInput [matDatepicker]="svcFrom" formControlName="serviceFromDate">
            <mat-datepicker-toggle matSuffix [for]="svcFrom"></mat-datepicker-toggle>
            <mat-datepicker #svcFrom></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Service To Date</mat-label>
            <input matInput [matDatepicker]="svcTo" formControlName="serviceToDate">
            <mat-datepicker-toggle matSuffix [for]="svcTo"></mat-datepicker-toggle>
            <mat-datepicker #svcTo></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Auth Created From</mat-label>
            <input matInput [matDatepicker]="crFrom" formControlName="createdFrom">
            <mat-datepicker-toggle matSuffix [for]="crFrom"></mat-datepicker-toggle>
            <mat-datepicker #crFrom></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Auth Created To</mat-label>
            <input matInput [matDatepicker]="crTo" formControlName="createdTo">
            <mat-datepicker-toggle matSuffix [for]="crTo"></mat-datepicker-toggle>
            <mat-datepicker #crTo></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Provider</mat-label>
            <input matInput formControlName="provider" placeholder="Provider name or ID">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Provider Specialty</mat-label>
            <input matInput formControlName="providerSpecialty" placeholder="e.g., Orthopedics">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Auth Due Date (From)</mat-label>
            <input matInput [matDatepicker]="dueFrom" formControlName="authDueFrom">
            <mat-datepicker-toggle matSuffix [for]="dueFrom"></mat-datepicker-toggle>
            <mat-datepicker #dueFrom></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Auth Due Date (To)</mat-label>
            <input matInput [matDatepicker]="dueTo" formControlName="authDueTo">
            <mat-datepicker-toggle matSuffix [for]="dueTo"></mat-datepicker-toggle>
            <mat-datepicker #dueTo></mat-datepicker>
          </mat-form-field>
        </div>
      </form>
    </section>

    <mat-drawer-container class="sidenav-container" autosize>
      <mat-drawer-content mode="side" opened>
        <div class="table-wrapper">
          <table mat-table [dataSource]="dataSource" matSort
                 multiTemplateDataRows
                 class="mat-elevation-z1 full-width-table pro-table mng-table">

            <!-- Actions -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let row">
                <button mat-icon-button [matMenuTriggerFor]="menu">
                  <mat-icon>list</mat-icon>
                </button>
              </td>
            </ng-container>

            <!-- Member (MemberName + MemberId) -->
            <ng-container matColumnDef="memberId">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Member</th>
              <td mat-cell *matCellDef="let row">
                <div class="name-cell">
                  <div class="sub-name">
                    <a href="#" (click)="onMemberClick(row.MemberId, row.MemberName); $event.preventDefault()">
                      {{ row.MemberName }}
                    </a>
                  </div>
                  <div class="sub-id">ID: {{ row.MemberId }}</div>
                </div>
              </td>
            </ng-container>

            <!-- Auth Number -->
            <ng-container matColumnDef="authNumber">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Auth #</th>
              <td mat-cell *matCellDef="let row">
                <a href="#" (click)="onAuthClick(row.AuthNumber, row.MemberId); $event.preventDefault()">
                  {{ row.AuthNumber }}
                </a>
                <!--{{ row.AuthNumber || '-' }}-->
              </td>
            </ng-container>

            <!-- Auth Type (TemplateName) -->
            <ng-container matColumnDef="authType">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Auth Type</th>
              <td mat-cell *matCellDef="let row">{{ row.TemplateName || '-' }}</td>
            </ng-container>

            <!-- Auth Due Date (colored + days-left) -->
            <ng-container matColumnDef="authDueDate">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Auth Due Date</th>
              <td mat-cell *matCellDef="let row">
                <span class="risk-chip compact" [ngClass]="getDueDateClass(row.AuthDueDate)">
                  <div class="date-value">
                    {{ row.AuthDueDate | date:'MM/dd/yyyy HH:mm:ss' }}
                  </div>
                  <div class="days-left">
                    {{ getDaysLeftLabel(row.AuthDueDate) }}
                  </div>
                </span>
              </td>
            </ng-container>

            <!-- Next Review Date -->
            <ng-container matColumnDef="nextReviewDate">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Next Review Date</th>
              <td mat-cell *matCellDef="let row">{{ row.NextReviewDate | date:'MM/dd/yyyy hh:mm:ss' }}</td>
            </ng-container>

            <!-- Treatment Type -->
            <ng-container matColumnDef="treatmentType">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Treatment Type</th>
              <td mat-cell *matCellDef="let row">{{ row.TreatmentTypeValue || row.TreatmentType || '-' }}</td>
            </ng-container>

            <!-- Priority -->
            <ng-container matColumnDef="priority">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Priority</th>
              <td mat-cell *matCellDef="let row">{{ row.RequestPriorityValue || row.AuthPriority || '-' }}</td>
            </ng-container>

            <!-- Status -->
            <ng-container matColumnDef="authStatusValue">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
              <td mat-cell *matCellDef="let row">{{ row.AuthStatusValue || row.AuthStatus || '-' }}</td>
            </ng-container>

            <!-- Expanded placeholder -->
            <ng-container matColumnDef="expandedDetail">
              <td mat-cell *matCellDef="let row" [attr.colspan]="displayedColumns.length">
                <!-- add expanded info if needed -->
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row
                *matRowDef="let row; columns: displayedColumns;"
                class="example-element-row"
                [class.example-expanded-row]="expandedElement === row"
                (click)="expandedElement = expandedElement === row ? null : row">
            </tr>
            <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>
          </table>

          <mat-paginator [pageSizeOptions]="[10, 25, 100]" aria-label="Select page of users"></mat-paginator>
        </div>
      </mat-drawer-content>

      <mat-drawer #drawer class="sidenav" style="width:22%;height:50%;align-content:center;" position="end" mode="side" opened="false">
      </mat-drawer>
    </mat-drawer-container>
  </mat-drawer-content>
</mat-drawer-container>
