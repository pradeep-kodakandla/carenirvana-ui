<!-- Header: search + Add -->
<div class="top-bar" style="display:flex;align-items:center;gap:10px;margin:8px 0;">
  <div class="search-section" style="display:flex;align-items:center;gap:8px;flex:1;">
    <input type="text"
           placeholder="🔍 Search faxes…"
           (input)="onQuickSearch($event)"
           class="search-input"
           style="flex:1; padding:10px 12px; border:1px solid #e1e5ea; border-radius:10px; outline:none;" />
    <!--<button class="filter-btn"
            type="button"
            (click)="toggleFilters()"
            title="Filters">
      <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M3 5h18v2l-7 7v5l-4 2v-7L3 7z"></path>
      </svg>
    </button>-->
  </div>

  <div class="filters-col">
    <div class="chip-list">
      <div class="flex items-center gap-2">
        <button mat-stroked-button color="primary" (click)="reload()">Search</button>


        <!-- Add / Upload -->
        <button mat-flat-button color="primary" (click)="fileInput.click()">
          <mat-icon>add</mat-icon>
          Add
        </button>
        <!-- faxes.component.html -->
        <input #fileInput type="file" accept="application/pdf" hidden (change)="saveFileData($event)" />

      </div>
    </div>
  </div>
</div>

<!-- Table -->
<div class="table-wrapper" *ngIf="!showPreview">
  <table mat-table [dataSource]="dataSource" class="mat-elevation-z0 mng-table responsive-table">

    <!-- Fax File Name -->
    <ng-container matColumnDef="fileName">
      <th mat-header-cell *matHeaderCellDef>Fax File Name</th>
      <td mat-cell *matCellDef="let r">
        <div class="font-medium">{{ r.fileName }}</div>
        <!--<div class="sub-id">#{{ r.faxId }}</div>-->
      </td>
    </ng-container>

    <!-- Received Datetime -->
    <ng-container matColumnDef="receivedAt">
      <th mat-header-cell *matHeaderCellDef>Received Datetime</th>
      <td mat-cell *matCellDef="let r">{{ r.receivedAt | date:'MM/dd/yyyy hh:mm:ss a' }}</td>
    </ng-container>

    <!-- Member -->
    <ng-container matColumnDef="member">
      <th mat-header-cell *matHeaderCellDef>Member</th>
      <td mat-cell *matCellDef="let r">{{ r.memberId || '—' }}</td>
    </ng-container>

    <!-- Work Basket -->
    <ng-container matColumnDef="workBasket">
      <th mat-header-cell *matHeaderCellDef>Work Basket</th>
      <td mat-cell *matCellDef="let r">{{ r.workBasket || '—' }}</td>
    </ng-container>

    <!-- Priority -->
    <ng-container matColumnDef="priority">
      <th mat-header-cell *matHeaderCellDef>Priority</th>
      <td mat-cell *matCellDef="let r">
        <span class="chip" [ngClass]="priorityClass(r.priority)">{{ priorityLabel(r.priority) }}</span>
      </td>
    </ng-container>

    <!-- Status -->
    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef>Status</th>
      <td mat-cell *matCellDef="let r">
        <span class="chip chip-soft">{{ r.status }}</span>
      </td>
    </ng-container>

    <!-- Actions -->
    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef class="is-center">Actions</th>
      <td mat-cell *matCellDef="let r" class="is-center">
        <button mat-icon-button matTooltip="Preview" (click)="openPreview(r)">
          <mat-icon>preview</mat-icon>
        </button>
        <a *ngIf="r.url" mat-icon-button [href]="r.url" target="_blank" matTooltip="Open file">
          <mat-icon>picture_as_pdf</mat-icon>
        </a>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="columns"></tr>
    <tr mat-row class="data-row" *matRowDef="let row; columns: columns;"></tr>
  </table>
</div>

<!-- Split preview panel (shows when selectedFax is set) -->
<div *ngIf="showPreview" class="split3 mt-4">
  <!-- Left: cards list -->
  <div class="pane pane-left">
    <div class="pane-header">
      <span>Faxes (Page {{ page }})</span>
      <button mat-flat-button color="primary" (click)="closePreview()">Close Preview</button>
    </div>

    <div class="cards">
      <div class="fax-card"
           *ngFor="let r of dataSource.data"
           [class.active]="(r.faxId ?? r.faxId) === (selectedFax?.faxId ?? selectedFax?.faxId)"
           (click)="openPreview(r)">
        <div class="title">{{ r.fileName }}</div>
        <div class="meta">
          <span>{{ (r.receivedAt ?? r.receivedAt) | date:'MM/dd/yyyy, hh:mm:ss a' }}</span> •
          <span>{{ r.pageCount ?? r.pageCount }} pg</span>
        </div>
        <!--<div class="row">
          <span class="muted">Member</span>
          <span>{{ r.memberId ?? r.memberId || '—' }}</span>
        </div>
        <div class="row">
          <span class="muted">Basket</span>
          <span>{{ r.workBasket ?? r.workBasket || '—' }}</span>
        </div>
        <div class="row">
          <span class="muted">Priority</span>
          <span class="chip xs" [ngClass]="priorityClass((r.priority ?? r.priority) || 2)">
            {{ priorityLabel((r.priority ?? r.priority) || 2) }}
          </span>
        </div>
        <div class="row">
          <span class="muted">Status</span>
          <span class="chip xs chip-soft">{{ r.status ?? r.status }}</span>
        </div>-->
      </div>
    </div>
  </div>

  <!-- Middle: details (bind to your OCR model when ready) -->
  <div class="pane pane-middle">
    <div class="pane-header">
      <span>Extracted Details</span>
    </div>

    <div *ngIf="priorAuth as pa; else noOcr" class="space-y-3">
      <div class="card">
        <div class="text-sm muted">
          {{ pa.source?.template || 'Generic' }}
          <ng-container *ngIf="pa.source?.confidence as conf">
            • {{ (conf * 100) | number:'1.0-0' }}% match
            <div class="info-highlight">
              Member identified and ready for linkage. Authorization is required for this request using the specified Service Codes and effective Start–End dates.
            </div>
          </ng-container>
        </div>
        <div class="card-title">Patient</div>
        <div class="grid-2">
          <div><strong>Name</strong>: {{ pa.patient?.name || '—' }}</div>
          <div><strong>Member ID</strong>: {{ pa.patient?.memberId || '—' }}</div>
          <div><strong>DOB</strong>: {{ pa.patient?.dob || '—' }}</div>
          <div><strong>Phone</strong>: {{ pa.patient?.phone || '—' }}</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Review / Setting</div>
        <div class="grid-2">
          <div><strong>Type</strong>: {{ pa.review?.type || '—' }}</div>
          <div><strong>Inpatient</strong>: {{ pa.setting?.inpatient ? 'Yes' : 'No' }}</div>
          <div><strong>Outpatient</strong>: {{ pa.setting?.outpatient ? 'Yes' : 'No' }}</div>
        </div>
      </div>

      <div class="card" *ngIf="pa.services?.length">
        <div class="card-title">Services</div>
        <div *ngFor="let s of pa.services" class="svc">
          <div><strong>Code</strong>: {{ s.code || '—' }}</div>
          <div class="md:col-span-2"><strong>Description</strong>: {{ s.description || '—' }}</div>
          <div><strong>Start</strong>: {{ s.startDate || '—' }}</div>
          <div><strong>End</strong>: {{ s.endDate || '—' }}</div>
          <div><strong>DX</strong>: {{ s.diagnosisCode || s.diagnosisDescription || (pa.dx?.codes?.join(', ') || '—') }}</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Providers</div>
        <div class="grid-2">
          <div>
            <strong>Requesting</strong>: {{ pa.providerRequesting?.name || '—' }}
            <span *ngIf="pa.providerRequesting?.npi"> (NPI {{ pa.providerRequesting?.npi }})</span>
          </div>
          <div><strong>Servicing/Facility</strong>: {{ pa.providerServicing?.name || pa.providerServicing?.facility || '—' }}</div>
          <div><strong>Req. Phone</strong>: {{ pa.providerRequesting?.phone || '—' }}</div>
          <div><strong>Serv. Phone</strong>: {{ pa.providerServicing?.phone || '—' }}</div>
        </div>
      </div>

      <div class="card" *ngIf="pa.notes || pa.submission?.issuerName">
        <div class="card-title">Submission / Notes</div>
        <div class="grid-2">
          <div><strong>Issuer</strong>: {{ pa.submission?.issuerName || '—' }}</div>
          <div><strong>Date</strong>: {{ pa.submission?.date || '—' }}</div>
        </div>
        <div class="mt-2"><strong>Notes</strong>: {{ pa.notes || '—' }}</div>
      </div>
    </div>

    <ng-template #noOcr>
      <div class="muted">No OCR details yet. Choose a fax on the left.</div>
    </ng-template>
  </div>

  <!-- Right: status (placeholder) -->
  <!--<div class="pane pane-right">
    <div class="pane-title">Load Status</div>
    <div class="card">
      <div class="row"><span class="muted">Current status</span><span class="chip chip-soft">{{ selectedFax.status }}</span></div>
      <div class="row"><span class="muted">Priority</span><span class="chip chip-soft" [ngClass]="priorityClass(selectedFax.priority || 2)">{{ priorityLabel(selectedFax.priority || 2) }}</span></div>
      <div class="row"><span class="muted">Pages</span><span>{{ selectedFax.pageCount }}</span></div>
      <div class="row"><span class="muted">Received</span><span>{{ selectedFax.receivedAt | date:'M/d/yy, h:mm a' }}</span></div>-->
  <!-- Add timeline/progress later -->
  <!--</div>
  </div>-->
  <!-- Right: PDF preview + status -->
  <div class="pane pane-right">
    <div class="pane-header">
      <span>Preview</span>
    </div>

    <!-- PDF IFRAME -->
    <div class="preview-frame" *ngIf="previewUrl; else noPreview">
      <iframe [src]="previewUrl"
              title="Fax Preview"
              style="width:100%; height:65vh; border:0; border-radius:8px;">
      </iframe>
    </div>
    <ng-template #noPreview>
      <div class="muted" style="padding:12px 0;">Select a fax to preview.</div>
    </ng-template>

    <!-- Status card (kept from your layout) -->
    <!--<div class="pane-title" style="margin-top:12px;">Load Status</div>
    <div class="card" *ngIf="selectedFax">
      <div class="row"><span class="muted">Current status</span><span class="chip chip-soft">{{ selectedFax.status || selectedFax.status }}</span></div>
      <div class="row">
        <span class="muted">Priority</span>
        <span class="chip chip-soft" [ngClass]="priorityClass((selectedFax.priority ?? selectedFax.priority) || 2)">
          {{ priorityLabel((selectedFax.priority ?? selectedFax.priority) || 2) }}
        </span>
      </div>
      <div class="row"><span class="muted">Pages</span><span>{{ selectedFax.pageCount ?? selectedFax.pageCount }}</span></div>
      <div class="row">
        <span class="muted">Received</span>
        <span>{{ (selectedFax.receivedAt ?? selectedFax.receivedAt) | date:'M/d/yy, h:mm a' }}</span>
      </div>
    </div>-->
  </div>

</div>

