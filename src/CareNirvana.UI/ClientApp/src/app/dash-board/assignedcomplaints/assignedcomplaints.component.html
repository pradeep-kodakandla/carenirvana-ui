<mat-menu #rowMenu="matMenu" panelClass="row-menu-panel">
  <ng-template matMenuContent let-row="row" let-trigger="trigger">
    <button mat-menu-item class="row-menu-item row-menu-item--primary"
            (click)="openActivity(row); trigger.closeMenu()">
      <span class="row-menu-icon">
        <mat-icon>add</mat-icon>
      </span>
      <span class="row-menu-label">Add Activity</span>
    </button>

    <button mat-menu-item class="row-menu-item"
            (click)="openNotes(row, 'add'); trigger.closeMenu()">
      <span class="row-menu-icon">
        <mat-icon>edit_note</mat-icon>
      </span>
      <span class="row-menu-label">Add Notes</span>
    </button>

    <button mat-menu-item class="row-menu-item">
      <span class="row-menu-icon">
        <mat-icon>assignment</mat-icon>
      </span>
      <span class="row-menu-label">Run Assessment</span>
    </button>

    <button mat-menu-item class="row-menu-item"
            (click)="openDocuments(row, 'add'); trigger.closeMenu()">
      <span class="row-menu-icon">
        <mat-icon>description</mat-icon>
      </span>
      <span class="row-menu-label">Add Documents</span>
    </button>

    <button mat-menu-item class="row-menu-item">
      <span class="row-menu-icon">
        <mat-icon>outgoing_mail</mat-icon>
      </span>
      <span class="row-menu-label">Send Letter</span>
    </button>

    <button mat-menu-item class="row-menu-item"
            (click)="openNotes(row); trigger.closeMenu()">
      <span class="row-menu-icon">
        <mat-icon>content_copy</mat-icon>
      </span>
      <span class="row-menu-label">Clone</span>
    </button>

    <button mat-menu-item class="row-menu-item"
            (click)="openNotes(row); trigger.closeMenu()">
      <span class="row-menu-icon">
        <mat-icon>summarize</mat-icon>
      </span>
      <span class="row-menu-label">Case Summary</span>
    </button>
  </ng-template>
</mat-menu>

<div class="dashboard-wrapper">
  <!-- Top bar: search + filter toggle + due chips -->
  <div class="top-bar">
    <div class="search-section">
      <input type="text"
             placeholder="ðŸ” Search complaintsâ€¦"
             (input)="onQuickSearch($event)"
             class="search-input" />

      <button class="filter-btn"
              type="button"
              (click)="toggleFilters()"
              title="Filters">
        <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3 5h18v2l-7 7v5l-4 2v-7L3 7z"></path>
        </svg>
      </button>

      <button matTooltip="Click to add a new complaint" class="btn btn-primary ms-2">
        Add Complaint
      </button>
    </div>

    <div class="summary-container" *ngIf="!showFilters">
      <div class="filters-col">
        <div class="chip-list">
          <button type="button" class="pill green" [class.active]="isDueSelected('TODAY')" (click)="setDueChip('TODAY')">
            <span class="dot green"></span> Due Today
            <span class="count">{{ dueTodayCount }}</span>
          </button>

          <button type="button" class="pill red" [class.active]="isDueSelected('OVERDUE')" (click)="setDueChip('OVERDUE')">
            <span class="dot red"></span> Over Due
            <span class="count">{{ overDueCount }}</span>
          </button>

          <button type="button" class="pill blue" [class.active]="isDueSelected('FUTURE')" (click)="setDueChip('FUTURE')">
            <span class="dot blue"></span> Due in Future
            <span class="count">{{ dueFutureCount }}</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Inline Filters Drawer -->
  <section class="filters-wrapper" *ngIf="showFilters">
    <form [formGroup]="filtersForm" class="filters-panel">
      <div class="filters-header">
        <h3>Filters</h3>
        <div class="filters-footer">
          <button type="button" (click)="resetFilters()" class="reset-btn">Reset</button>
          <button type="button" (click)="applyAdvancedFilters()" class="apply-btn">Apply</button>
          <button type="button" (click)="toggleFilters()" class="close-btn">Close</button>
        </div>
      </div>

      <div class="filters-grid filters-grid--three">
        <mat-form-field appearance="outline">
          <mat-label>Case #</mat-label>
          <input matInput formControlName="caseNumber" placeholder="e.g., 1000123">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Case Type</mat-label>
          <input matInput formControlName="caseType" placeholder="e.g., Appeal">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Priority</mat-label>
          <input matInput formControlName="casePriority" placeholder="e.g., High">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Status</mat-label>
          <input matInput formControlName="caseStatus" placeholder="e.g., In Progress">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Received From</mat-label>
          <input matInput [matDatepicker]="rcFrom" formControlName="receivedFrom">
          <mat-datepicker-toggle matSuffix [for]="rcFrom"></mat-datepicker-toggle>
          <mat-datepicker #rcFrom></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Received To</mat-label>
          <input matInput [matDatepicker]="rcTo" formControlName="receivedTo">
          <mat-datepicker-toggle matSuffix [for]="rcTo"></mat-datepicker-toggle>
          <mat-datepicker #rcTo></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Created From</mat-label>
          <input matInput [matDatepicker]="crFrom" formControlName="createdFrom">
          <mat-datepicker-toggle matSuffix [for]="crFrom"></mat-datepicker-toggle>
          <mat-datepicker #crFrom></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Created To</mat-label>
          <input matInput [matDatepicker]="crTo" formControlName="createdTo">
          <mat-datepicker-toggle matSuffix [for]="crTo"></mat-datepicker-toggle>
          <mat-datepicker #crTo></mat-datepicker>
        </mat-form-field>
      </div>
    </form>
  </section>

  <div class="workspace" [class.has-notes]="showNotesPanel">
    <div class="left-pane">
      <div class="table-wrapper">
        <table mat-table [dataSource]="dataSource" matSort
               multiTemplateDataRows
               class="mat-elevation-z1 full-width-table pro-table mng-table">

          <!-- Member -->
          <ng-container matColumnDef="memberId">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Member</th>
            <td mat-cell *matCellDef="let row">
              <div class="name-cell">
                <div class="sub-name">
                  <a href="#"
                     (click)="onMemberClick(row.memberId || '', row.memberName || '', row.memberDetailId); $event.preventDefault()">
                    {{ row.memberName || '-' }}
                  </a>
                </div>
                <div class="sub-id">ID: {{ row.memberId || '-' }}</div>
              </div>
            </td>
          </ng-container>

          <!-- Case Number -->
          <ng-container matColumnDef="caseNumber">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Case #</th>
            <td mat-cell *matCellDef="let row">
              <div class="name-cell">
                <div class="sub-name">
                  <a href="#"
                     (click)="onCaseClick(row.caseNumber || '', row.memberId || '', row.memberDetailId); $event.preventDefault()">
                    {{ row.caseNumber || '-' }}
                  </a>
                </div>
                <div class="sub-id">Level: {{ row.caseLevelId || '-' }}</div>
              </div>


            </td>
          </ng-container>

          <!-- Case Type -->
          <ng-container matColumnDef="caseType">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Case Type</th>
            <td mat-cell *matCellDef="let row">{{ row.caseTypeText || row.caseType || '-' }}</td>
          </ng-container>
          <!-- Case Category -->
          <ng-container matColumnDef="caseCategory">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Case Category</th>
            <td mat-cell *matCellDef="let row">{{ row.caseCategoryText || row.caseCategory || '-' }}</td>
          </ng-container>

          <!-- Received Date -->
          <ng-container matColumnDef="receivedDateTime">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Received</th>
            <td mat-cell *matCellDef="let row">
              {{ row.receivedDateTime ? (row.receivedDateTime | date) : '-' }}
            </td>
          </ng-container>

          <!-- Priority -->
          <ng-container matColumnDef="priority">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Priority</th>
            <td mat-cell *matCellDef="let row">
              <span class="priority-cell" [class.expedited-text]="isExpedited(row)">
                <mat-icon *ngIf="isExpedited(row)" class="expedited-icon" matTooltip="Expedited" aria-hidden="true">error</mat-icon>
                <span class="priority-text">{{ row.casePriorityText || row.casePriority || '-' }}</span>
              </span>
            </td>
          </ng-container>

          <!-- Status -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
            <td mat-cell *matCellDef="let row">{{ row.caseStatusText || row.caseStatusId || '-' }}</td>
          </ng-container>

          <!-- Created By -->
          <!--<ng-container matColumnDef="createdBy">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Created By</th>
            <td mat-cell *matCellDef="let row">{{ row.createdByUserName || row.createdBy || '-' }}</td>
          </ng-container>-->
          <!-- Created On -->
          <ng-container matColumnDef="createdOn">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Created</th>
            <td mat-cell *matCellDef="let row">
              {{ row.createdOn ? (row.createdOn | date) : '-' }}
            </td>
          </ng-container>

          <!-- Actions (RIGHT SIDE) -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="is-center">Actions</th>
            <td mat-cell *matCellDef="let row" class="is-center">
              <button mat-icon-button
                      class="row-menu-trigger-icon"
                      [matMenuTriggerFor]="rowMenu"
                      [matMenuTriggerData]="{ row: row, trigger: rowMenu }"
                      (click)="$event.stopPropagation()"
                      matTooltip="View action list">
                <mat-icon>more_vert</mat-icon>
              </button>
            </td>
          </ng-container>

          <!-- Expanded placeholder -->
          <ng-container matColumnDef="expandedDetail">
            <td mat-cell *matCellDef="let row" [attr.colspan]="displayedColumns.length">
              <!-- add expanded info if needed -->
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row
              *matRowDef="let row; columns: displayedColumns;"
              class="example-element-row"
              [class.example-expanded-row]="expandedElement === row"
              (click)="expandedElement = expandedElement === row ? null : row"
              [class.row-target]="(row.caseNumber) === selectedCaseNumber">
          </tr>
          <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>
          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell" [attr.colspan]="displayedColumns.length">No data</td>
          </tr>
        </table>

        <mat-paginator [pageSizeOptions]="[10, 25, 100]" aria-label="Select page"></mat-paginator>
      </div>
    </div>

    <aside class="right-pane" [attr.aria-hidden]="!showNotesPanel">
      <div class="notes-header">
        <h3 class="pane-title">
          <span class="title-strong">{{ getPanelTitle() }}</span>
          <span class="title-normal" *ngIf="panelSubtitle"> - {{ panelSubtitle }}</span>
        </h3>
        <button type="button" class="notes-close" (click)="closePanel()" aria-label="Close">Ã—</button>
      </div>

      <div class="panel-body">

        <!-- NOTES -->
        <app-casenotes *ngIf="selectedPanel === 'notes'"
                       [caseHeaderId]="selectedCaseHeaderId ?? undefined"
                       [caseTemplateId]="selectedCaseTemplateId ?? undefined"
                       [levelId]="selectedCaseLevelId ?? 1"
                       [caseNumber]="selectedCaseNumber ?? undefined"
                       [singlePane]="true"
                       [isAddOnly]="notesViewMode === 'add'"
                       (viewAll)="onNotesViewAll()">
        </app-casenotes>

        <!-- ACTIVITIES -->
        <app-caseactivities *ngIf="selectedPanel === 'activity'"
                            [memberDetailsId]="selectedMemberDetailsId ?? undefined"
                            [caseHeaderId]="selectedCaseHeaderId ?? undefined"
                            [caseTemplateId]="selectedCaseTemplateId ?? undefined"
                            [caseLevelId]="selectedCaseLevelId ?? 1"
                            [levelId]="selectedCaseLevelId ?? 1"
                            [singlePaneOnEdit]="true"
                            [mode]="activityViewMode === 'add' ? 'embed' : 'full'"
                            (viewAll)="onActivityViewAll()">
        </app-caseactivities>

        <!-- DOCUMENTS -->
        <app-casedocuments *ngIf="selectedPanel === 'documents'"
                           [caseHeaderId]="selectedCaseHeaderId ?? undefined"
                           [caseTemplateId]="selectedCaseTemplateId ?? undefined"
                           [levelId]="selectedCaseLevelId ?? 1"
                           [singlePane]="true"
                           [startAdd]="startAddDocuments"
                           [inputMode]="documentsViewMode"
                           [mode]="documentsViewMode"
                           (requestViewAll)="onDocumentsRequestViewAll()"
                           (requestAddOnly)="onDocumentsRequestAddOnly()">
        </app-casedocuments>

      </div>

    </aside>
  </div>
</div>
