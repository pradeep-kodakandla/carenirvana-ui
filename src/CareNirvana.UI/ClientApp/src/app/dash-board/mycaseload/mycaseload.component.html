<!--<mat-menu #rowMenu="matMenu">
  <ng-template matMenuContent let-member="member">-->
<!--<button mat-menu-item><span>Add Activity</span></button>-->
<!--<button mat-menu-item (click)="openPanel('activity', member)"><span>Add Activity</span></button>
<button mat-menu-item><span>Run Assessment</span></button>
<button mat-menu-item (click)="openPanel('messages', member)"><span>Add Messages</span></button>-->
<!--<button mat-menu-item><span>Add document</span></button>
<button mat-menu-item (click)="onAddNotesFor(member)">
  <span>Add Notes</span>
</button>-->
<!--<button mat-menu-item (click)="openPanel('notes', member)"><span>Add Notes</span></button>
    <button mat-menu-item (click)="openPanel('document', member)"><span>Add document</span></button>

    <button mat-menu-item><span>Send Letter</span></button>
    <button mat-menu-item (click)="confirmUnassign(member, $event)"><span>Unassign</span></button>
    <button mat-menu-item (click)="openPanel('journey', member)"><span>Journey</span></button>
    <button mat-menu-item (click)="openPanel('summary', member)"><span>Summary</span></button>
  </ng-template>
</mat-menu>-->
<!-- trigger example -->

<mat-menu #rowMenu="matMenu" panelClass="row-menu-panel">
  <ng-template matMenuContent let-member="member">

    <!-- Add Activity (primary row) -->
    <button mat-menu-item class="row-menu-item row-menu-item--primary"
            (click)="openPanel('activity', member)">
      <span class="row-menu-icon">
        <mat-icon>add</mat-icon>
      </span>
      <span class="row-menu-label">Add Activity</span>
    </button>

    <button mat-menu-item class="row-menu-item"
            (click)="openPanel('messages', member)">
      <span class="row-menu-icon">
        <mat-icon>mail</mat-icon>
      </span>
      <span class="row-menu-label">Send Message</span>
    </button>

    <button mat-menu-item class="row-menu-item"
            (click)="openPanel('notes', member)">
      <span class="row-menu-icon">
        <mat-icon>edit_note</mat-icon>
      </span>
      <span class="row-menu-label">Add Notes</span>
    </button>

    <button mat-menu-item class="row-menu-item">
      <span class="row-menu-icon">
        <mat-icon>assignment</mat-icon>
      </span>
      <span class="row-menu-label">Run Assessment</span>
    </button>

    <button mat-menu-item class="row-menu-item"
            (click)="openPanel('document', member)">
      <span class="row-menu-icon">
        <mat-icon>description</mat-icon>
      </span>
      <span class="row-menu-label">Add Documents</span>
    </button>

    <button mat-menu-item class="row-menu-item">
      <span class="row-menu-icon">
        <mat-icon>outgoing_mail</mat-icon>
      </span>
      <span class="row-menu-label">Send Letter</span>
    </button>

    <button mat-menu-item class="row-menu-item"
            (click)="confirmUnassign(member, $event)">
      <span class="row-menu-icon">
        <mat-icon>person_remove</mat-icon>
      </span>
      <span class="row-menu-label">Unassign</span>
    </button>

    <button mat-menu-item class="row-menu-item"
            (click)="openPanel('summary', member)">
      <span class="row-menu-icon">
        <mat-icon>summarize</mat-icon>
      </span>
      <span class="row-menu-label">Summarizer</span>
    </button>

    <button mat-menu-item class="row-menu-item"
            (click)="openPanel('journey', member)">
      <span class="row-menu-icon">
        <mat-icon>map</mat-icon>
      </span>
      <span class="row-menu-label">Member Journey</span>
    </button>

    <button mat-menu-item class="row-menu-item">
      <span class="row-menu-icon">
        <mat-icon>history</mat-icon>
      </span>
      <span class="row-menu-label">View History</span>
    </button>

  </ng-template>
</mat-menu>



<mat-menu #alertsMenu="matMenu"
          class="history-popover"
          yPosition="below"
          [overlapTrigger]="false"
          [hasBackdrop]="true"
          [backdropClass]="'cdk-overlay-dark-backdrop'"
          (menuClosed)="memDelId = 0"
          matMenuTriggerRestoreFocus="false">
  <div class="messages-wrap">
    <!-- Give the panel a nice fixed size -->
    <app-member-alerts [showTable]="true" [memberDetailsId]="memDelId"></app-member-alerts>
  </div>
</mat-menu>

<!-- mycaseload-dashboard.component.html -->
<div class="dashboard-wrapper">
  <!-- Search and Summary Cards in One Row -->
  <div class="top-bar">
    <!-- Search -->
    <div class="search-section">
      <input type="text" placeholder="ðŸ” Search..." (input)="onSearch($event)" class="search-input" />
      <button class="filter-btn"
              type="button"
              (click)="toggleFilters()"
              title="Filters">
        <!-- Use mat-icon if you have Angular Material; else fallback SVG -->
        <!-- <mat-icon>tune</mat-icon> -->
        <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3 5h18v2l-7 7v5l-4 2v-7L3 7z"></path>
        </svg>
      </button>
    </div>

    <!-- Summary Cards -->
    <div class="summary-container" style="padding-left:10px;align-self:center;" *ngIf="!showFilters">

      <div class="filters-col">
        <!--<div class="filters-title">Risk Level</div>-->
        <div class="chip-list">
          <button type="button" class="pill red" [class.active]="filters.risks.has('High')" (click)="toggleRisk('High')">
            <span class="dot red"></span> High Risk
            <span class="count">{{ counts.risk.high }}</span>
          </button>
          <button type="button" class="pill amber" [class.active]="filters.risks.has('Medium')" (click)="toggleRisk('Medium')">
            <span class="dot amber"></span> Medium Risk
            <span class="count">{{ counts.risk.medium }}</span>
          </button>
          <button type="button" class="pill green" [class.active]="filters.risks.has('Low')" (click)="toggleRisk('Low')">
            <span class="dot green"></span> Low Risk
            <span class="count">{{ counts.risk.low }}</span>
          </button>
          <button type="button" class="pill green" [class.active]="filters.risks.has('Norisk')" (click)="toggleRisk('Norisk')">
            <span class="dot"></span> No Risk
            <span class="count">{{ counts.risk.norisk }}</span>
          </button>
        </div>
      </div>
    </div>
    <!-- View Mode Toggle Button -->
    <!--<div class="view-toggle">
      <button mat-icon-button (click)="toggleViewMode()" matTooltip="Toggle View">
        <mat-icon>{{ viewMode === 'card' ? 'view_module' : 'table_rows' }}</mat-icon>
      </button>
    </div>-->
  </div>

  <!-- Filters Dialog -->
  <!-- INLINE FILTERS (toggle with showFilters) -->
  <section class="filters-wrapper" *ngIf="showFilters">
    <div class="filters-panel">
      <div class="filters-header">
        <h3>Member Filters &amp; Analytics</h3>
        <!--<button class="reset-btn" type="button" (click)="resetFilters(); toggleFilters()">
          <span class="reset-icon">â†º</span> Reset All Filters
        </button>-->
        <div class="filters-footer">
          <button class="close-btn" type="button" (click)="toggleFilters()">Close</button>
          <button class="apply-btn" type="button" (click)="applyFilters(); toggleFilters()">Apply Filters</button>
        </div>
      </div>

      <!-- Selected Filters Breadcrumb Bar -->
      <div class="selected-bar" *ngIf="selectedFilters.length > 0">
        <div class="selected-title">Selected:</div>

        <div class="selected-list">
          <button class="sel-pill"
                  *ngFor="let f of selectedFilters"
                  (click)="removeSelectedFilter(f)"
                  [attr.aria-label]="'Remove ' + f.group + ': ' + f.label"
                  type="button">
            <span class="group">{{ f.group }}:</span>
            <span class="label">{{ f.label }}</span>
            <span class="close">Ã—</span>
          </button>
        </div>

        <button class="clear-all" type="button" (click)="clearAllSelected()">
          Clear all
        </button>
      </div>

      <div class="filters-grid">
        <!-- Risk Level -->
        <div class="filters-col">
          <div class="filters-title">Risk Level</div>
          <div class="chip-list">
            <button type="button" class="pill red" [class.active]="filters.risks.has('High')" (click)="toggleRisk('High')">
              <span class="dot red"></span> High Risk
              <span class="count">{{ counts.risk.high }}</span>
            </button>
            <button type="button" class="pill amber" [class.active]="filters.risks.has('Medium')" (click)="toggleRisk('Medium')">
              <span class="dot amber"></span> Medium Risk
              <span class="count">{{ counts.risk.medium }}</span>
            </button>
            <button type="button" class="pill green" [class.active]="filters.risks.has('Low')" (click)="toggleRisk('Low')">
              <span class="dot green"></span> Low Risk
              <span class="count">{{ counts.risk.low }}</span>
            </button>
            <button type="button" class="pill green" [class.active]="filters.risks.has('Norisk')" (click)="toggleRisk('Norisk')">
              <span class="dot"></span> No Risk
              <span class="count">{{ counts.risk.norisk }}</span>
            </button>
          </div>
        </div>

        <!-- Diagnosis -->
        <div class="filters-col">
          <div class="filters-title">Diagnosis</div>
          <div class="listbox" role="listbox" aria-multiselectable="true">
            <label class="listbox-row" *ngFor="let d of diagnosisOptions">
              <input type="checkbox" [(ngModel)]="diagnosisSelection[d]" />
              <span>{{ d }}</span>
            </label>
          </div>
        </div>

        <!-- Quality Indicators -->
        <div class="filters-col">
          <div class="filters-title">Quality Indicators</div>
          <div class="listbox" role="listbox" aria-multiselectable="true">
            <label class="listbox-row" *ngFor="let q of qualityOptions">
              <input type="checkbox" [(ngModel)]="qualitySelection[q]" />
              <span>{{ q }}</span>
            </label>
          </div>
        </div>

        <!-- Enrollment Status -->
        <div class="filters-col">
          <div class="filters-title">Enrollment Status</div>
          <div class="chip-list">
            <button type="button" class="pill green" [class.active]="filters.enroll.has('Active')" (click)="toggleEnroll('Active')">
              <span class="dot green"></span> Active
              <span class="count">{{ counts.enroll.active }}</span>
            </button>
            <button type="button" class="pill amber" [class.active]="filters.enroll.has('Soon Ending')" (click)="toggleEnroll('Soon Ending')">
              <span class="dot amber"></span> Soon Ending
              <span class="count">{{ counts.enroll.soonEnding }}</span>
            </button>
            <button type="button" class="pill red" [class.active]="filters.enroll.has('Inactive')" (click)="toggleEnroll('Inactive')">
              <span class="dot red"></span> Inactive
              <span class="count">{{ counts.enroll.inactive }}</span>
            </button>
            <button type="button" class="pill red" [class.active]="filters.enroll.has('No Enrollment')" (click)="toggleEnroll('No Enrollment')">
              No Enrollment
              <span class="count">{{ counts.enroll.noEnrollment }}</span>
            </button>
          </div>
        </div>
      </div>

    </div>
  </section>
  <div class="workspace" [class.has-notes]="showNotesPanel">

    <!-- LEFT: main content (100% by default; 60% when notes open) -->
    <div class="left-pane">


      <!-- Table View -->

      <div class="table-wrapper" *ngIf="viewMode === 'table'">

        <!--Debug: Expanded Row ID = {{ expandedRow ? expandedRow.memberId : 'null' }}-->
        <table mat-table [dataSource]="dataSource"
               matSort
               multiTemplateDataRows
               [trackBy]="trackById"
               class="mat-elevation-z1 full-width-table pro-table mng-table">


          <!-- Alerts Column (new) -->
          <ng-container matColumnDef="alert">
            <th mat-header-cell *matHeaderCellDef class="is-center alert-col-header" matTooltip="Alerts">
              <!-- Header -->
            </th>
            <td mat-cell *matCellDef="let m" class="is-center alert-col-cell">
              <button mat-icon-button
                      *ngIf="m.alertCount > 0"
                      [matMenuTriggerFor]="alertsMenu"
                      (click)="onAlertsButtonClick(m.memberDetailId ?? m.memberDetailsId)">
                <span class="alert-bell"
                      [matBadge]="m.alertCount"
                      matTooltip="{{ m.alertCount }} active alerts">
                  <mat-icon>notifications</mat-icon>
                </span>
              </button>
            </td>
          </ng-container>


          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Member</th>
            <td mat-cell *matCellDef="let m">
              <div class="name-cell">
                <div class="sub-name">
                  <a href="#" (click)="onMemberClick(m.memberId, m.firstName + ' ' + m.lastName,m.memberDetailsId); $event.preventDefault()">{{ m.firstName }} {{ m.lastName }}</a>
                </div>
                <div class="sub-id">ID: {{ m.memberId }}</div>
              </div>
            </td>
          </ng-container>

          <!-- Enrollment Column -->
          <ng-container matColumnDef="enrollment">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Enrollment</th>
            <td mat-cell *matCellDef="let m">{{ getProduct(m.levelMap) || 'N/A' }}</td>

          </ng-container>

          <!-- Program Column -->
          <ng-container matColumnDef="program">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Program</th>
            <td mat-cell *matCellDef="let m">
              <ng-container *ngIf="m.programs; else noProgram">
                <div *ngFor="let p of m.programs.split(',')">{{ p.trim() }}</div>
              </ng-container>
              <ng-template #noProgram>N/A</ng-template>
            </td>
          </ng-container>

          <!-- DOB Column -->
          <!--<ng-container matColumnDef="dob">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>DOB</th>
            <td mat-cell *matCellDef="let m">{{ m.dob }}</td>
          </ng-container>-->


          <ng-container matColumnDef="dob">


            <th mat-header-cell *matHeaderCellDef mat-sort-header>DOB</th>
            <td mat-cell *matCellDef="let m">
              <div>
                {{ m.dob | date: 'MM/dd/yyyy' }}
                <div class="dob-age" *ngIf="getAgeText(m.dob)">
                  <small>{{ getAgeText(m.dob) }}</small>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Risk Column -->
          <ng-container matColumnDef="risk">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Risk Level </th>
            <td mat-cell *matCellDef="let m">
              <span class="risk-chip compact" [ngClass]="(m.riskLevelCode || '').toLowerCase()">{{ m.riskLevelCode || 'No Risk' }}</span>
            </td>
          </ng-container>

          <!-- Last Contact Column -->
          <ng-container matColumnDef="lastContact">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Last Contact</th>
            <td mat-cell *matCellDef="let m">{{ m.lastContact || 'N/A' }}</td>
          </ng-container>

          <!-- Next Contact Column -->
          <ng-container matColumnDef="nextContact">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Next Contact</th>
            <td mat-cell *matCellDef="let m">{{ m.nextContact || 'N/A' }}</td>
          </ng-container>

          <!-- Action Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="is-center alert-col-header" matTooltip="Actions">
              Actions
            </th>
            <td mat-cell *matCellDef="let m" class="is-center alert-col-cell">

              <button mat-icon-button [matMenuTriggerFor]="rowMenu" class="row-menu-trigger-icon" [matMenuTriggerData]="{ member: m }" matTooltip="View action list">
                <mat-icon>more_vert</mat-icon>
              </button>

            </td>
          </ng-container>
          <!--Expand Column-->
          <!--<ng-container matColumnDef="expand">
            <th mat-header-cell *matHeaderCellDef class="is-center"></th>
            <td mat-cell *matCellDef="let m" class="is-center">
              <button mat-icon-button class="chev-btn"
                      (click)="toggleRow(m); $event.stopPropagation()"
                      [attr.aria-label]="expandedRow === m ? 'Collapse' : 'Expand'">
                <mat-icon class="chev" [ngClass]="{'rot': expandedRow === m}">
                  keyboard_arrow_down
                </mat-icon>
              </button>
            </td>
          </ng-container>-->
          <!-- Expanded Detail Column (custom content) -->
          <!-- Header and main rows first -->
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"
              class="member-row" [class.expanded-row]="expandedRow === row" [class.notes-target]="(row.memberDetailsId ?? row.memberId) === selectedMemberId"></tr>

          <!-- Detail Row *matRowDef="let row; columns: ['expandedDetail']; when: isDetailRow"-->
          <tr mat-row class="detail-row"></tr>
          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell" [attr.colspan]="displayedColumns.length">No data</td>
          </tr>
        </table>
      </div>

      <!-- Paginator Always at Bottom -->
      <mat-paginator [pageSize]="10" [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>


    </div>

    <aside class="right-pane"
           [attr.aria-hidden]="!showNotesPanel"
           [class.is-open]="showNotesPanel">

      <div class="notes-header">
        <!--<h3>{{ getHeaderTitle() }}</h3>-->
        <h3 class="pane-title">
          <span class="title-strong">{{ getHeaderTitle() }}</span>
          <span class="title-normal"> - {{ headerTitle || '' }}</span>
        </h3>
        <button type="button" class="notes-close" (click)="closePanel()" aria-label="Close">Ã—</button>
      </div>

      <ng-container style="padding-left:5px;" #dynamicContainer></ng-container>

    </aside>
  </div>
</div>
